/*!!
 * save-storage-worker.js - corescript v1.6.1 (community-1.4)
 * (c) 2015 KADOKAWA CORPORATION./YOJI OJIMA
 * Contributions by the RPG Maker MV CoreScript team
 * https://github.com/thinknathan/corescript/blob/master/CONTRIBUTORS.md
 *
 * idb-keyval 6.2.0 | Copyright 2016, Jake Archibald
 * https://github.com/jakearchibald/idb-keyval/blob/main/LICENCE
 *
 * fflate@0.7.3 | https://github.com/101arrowz/fflate/blob/master/LICENSE
 *
 * Comlink | Copyright 2019 Google Inc.
 * https://github.com/GoogleChromeLabs/comlink/blob/main/LICENSE
 */
!(function(){"use strict";var e=Uint8Array,r=Uint16Array,t=Uint32Array,n=new e([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),a=new e([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),s=new e([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),i=function(e,n){for(var a=new r(31),s=0;s<31;++s)a[s]=n+=1<<e[s-1];var i=new t(a[30]);for(s=1;s<30;++s)for(var o=a[s];o<a[s+1];++o)i[o]=o-a[s]<<5|s;return[a,i]},o=i(n,2),c=o[0],u=o[1];c[28]=258,u[258]=28;for(var f=i(a,0),l=f[0],v=f[1],h=new r(32768),d=0;d<32768;++d){var p=(43690&d)>>>1|(21845&d)<<1;p=(61680&(p=(52428&p)>>>2|(13107&p)<<2))>>>4|(3855&p)<<4,h[d]=((65280&p)>>>8|(255&p)<<8)>>>1}var w=function(e,t,n){for(var a=e.length,s=0,i=new r(t);s<a;++s)e[s]&&++i[e[s]-1];var o,c=new r(t);for(s=0;s<t;++s)c[s]=c[s-1]+i[s-1]<<1;if(n){o=new r(1<<t);var u=15-t;for(s=0;s<a;++s)if(e[s])for(var f=s<<4|e[s],l=t-e[s],v=c[e[s]-1]++<<l,d=v|(1<<l)-1;v<=d;++v)o[h[v]>>>u]=f}else for(o=new r(a),s=0;s<a;++s)e[s]&&(o[s]=h[c[e[s]-1]++]>>>15-e[s]);return o},g=new e(288);for(d=0;d<144;++d)g[d]=8;for(d=144;d<256;++d)g[d]=9;for(d=256;d<280;++d)g[d]=7;for(d=280;d<288;++d)g[d]=8;var y=new e(32);for(d=0;d<32;++d)y[d]=5;var m=w(g,9,0),b=w(g,9,1),k=w(y,5,0),E=w(y,5,1),S=function(e){for(var r=e[0],t=1;t<e.length;++t)e[t]>r&&(r=e[t]);return r},C=function(e,r,t){var n=r/8|0;return(e[n]|e[n+1]<<8)>>(7&r)&t},M=function(e,r){var t=r/8|0;return(e[t]|e[t+1]<<8|e[t+2]<<16)>>(7&r)},T=function(e){return(e+7)/8|0},A=function(n,a,s){(null==a||a<0)&&(a=0),(null==s||s>n.length)&&(s=n.length);var i=new(2==n.BYTES_PER_ELEMENT?r:4==n.BYTES_PER_ELEMENT?t:e)(s-a);return i.set(n.subarray(a,s)),i},x=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],L=function(e,r,t){var n=new Error(r||x[e]);if(n.code=e,Error.captureStackTrace&&Error.captureStackTrace(n,L),!t)throw n;return n},P=function(e,r,t){t<<=7&r;var n=r/8|0;e[n]|=t,e[n+1]|=t>>>8},K=function(e,r,t){t<<=7&r;var n=r/8|0;e[n]|=t,e[n+1]|=t>>>8,e[n+2]|=t>>>16},N=function(t,n){for(var a=[],s=0;s<t.length;++s)t[s]&&a.push({s,f:t[s]});var i=a.length,o=a.slice();if(!i)return[U,0];if(1==i){var c=new e(a[0].s+1);return c[a[0].s]=1,[c,1]}a.sort((function(e,r){return e.f-r.f})),a.push({s:-1,f:25001});var u=a[0],f=a[1],l=0,v=1,h=2;for(a[0]={s:-1,f:u.f+f.f,l:u,r:f};v!=i-1;)u=a[a[l].f<a[h].f?l++:h++],f=a[l!=v&&a[l].f<a[h].f?l++:h++],a[v++]={s:-1,f:u.f+f.f,l:u,r:f};var d=o[0].s;for(s=1;s<i;++s)o[s].s>d&&(d=o[s].s);var p=new r(d+1),w=O(a[v-1],p,0);if(w>n){s=0;var g=0,y=w-n,m=1<<y;for(o.sort((function(e,r){return p[r.s]-p[e.s]||e.f-r.f}));s<i;++s){var b=o[s].s;if(!(p[b]>n))break;g+=m-(1<<w-p[b]),p[b]=n}for(g>>>=y;g>0;){var k=o[s].s;p[k]<n?g-=1<<n-p[k]++-1:++s}for(;s>=0&&g;--s){var E=o[s].s;p[E]==n&&(--p[E],++g)}w=n}return[new e(p),w]},O=function(e,r,t){return-1==e.s?Math.max(O(e.l,r,t+1),O(e.r,r,t+1)):r[e.s]=t},R=function(e){for(var t=e.length;t&&!e[--t];);for(var n=new r(++t),a=0,s=e[0],i=1,o=function(e){n[a++]=e},c=1;c<=t;++c)if(e[c]==s&&c!=t)++i;else{if(!s&&i>2){for(;i>138;i-=138)o(32754);i>2&&(o(i>10?i-11<<5|28690:i-3<<5|12305),i=0)}else if(i>3){for(o(s),--i;i>6;i-=6)o(8304);i>2&&(o(i-3<<5|8208),i=0)}for(;i--;)o(s);i=1,s=e[c]}return[n.subarray(0,a),t]},j=function(e,r){for(var t=0,n=0;n<r.length;++n)t+=e[n]*r[n];return t},B=function(e,r,t){var n=t.length,a=T(r+2);e[a]=255&n,e[a+1]=n>>>8,e[a+2]=255^e[a],e[a+3]=255^e[a+1];for(var s=0;s<n;++s)e[a+s+4]=t[s];return 8*(a+4+n)},z=function(e,t,i,o,c,u,f,l,v,h,d){P(t,d++,i),++c[256];for(var p=N(c,15),b=p[0],E=p[1],S=N(u,15),C=S[0],M=S[1],T=R(b),A=T[0],x=T[1],L=R(C),O=L[0],z=L[1],D=new r(19),U=0;U<A.length;++U)D[31&A[U]]++;for(U=0;U<O.length;++U)D[31&O[U]]++;for(var _=N(D,7),H=_[0],F=_[1],G=19;G>4&&!H[s[G-1]];--G);var Y,I,W,X,q=h+5<<3,J=j(c,g)+j(u,y)+f,Q=j(c,b)+j(u,C)+f+14+3*G+j(D,H)+(2*D[16]+3*D[17]+7*D[18]);if(q<=J&&q<=Q)return B(t,d,e.subarray(v,v+h));if(P(t,d,1+(Q<J)),d+=2,Q<J){Y=w(b,E,0),I=b,W=w(C,M,0),X=C;var V=w(H,F,0);for(P(t,d,x-257),P(t,d+5,z-1),P(t,d+10,G-4),d+=14,U=0;U<G;++U)P(t,d+3*U,H[s[U]]);d+=3*G;for(var Z=[A,O],$=0;$<2;++$){var ee=Z[$];for(U=0;U<ee.length;++U){var re=31&ee[U];P(t,d,V[re]),d+=H[re],re>15&&(P(t,d,ee[U]>>>5&127),d+=ee[U]>>>12)}}}else Y=m,I=g,W=k,X=y;for(U=0;U<l;++U)if(o[U]>255){re=o[U]>>>18&31,K(t,d,Y[re+257]),d+=I[re+257],re>7&&(P(t,d,o[U]>>>23&31),d+=n[re]);var te=31&o[U];K(t,d,W[te]),d+=X[te],te>3&&(K(t,d,o[U]>>>5&8191),d+=a[te])}else K(t,d,Y[o[U]]),d+=I[o[U]];return K(t,d,Y[256]),d+I[256]},D=new t([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),U=new e(0);var _="undefined"!=typeof TextEncoder&&new TextEncoder,H="undefined"!=typeof TextDecoder&&new TextDecoder;try{H.decode(U,{stream:!0})}catch(e){}function F(e){return new Promise(((r,t)=>{e.oncomplete=e.onsuccess=()=>r(e.result),e.onabort=e.onerror=()=>t(e.error)}))}let G;function Y(){return G||(G=(function(e,r){const t=indexedDB.open("keyval-store");t.onupgradeneeded=()=>t.result.createObjectStore(r);const n=F(t);return(e,t)=>n.then((n=>t(n.transaction(r,e).objectStore(r))))})(0,"keyval")),G}function I(e,r=Y()){return r("readonly",(r=>F(r.get(e))))}function W(e,r,t=Y()){return t("readwrite",(t=>(t.put(r,e),F(t.transaction))))}function X(e,r=Y()){return r("readwrite",(r=>(r.delete(e),F(r.transaction))))}function q(e=Y()){return e("readonly",(e=>{if(e.getAllKeys)return F(e.getAllKeys());const r=[];return(function(e,t){return e.openCursor().onsuccess=function(){var e;this.result&&(e=this.result,r.push(e.key),this.result.continue())},F(e.transaction)})(e).then((()=>r))}))}const J=Symbol("Comlink.proxy"),Q=Symbol("Comlink.endpoint"),V=Symbol("Comlink.releaseProxy"),Z=Symbol("Comlink.thrown"),$=e=>"object"==typeof e&&null!==e||"function"==typeof e,ee=new Map([["proxy",{canHandle:e=>$(e)&&e[J],serialize(e){const{port1:r,port2:t}=new MessageChannel;return re(e,r),[t,[t]]},deserialize:e=>(e.start(),ae(e,[],undefined))}],["throw",{canHandle:e=>$(e)&&Z in e,serialize({value:e}){let r;return r=e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[r,[]]},deserialize(e){if(e.isError)throw Object.assign(new Error(e.value.message),e.value);throw e.value}}]]);function re(e,r=self){r.addEventListener("message",(function t(n){if(!n||!n.data)return;const{id:a,type:s,path:i}=Object.assign({path:[]},n.data),o=(n.data.argumentList||[]).map(ce);let c;try{const r=i.slice(0,-1).reduce(((e,r)=>e[r]),e),t=i.reduce(((e,r)=>e[r]),e);switch(s){case"GET":c=t;break;case"SET":r[i.slice(-1)[0]]=ce(n.data.value),c=!0;break;case"APPLY":c=t.apply(r,o);break;case"CONSTRUCT":c=(function(e){return Object.assign(e,{[J]:!0})})(new t(...o));break;case"ENDPOINT":{const{port1:r,port2:t}=new MessageChannel;re(e,t),c=(function(e,r){return ie.set(e,r),e})(r,[r])}break;case"RELEASE":c=void 0;break;default:return}}catch(e){c={value:e,[Z]:0}}Promise.resolve(c).catch((e=>({value:e,[Z]:0}))).then((e=>{const[n,i]=oe(e);r.postMessage(Object.assign(Object.assign({},n),{id:a}),i),"RELEASE"===s&&(r.removeEventListener("message",t),te(r))}))})),r.start&&r.start()}function te(e){(function(e){return"MessagePort"===e.constructor.name})(e)&&e.close()}function ne(e){if(e)throw new Error("Proxy has been released and is not useable")}function ae(e,r=[],t=function(){}){let n=!1;const a=new Proxy(t,{get(t,s){if(ne(n),s===V)return()=>ue(e,{type:"RELEASE",path:r.map((e=>e.toString()))}).then((()=>{te(e),n=!0}));if("then"===s){if(0===r.length)return{then:()=>a};const t=ue(e,{type:"GET",path:r.map((e=>e.toString()))}).then(ce);return t.then.bind(t)}return ae(e,[...r,s])},set(t,a,s){ne(n);const[i,o]=oe(s);return ue(e,{type:"SET",path:[...r,a].map((e=>e.toString())),value:i},o).then(ce)},apply(t,a,s){ne(n);const i=r[r.length-1];if(i===Q)return ue(e,{type:"ENDPOINT"}).then(ce);if("bind"===i)return ae(e,r.slice(0,-1));const[o,c]=se(s);return ue(e,{type:"APPLY",path:r.map((e=>e.toString())),argumentList:o},c).then(ce)},construct(t,a){ne(n);const[s,i]=se(a);return ue(e,{type:"CONSTRUCT",path:r.map((e=>e.toString())),argumentList:s},i).then(ce)}});return a}function se(e){const r=e.map(oe);return[r.map((e=>e[0])),(t=r.map((e=>e[1])),Array.prototype.concat.apply([],t))];var t}const ie=new WeakMap;function oe(e){for(const[r,t]of ee)if(t.canHandle(e)){const[n,a]=t.serialize(e);return[{type:"HANDLER",name:r,value:n},a]}return[{type:"RAW",value:e},ie.get(e)||[]]}function ce(e){switch(e.type){case"HANDLER":return ee.get(e.name).deserialize(e.value);case"RAW":return e.value}}function ue(e,r,t){return new Promise((n=>{const a=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");e.addEventListener("message",(function r(t){t.data&&t.data.id&&t.data.id===a&&(e.removeEventListener("message",r),n(t.data))})),e.start&&e.start(),e.postMessage(Object.assign({id:a},r),t)}))}class fe{static async compress(s){try{const i=(function(r,t){var n;if(_)return _.encode(r);var a=r.length,s=new e(r.length+(r.length>>1)),i=0,o=function(e){s[i++]=e};for(n=0;n<a;++n){if(i+5>s.length){var c=new e(i+8+(a-n<<1));c.set(s),s=c}var u=r.charCodeAt(n);u<128?o(u):u<2048?(o(192|u>>6),o(128|63&u)):u>55295&&u<57344?(o(240|(u=65536+(1047552&u)|1023&r.charCodeAt(++n))>>18),o(128|u>>12&63),o(128|u>>6&63),o(128|63&u)):(o(224|u>>12),o(128|u>>6&63),o(128|63&u))}return A(s,0,i)})(s);return(function(s,i){return f=0,l=0,(function(s,i,o,c,f,l){var h=s.length,d=new e(c+h+5*(1+Math.ceil(h/7e3))+f),p=d.subarray(c,d.length-f),w=0;if(!i||h<8)for(var g=0;g<=h;g+=65535){var y=g+65535;y>=h&&(p[w>>3]=l),w=B(p,w+1,s.subarray(g,y))}else{for(var m=D[i-1],b=m>>>13,k=8191&m,E=(1<<o)-1,S=new r(32768),C=new r(E+1),M=Math.ceil(o/3),x=2*M,L=function(e){return(s[e]^s[e+1]<<M^s[e+2]<<x)&E},P=new t(25e3),K=new r(288),N=new r(32),O=0,R=0,j=(g=0,0),_=0,H=0;g<h;++g){var F=L(g),G=32767&g,Y=C[F];if(S[G]=Y,C[F]=G,_<=g){var I=h-g;if((O>7e3||j>24576)&&I>423){w=z(s,p,0,P,K,N,R,j,H,g-H,w),j=O=R=0,H=g;for(var W=0;W<286;++W)K[W]=0;for(W=0;W<30;++W)N[W]=0}var X=2,q=0,J=k,Q=G-Y&32767;if(I>2&&F==L(g-Q))for(var V=Math.min(b,I)-1,Z=Math.min(32767,g),$=Math.min(258,I);Q<=Z&&--J&&G!=Y;){if(s[g+X]==s[g+X-Q]){for(var ee=0;ee<$&&s[g+ee]==s[g+ee-Q];++ee);if(ee>X){if(X=ee,q=Q,ee>V)break;var re=Math.min(Q,ee-2),te=0;for(W=0;W<re;++W){var ne=g-Q+W+32768&32767,ae=ne-S[ne]+32768&32767;ae>te&&(te=ae,Y=ne)}}}Q+=(G=Y)-(Y=S[G])+32768&32767}if(q){P[j++]=268435456|u[X]<<18|v[q];var se=31&u[X],ie=31&v[q];R+=n[se]+a[ie],++K[257+se],++N[ie],_=g+X,++O}else P[j++]=s[g],++K[s[g]]}}w=z(s,p,l,P,K,N,R,j,H,g-H,w),!l&&7&w&&(w=B(p,w+1,U))}return A(d,0,c+T(w)+f)})(o=s,null==(c={level:1}||{}).level?6:c.level,null==c.mem?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(o.length)))):12+c.mem,f,l,!h);var o,c,f,l,h})(i)}catch(e){return null}}static async decompress(r){try{return(function(e,r){if(r){for(var t="",n=0;n<e.length;n+=16384)t+=String.fromCharCode.apply(null,e.subarray(n,n+16384));return t}if(H)return H.decode(e);var a=(function(e){for(var r="",t=0;;){var n=e[t++],a=(n>127)+(n>223)+(n>239);if(t+a>e.length)return[r,A(e,t-1)];a?3==a?(n=((15&n)<<18|(63&e[t++])<<12|(63&e[t++])<<6|63&e[t++])-65536,r+=String.fromCharCode(55296|n>>10,56320|1023&n)):r+=1&a?String.fromCharCode((31&n)<<6|63&e[t++]):String.fromCharCode((15&n)<<12|(63&e[t++])<<6|63&e[t++]):r+=String.fromCharCode(n)}})(e),s=a[0];return a[1].length&&L(8),s})((function(r,t){return(function(r,t,i){var o=r.length;if(!o||i&&i.f&&!i.l)return t||new e(0);var u=!t||i,f=!i||i.i;i||(i={}),t||(t=new e(3*o));var v=function(r){var n=t.length;if(r>n){var a=new e(Math.max(2*n,r));a.set(t),t=a}},h=i.f||0,d=i.p||0,p=i.b||0,g=i.l,y=i.d,m=i.m,k=i.n,x=8*o;do{if(!g){h=C(r,d,1);var P=C(r,d+1,3);if(d+=3,!P){var K=r[(F=T(d)+4)-4]|r[F-3]<<8,N=F+K;if(N>o){f&&L(0);break}u&&v(p+K),t.set(r.subarray(F,N),p),i.b=p+=K,i.p=d=8*N,i.f=h;continue}if(1==P)g=b,y=E,m=9,k=5;else if(2==P){var O=C(r,d,31)+257,R=C(r,d+10,15)+4,j=O+C(r,d+5,31)+1;d+=14;for(var B=new e(j),z=new e(19),D=0;D<R;++D)z[s[D]]=C(r,d+3*D,7);d+=3*R;var U=S(z),_=(1<<U)-1,H=w(z,U,1);for(D=0;D<j;){var F,G=H[C(r,d,_)];if(d+=15&G,(F=G>>>4)<16)B[D++]=F;else{var Y=0,I=0;for(16==F?(I=3+C(r,d,3),d+=2,Y=B[D-1]):17==F?(I=3+C(r,d,7),d+=3):18==F&&(I=11+C(r,d,127),d+=7);I--;)B[D++]=Y}}var W=B.subarray(0,O),X=B.subarray(O);m=S(W),k=S(X),g=w(W,m,1),y=w(X,k,1)}else L(1);if(d>x){f&&L(0);break}}u&&v(p+131072);for(var q=(1<<m)-1,J=(1<<k)-1,Q=d;;Q=d){var V=(Y=g[M(r,d)&q])>>>4;if((d+=15&Y)>x){f&&L(0);break}if(Y||L(2),V<256)t[p++]=V;else{if(256==V){Q=d,g=null;break}var Z=V-254;if(V>264){var $=n[D=V-257];Z=C(r,d,(1<<$)-1)+c[D],d+=$}var ee=y[M(r,d)&J],re=ee>>>4;if(ee||L(3),d+=15&ee,X=l[re],re>3&&($=a[re],X+=M(r,d)&(1<<$)-1,d+=$),d>x){f&&L(0);break}u&&v(p+131072);for(var te=p+Z;p<te;p+=4)t[p]=t[p-X],t[p+1]=t[p+1-X],t[p+2]=t[p+2-X],t[p+3]=t[p+3-X];p=te}}i.l=g,i.p=Q,i.b=p,i.f=h,g&&(h=1,i.m=m,i.d=y,i.n=k)}while(!h);return p==t.length?t:A(t,0,p)})(r,t)})(r))}catch(e){return null}}static storageKey(e,r){return e<0?r+" Config":0===e?r+" Global":r+" File"+e}static async save(e,r,t){const n=this.storageKey(e,t),a=await this.compress(r);return await W(n,a).then(this.successCallback).catch(this.failureCallback)}static async load(e,r){const t=this.storageKey(e,r),n=await I(t).catch(this.failureCallback),a=await this.decompress(n);if(a)return a;if(e>0){const t=await this.loadBackup(e,r);return await this.restoreBackup(e,r),t}return!1}static async deleteSave(e,r){const t=this.storageKey(e,r);return await X(t).then(this.successCallback).catch(this.failureCallback)}static async saveExists(e,r){const t=this.storageKey(e,r);return await q().then((function(e){return e.includes(t)}))}static async restoreBackup(e,r){const t=this.storageKey(e,r)+"bak",n=await this.loadBackup(e,r);return await this.save(e,n,r),await X(t).then(this.successCallback).catch(this.failureCallback)}static async backupSave(e,r){const t=this.storageKey(e,r),n=t+"bak",a=await I(t).catch(this.failureCallback);return!!a&&await W(n,a).then(this.successCallback).catch(this.failureCallback)}static async loadBackup(e,r){const t=this.storageKey(e,r)+"bak",n=await I(t);return await this.decompress(n)}}re(class{static async compress(e){return{result:await fe.compress(e)}}static async decompress(e){return{result:await fe.decompress(e)}}static async makeSave(e){return{success:await fe.save(e.id,e.data,e.webKey)}}static async loadSave(e){return{result:await fe.load(e.id,e.webKey)}}static async backupSave(e){return{success:await fe.backupSave(e.id,e.webKey)}}static async checkSaveExists(e){return{result:await fe.saveExists(e.id,e.webKey)}}})})();
