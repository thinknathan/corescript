// @license https://github.com/thinknathan/corescript/blob/master/LICENSE
"use strict"
function ProgressWatcher(){throw new Error("This is a static class")}function JsExtensions(){throw new Error("This is not a class")}function Utils(){throw new Error("This is a static class")}function CacheEntry(cache,key,item){this.cache=cache,this.key=key,this.item=item,this.cached=!1,this.touchTicks=0,this.touchSeconds=0,this.ttlTicks=0,this.ttlSeconds=0,this.freedByTTL=!1}function CacheMap(manager){this.manager=manager,this._inner={},this._lastRemovedEntries={},this.updateTicks=0,this.lastCheckTTL=0,this.delayCheckTTL=100,this.updateSeconds=Date.now()}function ImageCache(){this.initialize.apply(this,arguments)}function RequestQueue(){this.initialize.apply(this,arguments)}function Point(){this.initialize.apply(this,arguments)}function Rectangle(){this.initialize.apply(this,arguments)}function Bitmap(){this.initialize.apply(this,arguments)}function BitmapPIXI(){this.initialize.apply(this,arguments)}function Graphics(){throw new Error("This is a static class")}function Input(){throw new Error("This is a static class")}function TouchInput(){throw new Error("This is a static class")}function Sprite(){this.initialize.apply(this,arguments)}function Tilemap(){this.initialize.apply(this,arguments)}function ShaderTilemap(){Tilemap.apply(this,arguments),this.roundPixels=!0}function TilingSprite(){this.initialize.apply(this,arguments)}function ScreenSprite(){this.initialize.apply(this,arguments)}function WindowSkinCache(){throw new Error("This is a static class")}function Window(){this.initialize.apply(this,arguments)}function WindowLayer(){this.initialize.apply(this,arguments)}function Weather(){this.initialize.apply(this,arguments)}function ToneFilter(){PIXI.filters.ColorMatrixFilter.call(this)}function ToneSprite(){this.initialize.apply(this,arguments)}function Stage(){this.initialize.apply(this,arguments)}function WebAudio(){this.initialize.apply(this,arguments)}function JsonEx(){throw new Error("This is a static class")}function Decrypter(){throw new Error("This is a static class")}function ResourceHandler(){throw new Error("This is a static class")}ProgressWatcher.initialize=function(){this.clearProgress(),ImageManager.setCreationHook(this._bitmapListener.bind(this)),AudioManager.setCreationHook(this._audioListener.bind(this))},ProgressWatcher._bitmapListener=function(bitmap){this._countLoading++,bitmap.addLoadListener(function(){this._countLoaded++,this._progressListener&&this._progressListener(this._countLoaded,this._countLoading)}.bind(this))},ProgressWatcher._audioListener=function(audio){this._countLoading++,audio.addLoadListener(function(){this._countLoaded++,this._progressListener&&this._progressListener(this._countLoaded,this._countLoading)}.bind(this))},ProgressWatcher.setProgressListener=function(progressListener){this._progressListener=progressListener},ProgressWatcher.clearProgress=function(){this._countLoading=0,this._countLoaded=0},ProgressWatcher.truncateProgress=function(){this._countLoaded&&(this._countLoading-=this._countLoaded,this._countLoaded=0)},Number.prototype.clamp=function(min,max){return Math.min(Math.max(this,min),max)},Number.prototype.mod=function(n){return(this%n+n)%n},String.prototype.format=function(){const args=arguments
return this.replace(/%([0-9]+)/g,(function(s,n){return args[Number(n)-1]}))},String.prototype.padZero=function(length){let s=this
for(;s.length<length;)s="0"+s
return s},Number.prototype.padZero=function(length){return String(this).padZero(length)},Object.defineProperties(Array.prototype,{equals:{enumerable:!1,value(array){if(!array||this.length!==array.length)return!1
for(let i=0;i<this.length;i++)if(this[i]instanceof Array&&array[i]instanceof Array){if(!this[i].equals(array[i]))return!1}else if(this[i]!==array[i])return!1
return!0}},clone:{enumerable:!1,value(){return this.slice(0)}},contains:{enumerable:!1,value(element){return this.indexOf(element)>=0}}}),String.prototype.contains=function(string){return this.indexOf(string)>=0},Math.randomInt=function(max){return Math.floor(max*Math.random())},Utils.RPGMAKER_NAME="MV",Utils.RPGMAKER_VERSION="1.6.1",Utils.RPGMAKER_ENGINE="community-1.4",Utils.isOptionValid=function(name){return!!location.search.slice(1).split("&").contains(name)||!!("undefined"!=typeof nw&&nw.App.argv.length>0&&nw.App.argv[0].split("&").contains(name))},Utils._nwjs=null,Utils.isNwjs=function(){if("boolean"==typeof Utils._nwjs)return Utils._nwjs
const result="function"==typeof require&&"object"==typeof process
return Utils._nwjs=result,result},Utils._highFps=!1,Utils.isHighFps=function(){return Utils._fpsChecked?Utils._highFps:Utils.getFps()>=66},Utils._fps=60,Utils._fpsIsBusyCounting=!1,Utils._fpsChecked=!1,
/**
 * Returns estimated monitor refresh rate.
 *
 * @static
 * @method getFps
 * @return {Number} Refresh rate
 * @credit Adapted from Adam Sassano on Stack Overflow
 * @license CC BY-SA 4.0
 */
Utils.getFps=function(){if(Utils._fpsChecked||Utils._fpsIsBusyCounting)return Utils._fps
{let previousTimestamp=0,count=0,rate=0
const rafLoop=timestamp=>{if(count<=180){let interval
count++,rate+=1e3/(timestamp-previousTimestamp),previousTimestamp=timestamp,requestAnimationFrame(rafLoop)}else Infinity!==Utils._fps&&(Utils._fps=rate/count,Utils._fps>=66&&(Utils._highFps=!0)),Utils._fpsChecked=!0,Utils._fpsIsBusyCounting=!1}
return requestAnimationFrame((timestamp=>{previousTimestamp=timestamp,requestAnimationFrame(rafLoop)})),Utils._fpsIsBusyCounting=!0,Utils._fps}},Utils._mobileDevice=null,Utils.isMobileDevice=function(){if("boolean"==typeof Utils._mobileDevice)return Utils._mobileDevice
const r=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i,result=!!navigator.userAgent.match(r)
return Utils._mobileDevice=result,result},Utils._mobileSafari=null,Utils.isMobileSafari=function(){if("boolean"==typeof Utils._mobileSafari)return Utils._mobileSafari
const agent=navigator.userAgent,result=!(!agent.match(/iPhone|iPad|iPod/)||!agent.match(/AppleWebKit/)||agent.match("CriOS"))
return Utils._mobileSafari=result,result},Utils._androidChrome=null,Utils.isAndroidChrome=function(){if("boolean"==typeof Utils._androidChrome)return Utils._androidChrome
const agent=navigator.userAgent,result=!(!agent.match(/Android/)||!agent.match(/Chrome/))
return Utils._androidChrome=result,result},Utils.canReadGameFiles=function(){const scripts=document.getElementsByTagName("script"),lastScript=scripts[scripts.length-1],xhr=new XMLHttpRequest
try{return xhr.open("GET",lastScript.src),xhr.overrideMimeType("text/javascript"),xhr.send(),!0}catch(e){return!1}},Utils.rgbToCssColor=function(r,g,b){return"rgb("+(r=Math.round(r))+","+(g=Math.round(g))+","+(b=Math.round(b))+")"},Utils._id=1,Utils.generateRuntimeId=function(){return Utils._id++},Utils._supportPassiveEvent=null,Utils.isSupportPassiveEvent=function(){if("boolean"==typeof Utils._supportPassiveEvent)return Utils._supportPassiveEvent
let passive=!1
const options=Object.defineProperty({},"passive",{get(){passive=!0}})
return window.addEventListener("test",null,options),Utils._supportPassiveEvent=passive,passive},CacheEntry.prototype.free=function(byTTL){this.freedByTTL=byTTL||!1,this.cached&&(this.cached=!1,delete this.cache._inner[this.key])},CacheEntry.prototype.allocate=function(){return this.cached||(this.cache._inner[this.key]=this,this.cached=!0),this.touch(),this},CacheEntry.prototype.setTimeToLive=function(ticks,seconds){return this.ttlTicks=ticks||0,this.ttlSeconds=seconds||0,this},CacheEntry.prototype.isStillAlive=function(){const cache=this.cache
return(0==this.ttlTicks||this.touchTicks+this.ttlTicks<cache.updateTicks)&&(0==this.ttlSeconds||this.touchSeconds+this.ttlSeconds<cache.updateSeconds)},CacheEntry.prototype.touch=function(){const cache=this.cache
this.cached?(this.touchTicks=cache.updateTicks,this.touchSeconds=cache.updateSeconds):this.freedByTTL&&(this.freedByTTL=!1,cache._inner[this.key]||(cache._inner[this.key]=this))},CacheMap.prototype.checkTTL=function(){const cache=this._inner
let temp=this._lastRemovedEntries
temp||(temp=[],this._lastRemovedEntries=temp)
for(let key in cache){const entry=cache[key]
entry.isStillAlive()||temp.push(entry)}for(let i=0;i<temp.length;i++)temp[i].free(!0)
temp.length=0},CacheMap.prototype.getItem=function(key){const entry=this._inner[key]
return entry?entry.item:null},CacheMap.prototype.clear=function(){const keys=Object.keys(this._inner)
for(let i=0;i<keys.length;i++)this._inner[keys[i]].free()},CacheMap.prototype.setItem=function(key,item){return new CacheEntry(this,key,item).allocate()},CacheMap.prototype.update=function(ticks,delta){this.updateTicks+=ticks,this.updateSeconds+=delta,this.updateSeconds>=this.delayCheckTTL+this.lastCheckTTL&&(this.lastCheckTTL=this.updateSeconds,this.checkTTL())},ImageCache.limit=1e7,ImageCache.prototype.initialize=function(){this._items={}},ImageCache.prototype.add=function(key,value){this._items[key]={bitmap:value,touch:Date.now(),key},this._truncateCache()},ImageCache.prototype.get=function(key){if(this._items[key]){const item=this._items[key]
return item.touch=Date.now(),item.bitmap}return null},ImageCache.prototype.reserve=function(key,value,reservationId){this._items[key]||(this._items[key]={bitmap:value,touch:Date.now(),key}),this._items[key].reservationId=reservationId},ImageCache.prototype.releaseReservation=function(reservationId){const items=this._items
Object.keys(items).map((function(key){return items[key]})).forEach((function(item){item.reservationId===reservationId&&delete item.reservationId}))},ImageCache.prototype._truncateCache=function(){const items=this._items
let sizeLeft=ImageCache.limit
Object.keys(items).map((function(key){return items[key]})).sort((function(a,b){return b.touch-a.touch})).forEach(function(item){if(sizeLeft>0||this._mustBeHeld(item)){const bitmap=item.bitmap
sizeLeft-=bitmap.width*bitmap.height}else delete items[item.key]}.bind(this))},ImageCache.prototype._mustBeHeld=function(item){return!(item.bitmap.isRequestOnly()||!item.reservationId&&item.bitmap.isReady())},ImageCache.prototype.isReady=function(){const items=this._items
return!Object.keys(items).some((function(key){return!items[key].bitmap.isRequestOnly()&&!items[key].bitmap.isReady()}))},ImageCache.prototype.getErrorBitmap=function(){const items=this._items
let bitmap=null
return Object.keys(items).some((function(key){return!!items[key].bitmap.isError()&&(bitmap=items[key].bitmap,!0)}))?bitmap:null},RequestQueue.prototype.initialize=function(){this._queue=[]},RequestQueue.prototype.enqueue=function(key,value){this._queue.push({key,value})},RequestQueue.prototype.update=function(){if(0===this._queue.length)return
const top=this._queue[0]
top.value.isRequestReady()?(this._queue.shift(),0!==this._queue.length&&this._queue[0].value.startRequest()):top.value.startRequest()},RequestQueue.prototype.raisePriority=function(key){for(let n=0;n<this._queue.length;n++){const item=this._queue[n]
if(item.key===key){this._queue.splice(n,1),this._queue.unshift(item)
break}}},RequestQueue.prototype.clear=function(){this._queue.splice(0)},Point.prototype=Object.create(PIXI.Point.prototype),Point.prototype.constructor=Point,Point.prototype.initialize=function(x,y){PIXI.Point.call(this,x,y)},Rectangle.prototype=Object.create(PIXI.Rectangle.prototype),Rectangle.prototype.constructor=Rectangle,Rectangle.prototype.initialize=function(x,y,width,height){PIXI.Rectangle.call(this,x,y,width,height)},Rectangle.emptyRectangle=new Rectangle(0,0,0,0),Bitmap._reuseImages=[],Bitmap.prototype._createCanvas=function(width,height){if(this.__canvas=this.__canvas||document.createElement("canvas"),this.__context=this.__canvas.getContext("2d"),this.__canvas.width=Math.max(width||0,1),this.__canvas.height=Math.max(height||0,1),this._image){const w=Math.max(this._image.width||0,1),h=Math.max(this._image.height||0,1)
this.__canvas.width=w,this.__canvas.height=h,this._createBaseTexture(this._canvas),this.__context.drawImage(this._image,0,0)}this._setDirty()},Bitmap.prototype._createBaseTexture=function(source){this.__baseTexture=new PIXI.BaseTexture(source),this.__baseTexture.mipmap=!1,this.__baseTexture.width=source.width,this.__baseTexture.height=source.height,this._baseTexture.scaleMode=PIXI.SCALE_MODES.NEAREST},Bitmap.prototype._clearImgInstance=function(){this._image.src="",this._image.onload=null,this._image.onerror=null,this._errorListener=null,this._loadListener=null,Bitmap._reuseImages.push(this._image),this._image=null},Object.defineProperties(Bitmap.prototype,{_canvas:{get(){return this.__canvas||this._createCanvas(),this.__canvas}},_context:{get(){return this.__context||this._createCanvas(),this.__context}},_baseTexture:{get(){return this.__baseTexture||this._createBaseTexture(this._image||this.__canvas),this.__baseTexture}}}),Bitmap.prototype._renewCanvas=function(){const newImage=this._image
newImage&&this.__canvas&&(this.__canvas.width<newImage.width||this.__canvas.height<newImage.height)&&this._createCanvas()},Bitmap.prototype.initialize=function(width,height){this._defer||this._createCanvas(width,height),this._image=null,this._url="",this._paintOpacity=255,this._smooth=!1,this._loadListeners=[],this._loadingState="none",this._decodeAfterRequest=!1,this.cacheEntry=null,this.fontFace="GameFont",this.fontSize=28,this.fontItalic=!1,this.textColor="#ffffff",this.outlineColor="rgba(0, 0, 0, 0.5)",this.outlineWidth=4},Bitmap.load=function(url){const bitmap=Object.create(Bitmap.prototype)
return bitmap._defer=!0,bitmap.initialize(),bitmap._decodeAfterRequest=!0,bitmap._requestImage(url),bitmap},Bitmap.snap=function(stage){const width=Graphics.width,height=Graphics.height,bitmap=new Bitmap(width,height),context=bitmap._context,renderTexture=PIXI.RenderTexture.create({width,height})
if(stage){Graphics._renderer.render(stage,{renderTexture}),stage.worldTransform.identity()
let canvas=null
canvas=Graphics.isWebGL()?Graphics._renderer.plugins.extract.canvas(renderTexture):renderTexture.baseTexture._canvasRenderTarget.canvas,context.drawImage(canvas,0,0)}return renderTexture.destroy({destroyBase:!0}),bitmap._setDirty(),bitmap},Bitmap.prototype.isReady=function(){return"loaded"===this._loadingState||"none"===this._loadingState},Bitmap.prototype.isError=function(){return"error"===this._loadingState},Bitmap.prototype.touch=function(){this.cacheEntry&&this.cacheEntry.touch()},Object.defineProperty(Bitmap.prototype,"url",{get(){return this._url},configurable:!0}),Object.defineProperty(Bitmap.prototype,"baseTexture",{get(){return this._baseTexture},configurable:!0}),Object.defineProperty(Bitmap.prototype,"canvas",{get(){return this._canvas},configurable:!0}),Object.defineProperty(Bitmap.prototype,"context",{get(){return this._context},configurable:!0}),Object.defineProperty(Bitmap.prototype,"width",{get(){return this.isReady()?this._image?this._image.width:this._canvas.width:0},configurable:!0}),Object.defineProperty(Bitmap.prototype,"height",{get(){return this.isReady()?this._image?this._image.height:this._canvas.height:0},configurable:!0}),Object.defineProperty(Bitmap.prototype,"rect",{get(){return new Rectangle(0,0,this.width,this.height)},configurable:!0}),Object.defineProperty(Bitmap.prototype,"smooth",{get(){return this._smooth},set(value){!1!==this._smooth&&(this._smooth=!1)},configurable:!0}),Object.defineProperty(Bitmap.prototype,"paintOpacity",{get(){return this._paintOpacity},set(value){this._paintOpacity!==value&&(this._paintOpacity=value,this._context.globalAlpha=this._paintOpacity/255)},configurable:!0}),Bitmap.prototype.resize=function(width,height){width=Math.max(width||0,1),height=Math.max(height||0,1),this._canvas.width=width,this._canvas.height=height,this._baseTexture.width=width,this._baseTexture.height=height},Bitmap.prototype.blt=function(source,sx,sy,sw,sh,dx,dy,dw,dh){dw=dw||sw,dh=dh||sh,sx=Math.floor(sx),sy=Math.floor(sy),sw=Math.floor(sw),sh=Math.floor(sh),dx=Math.floor(dx),dy=Math.floor(dy),dw=Math.floor(dw),dh=Math.floor(dh),sx>=0&&sy>=0&&sw>0&&sh>0&&dw>0&&dh>0&&sx+sw<=source.width&&sy+sh<=source.height&&(this._context.globalCompositeOperation="source-over",this._context.drawImage(source._canvas,sx,sy,sw,sh,dx,dy,dw,dh),this._setDirty())},Bitmap.prototype.bltImage=function(source,sx,sy,sw,sh,dx,dy,dw,dh){dw=dw||sw,dh=dh||sh,sx>=0&&sy>=0&&sw>0&&sh>0&&dw>0&&dh>0&&sx+sw<=source.width&&sy+sh<=source.height&&(this._context.globalCompositeOperation="source-over",this._context.drawImage(source._image,sx,sy,sw,sh,dx,dy,dw,dh),this._setDirty())},Bitmap.prototype.getPixel=function(x,y){const data=this._context.getImageData(x,y,1,1).data
let result="#"
for(let i=0;i<3;i++)result+=data[i].toString(16).padZero(2)
return result},Bitmap.prototype.getAlphaPixel=function(x,y){const data=void 0
return this._context.getImageData(x,y,1,1).data[3]},Bitmap.prototype.clearRect=function(x,y,width,height){this._context.clearRect(x,y,width,height),this._setDirty()},Bitmap.prototype.clear=function(){this.clearRect(0,0,this.width,this.height)},Bitmap.prototype.fillRect=function(x,y,width,height,color){x=Math.floor(x),y=Math.floor(y),width=Math.floor(width),height=Math.floor(height)
const context=this._context
context.save(),context.fillStyle=color,context.fillRect(x,y,width,height),context.restore(),this._setDirty()},Bitmap.prototype.fillAll=function(color){this.fillRect(0,0,this.width,this.height,color)},Bitmap.prototype.gradientFillRect=function(x,y,width,height,color1,color2,vertical){const context=this._context
let grad
grad=vertical?context.createLinearGradient(x,y,x,y+height):context.createLinearGradient(x,y,x+width,y),grad.addColorStop(0,color1),grad.addColorStop(1,color2),context.save(),context.fillStyle=grad,context.fillRect(x,y,width,height),context.restore(),this._setDirty()},Bitmap.prototype.drawCircle=function(x,y,radius,color){x=Math.floor(x),y=Math.floor(y)
const context=this._context
context.save(),context.fillStyle=color,context.beginPath(),context.arc(x,y,radius,0,2*Math.PI,!1),context.fill(),context.restore(),this._setDirty()},Bitmap.prototype.drawText=function(text,x,y,maxWidth,lineHeight,align){if(void 0!==text){x=Math.floor(x),y=Math.floor(y),maxWidth=Math.floor(maxWidth)||4294967295
let tx=x
const ty=y+(lineHeight=Math.floor(lineHeight))-Math.round((lineHeight-.7*this.fontSize)/2),context=this._context,alpha=context.globalAlpha
"center"===align&&(tx+=maxWidth/2),"right"===align&&(tx+=maxWidth),context.save(),context.font=this._makeFontNameText(),context.textAlign=align,context.textBaseline="alphabetic",context.globalAlpha=1,this._drawTextOutline(text,tx,ty,maxWidth),context.globalAlpha=alpha,this._drawTextBody(text,tx,ty,maxWidth),context.restore(),this._setDirty()}},Bitmap.prototype.drawSmallText=function(text,x,y,maxWidth,lineHeight,align){},Bitmap.prototype.measureTextWidth=function(text){const context=this._context
context.save(),context.font=this._makeFontNameText()
const width=context.measureText(text).width
return context.restore(),width},Bitmap.prototype.adjustTone=function(r,g,b){if((r||g||b)&&this.width>0&&this.height>0){const context=this._context,imageData=context.getImageData(0,0,this.width,this.height),pixels=imageData.data
for(let i=0;i<pixels.length;i+=4)pixels[i+0]+=r,pixels[i+1]+=g,pixels[i+2]+=b
context.putImageData(imageData,0,0),this._setDirty()}},Bitmap.prototype.rotateHue=function(offset){if(offset&&offset&&this.width>0&&this.height>0){offset=(offset%360+360)%360
const context=this._context,imageData=context.getImageData(0,0,this.width,this.height),pixels=imageData.data
for(let i=0;i<pixels.length;i+=4){const hsl=rgbToHsl(pixels[i+0],pixels[i+1],pixels[i+2]),h=void 0,s=void 0,l=void 0,rgb=hslToRgb((hsl[0]+offset)%360,hsl[1],hsl[2])
pixels[i+0]=rgb[0],pixels[i+1]=rgb[1],pixels[i+2]=rgb[2]}context.putImageData(imageData,0,0),this._setDirty()}function rgbToHsl(r,g,b){const cmin=Math.min(r,g,b),cmax=Math.max(r,g,b)
let h=0,s=0
const l=(cmin+cmax)/2,delta=cmax-cmin
return delta>0&&(h=r===cmax?((g-b)/delta+6)%6*60:g===cmax?60*((b-r)/delta+2):60*((r-g)/delta+4),s=delta/(255-Math.abs(2*l-255))),[h,s,l]}function hslToRgb(h,s,l){const c=(255-Math.abs(2*l-255))*s,x=void 0,m=l-c/2,cm=c+m,xm=c*(1-Math.abs(h/60%2-1))+m
return h<60?[cm,xm,m]:h<120?[xm,cm,m]:h<180?[m,cm,xm]:h<240?[m,xm,cm]:h<300?[xm,m,cm]:[cm,m,xm]}},Bitmap.prototype.blur=function(){for(let i=0;i<2;i++){const w=this.width,h=this.height,canvas=this._canvas,context=this._context,tempCanvas=document.createElement("canvas"),tempContext=tempCanvas.getContext("2d")
tempCanvas.width=w+2,tempCanvas.height=h+2,tempContext.drawImage(canvas,0,0,w,h,1,1,w,h),tempContext.drawImage(canvas,0,0,w,1,1,0,w,1),tempContext.drawImage(canvas,0,0,1,h,0,1,1,h),tempContext.drawImage(canvas,0,h-1,w,1,1,h+1,w,1),tempContext.drawImage(canvas,w-1,0,1,h,w+1,1,1,h),context.save(),context.fillStyle="black",context.fillRect(0,0,w,h),context.globalCompositeOperation="lighter",context.globalAlpha=1/9
for(let y=0;y<3;y++)for(let x=0;x<3;x++)context.drawImage(tempCanvas,x,y,w,h,0,0,w,h)
context.restore()}this._setDirty()},Bitmap.prototype.addLoadListener=function(listner){this.isReady()?listner(this):this._loadListeners.push(listner)},Bitmap.prototype._makeFontNameText=function(){return(this.fontItalic?"Italic ":"")+this.fontSize+"px "+this.fontFace},Bitmap.prototype._drawTextOutline=function(text,tx,ty,maxWidth){const context=this._context
context.strokeStyle=this.outlineColor,context.lineWidth=this.outlineWidth,context.lineJoin="round",context.strokeText(text,tx,ty,maxWidth)},Bitmap.prototype._drawTextBody=function(text,tx,ty,maxWidth){const context=this._context
context.fillStyle=this.textColor,context.fillText(text,tx,ty,maxWidth)},Bitmap.prototype._onLoad=function(){switch(this._image.removeEventListener("load",this._loadListener),this._image.removeEventListener("error",this._errorListener),this._renewCanvas(),this._loadingState){case"requesting":this._loadingState="requestCompleted",this._decodeAfterRequest?this.decode():(this._loadingState="purged",this._clearImgInstance())
break
case"decrypting":window.URL.revokeObjectURL(this._image.src),this._loadingState="decryptCompleted",this._decodeAfterRequest?this.decode():(this._loadingState="purged",this._clearImgInstance())}},Bitmap.prototype.decode=function(){switch(this._loadingState){case"requestCompleted":case"decryptCompleted":this._loadingState="loaded",this.__canvas||this._createBaseTexture(this._image),this._setDirty(),this._callLoadListeners()
break
case"requesting":case"decrypting":this._decodeAfterRequest=!0,this._loader||(this._loader=ResourceHandler.createLoader(this._url,this._requestImage.bind(this,this._url),this._onError.bind(this)),this._image.removeEventListener("error",this._errorListener),this._image.addEventListener("error",this._errorListener=this._loader))
break
case"pending":case"purged":case"error":this._decodeAfterRequest=!0,this._requestImage(this._url)}},Bitmap.prototype._callLoadListeners=function(){for(;this._loadListeners.length>0;){const listener=void 0
this._loadListeners.shift()(this)}},Bitmap.prototype._onError=function(){this._image.removeEventListener("load",this._loadListener),this._image.removeEventListener("error",this._errorListener),this._loadingState="error"},Bitmap.prototype._setDirty=function(){this._dirty=!0},Bitmap.prototype.checkDirty=function(){if(this._dirty){this._baseTexture.update()
const baseTexture=this._baseTexture
setTimeout((function(){baseTexture.update()}),0),this._dirty=!1}},Bitmap.request=function(url){const bitmap=Object.create(Bitmap.prototype)
return bitmap._defer=!0,bitmap.initialize(),bitmap._url=url,bitmap._loadingState="pending",bitmap},Bitmap.prototype._requestImage=function(url){0!==Bitmap._reuseImages.length?this._image=Bitmap._reuseImages.pop():this._image=new Image,this._decodeAfterRequest&&!this._loader&&(this._loader=ResourceHandler.createLoader(url,this._requestImage.bind(this,url),this._onError.bind(this))),this._url=url,this._loadingState="requesting",!Decrypter.checkImgIgnore(url)&&Decrypter.hasEncryptedImages?(this._loadingState="decrypting",Decrypter.decryptImg(url,this)):(this._image.src=url,this._image.addEventListener("load",this._loadListener=Bitmap.prototype._onLoad.bind(this)),this._image.addEventListener("error",this._errorListener=this._loader||Bitmap.prototype._onError.bind(this)))},Bitmap.prototype.isRequestOnly=function(){return!(this._decodeAfterRequest||this.isReady())},Bitmap.prototype.isRequestReady=function(){return"pending"!==this._loadingState&&"requesting"!==this._loadingState&&"decrypting"!==this._loadingState},Bitmap.prototype.startRequest=function(){"pending"===this._loadingState&&(this._decodeAfterRequest=!1,this._requestImage(this._url))},BitmapPIXI.prototype=Object.create(PIXI.Container.prototype),BitmapPIXI.prototype.constructor=BitmapPIXI,BitmapPIXI.prototype.initialize=function(width,height){PIXI.Container.call(this),width=Math.max(width||0,1),height=Math.max(height||0,1),this._width=width,this._height=height,this._paintOpacity=255,this.textPadding=2,this.wordWrap=!1,this.wordWrapWidth=0,this.fontFace="GameFont",this.fontSize=28,this.fontItalic=!1,this.textColor="#ffffff",this.outlineColor="rgba(0, 0, 0, 0.5)",this.outlineWidth=4,this.textCache=[],this.on("removed",this.onRemoveAsAChild)},BitmapPIXI.prototype.onRemoveAsAChild=function(){this.textCache=[]
for(let i=this.children.length-1;i>=0;i--)this.children[i].destroy({children:!0,texture:!0}),this.removeChild(this.children[i])},Object.defineProperty(BitmapPIXI.prototype,"paintOpacity",{get(){return this._paintOpacity},set(value){this._paintOpacity!==value&&(this._paintOpacity=value)},configurable:!0}),Object.defineProperty(BitmapPIXI.prototype,"width",{get(){return this._width},set(value){this._width!==value&&(this._width=value)},configurable:!0}),Object.defineProperty(BitmapPIXI.prototype,"height",{get(){return this._height},set(value){this._height!==value&&(this._height=value)},configurable:!0}),BitmapPIXI.prototype.resize=function(width,height){width=Math.max(width||0,1),height=Math.max(height||0,1),this._width=width,this._height=height},BitmapPIXI.prototype.clear=function(){for(let i=this.children.length-1;i>=0;i--)this.children[i].isBitmapText?this.children[i].text="":(this.children[i].destroy({children:!0,texture:!0}),this.removeChild(this.children[i]))},BitmapPIXI.prototype.clearRect=function(x,y,width,height){const self=this,toRemove=[]
this.children.forEach((function(child){child&&child.x>=x&&child.x<x+width&&child.y>=y&&child.y<y+height&&(child.isBitmapText?child.text="":toRemove.push(child))})),toRemove.forEach((function(child){child.destroy({children:!0,texture:!0}),self.removeChild(child)}))},BitmapPIXI.prototype.drawText=function(text,x,y,maxWidth,lineHeight,align){if(void 0===text)return
const alpha=this._paintOpacity/255
maxWidth=Math.floor(maxWidth)||4294967295,lineHeight=Math.floor(lineHeight),text=String(text),"center"===align?x+=maxWidth/2:"right"===align&&(x+=maxWidth),y=y+lineHeight-1.25*this.fontSize,x=Math.floor(x),y=Math.floor(y)
const updateExisting=void 0
this._updateExistingText(text,x,y,alpha)||this._drawNewText(text,x,y,alpha,maxWidth,lineHeight,align)},BitmapPIXI.prototype._updateExistingText=function(text,x,y,alpha){for(let i=0;i<this.textCache.length;i++){const bitmapTextInstance=this.textCache[i]
if(bitmapTextInstance.x===x&&bitmapTextInstance.y===y){const newTint=PIXI.utils.string2hex(this.textColor)
return bitmapTextInstance._tint!==newTint&&(bitmapTextInstance.tint=newTint),bitmapTextInstance.text!==text&&(bitmapTextInstance.text=text),bitmapTextInstance.alpha!==alpha&&(bitmapTextInstance.alpha=alpha),this.addChild(bitmapTextInstance),!0}}return!1},BitmapPIXI.prototype._drawNewText=function(text,x,y,alpha,maxWidth,lineHeight,align){const style={fontFamily:this.fontFace,fontSize:this.fontSize,fill:16777215,lineHeight,wordWrap:this.wordWrap,wordWrapWidth:this.wordWrapWidth,padding:this.textPadding,fontStyle:this.fontItalic?"italic":"normal",stroke:this.outlineColor,strokeThickness:this.outlineWidth}
PIXI.BitmapFont.available[style.fontFamily]||this._makeBitmapFont(style)
const pixiText=new PIXI.BitmapText(text,{fontName:style.fontFamily,fontSize:style.fontSize})
!style.wordWrap&&pixiText.width>maxWidth&&(pixiText.scale.x=maxWidth/pixiText.width),"center"===align?pixiText.anchor.set(.5,0):"right"===align&&pixiText.anchor.set(1,0),pixiText&&(pixiText.x=x,pixiText.y=y,pixiText.tint=PIXI.utils.string2hex(this.textColor),pixiText.alpha=alpha,pixiText.isBitmapText=!0,this.textCache.push(pixiText),this.addChild(pixiText))},BitmapPIXI.prototype._makeBitmapFont=function(style){const bitmapOptions={chars:[[" ","~"],"→","’"]}
PIXI.BitmapFont.from(style.fontFamily,style,bitmapOptions)},BitmapPIXI.prototype.measureTextWidth=function(text){text=String(text)
const style=new PIXI.TextStyle({fontFamily:this.fontFace,fontSize:this.fontSize,padding:this.textPadding}),textMetrics=void 0
return PIXI.TextMetrics.measureText(text,style).width},BitmapPIXI.prototype.create9Slice=function(source,x,y,w,h,tl,tr,br,bl){return new PIXI.NineSlicePlane(new PIXI.Texture(source,new PIXI.Rectangle(x,y,w,h)),tl,tr,br,bl)},BitmapPIXI.prototype.createTilingSprite=function(source,x,y,w,h,tileWidth,tileHeight){return new PIXI.TilingSprite(new PIXI.Texture(source,new PIXI.Rectangle(x,y,w,h)),tileWidth,tileHeight)},BitmapPIXI.prototype.createCroppedSprite=function(source,x,y,w,h){return new PIXI.Sprite(new PIXI.Texture(source,new PIXI.Rectangle(x,y,w,h)))},BitmapPIXI.prototype.blt=function(source,sx,sy,sw,sh,dx,dy,dw,dh){if(dw=dw||sw,dh=dh||sh,sx=Math.floor(sx),sy=Math.floor(sy),sw=Math.floor(sw),sh=Math.floor(sh),dx=Math.floor(dx),dy=Math.floor(dy),dw=Math.floor(dw),dh=Math.floor(dh),sx>=0&&sy>=0&&sw>0&&sh>0&&dw>0&&dh>0&&sx+sw<=source.width&&sy+sh<=source.height){const sprite=this.createCroppedSprite(source.baseTexture,sx,sy,sw,sh)
if(sprite)return sprite.x=dx,sprite.y=dy,sprite.width=dw,sprite.height=dh,sprite.alpha=this._paintOpacity/255,this.addChild(sprite),sprite}},BitmapPIXI.prototype.fillRect=function(x,y,width,height,color){x=Math.floor(x),y=Math.floor(y),width=Math.floor(width),height=Math.floor(height)
const rectangle=new PIXI.Graphics
return color=PIXI.utils.string2hex(color),rectangle.beginFill(color),rectangle.drawRect(0,0,width,height),rectangle.endFill(),rectangle&&(rectangle.x=x,rectangle.y=y,rectangle.alpha=this._paintOpacity/255,this.addChild(rectangle)),rectangle},BitmapPIXI.prototype.gradientFillRect=function(x,y,width,height,color1,color2,vertical){return this.fillRect(x,y,width,height,color1)},BitmapPIXI.prototype.drawCircle=function(x,y,radius,color){x=Math.floor(x),y=Math.floor(y)
const circle=new PIXI.Graphics
return color=PIXI.utils.string2hex(color),circle.beginFill(color),circle.drawCircle(0,0,radius),circle.endFill(),circle&&(circle.x=x,circle.y=y,circle.alpha=this._paintOpacity/255,this.addChild(circle)),circle},Graphics._cssFontLoading=document.fonts&&document.fonts.ready&&document.fonts.ready.then,Graphics._fontLoaded=null,Graphics._videoVolume=1,Graphics.initialize=function(width,height,type){this._width=width||800,this._height=height||600,this._rendererType=type||"auto",this._boxWidth=this._width,this._boxHeight=this._height,this._scale=1,this._realScale=1,this._errorShowed=!1,this._errorPrinter=null,this._canvas=null,this._video=null,this._videoUnlocked=!1,this._videoLoading=!1,this._upperCanvas=null,this._fpsMeter=null,this._modeBox=null,this._skipCount=0,this._maxSkip=3,this._rendered=!1,this._loadingImage=null,this._loadingCount=0,this._fpsMeterToggled=!1,this._stretchEnabled=this._defaultStretchMode(),this._canUseDifferenceBlend=!1,this._canUseSaturationBlend=!1,this._hiddenCanvas=null,this._app=null,this._testCanvasBlendModes(),this._modifyExistingElements(),this._updateRealScale(),this._createAllElements(),this._disableTextSelection(),this._disableContextMenu(),this._setupEventHandlers(),this._setupCssFontLoading(),this._setupProgress()},Graphics._setupCssFontLoading=function(){Graphics._cssFontLoading&&document.fonts.ready.then((function(fonts){Graphics._fontLoaded=fonts})).catch((function(error){SceneManager.onError(error)}))},Graphics.canUseCssFontLoading=function(){return!!this._cssFontLoading},Object.defineProperty(Graphics,"app",{get(){return this._app},configurable:!0}),Object.defineProperty(Graphics,"_renderer",{get(){return this._app.renderer},configurable:!0}),Graphics.frameCount=0,Graphics.BLEND_NORMAL=0,Graphics.BLEND_ADD=1,Graphics.BLEND_MULTIPLY=2,Graphics.BLEND_SCREEN=3,Graphics.tickStart=function(){},Graphics.tickEnd=function(){},Graphics.render=function(stage){stage&&(this._app.stage=stage)},Graphics.isWebGL=function(){return this._renderer&&this._renderer.type===PIXI.RENDERER_TYPE.WEBGL},Graphics._canWebGL=null,Graphics.hasWebGL=function(){if("boolean"==typeof Graphics._canWebGL)return Graphics._canWebGL
try{const canvas=document.createElement("canvas"),result=!(!canvas.getContext("webgl")&&!canvas.getContext("experimental-webgl"))
return Graphics._canWebGL=result,result}catch(e){return Graphics._canWebGL=!1,!1}},Graphics.canUseDifferenceBlend=function(){return this._canUseDifferenceBlend},Graphics.canUseSaturationBlend=function(){return this._canUseSaturationBlend},Graphics.setLoadingImage=function(src){this._loadingImage=new Image,this._loadingImage.src=src},Graphics.setProgressEnabled=function(enable){this._progressEnabled=enable},Graphics.startLoading=function(){this._loadingCount=0,ProgressWatcher.truncateProgress(),ProgressWatcher.setProgressListener(this._updateProgressCount.bind(this)),this._progressTimeout=setTimeout((function(){Graphics._showProgress()}),1500)},Graphics._setupProgress=function(){this._progressElement=document.createElement("div"),this._progressElement.id="loading-progress",this._progressElement.width=600,this._progressElement.height=300,this._progressElement.style.visibility="hidden",this._barElement=document.createElement("div"),this._barElement.id="loading-bar",this._barElement.style.width="100%",this._barElement.style.height="10%",this._barElement.style.background="linear-gradient(to top, gray, lightgray)",this._barElement.style.border="5px solid white",this._barElement.style.borderRadius="15px",this._barElement.style.marginTop="40%",this._filledBarElement=document.createElement("div"),this._filledBarElement.id="loading-filled-bar",this._filledBarElement.style.width="0%",this._filledBarElement.style.height="100%",this._filledBarElement.style.background="linear-gradient(to top, lime, honeydew)",this._filledBarElement.style.borderRadius="10px",this._progressElement.appendChild(this._barElement),this._barElement.appendChild(this._filledBarElement),this._updateProgress(),document.body.appendChild(this._progressElement)},Graphics._showProgress=function(){this._progressEnabled&&(this._progressElement.value=0,this._progressElement.style.visibility="visible",this._progressElement.style.zIndex=98)},Graphics._hideProgress=function(){this._progressElement&&(this._progressElement.style.visibility="hidden"),clearTimeout(this._progressTimeout)},Graphics._updateProgressCount=function(countLoaded,countLoading){let progressValue
progressValue=0!==countLoading?countLoaded/countLoading*100:100,this._filledBarElement.style.width=progressValue+"%"},Graphics._updateProgress=function(){this._centerElement(this._progressElement)},Graphics.updateLoading=function(){this._loadingCount++,this._paintUpperCanvas(),this._upperCanvas.style.opacity=1,this._updateProgress()},Graphics.endLoading=function(){this._clearUpperCanvas(),this._upperCanvas.style.opacity=0,this._hideProgress()},Graphics.printLoadingError=function(url){if(this._errorPrinter&&!this._errorShowed){this._updateErrorPrinter(),this._errorPrinter.innerHTML=this._makeErrorHtml("Loading Error","Failed to load: "+url),this._errorPrinter.style.userSelect="text",this._errorPrinter.style.webkitUserSelect="text",this._errorPrinter.style.msUserSelect="text",this._errorPrinter.style.mozUserSelect="text",this._errorPrinter.oncontextmenu=null
const button=document.createElement("button")
button.innerHTML="Retry",button.style.fontSize="24px",button.style.color="#ffffff",button.style.backgroundColor="#000000",button.addEventListener("touchstart",(function(event){event.stopPropagation()})),button.addEventListener("click",(function(event){ResourceHandler.retry()})),this._errorPrinter.appendChild(button),this._loadingCount=-Infinity}},Graphics.eraseLoadingError=function(){this._errorPrinter&&!this._errorShowed&&(this._errorPrinter.innerHTML="",this._errorPrinter.style.userSelect="none",this._errorPrinter.style.webkitUserSelect="none",this._errorPrinter.style.msUserSelect="none",this._errorPrinter.style.mozUserSelect="none",this._errorPrinter.oncontextmenu=function(){return!1},this._loadingCount=0)},Graphics.printError=function(name,message){this._errorShowed=!0,this._hideProgress(),this.hideFps(),this._errorPrinter&&(this._updateErrorPrinter(),this._errorPrinter.innerHTML=this._makeErrorHtml(name,message),this._errorPrinter.style.userSelect="text",this._errorPrinter.style.webkitUserSelect="text",this._errorPrinter.style.msUserSelect="text",this._errorPrinter.style.mozUserSelect="text",this._errorPrinter.oncontextmenu=null,this._errorMessage&&this._makeErrorMessage()),this._applyCanvasFilter(),this._clearUpperCanvas()},Graphics.printErrorDetail=function(error){if(this._errorPrinter&&this._showErrorDetail){const eventInfo=this._formatEventInfo(error),eventCommandInfo=this._formatEventCommandInfo(error),info=eventCommandInfo?eventInfo+", "+eventCommandInfo:eventInfo,stack=this._formatStackTrace(error)
this._makeErrorDetail(info,stack)}},Graphics.setErrorMessage=function(message){this._errorMessage=message},Graphics.setShowErrorDetail=function(showErrorDetail){this._showErrorDetail=showErrorDetail},Graphics.showFps=function(){this._fpsMeter&&(this._fpsMeter.extensions.pixi||this._fpsMeter.enableExtension("pixi",[PIXI,this._app]),document.body.appendChild(this._fpsMeter.dom),this._fpsMeter.show(!0))},Graphics.hideFps=function(){this._fpsMeter&&(document.body.removeChild(this._fpsMeter.dom),this._fpsMeter.show(!1))},Graphics.loadFont=function(name,url){const style=document.createElement("style"),head=document.getElementsByTagName("head"),rule='@font-face { font-family: "'+name+'"; src: url("'+url+'"); }'
style.type="text/css",head.item(0).appendChild(style),style.sheet.insertRule(rule,0),this._createFontLoader(name)},Graphics.isFontLoaded=function(name){if(Graphics._cssFontLoading)return!!Graphics._fontLoaded&&Graphics._fontLoaded.check('10px "'+name+'"')
{this._hiddenCanvas||(this._hiddenCanvas=document.createElement("canvas"))
const context=this._hiddenCanvas.getContext("2d"),text="abcdefghijklmnopqrstuvwxyz"
let width1,width2
return context.font="40px "+name+", sans-serif",width1=context.measureText(text).width,context.font="40px sans-serif",width2=context.measureText(text).width,width1!==width2}},Graphics.playVideo=function(src){this._videoLoader=ResourceHandler.createLoader(null,this._playVideo.bind(this,src),this._onVideoError.bind(this)),this._playVideo(src)},Graphics._playVideo=function(src){this._video.src=src,this._video.onloadeddata=this._onVideoLoad.bind(this),this._video.onerror=this._videoLoader,this._video.onended=this._onVideoEnd.bind(this),this._video.load(),this._videoLoading=!0},Graphics.isVideoPlaying=function(){return this._videoLoading||this._isVideoVisible()},Graphics.canPlayVideoType=function(type){return this._video&&this._video.canPlayType(type)},Graphics.setVideoVolume=function(value){this._videoVolume=value,this._video&&(this._video.volume=this._videoVolume)},Graphics.pageToCanvasX=function(x){if(this._canvas){const left=this._canvas.offsetLeft
return Math.round((x-left)/this._realScale)}return 0},Graphics.pageToCanvasY=function(y){if(this._canvas){const top=this._canvas.offsetTop
return Math.round((y-top)/this._realScale)}return 0},Graphics.isInsideCanvas=function(x,y){return x>=0&&x<this._width&&y>=0&&y<this._height},Graphics.callGC=function(){Graphics.isWebGL()&&Graphics._renderer.textureGC.run()},Object.defineProperty(Graphics,"width",{get(){return this._width},set(value){this._width!==value&&(this._width=value,this._updateAllElements())},configurable:!0}),Object.defineProperty(Graphics,"height",{get(){return this._height},set(value){this._height!==value&&(this._height=value,this._updateAllElements())},configurable:!0}),Object.defineProperty(Graphics,"boxWidth",{get(){return this._boxWidth},set(value){this._boxWidth=value},configurable:!0}),Object.defineProperty(Graphics,"boxHeight",{get(){return this._boxHeight},set(value){this._boxHeight=value},configurable:!0}),Object.defineProperty(Graphics,"scale",{get(){return this._scale},set(value){this._scale!==value&&(this._scale=value,this._updateAllElements())},configurable:!0}),Graphics._createAllElements=function(){this._createErrorPrinter(),this._createCanvas(),this._createVideo(),this._createUpperCanvas(),this._createRenderer(),this._createPixiApp(),this._createFPSMeter(),this._createModeBox(),this._createGameFontLoader()},Graphics._updateAllElements=function(){this._updateRealScale(),this._updateErrorPrinter(),this._updateCanvas(),this._updateVideo(),this._updateUpperCanvas(),this._updateRenderer(),this._paintUpperCanvas(),this._updateProgress()},Graphics._updateRealScale=function(){if(this._stretchEnabled){let h=window.innerWidth/this._width,v=window.innerHeight/this._height
h>=1&&h-.01<=1&&(h=1),v>=1&&v-.01<=1&&(v=1),this._realScale=Math.min(h,v)}else this._realScale=this._scale},Graphics._makeErrorHtml=function(name,message){return'<font color="yellow"><b>'+name+'</b></font><br><font color="white">'+decodeURIComponent(message)+"</font><br>"},Graphics._defaultStretchMode=function(){return Utils.isNwjs()||Utils.isMobileDevice()},Graphics._testCanvasBlendModes=function(){let canvas,context,imageData1,imageData2
canvas=document.createElement("canvas"),canvas.width=1,canvas.height=1,context=canvas.getContext("2d"),context.globalCompositeOperation="source-over",context.fillStyle="white",context.fillRect(0,0,1,1),context.globalCompositeOperation="difference",context.fillStyle="white",context.fillRect(0,0,1,1),imageData1=context.getImageData(0,0,1,1),context.globalCompositeOperation="source-over",context.fillStyle="black",context.fillRect(0,0,1,1),context.globalCompositeOperation="saturation",context.fillStyle="white",context.fillRect(0,0,1,1),imageData2=context.getImageData(0,0,1,1),this._canUseDifferenceBlend=0===imageData1.data[0],this._canUseSaturationBlend=0===imageData2.data[0]},Graphics._modifyExistingElements=function(){const elements=document.getElementsByTagName("*")
for(let i=0;i<elements.length;i++)elements[i].style.zIndex>0&&(elements[i].style.zIndex=0)},Graphics._createErrorPrinter=function(){this._errorPrinter=document.createElement("p"),this._errorPrinter.id="ErrorPrinter",this._updateErrorPrinter(),document.body.appendChild(this._errorPrinter)},Graphics._updateErrorPrinter=function(){this._errorPrinter.width=.9*this._width,this._errorShowed&&this._showErrorDetail?this._errorPrinter.height=.9*this._height:this._errorShowed&&this._errorMessage?this._errorPrinter.height=100:this._errorPrinter.height=40,this._errorPrinter.style.textAlign="center",this._errorPrinter.style.textShadow="1px 1px 3px #000",this._errorPrinter.style.fontSize="20px",this._errorPrinter.style.zIndex=99,this._centerElement(this._errorPrinter)},Graphics._makeErrorMessage=function(){const mainMessage=document.createElement("div"),style=mainMessage.style
style.color="white",style.textAlign="left",style.fontSize="18px",mainMessage.innerHTML="<hr>"+this._errorMessage,this._errorPrinter.appendChild(mainMessage)},Graphics._makeErrorDetail=function(info,stack){const detail=document.createElement("div"),style=detail.style
style.color="white",style.textAlign="left",style.fontSize="18px",detail.innerHTML="<br><hr>"+info+"<br><br>"+stack,this._errorPrinter.appendChild(detail)},Graphics._formatEventInfo=function(error){switch(String(error.eventType)){case"map_event":return"MapID: %1, MapEventID: %2, page: %3, line: %4".format(error.mapId,error.mapEventId,error.page,error.line)
case"common_event":return"CommonEventID: %1, line: %2".format(error.commonEventId,error.line)
case"battle_event":return"TroopID: %1, page: %2, line: %3".format(error.troopId,error.page,error.line)
case"test_event":return"TestEvent, line: %1".format(error.line)
default:return"No information"}},Graphics._formatEventCommandInfo=function(error){switch(String(error.eventCommand)){case"plugin_command":return"◆Plugin Command: "+error.content
case"script":return"◆Script: "+error.content
case"control_variables":return"◆Control Variables: Script: "+error.content
case"conditional_branch_script":return"◆If: Script: "+error.content
case"set_route_script":return"◆Set Movement Route: ◇Script: "+error.content
case"auto_route_script":return"Autonomous Movement Custom Route: ◇Script: "+error.content
default:return""}},Graphics._formatStackTrace=function(error){return decodeURIComponent((error.stack||"").replace(/file:.*js\//g,"").replace(/http:.*js\//g,"").replace(/https:.*js\//g,"").replace(/chrome-extension:.*js\//g,"").replace(/\n/g,"<br>"))},Graphics._createCanvas=function(){this._canvas=document.createElement("canvas"),this._canvas.id="GameCanvas",this._updateCanvas(),document.body.appendChild(this._canvas)},Graphics._updateCanvas=function(){this._canvas.width=this._width,this._canvas.height=this._height,this._canvas.style.zIndex=1,this._centerElement(this._canvas)},Graphics._createVideo=function(){this._video=document.createElement("video"),this._video.id="GameVideo",this._video.style.opacity=0,this._video.setAttribute("playsinline",""),this._video.volume=this._videoVolume,this._updateVideo(),makeVideoPlayableInline(this._video),document.body.appendChild(this._video)},Graphics._updateVideo=function(){this._video.width=this._width,this._video.height=this._height,this._video.style.zIndex=2,this._centerElement(this._video)},Graphics._createUpperCanvas=function(){this._upperCanvas=document.createElement("canvas"),this._upperCanvas.id="UpperCanvas",this._updateUpperCanvas(),document.body.appendChild(this._upperCanvas)},Graphics._updateUpperCanvas=function(){this._upperCanvas.width=this._width,this._upperCanvas.height=this._height,this._upperCanvas.style.zIndex=3,this._centerElement(this._upperCanvas)},Graphics._clearUpperCanvas=function(){const context=void 0
this._upperCanvas.getContext("2d").clearRect(0,0,this._width,this._height)},Graphics._paintUpperCanvas=function(){if(this._clearUpperCanvas(),this._loadingImage&&this._loadingCount>=20){const context=this._upperCanvas.getContext("2d"),dx=(this._width-this._loadingImage.width)/2,dy=(this._height-this._loadingImage.height)/2,alpha=((this._loadingCount-20)/30).clamp(0,1)
context.save(),context.globalAlpha=alpha,context.drawImage(this._loadingImage,dx,dy),context.restore()}},Graphics._createRenderer=function(){},Graphics._updateRenderer=function(){this._app&&this._app.renderer.resize(this._width,this._height)},Graphics._createFPSMeter=function(){"function"==typeof GameStats&&(this._fpsMeter=new GameStats({autoPlace:!1}),this._fpsMeter.show(!1),this._fpsMeter.dom.style.zIndex=1)},Graphics._createModeBox=function(){const box=document.createElement("div")
box.id="modeTextBack",box.style.position="absolute",box.style.left="5px",box.style.top="5px",box.style.width="119px",box.style.height="58px",box.style.background="rgba(0,0,0,0.2)",box.style.zIndex=9,box.style.opacity=0
const text=document.createElement("div")
text.id="modeText",text.style.position="absolute",text.style.left="0px",text.style.top="41px",text.style.width="119px",text.style.fontSize="12px",text.style.fontFamily="monospace",text.style.color="white",text.style.textAlign="center",text.style.textShadow="1px 1px 0 rgba(0,0,0,0.5)",text.innerHTML=this.isWebGL()?"WebGL mode":"Canvas mode",document.body.appendChild(box),box.appendChild(text),this._modeBox=box},Graphics._createGameFontLoader=function(){this._createFontLoader("GameFont")},Graphics._createFontLoader=function(name){const div=document.createElement("div"),text=document.createTextNode(".")
div.style.fontFamily=name,div.style.fontSize="0px",div.style.color="transparent",div.style.position="absolute",div.style.margin="auto",div.style.top="0px",div.style.left="0px",div.style.width="1px",div.style.height="1px",div.appendChild(text),document.body.appendChild(div)},Graphics._centerElement=function(element){const width=element.width*this._realScale,height=element.height*this._realScale
element.style.position="absolute",element.style.margin="auto",element.style.top=0,element.style.left=0,element.style.right=0,element.style.bottom=0,element.style.width=width+"px",element.style.height=height+"px"},Graphics._disableTextSelection=function(){const body=document.body
body.style.userSelect="none",body.style.webkitUserSelect="none",body.style.msUserSelect="none",body.style.mozUserSelect="none"},Graphics._disableContextMenu=function(){const elements=document.body.getElementsByTagName("*"),oncontextmenu=function(){return!1}
for(let i=0;i<elements.length;i++)elements[i].oncontextmenu=oncontextmenu},Graphics._applyCanvasFilter=function(){this._canvas&&(this._canvas.style.opacity=.5,this._canvas.style.filter="blur(8px)",this._canvas.style.webkitFilter="blur(8px)")},Graphics._onVideoLoad=function(){this._video.play(),this._updateVisibility(!0),this._videoLoading=!1},Graphics._onVideoError=function(){this._updateVisibility(!1),this._videoLoading=!1},Graphics._onVideoEnd=function(){this._updateVisibility(!1)},Graphics._updateVisibility=function(videoVisible){this._video.style.opacity=videoVisible?1:0,this._canvas.style.opacity=videoVisible?0:1},Graphics._isVideoVisible=function(){return this._video.style.opacity>0},Graphics._setupEventHandlers=function(){window.addEventListener("resize",this._onWindowResize.bind(this)),document.addEventListener("keydown",this._onKeyDown.bind(this)),document.addEventListener("keydown",this._onTouchEnd.bind(this)),document.addEventListener("mousedown",this._onTouchEnd.bind(this)),document.addEventListener("touchend",this._onTouchEnd.bind(this))},Graphics._onWindowResize=function(){this._updateAllElements()},Graphics._onKeyDown=function(event){if(!event.ctrlKey&&!event.altKey)switch(event.keyCode){case 113:event.preventDefault(),this._switchFPSMeter()
break
case 114:event.preventDefault(),this._switchStretchMode()
break
case 115:event.preventDefault(),this._switchFullScreen()}},Graphics._onTouchEnd=function(event){this._videoUnlocked||(this._video.play(),this._videoUnlocked=!0),this._isVideoVisible()&&this._video.paused&&this._video.play()},Graphics._switchFPSMeter=function(){this._fpsMeter&&this._fpsMeterToggled?(this.hideFps(),this._fpsMeterToggled=!1):this._fpsMeter&&!this._fpsMeterToggled&&(this.showFps(),this._fpsMeterToggled=!0)},Graphics._switchStretchMode=function(){this._stretchEnabled=!this._stretchEnabled,this._updateAllElements()},Graphics._switchFullScreen=function(){this._isFullScreen()?this._cancelFullScreen():this._requestFullScreen()},Graphics._isFullScreen=function(){return document.fullscreenElement||document.mozFullScreen||document.webkitFullscreenElement||document.msFullscreenElement},Graphics._requestFullScreen=function(){const element=document.body
element.requestFullscreen?element.requestFullscreen():element.mozRequestFullScreen?element.mozRequestFullScreen():element.webkitRequestFullScreen?element.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT):element.msRequestFullscreen&&element.msRequestFullscreen()},Graphics._cancelFullScreen=function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()},Graphics._onTick=function(delta){this._fpsMeter&&this._fpsMeter.shown&&this._fpsMeter.begin(),this._app.stage&&this._app.render(),this._fpsMeter&&this._fpsMeter.shown&&this._fpsMeter.end()},Graphics._createPixiApp=function(){const options={view:this._canvas,width:this._width,height:this._height,resolution:window.devicePixelRatio,powerPreference:"high-performance",autoStart:!0}
try{this._app=new PIXI.Application(options),this._app.ticker.remove(this._app.render,this._app),this._app.ticker.add(this._onTick,this)}catch(e){this._app=null}},Input.initialize=function(){this.clear(),this._wrapNwjsAlert(),this._setupEventHandlers()},Input.keyRepeatWait=24,Input.keyRepeatInterval=6,Input.keyMapper={9:"tab",13:"ok",16:"shift",17:"control",18:"control",27:"escape",32:"ok",33:"pageup",34:"pagedown",37:"left",38:"up",39:"right",40:"down",45:"escape",81:"pageup",87:"pagedown",88:"escape",90:"ok",96:"escape",98:"down",100:"left",102:"right",104:"up",120:"debug"},Input.gamepadMapper={0:"ok",1:"cancel",2:"shift",3:"menu",4:"pageup",5:"pagedown",12:"up",13:"down",14:"left",15:"right"},Input.clear=function(){this._currentState={},this._previousState={},this._gamepadStates=[],this._latestButton=null,this._pressedTime=0,this._dir4=0,this._dir8=0,this._preferredAxis="",this._date=0},Input.update=function(){this._pollGamepads(),this._currentState[this._latestButton]?this._pressedTime++:this._latestButton=null
for(let name in this._currentState)this._currentState[name]&&!this._previousState[name]&&(this._latestButton=name,this._pressedTime=0,this._date=Date.now()),this._previousState[name]=this._currentState[name]
this._updateDirection()},Input.isPressed=function(keyName){return!(!this._isEscapeCompatible(keyName)||!this.isPressed("escape"))||!!this._currentState[keyName]},Input.isTriggered=function(keyName){return!(!this._isEscapeCompatible(keyName)||!this.isTriggered("escape"))||this._latestButton===keyName&&0===this._pressedTime},Input.isRepeated=function(keyName){return!(!this._isEscapeCompatible(keyName)||!this.isRepeated("escape"))||this._latestButton===keyName&&(0===this._pressedTime||this._pressedTime>=this.keyRepeatWait&&this._pressedTime%this.keyRepeatInterval==0)},Input.isLongPressed=function(keyName){return!(!this._isEscapeCompatible(keyName)||!this.isLongPressed("escape"))||this._latestButton===keyName&&this._pressedTime>=this.keyRepeatWait},Object.defineProperty(Input,"dir4",{get(){return this._dir4},configurable:!0}),Object.defineProperty(Input,"dir8",{get(){return this._dir8},configurable:!0}),Object.defineProperty(Input,"date",{get(){return this._date},configurable:!0}),Input._wrapNwjsAlert=function(){if(Utils.isNwjs()){const _alert=window.alert
window.alert=function(){const gui=require("nw.gui"),win=gui.Window.get()
_alert.apply(this,arguments),win.focus(),Input.clear()}}},Input._setupEventHandlers=function(){document.addEventListener("keydown",this._onKeyDown.bind(this)),document.addEventListener("keyup",this._onKeyUp.bind(this)),window.addEventListener("blur",this._onLostFocus.bind(this))},Input._onKeyDown=function(event){this._shouldPreventDefault(event.keyCode)&&event.preventDefault(),144===event.keyCode&&this.clear()
const buttonName=this.keyMapper[event.keyCode]
ResourceHandler.exists()&&"ok"===buttonName?ResourceHandler.retry():buttonName&&(this._currentState[buttonName]=!0)},Input._shouldPreventDefault=function(keyCode){switch(keyCode){case 8:case 33:case 34:case 37:case 38:case 39:case 40:return!0}return!1},Input._onKeyUp=function(event){const buttonName=this.keyMapper[event.keyCode]
buttonName&&(this._currentState[buttonName]=!1),0===event.keyCode&&this.clear()},Input._onLostFocus=function(){this.clear()},Input._pollGamepads=function(){if(navigator.getGamepads){const gamepads=navigator.getGamepads()
if(gamepads)for(let i=0;i<gamepads.length;i++){const gamepad=gamepads[i]
gamepad&&gamepad.connected&&this._updateGamepadState(gamepad)}}},Input._updateGamepadState=function(gamepad){const lastState=this._gamepadStates[gamepad.index]||[],newState=[],buttons=gamepad.buttons,axes=gamepad.axes,threshold=.5
newState[12]=!1,newState[13]=!1,newState[14]=!1,newState[15]=!1
for(let i=0;i<buttons.length;i++)newState[i]=buttons[i].pressed
axes[1]<-.5?newState[12]=!0:axes[1]>.5&&(newState[13]=!0),axes[0]<-.5?newState[14]=!0:axes[0]>.5&&(newState[15]=!0)
for(let j=0;j<newState.length;j++)if(newState[j]!==lastState[j]){const buttonName=this.gamepadMapper[j]
buttonName&&(this._currentState[buttonName]=newState[j])}this._gamepadStates[gamepad.index]=newState},Input._updateDirection=function(){let x=this._signX(),y=this._signY()
this._dir8=this._makeNumpadDirection(x,y),0!==x&&0!==y?"x"===this._preferredAxis?y=0:x=0:0!==x?this._preferredAxis="y":0!==y&&(this._preferredAxis="x"),this._dir4=this._makeNumpadDirection(x,y)},Input._signX=function(){let x=0
return this.isPressed("left")&&x--,this.isPressed("right")&&x++,x},Input._signY=function(){let y=0
return this.isPressed("up")&&y--,this.isPressed("down")&&y++,y},Input._makeNumpadDirection=function(x,y){return 0!==x||0!==y?5-3*y+x:0},Input._isEscapeCompatible=function(keyName){return"cancel"===keyName||"menu"===keyName},TouchInput.initialize=function(){this.clear(),this._setupEventHandlers()},TouchInput.keyRepeatWait=24,TouchInput.keyRepeatInterval=6,TouchInput.clear=function(){this._mousePressed=!1,this._screenPressed=!1,this._pressedTime=0,this._events={},this._events.triggered=!1,this._events.cancelled=!1,this._events.moved=!1,this._events.released=!1,this._events.wheelX=0,this._events.wheelY=0,this._triggered=!1,this._cancelled=!1,this._moved=!1,this._released=!1,this._wheelX=0,this._wheelY=0,this._x=0,this._y=0,this._date=0},TouchInput.update=function(){this._triggered=this._events.triggered,this._cancelled=this._events.cancelled,this._moved=this._events.moved,this._released=this._events.released,this._wheelX=this._events.wheelX,this._wheelY=this._events.wheelY,this._events.triggered=!1,this._events.cancelled=!1,this._events.moved=!1,this._events.released=!1,this._events.wheelX=0,this._events.wheelY=0,this.isPressed()&&this._pressedTime++},TouchInput.isPressed=function(){return this._mousePressed||this._screenPressed},TouchInput.isTriggered=function(){return this._triggered},TouchInput.isRepeated=function(){return this.isPressed()&&(this._triggered||this._pressedTime>=this.keyRepeatWait&&this._pressedTime%this.keyRepeatInterval==0)},TouchInput.isLongPressed=function(){return this.isPressed()&&this._pressedTime>=this.keyRepeatWait},TouchInput.isCancelled=function(){return this._cancelled},TouchInput.isMoved=function(){return this._moved},TouchInput.isReleased=function(){return this._released},Object.defineProperty(TouchInput,"wheelX",{get(){return this._wheelX},configurable:!0}),Object.defineProperty(TouchInput,"wheelY",{get(){return this._wheelY},configurable:!0}),Object.defineProperty(TouchInput,"x",{get(){return this._x},configurable:!0}),Object.defineProperty(TouchInput,"y",{get(){return this._y},configurable:!0}),Object.defineProperty(TouchInput,"date",{get(){return this._date},configurable:!0}),TouchInput._setupEventHandlers=function(){const isSupportPassive=Utils.isSupportPassiveEvent()
document.addEventListener("mousedown",this._onMouseDown.bind(this)),document.addEventListener("mousemove",this._onMouseMove.bind(this)),document.addEventListener("mouseup",this._onMouseUp.bind(this)),document.addEventListener("wheel",this._onWheel.bind(this),!!isSupportPassive&&{passive:!1}),document.addEventListener("touchstart",this._onTouchStart.bind(this),!!isSupportPassive&&{passive:!1}),document.addEventListener("touchmove",this._onTouchMove.bind(this),!!isSupportPassive&&{passive:!1}),document.addEventListener("touchend",this._onTouchEnd.bind(this)),document.addEventListener("touchcancel",this._onTouchCancel.bind(this)),document.addEventListener("pointerdown",this._onPointerDown.bind(this)),window.addEventListener("blur",this._onLostFocus.bind(this))},TouchInput._onMouseDown=function(event){0===event.button?this._onLeftButtonDown(event):1===event.button?this._onMiddleButtonDown(event):2===event.button&&this._onRightButtonDown(event)},TouchInput._onLeftButtonDown=function(event){const x=Graphics.pageToCanvasX(event.pageX),y=Graphics.pageToCanvasY(event.pageY)
Graphics.isInsideCanvas(x,y)&&(this._mousePressed=!0,this._pressedTime=0,this._onTrigger(x,y))},TouchInput._onMiddleButtonDown=function(event){},TouchInput._onRightButtonDown=function(event){const x=Graphics.pageToCanvasX(event.pageX),y=Graphics.pageToCanvasY(event.pageY)
Graphics.isInsideCanvas(x,y)&&this._onCancel(x,y)},TouchInput._onMouseMove=function(event){if(this._mousePressed){const x=Graphics.pageToCanvasX(event.pageX),y=Graphics.pageToCanvasY(event.pageY)
this._onMove(x,y)}},TouchInput._onMouseUp=function(event){if(0===event.button){const x=Graphics.pageToCanvasX(event.pageX),y=Graphics.pageToCanvasY(event.pageY)
this._mousePressed=!1,this._onRelease(x,y)}},TouchInput._onWheel=function(event){this._events.wheelX+=event.deltaX,this._events.wheelY+=event.deltaY,event.preventDefault()},TouchInput._onTouchStart=function(event){for(let i=0;i<event.changedTouches.length;i++){const touch=event.changedTouches[i],x=Graphics.pageToCanvasX(touch.pageX),y=Graphics.pageToCanvasY(touch.pageY)
Graphics.isInsideCanvas(x,y)&&(this._screenPressed=!0,this._pressedTime=0,event.touches.length>=2?this._onCancel(x,y):this._onTrigger(x,y),event.preventDefault())}(window.cordova||window.navigator.standalone)&&event.preventDefault()},TouchInput._onTouchMove=function(event){for(let i=0;i<event.changedTouches.length;i++){const touch=event.changedTouches[i],x=Graphics.pageToCanvasX(touch.pageX),y=Graphics.pageToCanvasY(touch.pageY)
this._onMove(x,y)}},TouchInput._onTouchEnd=function(event){for(let i=0;i<event.changedTouches.length;i++){const touch=event.changedTouches[i],x=Graphics.pageToCanvasX(touch.pageX),y=Graphics.pageToCanvasY(touch.pageY)
this._screenPressed=!1,this._onRelease(x,y)}},TouchInput._onTouchCancel=function(event){this._screenPressed=!1},TouchInput._onPointerDown=function(event){if("touch"===event.pointerType&&!event.isPrimary){const x=Graphics.pageToCanvasX(event.pageX),y=Graphics.pageToCanvasY(event.pageY)
Graphics.isInsideCanvas(x,y)&&(this._onCancel(x,y),event.preventDefault())}},TouchInput._onLostFocus=function(){this.clear()},TouchInput._onTrigger=function(x,y){this._events.triggered=!0,this._x=x,this._y=y,this._date=Date.now()},TouchInput._onCancel=function(x,y){this._events.cancelled=!0,this._x=x,this._y=y},TouchInput._onMove=function(x,y){this._events.moved=!0,this._x=x,this._y=y},TouchInput._onRelease=function(x,y){this._events.released=!0,this._x=x,this._y=y},Sprite.prototype=Object.create(PIXI.Sprite.prototype),Sprite.prototype.constructor=Sprite,Sprite.voidFilter=new PIXI.filters.AlphaFilter,Sprite.prototype.initialize=function(bitmap){const texture=new PIXI.Texture(new PIXI.BaseTexture)
PIXI.Sprite.call(this,texture),this.filters=null,this._bitmap=null,this._frame=new Rectangle,this._realFrame=new Rectangle,this._blendColor=[0,0,0,0],this._colorTone=[0,0,0,0],this._canvas=null,this._context=null,this._tintTexture=null,this._colorMatrixFilter=null,this.spriteId=Sprite._counter++,this.opaque=!1,this.bitmap=bitmap},Sprite._counter=0,Object.defineProperty(Sprite.prototype,"bitmap",{get(){return this._bitmap},set(value){this._bitmap!==value&&(this._bitmap=value,value?(this._refreshFrame=!0,value.addLoadListener(this._onBitmapLoad.bind(this))):(this._refreshFrame=!1,this.texture.frame=Rectangle.emptyRectangle))},configurable:!0}),Object.defineProperty(Sprite.prototype,"width",{get(){return this._frame.width},set(value){this._frame.width=value,this._refresh()},configurable:!0}),Object.defineProperty(Sprite.prototype,"height",{get(){return this._frame.height},set(value){this._frame.height=value,this._refresh()},configurable:!0}),Object.defineProperty(Sprite.prototype,"opacity",{get(){return 255*this.alpha},set(value){this.alpha=value.clamp(0,255)/255},configurable:!0}),Sprite.prototype.update=function(){this.children.forEach((function(child){child.update&&child.update()}))},Sprite.prototype.move=function(x,y){this.x=x,this.y=y},Sprite.prototype.setFrame=function(x,y,width,height){this._refreshFrame=!1
const frame=this._frame
x===frame.x&&y===frame.y&&width===frame.width&&height===frame.height||(frame.x=x,frame.y=y,frame.width=width,frame.height=height,this._refresh())},Sprite.prototype.getBlendColor=function(){return this._blendColor.clone()},Sprite.prototype.setBlendColor=function(color){if(!(color instanceof Array))throw new Error("Argument must be an array")
this._blendColor.equals(color)||(this._blendColor=color.clone(),this._refresh())},Sprite.prototype.getColorTone=function(){return this._colorTone.clone()},Sprite.prototype.setColorTone=function(tone){if(!(tone instanceof Array))throw new Error("Argument must be an array")
this._colorTone.equals(tone)||(this._colorTone=tone.clone(),this._refresh())},Sprite.prototype._onBitmapLoad=function(bitmapLoaded){bitmapLoaded===this._bitmap&&this._refreshFrame&&this._bitmap&&(this._refreshFrame=!1,this._frame.width=this._bitmap.width,this._frame.height=this._bitmap.height),this._refresh()},Sprite.prototype._refresh=function(){const frameX=Math.floor(this._frame.x),frameY=Math.floor(this._frame.y),frameW=Math.floor(this._frame.width),frameH=Math.floor(this._frame.height),bitmapW=this._bitmap?this._bitmap.width:0,bitmapH=this._bitmap?this._bitmap.height:0,realX=frameX.clamp(0,bitmapW),realY=frameY.clamp(0,bitmapH),realW=(frameW-realX+frameX).clamp(0,bitmapW-realX),realH=(frameH-realY+frameY).clamp(0,bitmapH-realY)
this._realFrame.x=realX,this._realFrame.y=realY,this._realFrame.width=realW,this._realFrame.height=realH,this.pivot.x=frameX-realX,this.pivot.y=frameY-realY,realW>0&&realH>0?this._needsTint()?Graphics.isWebGL()?(this._createTinterWebGL(),this._executeTintWebGL()):(this._createTinter(realW,realH),this._executeTint(realX,realY,realW,realH),this._tintTexture.update(),this.texture.baseTexture=this._tintTexture,this.texture.frame=new Rectangle(0,0,realW,realH)):(this._bitmap&&(this.texture.baseTexture=this._bitmap.baseTexture),this.texture.frame=this._realFrame,this._clearTintWebGL()):this._bitmap?this.texture.frame=Rectangle.emptyRectangle:(this.texture.baseTexture.width=Math.max(this.texture.baseTexture.width,this._frame.x+this._frame.width),this.texture.baseTexture.height=Math.max(this.texture.baseTexture.height,this._frame.y+this._frame.height),this.texture.frame=this._frame),this.texture._updateID++},Sprite.prototype._isInBitmapRect=function(x,y,w,h){return this._bitmap&&x+w>0&&y+h>0&&x<this._bitmap.width&&y<this._bitmap.height},Sprite.prototype._needsTint=function(){const tone=this._colorTone
return tone[0]||tone[1]||tone[2]||tone[3]||this._blendColor[3]>0},Sprite.prototype._createTinter=function(w,h){this._canvas||(this._canvas=document.createElement("canvas"),this._context=this._canvas.getContext("2d")),this._canvas.width=w,this._canvas.height=h,this._tintTexture||(this._tintTexture=new PIXI.BaseTexture(this._canvas)),this._tintTexture.width=w,this._tintTexture.height=h,this._tintTexture.scaleMode=this._bitmap.baseTexture.scaleMode},Sprite.prototype._executeTint=function(x,y,w,h){const context=this._context,tone=this._colorTone,color=this._blendColor
if(context.globalCompositeOperation="copy",context.drawImage(this._bitmap.canvas,x,y,w,h,0,0,w,h),tone[0]||tone[1]||tone[2]||tone[3]){if(Graphics.canUseSaturationBlend()){const gray=Math.max(0,tone[3])
context.globalCompositeOperation="saturation",context.fillStyle="rgba(255,255,255,"+gray/255+")",context.fillRect(0,0,w,h)}const r1=Math.max(0,tone[0]),g1=Math.max(0,tone[1]),b1=Math.max(0,tone[2])
if(context.globalCompositeOperation="lighter",context.fillStyle=Utils.rgbToCssColor(r1,g1,b1),context.fillRect(0,0,w,h),Graphics.canUseDifferenceBlend()){context.globalCompositeOperation="difference",context.fillStyle="white",context.fillRect(0,0,w,h)
const r2=Math.max(0,-tone[0]),g2=Math.max(0,-tone[1]),b2=Math.max(0,-tone[2])
context.globalCompositeOperation="lighter",context.fillStyle=Utils.rgbToCssColor(r2,g2,b2),context.fillRect(0,0,w,h),context.globalCompositeOperation="difference",context.fillStyle="white",context.fillRect(0,0,w,h)}}const r3=Math.max(0,color[0]),g3=Math.max(0,color[1]),b3=Math.max(0,color[2]),a3=Math.max(0,color[3])
context.globalCompositeOperation="source-atop",context.fillStyle=Utils.rgbToCssColor(r3,g3,b3),context.globalAlpha=a3/255,context.fillRect(0,0,w,h),context.globalCompositeOperation="destination-in",context.globalAlpha=1,context.drawImage(this._bitmap.canvas,x,y,w,h,0,0,w,h)},Sprite.prototype._createTinterWebGL=function(){this.filters||(this.filters=[]),this._colorMatrixFilter||(this._colorMatrixFilter=new PIXI.filters.ColorMatrixFilter,this.filters.push(this._colorMatrixFilter)),this._colorMatrixFilter.enabled=!0},Sprite.prototype._executeTintWebGL=function(){const color=this._blendColor,red=color[0]/255,green=color[1]/255,blue=color[2]/255,opacity=color[3]/255
this._colorMatrixFilter.matrix=[red/64,0,0,0,red,0,green/64,0,0,green,0,0,blue/64,0,blue,0,0,0,1,0],this._colorMatrixFilter.alpha=opacity},Sprite.prototype._clearTintWebGL=function(){this._colorMatrixFilter&&(this._colorMatrixFilter.enabled=!1)},Sprite.prototype._renderCanvas_PIXI=PIXI.Sprite.prototype._renderCanvas,Sprite.prototype._render_PIXI=PIXI.Sprite.prototype._render,Sprite.prototype._renderCanvas=function(renderer){this.bitmap&&this.bitmap.touch(),this.bitmap&&!this.bitmap.isReady()||this.texture.frame.width>0&&this.texture.frame.height>0&&this._renderCanvas_PIXI(renderer)},Sprite.prototype._render=function(renderer){this.bitmap&&this.bitmap.touch(),this.bitmap&&!this.bitmap.isReady()||this.texture.frame.width>0&&this.texture.frame.height>0&&(this._bitmap&&this._bitmap.checkDirty(),this._render_PIXI(renderer))},Tilemap.prototype=Object.create(PIXI.Container.prototype),Tilemap.prototype.constructor=Tilemap,Tilemap.prototype.initialize=function(){PIXI.Container.call(this),this._margin=20,this._width=Graphics.width+2*this._margin,this._height=Graphics.height+2*this._margin,this._tileWidth=48,this._tileHeight=48,this._mapWidth=0,this._mapHeight=0,this._mapData=null,this._layerWidth=0,this._layerHeight=0,this._lastTiles=[],this.bitmaps=[],this.origin=new Point,this.flags=[],this.animationCount=0,this.horizontalWrap=!1,this.verticalWrap=!1,this._createLayers(),this.refresh()},Object.defineProperty(Tilemap.prototype,"width",{get(){return this._width},set(value){this._width!==value&&(this._width=value,this._createLayers())}}),Object.defineProperty(Tilemap.prototype,"height",{get(){return this._height},set(value){this._height!==value&&(this._height=value,this._createLayers())}}),Object.defineProperty(Tilemap.prototype,"tileWidth",{get(){return this._tileWidth},set(value){this._tileWidth!==value&&(this._tileWidth=value,this._createLayers())}}),Object.defineProperty(Tilemap.prototype,"tileHeight",{get(){return this._tileHeight},set(value){this._tileHeight!==value&&(this._tileHeight=value,this._createLayers())}}),Tilemap.prototype.setData=function(width,height,data){this._mapWidth=width,this._mapHeight=height,this._mapData=data},Tilemap.prototype.isReady=function(){for(let i=0;i<this.bitmaps.length;i++)if(this.bitmaps[i]&&!this.bitmaps[i].isReady())return!1
return!0},Tilemap.prototype.update=function(){this.animationCount++,this.animationFrame=Math.floor(this.animationCount/30),this.children.forEach((function(child){child.update&&child.update()}))
for(let i=0;i<this.bitmaps.length;i++)this.bitmaps[i]&&this.bitmaps[i].touch()},Tilemap.prototype.refresh=function(){this._lastTiles.length=0},Tilemap.prototype.refreshTileset=function(){},Tilemap.prototype.updateTransform=function(){const ox=Math.floor(this.origin.x),oy=Math.floor(this.origin.y),startX=Math.floor((ox-this._margin)/this._tileWidth),startY=Math.floor((oy-this._margin)/this._tileHeight)
this._updateLayerPositions(startX,startY),(this._needsRepaint||this._lastAnimationFrame!==this.animationFrame||this._lastStartX!==startX||this._lastStartY!==startY)&&(this._frameUpdated=this._lastAnimationFrame!==this.animationFrame,this._lastAnimationFrame=this.animationFrame,this._lastStartX=startX,this._lastStartY=startY,this._paintAllTiles(startX,startY),this._needsRepaint=!1),this._sortChildren(),PIXI.Container.prototype.updateTransform.call(this)},Tilemap.prototype._createLayers=function(){const width=this._width,height=this._height,margin=this._margin,tileCols=Math.ceil(width/this._tileWidth)+1,tileRows=Math.ceil(height/this._tileHeight)+1,layerWidth=tileCols*this._tileWidth,layerHeight=tileRows*this._tileHeight
this._lowerBitmap=new Bitmap(layerWidth,layerHeight),this._upperBitmap=new Bitmap(layerWidth,layerHeight),this._layerWidth=layerWidth,this._layerHeight=layerHeight,this._lowerLayer=new Sprite,this._lowerLayer.move(-margin,-margin,width,height),this._lowerLayer.z=0,this._upperLayer=new Sprite,this._upperLayer.move(-margin,-margin,width,height),this._upperLayer.z=4
for(let i=0;i<4;i++)this._lowerLayer.addChild(new Sprite(this._lowerBitmap)),this._upperLayer.addChild(new Sprite(this._upperBitmap))
this.addChild(this._lowerLayer),this.addChild(this._upperLayer)},Tilemap.prototype._updateLayerPositions=function(startX,startY){const m=this._margin,ox=Math.floor(this.origin.x),oy=Math.floor(this.origin.y),x2=(ox-m).mod(this._layerWidth),y2=(oy-m).mod(this._layerHeight),w1=this._layerWidth-x2,h1=this._layerHeight-y2,w2=this._width-w1,h2=this._height-h1
for(let i=0;i<2;i++){let children
children=0===i?this._lowerLayer.children:this._upperLayer.children,children[0].move(0,0,w1,h1),children[0].setFrame(x2,y2,w1,h1),children[1].move(w1,0,w2,h1),children[1].setFrame(0,y2,w2,h1),children[2].move(0,h1,w1,h2),children[2].setFrame(x2,0,w1,h2),children[3].move(w1,h1,w2,h2),children[3].setFrame(0,0,w2,h2)}},Tilemap.prototype._paintAllTiles=function(startX,startY){const tileCols=Math.ceil(this._width/this._tileWidth)+1,tileRows=Math.ceil(this._height/this._tileHeight)+1
for(let y=0;y<tileRows;y++)for(let x=0;x<tileCols;x++)this._paintTiles(startX,startY,x,y)},Tilemap.prototype._paintTiles=function(startX,startY,x,y){const tableEdgeVirtualId=1e4,mx=startX+x,my=startY+y,dx=(mx*this._tileWidth).mod(this._layerWidth),dy=(my*this._tileHeight).mod(this._layerHeight),lx=dx/this._tileWidth,ly=dy/this._tileHeight,tileId0=this._readMapData(mx,my,0),tileId1=this._readMapData(mx,my,1),tileId2=this._readMapData(mx,my,2),tileId3=this._readMapData(mx,my,3),shadowBits=this._readMapData(mx,my,4),upperTileId1=this._readMapData(mx,my-1,1),lowerTiles=[],upperTiles=[]
this._isHigherTile(tileId0)?upperTiles.push(tileId0):lowerTiles.push(tileId0),this._isHigherTile(tileId1)?upperTiles.push(tileId1):lowerTiles.push(tileId1),lowerTiles.push(-shadowBits),this._isTableTile(upperTileId1)&&!this._isTableTile(tileId1)&&(Tilemap.isShadowingTile(tileId0)||lowerTiles.push(1e4+upperTileId1)),this._isOverpassPosition(mx,my)?(upperTiles.push(tileId2),upperTiles.push(tileId3)):(this._isHigherTile(tileId2)?upperTiles.push(tileId2):lowerTiles.push(tileId2),this._isHigherTile(tileId3)?upperTiles.push(tileId3):lowerTiles.push(tileId3))
const lastLowerTiles=this._readLastTiles(0,lx,ly)
if(!lowerTiles.equals(lastLowerTiles)||Tilemap.isTileA1(tileId0)&&this._frameUpdated){this._lowerBitmap.clearRect(dx,dy,this._tileWidth,this._tileHeight)
for(let i=0;i<lowerTiles.length;i++){const lowerTileId=lowerTiles[i]
lowerTileId<0?this._drawShadow(this._lowerBitmap,shadowBits,dx,dy):lowerTileId>=1e4?this._drawTableEdge(this._lowerBitmap,upperTileId1,dx,dy):this._drawTile(this._lowerBitmap,lowerTileId,dx,dy)}this._writeLastTiles(0,lx,ly,lowerTiles)}const lastUpperTiles=this._readLastTiles(1,lx,ly)
if(!upperTiles.equals(lastUpperTiles)){this._upperBitmap.clearRect(dx,dy,this._tileWidth,this._tileHeight)
for(let j=0;j<upperTiles.length;j++)this._drawTile(this._upperBitmap,upperTiles[j],dx,dy)
this._writeLastTiles(1,lx,ly,upperTiles)}},Tilemap.prototype._readLastTiles=function(i,x,y){const array1=this._lastTiles[i]
if(array1){const array2=array1[y]
if(array2){const tiles=array2[x]
if(tiles)return tiles}}return[]},Tilemap.prototype._writeLastTiles=function(i,x,y,tiles){let array1=this._lastTiles[i]
array1||(array1=this._lastTiles[i]=[])
let array2=array1[y]
array2||(array2=array1[y]=[]),array2[x]=tiles},Tilemap.prototype._drawTile=function(bitmap,tileId,dx,dy){Tilemap.isVisibleTile(tileId)&&(Tilemap.isAutotile(tileId)?this._drawAutotile(bitmap,tileId,dx,dy):this._drawNormalTile(bitmap,tileId,dx,dy))},Tilemap.prototype._drawNormalTile=function(bitmap,tileId,dx,dy){let setNumber=0
setNumber=Tilemap.isTileA5(tileId)?4:5+Math.floor(tileId/256)
const w=this._tileWidth,h=this._tileHeight,sx=(Math.floor(tileId/128)%2*8+tileId%8)*w,sy=Math.floor(tileId%256/8)%16*h,source=this.bitmaps[setNumber]
source&&bitmap.bltImage(source,sx,sy,w,h,dx,dy,w,h)},Tilemap.prototype._drawAutotile=function(bitmap,tileId,dx,dy){let autotileTable=Tilemap.FLOOR_AUTOTILE_TABLE
const kind=Tilemap.getAutotileKind(tileId),shape=Tilemap.getAutotileShape(tileId),tx=kind%8,ty=Math.floor(kind/8)
let bx=0,by=0,setNumber=0,isTable=!1
if(Tilemap.isTileA1(tileId)){const waterSurfaceIndex=[0,1,2,1][this.animationFrame%4]
setNumber=0,0===kind?(bx=2*waterSurfaceIndex,by=0):1===kind?(bx=2*waterSurfaceIndex,by=3):2===kind?(bx=6,by=0):3===kind?(bx=6,by=3):(bx=8*Math.floor(tx/4),by=6*ty+Math.floor(tx/2)%2*3,kind%2==0?bx+=2*waterSurfaceIndex:(bx+=6,autotileTable=Tilemap.WATERFALL_AUTOTILE_TABLE,by+=this.animationFrame%3))}else Tilemap.isTileA2(tileId)?(setNumber=1,bx=2*tx,by=3*(ty-2),isTable=this._isTableTile(tileId)):Tilemap.isTileA3(tileId)?(setNumber=2,bx=2*tx,by=2*(ty-6),autotileTable=Tilemap.WALL_AUTOTILE_TABLE):Tilemap.isTileA4(tileId)&&(setNumber=3,bx=2*tx,by=Math.floor(2.5*(ty-10)+(ty%2==1?.5:0)),ty%2==1&&(autotileTable=Tilemap.WALL_AUTOTILE_TABLE))
const table=autotileTable[shape],source=this.bitmaps[setNumber]
if(table&&source){const w1=this._tileWidth/2,h1=this._tileHeight/2
for(let i=0;i<4;i++){const qsx=table[i][0],qsy=table[i][1],sx1=(2*bx+qsx)*w1,sy1=(2*by+qsy)*h1,dx1=dx+i%2*w1
let dy1=dy+Math.floor(i/2)*h1
if(!isTable||1!==qsy&&5!==qsy)bitmap.bltImage(source,sx1,sy1,w1,h1,dx1,dy1,w1,h1)
else{let qsx2=qsx,qsy2
1===qsy&&(qsx2=[0,3,2,1][qsx])
const sx2=(2*bx+qsx2)*w1,sy2=(2*by+3)*h1
bitmap.bltImage(source,sx2,sy2,w1,h1,dx1,dy1,w1,h1),dy1+=h1/2,bitmap.bltImage(source,sx1,sy1,w1,h1/2,dx1,dy1,w1,h1/2)}}}},Tilemap.prototype._drawTableEdge=function(bitmap,tileId,dx,dy){if(Tilemap.isTileA2(tileId)){const autotileTable=Tilemap.FLOOR_AUTOTILE_TABLE,kind=Tilemap.getAutotileKind(tileId),shape=Tilemap.getAutotileShape(tileId),tx=void 0,ty=void 0,setNumber=1,bx=kind%8*2,by=3*(Math.floor(kind/8)-2),table=autotileTable[shape]
if(table){const source=this.bitmaps[setNumber],w1=this._tileWidth/2,h1=this._tileHeight/2
for(let i=0;i<2;i++){const qsx=void 0,qsy=void 0,sx1=(2*bx+table[2+i][0])*w1,sy1=(2*by+table[2+i][1])*h1+h1/2,dx1=dx+i%2*w1,dy1=dy+Math.floor(i/2)*h1
bitmap.bltImage(source,sx1,sy1,w1,h1/2,dx1,dy1,w1,h1/2)}}}},Tilemap.prototype._drawShadow=function(bitmap,shadowBits,dx,dy){if(15&shadowBits){const w1=this._tileWidth/2,h1=this._tileHeight/2,color="rgba(0,0,0,0.5)"
for(let i=0;i<4;i++)if(shadowBits&1<<i){const dx1=dx+i%2*w1,dy1=dy+Math.floor(i/2)*h1
bitmap.fillRect(dx1,dy1,w1,h1,color)}}},Tilemap.prototype._readMapData=function(x,y,z){if(this._mapData){const width=this._mapWidth,height=this._mapHeight
return this.horizontalWrap&&(x=x.mod(width)),this.verticalWrap&&(y=y.mod(height)),x>=0&&x<width&&y>=0&&y<height&&this._mapData[(z*height+y)*width+x]||0}return 0},Tilemap.prototype._isHigherTile=function(tileId){return 16&this.flags[tileId]},Tilemap.prototype._isTableTile=function(tileId){return Tilemap.isTileA2(tileId)&&128&this.flags[tileId]},Tilemap.prototype._isOverpassPosition=function(mx,my){return!1},Tilemap.prototype._sortChildren=function(){this.children.sort(this._compareChildOrder.bind(this))},Tilemap.prototype._compareChildOrder=function(a,b){return a.z===b.z?a.y===b.y?a.spriteId-b.spriteId:a.y-b.y:a.z-b.z},Tilemap.TILE_ID_B=0,Tilemap.TILE_ID_C=256,Tilemap.TILE_ID_D=512,Tilemap.TILE_ID_E=768,Tilemap.TILE_ID_A5=1536,Tilemap.TILE_ID_A1=2048,Tilemap.TILE_ID_A2=2816,Tilemap.TILE_ID_A3=4352,Tilemap.TILE_ID_A4=5888,Tilemap.TILE_ID_MAX=8192,Tilemap.isVisibleTile=function(tileId){return tileId>0&&tileId<this.TILE_ID_MAX},Tilemap.isAutotile=function(tileId){return tileId>=this.TILE_ID_A1},Tilemap.getAutotileKind=function(tileId){return Math.floor((tileId-this.TILE_ID_A1)/48)},Tilemap.getAutotileShape=function(tileId){return(tileId-this.TILE_ID_A1)%48},Tilemap.makeAutotileId=function(kind,shape){return this.TILE_ID_A1+48*kind+shape},Tilemap.isSameKindTile=function(tileID1,tileID2){return this.isAutotile(tileID1)&&this.isAutotile(tileID2)?this.getAutotileKind(tileID1)===this.getAutotileKind(tileID2):tileID1===tileID2},Tilemap.isTileA1=function(tileId){return tileId>=this.TILE_ID_A1&&tileId<this.TILE_ID_A2},Tilemap.isTileA2=function(tileId){return tileId>=this.TILE_ID_A2&&tileId<this.TILE_ID_A3},Tilemap.isTileA3=function(tileId){return tileId>=this.TILE_ID_A3&&tileId<this.TILE_ID_A4},Tilemap.isTileA4=function(tileId){return tileId>=this.TILE_ID_A4&&tileId<this.TILE_ID_MAX},Tilemap.isTileA5=function(tileId){return tileId>=this.TILE_ID_A5&&tileId<this.TILE_ID_A1},Tilemap.isWaterTile=function(tileId){return!(!this.isTileA1(tileId)||tileId>=this.TILE_ID_A1+96&&tileId<this.TILE_ID_A1+192)},Tilemap.isWaterfallTile=function(tileId){return tileId>=this.TILE_ID_A1+192&&tileId<this.TILE_ID_A2&&this.getAutotileKind(tileId)%2==1},Tilemap.isGroundTile=function(tileId){return this.isTileA1(tileId)||this.isTileA2(tileId)||this.isTileA5(tileId)},Tilemap.isShadowingTile=function(tileId){return this.isTileA3(tileId)||this.isTileA4(tileId)},Tilemap.isRoofTile=function(tileId){return this.isTileA3(tileId)&&this.getAutotileKind(tileId)%16<8},Tilemap.isWallTopTile=function(tileId){return this.isTileA4(tileId)&&this.getAutotileKind(tileId)%16<8},Tilemap.isWallSideTile=function(tileId){return(this.isTileA3(tileId)||this.isTileA4(tileId))&&this.getAutotileKind(tileId)%16>=8},Tilemap.isWallTile=function(tileId){return this.isWallTopTile(tileId)||this.isWallSideTile(tileId)},Tilemap.isFloorTypeAutotile=function(tileId){return this.isTileA1(tileId)&&!this.isWaterfallTile(tileId)||this.isTileA2(tileId)||this.isWallTopTile(tileId)},Tilemap.isWallTypeAutotile=function(tileId){return this.isRoofTile(tileId)||this.isWallSideTile(tileId)},Tilemap.isWaterfallTypeAutotile=function(tileId){return this.isWaterfallTile(tileId)},Tilemap.FLOOR_AUTOTILE_TABLE=[[[2,4],[1,4],[2,3],[1,3]],[[2,0],[1,4],[2,3],[1,3]],[[2,4],[3,0],[2,3],[1,3]],[[2,0],[3,0],[2,3],[1,3]],[[2,4],[1,4],[2,3],[3,1]],[[2,0],[1,4],[2,3],[3,1]],[[2,4],[3,0],[2,3],[3,1]],[[2,0],[3,0],[2,3],[3,1]],[[2,4],[1,4],[2,1],[1,3]],[[2,0],[1,4],[2,1],[1,3]],[[2,4],[3,0],[2,1],[1,3]],[[2,0],[3,0],[2,1],[1,3]],[[2,4],[1,4],[2,1],[3,1]],[[2,0],[1,4],[2,1],[3,1]],[[2,4],[3,0],[2,1],[3,1]],[[2,0],[3,0],[2,1],[3,1]],[[0,4],[1,4],[0,3],[1,3]],[[0,4],[3,0],[0,3],[1,3]],[[0,4],[1,4],[0,3],[3,1]],[[0,4],[3,0],[0,3],[3,1]],[[2,2],[1,2],[2,3],[1,3]],[[2,2],[1,2],[2,3],[3,1]],[[2,2],[1,2],[2,1],[1,3]],[[2,2],[1,2],[2,1],[3,1]],[[2,4],[3,4],[2,3],[3,3]],[[2,4],[3,4],[2,1],[3,3]],[[2,0],[3,4],[2,3],[3,3]],[[2,0],[3,4],[2,1],[3,3]],[[2,4],[1,4],[2,5],[1,5]],[[2,0],[1,4],[2,5],[1,5]],[[2,4],[3,0],[2,5],[1,5]],[[2,0],[3,0],[2,5],[1,5]],[[0,4],[3,4],[0,3],[3,3]],[[2,2],[1,2],[2,5],[1,5]],[[0,2],[1,2],[0,3],[1,3]],[[0,2],[1,2],[0,3],[3,1]],[[2,2],[3,2],[2,3],[3,3]],[[2,2],[3,2],[2,1],[3,3]],[[2,4],[3,4],[2,5],[3,5]],[[2,0],[3,4],[2,5],[3,5]],[[0,4],[1,4],[0,5],[1,5]],[[0,4],[3,0],[0,5],[1,5]],[[0,2],[3,2],[0,3],[3,3]],[[0,2],[1,2],[0,5],[1,5]],[[0,4],[3,4],[0,5],[3,5]],[[2,2],[3,2],[2,5],[3,5]],[[0,2],[3,2],[0,5],[3,5]],[[0,0],[1,0],[0,1],[1,1]]],Tilemap.WALL_AUTOTILE_TABLE=[[[2,2],[1,2],[2,1],[1,1]],[[0,2],[1,2],[0,1],[1,1]],[[2,0],[1,0],[2,1],[1,1]],[[0,0],[1,0],[0,1],[1,1]],[[2,2],[3,2],[2,1],[3,1]],[[0,2],[3,2],[0,1],[3,1]],[[2,0],[3,0],[2,1],[3,1]],[[0,0],[3,0],[0,1],[3,1]],[[2,2],[1,2],[2,3],[1,3]],[[0,2],[1,2],[0,3],[1,3]],[[2,0],[1,0],[2,3],[1,3]],[[0,0],[1,0],[0,3],[1,3]],[[2,2],[3,2],[2,3],[3,3]],[[0,2],[3,2],[0,3],[3,3]],[[2,0],[3,0],[2,3],[3,3]],[[0,0],[3,0],[0,3],[3,3]]],Tilemap.WATERFALL_AUTOTILE_TABLE=[[[2,0],[1,0],[2,1],[1,1]],[[0,0],[1,0],[0,1],[1,1]],[[2,0],[3,0],[2,1],[3,1]],[[0,0],[3,0],[0,1],[3,1]]],ShaderTilemap.prototype=Object.create(Tilemap.prototype),ShaderTilemap.prototype.constructor=ShaderTilemap,PIXI.tilemap.Constant.SCALE_MODE=PIXI.SCALE_MODES.NEAREST,PIXI.tilemap.Constant.DO_CLEAR=!0,PIXI.tilemap.Constant.boundCountPerBuffer=4,PIXI.tilemap.Constant.maxTextures=4,ShaderTilemap.prototype._hackRenderer=function(renderer){let af=this.animationFrame%4
return 3==af&&(af=1),renderer.plugins.tilemap.tileAnim[0]=af*this._tileWidth,renderer.plugins.tilemap.tileAnim[1]=this.animationFrame%3*this._tileHeight,renderer},ShaderTilemap.prototype.renderCanvas=function(renderer){this._hackRenderer(renderer),PIXI.Container.prototype.renderCanvas.call(this,renderer)},ShaderTilemap.prototype.render=function(renderer){this._hackRenderer(renderer),PIXI.Container.prototype.render.call(this,renderer)},ShaderTilemap.prototype.refresh=function(){this._lastBitmapLength!==this.bitmaps.length&&(this._lastBitmapLength=this.bitmaps.length,this.refreshTileset()),this._needsRepaint=!0},ShaderTilemap.prototype.refreshTileset=function(){const bitmaps=this.bitmaps.map((function(x){return x._baseTexture?new PIXI.Texture(x._baseTexture):x}))
this.lowerLayer.setBitmaps(bitmaps),this.upperLayer.setBitmaps(bitmaps)},ShaderTilemap.prototype.updateTransform=function(){const ox=Math.floor(this.origin.x),oy=Math.floor(this.origin.y),startX=Math.floor((ox-this._margin)/this._tileWidth),startY=Math.floor((oy-this._margin)/this._tileHeight)
this._updateLayerPositions(startX,startY),(this._needsRepaint||this._lastStartX!==startX||this._lastStartY!==startY)&&(this._lastStartX=startX,this._lastStartY=startY,this._paintAllTiles(startX,startY),this._needsRepaint=!1),this._sortChildren(),PIXI.Container.prototype.updateTransform.call(this)},ShaderTilemap.prototype._createLayers=function(){this._needsRepaint=!0,this.lowerZLayer||(this.addChild(this.lowerZLayer=new PIXI.tilemap.ZLayer(this,0)),this.addChild(this.upperZLayer=new PIXI.tilemap.ZLayer(this,4)),this.lowerZLayer.addChild(this.lowerLayer=new PIXI.tilemap.CompositeRectTileLayer(0,[])),this.lowerLayer.shadowColor=new Float32Array([0,0,0,.5]),this.upperZLayer.addChild(this.upperLayer=new PIXI.tilemap.CompositeRectTileLayer(4,[])))},ShaderTilemap.prototype._updateLayerPositions=function(startX,startY){const ox=Math.floor(this.origin.x),oy=Math.floor(this.origin.y)
this.lowerZLayer.position.x=startX*this._tileWidth-ox,this.lowerZLayer.position.y=startY*this._tileHeight-oy,this.upperZLayer.position.x=startX*this._tileWidth-ox,this.upperZLayer.position.y=startY*this._tileHeight-oy},ShaderTilemap.prototype._paintAllTiles=function(startX,startY){this.lowerZLayer.clear(),this.upperZLayer.clear()
const tileCols=Math.ceil(this._width/this._tileWidth)+1,tileRows=Math.ceil(this._height/this._tileHeight)+1
for(let y=0;y<tileRows;y++)for(let x=0;x<tileCols;x++)this._paintTiles(startX,startY,x,y)},ShaderTilemap.prototype._paintTiles=function(startX,startY,x,y){const mx=startX+x,my=startY+y,dx=x*this._tileWidth,dy=y*this._tileHeight,tileId0=this._readMapData(mx,my,0),tileId1=this._readMapData(mx,my,1),tileId2=this._readMapData(mx,my,2),tileId3=this._readMapData(mx,my,3),shadowBits=this._readMapData(mx,my,4),upperTileId1=this._readMapData(mx,my-1,1),lowerLayer=this.lowerLayer.children[0],upperLayer=this.upperLayer.children[0]
this._isHigherTile(tileId0)?this._drawTile(upperLayer,tileId0,dx,dy):this._drawTile(lowerLayer,tileId0,dx,dy),this._isHigherTile(tileId1)?this._drawTile(upperLayer,tileId1,dx,dy):this._drawTile(lowerLayer,tileId1,dx,dy),this._drawShadow(lowerLayer,shadowBits,dx,dy),this._isTableTile(upperTileId1)&&!this._isTableTile(tileId1)&&(Tilemap.isShadowingTile(tileId0)||this._drawTableEdge(lowerLayer,upperTileId1,dx,dy)),this._isOverpassPosition(mx,my)?(this._drawTile(upperLayer,tileId2,dx,dy),this._drawTile(upperLayer,tileId3,dx,dy)):(this._isHigherTile(tileId2)?this._drawTile(upperLayer,tileId2,dx,dy):this._drawTile(lowerLayer,tileId2,dx,dy),this._isHigherTile(tileId3)?this._drawTile(upperLayer,tileId3,dx,dy):this._drawTile(lowerLayer,tileId3,dx,dy))},ShaderTilemap.prototype._drawTile=function(layer,tileId,dx,dy){Tilemap.isVisibleTile(tileId)&&(Tilemap.isAutotile(tileId)?this._drawAutotile(layer,tileId,dx,dy):this._drawNormalTile(layer,tileId,dx,dy))},ShaderTilemap.prototype._drawNormalTile=function(layer,tileId,dx,dy){let setNumber=0
setNumber=Tilemap.isTileA5(tileId)?4:5+Math.floor(tileId/256)
const w=this._tileWidth,h=this._tileHeight,sx=(Math.floor(tileId/128)%2*8+tileId%8)*w,sy=Math.floor(tileId%256/8)%16*h
layer.addRect(setNumber,sx,sy,dx,dy,w,h)},ShaderTilemap.prototype._drawAutotile=function(layer,tileId,dx,dy){let autotileTable=Tilemap.FLOOR_AUTOTILE_TABLE
const kind=Tilemap.getAutotileKind(tileId),shape=Tilemap.getAutotileShape(tileId),tx=kind%8,ty=Math.floor(kind/8)
let bx=0,by=0,setNumber=0,isTable=!1,animX=0,animY=0
Tilemap.isTileA1(tileId)?(setNumber=0,0===kind?(animX=2,by=0):1===kind?(animX=2,by=3):2===kind?(bx=6,by=0):3===kind?(bx=6,by=3):(bx=8*Math.floor(tx/4),by=6*ty+Math.floor(tx/2)%2*3,kind%2==0?animX=2:(bx+=6,autotileTable=Tilemap.WATERFALL_AUTOTILE_TABLE,animY=1))):Tilemap.isTileA2(tileId)?(setNumber=1,bx=2*tx,by=3*(ty-2),isTable=this._isTableTile(tileId)):Tilemap.isTileA3(tileId)?(setNumber=2,bx=2*tx,by=2*(ty-6),autotileTable=Tilemap.WALL_AUTOTILE_TABLE):Tilemap.isTileA4(tileId)&&(setNumber=3,bx=2*tx,by=Math.floor(2.5*(ty-10)+(ty%2==1?.5:0)),ty%2==1&&(autotileTable=Tilemap.WALL_AUTOTILE_TABLE))
const table=autotileTable[shape],w1=this._tileWidth/2,h1=this._tileHeight/2
for(let i=0;i<4;i++){const qsx=table[i][0],qsy=table[i][1],sx1=(2*bx+qsx)*w1,sy1=(2*by+qsy)*h1,dx1=dx+i%2*w1,dy1=dy+Math.floor(i/2)*h1
if(!isTable||1!==qsy&&5!==qsy)layer.addRect(setNumber,sx1,sy1,dx1,dy1,w1,h1,animX,animY)
else{let qsx2=qsx
const qsy2=void 0
1===qsy&&(qsx2=(4-qsx)%4)
const sx2=(2*bx+qsx2)*w1,sy2=(2*by+3)*h1
layer.addRect(setNumber,sx2,sy2,dx1,dy1,w1,h1,animX,animY),layer.addRect(setNumber,sx1,sy1,dx1,dy1+h1/2,w1,h1/2,animX,animY)}}},ShaderTilemap.prototype._drawTableEdge=function(layer,tileId,dx,dy){if(Tilemap.isTileA2(tileId)){const autotileTable=Tilemap.FLOOR_AUTOTILE_TABLE,kind=Tilemap.getAutotileKind(tileId),shape=Tilemap.getAutotileShape(tileId),tx=void 0,ty=void 0,setNumber=1,bx=kind%8*2,by=3*(Math.floor(kind/8)-2),table=autotileTable[shape],w1=this._tileWidth/2,h1=this._tileHeight/2
for(let i=0;i<2;i++){const qsx=void 0,qsy=void 0,sx1=(2*bx+table[2+i][0])*w1,sy1=(2*by+table[2+i][1])*h1+h1/2,dx1=dx+i%2*w1,dy1=dy+Math.floor(i/2)*h1
layer.addRect(setNumber,sx1,sy1,dx1,dy1,w1,h1/2)}}},ShaderTilemap.prototype._drawShadow=function(layer,shadowBits,dx,dy){if(15&shadowBits){const w1=this._tileWidth/2,h1=this._tileHeight/2
for(let i=0;i<4;i++)if(shadowBits&1<<i){const dx1=dx+i%2*w1,dy1=dy+Math.floor(i/2)*h1
layer.addRect(-1,0,0,dx1,dy1,w1,h1)}}},TilingSprite.prototype=Object.create(PIXI.TilingSprite.prototype),TilingSprite.prototype.constructor=TilingSprite,TilingSprite.prototype.initialize=function(bitmap){const texture=new PIXI.Texture(new PIXI.BaseTexture)
PIXI.TilingSprite.call(this,texture),this._bitmap=null,this._width=0,this._height=0,this._frame=new Rectangle,this.spriteId=Sprite._counter++,this.origin=new Point,this.bitmap=bitmap},TilingSprite.prototype._renderCanvas_PIXI=PIXI.TilingSprite.prototype._renderCanvas,TilingSprite.prototype._render_PIXI=PIXI.TilingSprite.prototype._render,TilingSprite.prototype._renderCanvas=function(renderer){this._bitmap&&this._bitmap.touch(),this.texture.frame.width>0&&this.texture.frame.height>0&&this._renderCanvas_PIXI(renderer)},Object.defineProperty(TilingSprite.prototype,"bitmap",{get(){return this._bitmap},set(value){this._bitmap!==value&&(this._bitmap=value,this._bitmap?this._bitmap.addLoadListener(this._onBitmapLoad.bind(this)):this.texture.frame=Rectangle.emptyRectangle)},configurable:!0}),Object.defineProperty(TilingSprite.prototype,"opacity",{get(){return 255*this.alpha},set(value){this.alpha=value.clamp(0,255)/255},configurable:!0}),TilingSprite.prototype.update=function(){this.children.forEach((function(child){child.update&&child.update()}))},TilingSprite.prototype.move=function(x,y,width,height){this.x=x||0,this.y=y||0,this._width=width||0,this._height=height||0},TilingSprite.prototype.setFrame=function(x,y,width,height){this._frame.x=x,this._frame.y=y,this._frame.width=width,this._frame.height=height,this._refresh()},TilingSprite.prototype.updateTransform=function(){this.tilePosition.x=Math.round(-this.origin.x),this.tilePosition.y=Math.round(-this.origin.y),this.updateTransformTS()},TilingSprite.prototype.updateTransformTS=PIXI.TilingSprite.prototype.updateTransform,TilingSprite.prototype._onBitmapLoad=function(){this.texture.baseTexture=this._bitmap.baseTexture,this._refresh()},TilingSprite.prototype._refresh=function(){const frame=this._frame.clone()
0===frame.width&&0===frame.height&&this._bitmap&&(frame.width=this._bitmap.width,frame.height=this._bitmap.height),this.texture.frame=frame,this.texture._updateID++,this.tilingTexture=null},TilingSprite.prototype._render=function(renderer){this._bitmap&&(this._bitmap.touch(),this._bitmap.checkDirty()),this._render_PIXI(renderer)},ScreenSprite.prototype=Object.create(PIXI.Container.prototype),ScreenSprite.prototype.constructor=ScreenSprite,ScreenSprite.prototype.initialize=function(){PIXI.Container.call(this),this._graphics=new PIXI.Graphics,this.addChild(this._graphics),this.opacity=0,this._red=-1,this._green=-1,this._blue=-1,this._colorText="",this.setBlack()},Object.defineProperty(ScreenSprite.prototype,"opacity",{get(){return 255*this.alpha},set(value){this.alpha=value.clamp(0,255)/255},configurable:!0}),ScreenSprite.YEPWarned=!1,ScreenSprite.warnYep=function(){ScreenSprite.YEPWarned||(ScreenSprite.YEPWarned=!0)},Object.defineProperty(ScreenSprite.prototype,"anchor",{get(){return ScreenSprite.warnYep(),this.scale.x=1,this.scale.y=1,{x:0,y:0}},set(value){this.alpha=value.clamp(0,255)/255},configurable:!0}),Object.defineProperty(ScreenSprite.prototype,"blendMode",{get(){return this._graphics.blendMode},set(value){this._graphics.blendMode=value},configurable:!0}),ScreenSprite.prototype.setBlack=function(){this.setColor(0,0,0)},ScreenSprite.prototype.setWhite=function(){this.setColor(255,255,255)},ScreenSprite.prototype.setColor=function(r,g,b){if(this._red!==r||this._green!==g||this._blue!==b){r=Math.round(r||0).clamp(0,255),g=Math.round(g||0).clamp(0,255),b=Math.round(b||0).clamp(0,255),this._red=r,this._green=g,this._blue=b,this._colorText=Utils.rgbToCssColor(r,g,b)
const graphics=this._graphics
graphics.clear()
const intColor=r<<16|g<<8|b
graphics.beginFill(intColor,1),graphics.drawRect(5*-Graphics.width,5*-Graphics.height,10*Graphics.width,10*Graphics.height)}},WindowSkinCache._cache={},WindowSkinCache.setItem=function(name,resource,type){WindowSkinCache._cache[name]||(WindowSkinCache._cache[name]={}),WindowSkinCache._cache[name][type]=resource},WindowSkinCache.getItem=function(name,type){return!!WindowSkinCache._cache[name]&&!!WindowSkinCache._cache[name][type]&&WindowSkinCache._cache[name][type]},Window.prototype=Object.create(PIXI.Container.prototype),Window.prototype.constructor=Window,Window.prototype.initialize=function(){PIXI.Container.call(this),this._isWindow=!0,this._windowskin=null,this._width=0,this._height=0,this._cursorRect=new Rectangle,this._openness=255,this._animationCount=0,this._padding=18,this._margin=4,this._colorTone=[0,0,0],this._windowSpriteContainer=null,this._windowBackSprite=null,this._windowCursorSprite=null,this._windowFrameSprite=null,this._windowContentsSprite=null,this._windowArrowSprites=[],this._windowPauseSignSprite=null,this._createAllParts(),this.origin=new Point,this.active=!0,this.downArrowVisible=!1,this.upArrowVisible=!1,this.pause=!1},Object.defineProperty(Window.prototype,"windowskin",{get(){return this._windowskin},set(value){this._windowskin!==value&&(this._windowskin=value,this._windowskin.addLoadListener(this._onWindowskinLoad.bind(this)))},configurable:!0}),Object.defineProperty(Window.prototype,"contents",{get(){return this._windowContentsSprite.children[0]},set(value){const oldContents=this._windowContentsSprite.children[0]
oldContents&&this._windowContentsSprite.removeChild(oldContents),this._windowContentsSprite.addChild(value)},configurable:!0}),Object.defineProperty(Window.prototype,"width",{get(){return this._width},set(value){this._width=value,this._refreshAllParts()},configurable:!0}),Object.defineProperty(Window.prototype,"height",{get(){return this._height},set(value){this._height=value,this._refreshAllParts()},configurable:!0}),Object.defineProperty(Window.prototype,"padding",{get(){return this._padding},set(value){this._padding=value,this._refreshAllParts()},configurable:!0}),Object.defineProperty(Window.prototype,"margin",{get(){return this._margin},set(value){this._margin=value,this._refreshAllParts()},configurable:!0}),Object.defineProperty(Window.prototype,"opacity",{get(){return 255*this._windowSpriteContainer.alpha},set(value){this._windowSpriteContainer.alpha=value.clamp(0,255)/255},configurable:!0}),Object.defineProperty(Window.prototype,"backOpacity",{get(){return 255*this._windowBackSprite.alpha},set(value){this._windowBackSprite.alpha=value.clamp(0,255)/255},configurable:!0}),Object.defineProperty(Window.prototype,"contentsOpacity",{get(){return 255*this._windowContentsSprite.alpha},set(value){this._windowContentsSprite.alpha=value.clamp(0,255)/255},configurable:!0}),Object.defineProperty(Window.prototype,"openness",{get(){return this._openness},set(value){this._openness!==value&&(this._openness=value.clamp(0,255),this._windowSpriteContainer.scale.y=this._openness/255,this._windowSpriteContainer.y=this.height/2*(1-this._openness/255))},configurable:!0}),Window.prototype.update=function(){this.active&&this._animationCount++,this.children.forEach((function(child){child.update&&child.update()}))},Window.prototype.move=function(x,y,width,height){this.x=Math.floor(x||0),this.y=Math.floor(y||0),this._width===width&&this._height===height||(this._width=Math.floor(width||0),this._height=Math.floor(height||0),this._refreshAllParts())},Window.prototype.isOpen=function(){return this._openness>=255},Window.prototype.isClosed=function(){return this._openness<=0},Window.prototype.setCursorRect=function(x,y,width,height){const cx=Math.floor(x||0),cy=Math.floor(y||0),cw=Math.floor(width||0),ch=Math.floor(height||0),rect=this._cursorRect
rect.x===cx&&rect.y===cy&&rect.width===cw&&rect.height===ch||(this._cursorRect.x=cx,this._cursorRect.y=cy,this._cursorRect.width=cw,this._cursorRect.height=ch,this._refreshCursor())},Window.prototype.setTone=function(r,g,b){const tone=this._colorTone;(r/=255)<0&&(r=0),(g/=255)<0&&(g=0),(b/=255)<0&&(b=0),r===tone[0]&&g===tone[1]&&b===tone[2]||(this._colorTone=[r,g,b],this._refreshBack())},Window.prototype.addChildToBack=function(child){const containerIndex=this.children.indexOf(this._windowSpriteContainer)
return this.addChildAt(child,containerIndex+1)},Window.prototype.updateTransform=function(){this._updateCursor(),this._updateArrows(),this._updatePauseSign(),this._updateContents(),PIXI.Container.prototype.updateTransform.call(this)},Window.prototype._createAllParts=function(){this._windowSpriteContainer=new PIXI.Container,this._windowBackSprite=new BitmapPIXI,this._windowCursorSprite=new BitmapPIXI,this._windowFrameSprite=new PIXI.Container,this._windowContentsSprite=new Sprite,this._downArrowSprite=new Sprite,this._upArrowSprite=new Sprite,this._windowPauseSignSprite=new Sprite,this._windowBackSprite.alpha=192/255,this.addChild(this._windowSpriteContainer),this._windowSpriteContainer.addChild(this._windowBackSprite),this._windowSpriteContainer.addChild(this._windowFrameSprite),this.addChild(this._windowCursorSprite),this.addChild(this._windowContentsSprite),this.addChild(this._downArrowSprite),this.addChild(this._upArrowSprite),this.addChild(this._windowPauseSignSprite)},Window.prototype._onWindowskinLoad=function(){this._refreshAllParts()},Window.prototype._refreshAllParts=function(){this._refreshBack(),this._refreshFrame(),this._refreshCursor(),this._refreshContents(),this._refreshArrows(),this._refreshPauseSign()},Window.prototype._refreshBack=function(){const m=this._margin,w=this._width-2*m,h=this._height-2*m,tone=PIXI.utils.rgb2hex(this._colorTone)
if(w>0&&h>0&&this._windowskin&&!this._windowBackSprite._setupComplete){const p=96
this._windowBackSprite.blt(this._windowskin,0,0,p,p,0,0,w,h),this._windowBackSprite.addChild(this._windowBackSprite.createTilingSprite(this._windowskin.baseTexture,0,p,p,p,w,h)),this._windowBackSprite._setupComplete=!0}this._windowBackSprite.width=w,this._windowBackSprite.height=h,this._windowBackSprite.x=m,this._windowBackSprite.y=m,this._windowBackSprite.children.forEach((function(child){child&&(child.width=w,child.height=h,child.tint=tone)}))},Window.prototype._refreshFrame=function(){const w=this._width,h=this._height,m=24
if(w>0&&h>0&&this._windowskin&&!this._windowFrameSprite._setupComplete){let texture
const cachedFrame=WindowSkinCache.getItem(this._windowskin._url,"frame")
if(cachedFrame)texture=cachedFrame
else{const container=new BitmapPIXI,skin=this._windowskin,p=96,q=96
container.blt(skin,p+m,0,p-48,m,m,0,w-48,m),container.blt(skin,p+m,0+q-m,p-48,m,m,h-m,w-48,m),container.blt(skin,p+0,24,m,p-48,0,m,m,h-48),container.blt(skin,p+q-m,24,m,p-48,w-m,m,m,h-48),container.blt(skin,p+0,0,m,m,0,0,m,m),container.blt(skin,p+q-m,0,m,m,w-m,0,m,m),container.blt(skin,p+0,0+q-m,m,m,0,h-m,m,m),container.blt(skin,p+q-m,0+q-m,m,m,w-m,h-m,m,m),texture=Graphics._renderer.generateTexture(container),container.destroy({children:!0,texture:!0}),WindowSkinCache.setItem(this._windowskin._url,texture,"frame")}this._windowFramePlane=new PIXI.NineSlicePlane(texture,12,12,12,12),this._windowFrameSprite.addChild(this._windowFramePlane),this._windowFrameSprite._setupComplete=!0}this._windowFrameSprite._setupComplete&&(this._windowFramePlane.width=w,this._windowFramePlane.height=h)},Window.prototype._refreshCursor=function(){const pad=this._padding,x=this._cursorRect.x+pad-this.origin.x,y=this._cursorRect.y+pad-this.origin.y,w=this._cursorRect.width,h=this._cursorRect.height
if(w>0&&h>0&&this._windowskin&&!this._windowCursorSprite._setupComplete){const p=96,q=48
this._windowCursorPlane=this._windowCursorSprite.create9Slice(this._windowskin.baseTexture,p,p,q,q,12,12,12,12),this._windowCursorSprite.addChild(this._windowCursorPlane),this._windowCursorSprite._setupComplete=!0}this._windowCursorPlane&&(this._windowCursorPlane.x=x,this._windowCursorPlane.y=y,this._windowCursorPlane.width=w,this._windowCursorPlane.height=h)},Window.prototype._refreshContents=function(){this._windowContentsSprite.move(this.padding,this.padding),this._windowContentsSprite.children.length&&this._windowContentsSprite.children[0].clear()},Window.prototype._refreshArrows=function(){const w=this._width,h=this._height,p=24,q=12,sx=120,sy=24
this._downArrowSprite.bitmap=this._windowskin,this._downArrowSprite.anchor.x=.5,this._downArrowSprite.anchor.y=.5,this._downArrowSprite.setFrame(132,60,p,q),this._downArrowSprite.move(w/2,h-q),this._upArrowSprite.bitmap=this._windowskin,this._upArrowSprite.anchor.x=.5,this._upArrowSprite.anchor.y=.5,this._upArrowSprite.setFrame(132,24,p,q),this._upArrowSprite.move(w/2,q)},Window.prototype._refreshPauseSign=function(){const sx=144,sy=96,p=24
this._windowPauseSignSprite.bitmap=this._windowskin,this._windowPauseSignSprite.anchor.x=.5,this._windowPauseSignSprite.anchor.y=1,this._windowPauseSignSprite.move(this._width/2,this._height),this._windowPauseSignSprite.setFrame(sx,96,p,p),this._windowPauseSignSprite.alpha=0},Window.prototype._updateCursor=function(){const blinkCount=this._animationCount%40
let cursorOpacity=this.contentsOpacity
this.active&&(cursorOpacity-=blinkCount<20?8*blinkCount:8*(40-blinkCount)),this._windowCursorSprite.alpha=cursorOpacity/255,this._windowCursorSprite.visible=this.isOpen()},Window.prototype._updateContents=function(){const w=this._width-2*this._padding,h=this._height-2*this._padding
w>0&&h>0?(this._windowContentsSprite.setFrame(this.origin.x,this.origin.y,w,h),this._windowContentsSprite.visible=this.isOpen()):this._windowContentsSprite.visible=!1},Window.prototype._updateArrows=function(){this._downArrowSprite.visible=this.isOpen()&&this.downArrowVisible,this._upArrowSprite.visible=this.isOpen()&&this.upArrowVisible},Window.prototype._updatePauseSign=function(){const sprite=this._windowPauseSignSprite,x=Math.floor(this._animationCount/16)%2,y=Math.floor(this._animationCount/16/2)%2,sx=144,sy=96,p=24
this.pause?sprite.alpha<1&&(sprite.alpha=Math.min(sprite.alpha+.1,1)):sprite.alpha=0,sprite.setFrame(sx+x*p,96+y*p,p,p),sprite.visible=this.isOpen()},WindowLayer.prototype=Object.create(PIXI.Container.prototype),WindowLayer.prototype.constructor=WindowLayer,WindowLayer.prototype.initialize=function(){PIXI.Container.call(this),this._width=0,this._height=0,this.on("removed",this.onRemoveAsAChild)},WindowLayer.prototype.onRemoveAsAChild=function(){this.removeChildren()},WindowLayer.voidFilter=new PIXI.filters.AlphaFilter,Object.defineProperty(WindowLayer.prototype,"width",{get(){return this._width},set(value){this._width=value},configurable:!0}),Object.defineProperty(WindowLayer.prototype,"height",{get(){return this._height},set(value){this._height=value},configurable:!0}),WindowLayer.prototype.move=function(x,y,width,height){this.x=x,this.y=y,this.width=width,this.height=height},WindowLayer.prototype.update=function(){this.children.forEach((function(child){child.update&&child.update()}))},WindowLayer.prototype.render=PIXI.Container.prototype.render,WindowLayer.prototype.renderCanvas=PIXI.Container.prototype.renderCanvas,Weather.prototype=Object.create(PIXI.Container.prototype),Weather.prototype.constructor=Weather,Weather.prototype.initialize=function(){PIXI.Container.call(this),this._width=Graphics.width,this._height=Graphics.height,this._sprites=[],this._createBitmaps(),this._createDimmer(),this.type="none",this.power=0,this.origin=new Point},Weather.prototype.update=function(){this._updateDimmer(),this._updateAllSprites()},Weather.prototype._createBitmaps=function(){this._rainBitmap=new Bitmap(1,60),this._rainBitmap.fillAll("white"),this._stormBitmap=new Bitmap(2,100),this._stormBitmap.fillAll("white"),this._snowBitmap=new Bitmap(9,9),this._snowBitmap.drawCircle(4,4,4,"white")},Weather.prototype._createDimmer=function(){this._dimmerSprite=new ScreenSprite,this._dimmerSprite.setColor(80,80,80),this.addChild(this._dimmerSprite)},Weather.prototype._updateDimmer=function(){this._dimmerSprite.opacity=Math.floor(6*this.power)},Weather.prototype._updateAllSprites=function(){const maxSprites=Math.floor(10*this.power)
for(;this._sprites.length<maxSprites;)this._addSprite()
for(;this._sprites.length>maxSprites;)this._removeSprite()
this._sprites.forEach((function(sprite){this._updateSprite(sprite),sprite.x=sprite.ax-this.origin.x,sprite.y=sprite.ay-this.origin.y}),this)},Weather.prototype._addSprite=function(){const sprite=new Sprite(this.viewport)
sprite.opacity=0,this._sprites.push(sprite),this.addChild(sprite)},Weather.prototype._removeSprite=function(){this.removeChild(this._sprites.pop())},Weather.prototype._updateSprite=function(sprite){switch(this.type){case"rain":this._updateRainSprite(sprite)
break
case"storm":this._updateStormSprite(sprite)
break
case"snow":this._updateSnowSprite(sprite)}sprite.opacity<40&&this._rebornSprite(sprite)},Weather.prototype._updateRainSprite=function(sprite){sprite.bitmap=this._rainBitmap,sprite.rotation=Math.PI/16,sprite.ax-=6*Math.sin(sprite.rotation),sprite.ay+=6*Math.cos(sprite.rotation),sprite.opacity-=6},Weather.prototype._updateStormSprite=function(sprite){sprite.bitmap=this._stormBitmap,sprite.rotation=Math.PI/8,sprite.ax-=8*Math.sin(sprite.rotation),sprite.ay+=8*Math.cos(sprite.rotation),sprite.opacity-=8},Weather.prototype._updateSnowSprite=function(sprite){sprite.bitmap=this._snowBitmap,sprite.rotation=Math.PI/16,sprite.ax-=3*Math.sin(sprite.rotation),sprite.ay+=3*Math.cos(sprite.rotation),sprite.opacity-=3},Weather.prototype._rebornSprite=function(sprite){sprite.ax=Math.randomInt(Graphics.width+100)-100+this.origin.x,sprite.ay=Math.randomInt(Graphics.height+200)-200+this.origin.y,sprite.opacity=160+Math.randomInt(60)},ToneFilter.prototype=Object.create(PIXI.filters.ColorMatrixFilter.prototype),ToneFilter.prototype.constructor=ToneFilter,ToneFilter.prototype.adjustHue=function(value){this.hue(value,!0)},ToneFilter.prototype.adjustSaturation=function(value){value=(value||0).clamp(-255,255)/255,this.saturate(value,!0)},ToneFilter.prototype.adjustTone=function(r,g,b){if(r=(r||0).clamp(-255,255)/255,g=(g||0).clamp(-255,255)/255,b=(b||0).clamp(-255,255)/255,0!==r||0!==g||0!==b){const matrix=[1,0,0,r,0,0,1,0,g,0,0,0,1,b,0,0,0,0,1,0]
this._loadMatrix(matrix,!0)}},ToneSprite.prototype=Object.create(PIXI.Container.prototype),ToneSprite.prototype.constructor=ToneSprite,ToneSprite.prototype.initialize=function(){PIXI.Container.call(this),this.clear()},ToneSprite.prototype.clear=function(){this._red=0,this._green=0,this._blue=0,this._gray=0},ToneSprite.prototype.setTone=function(r,g,b,gray){this._red=Math.round(r||0).clamp(-255,255),this._green=Math.round(g||0).clamp(-255,255),this._blue=Math.round(b||0).clamp(-255,255),this._gray=Math.round(gray||0).clamp(0,255)},ToneSprite.prototype._renderCanvas=function(renderer){if(this.visible){const context=renderer.context,t=this.worldTransform,r=renderer.resolution,width=Graphics.width,height=Graphics.height
context.save(),context.setTransform(t.a,t.b,t.c,t.d,t.tx*r,t.ty*r),Graphics.canUseSaturationBlend()&&this._gray>0&&(context.globalCompositeOperation="saturation",context.globalAlpha=this._gray/255,context.fillStyle="#ffffff",context.fillRect(0,0,width,height)),context.globalAlpha=1
const r1=Math.max(0,this._red),g1=Math.max(0,this._green),b1=Math.max(0,this._blue)
if((r1||g1||b1)&&(context.globalCompositeOperation="lighter",context.fillStyle=Utils.rgbToCssColor(r1,g1,b1),context.fillRect(0,0,width,height)),Graphics.canUseDifferenceBlend()){const r2=Math.max(0,-this._red),g2=Math.max(0,-this._green),b2=Math.max(0,-this._blue);(r2||g2||b2)&&(context.globalCompositeOperation="difference",context.fillStyle="#ffffff",context.fillRect(0,0,width,height),context.globalCompositeOperation="lighter",context.fillStyle=Utils.rgbToCssColor(r2,g2,b2),context.fillRect(0,0,width,height),context.globalCompositeOperation="difference",context.fillStyle="#ffffff",context.fillRect(0,0,width,height))}context.restore()}},ToneSprite.prototype._render=function(renderer){},Stage.prototype=Object.create(PIXI.Container.prototype),Stage.prototype.constructor=Stage,Stage.prototype.initialize=function(){PIXI.Container.call(this),this.interactive=!1},WebAudio._standAlone=(function(top){return!top.ResourceHandler})(this),WebAudio.prototype.initialize=function(url){WebAudio._initialized||WebAudio.initialize(),this.clear(),WebAudio._standAlone||(this._loader=ResourceHandler.createLoader(url,this._load.bind(this,url),function(){this._hasError=!0}.bind(this))),this._load(url),this._url=url},WebAudio._masterVolume=1,WebAudio._context=null,WebAudio._masterGainNode=null,WebAudio._initialized=!1,WebAudio._unlocked=!1,WebAudio.initialize=function(noAudio){return this._initialized||(noAudio||(this._createContext(),this._detectCodecs(),this._createMasterGainNode(),this._setupEventHandlers()),this._initialized=!0),!!this._context},WebAudio.canPlayOgg=function(){return this._initialized||this.initialize(),!!this._canPlayOgg},WebAudio.canPlayM4a=function(){return this._initialized||this.initialize(),!!this._canPlayM4a},WebAudio.setMasterVolume=function(value){this._masterVolume=value,this._masterGainNode&&this._masterGainNode.gain.setValueAtTime(this._masterVolume,this._context.currentTime)},WebAudio._createContext=function(){try{"undefined"!=typeof AudioContext?this._context=new AudioContext:"undefined"!=typeof webkitAudioContext&&(this._context=new webkitAudioContext)}catch(e){this._context=null}},WebAudio._detectCodecs=function(){const audio=document.createElement("audio")
audio.canPlayType&&(this._canPlayOgg=audio.canPlayType('audio/ogg; codecs="vorbis"'),this._canPlayM4a=audio.canPlayType("audio/mp4"))},WebAudio._createMasterGainNode=function(){const context=WebAudio._context
context&&(this._masterGainNode=context.createGain(),this._masterGainNode.gain.setValueAtTime(this._masterVolume,context.currentTime),this._masterGainNode.connect(context.destination))},WebAudio._setupEventHandlers=function(){const resumeHandler=function(){const context=WebAudio._context
context&&"suspended"===context.state&&"function"==typeof context.resume?context.resume().then((function(){WebAudio._onTouchStart()})):WebAudio._onTouchStart()}
document.addEventListener("keydown",resumeHandler),document.addEventListener("mousedown",resumeHandler),document.addEventListener("touchend",resumeHandler),document.addEventListener("touchstart",this._onTouchStart.bind(this)),document.addEventListener("visibilitychange",this._onVisibilityChange.bind(this))},WebAudio._onTouchStart=function(){const context=WebAudio._context
if(context&&!this._unlocked){const node=void 0
context.createBufferSource().start(0),this._unlocked=!0}},WebAudio._onVisibilityChange=function(){"hidden"===document.visibilityState?this._onHide():this._onShow()},WebAudio._onHide=function(){this._shouldMuteOnHide()&&this._fadeOut(1)},WebAudio._onShow=function(){this._shouldMuteOnHide()&&this._fadeIn(1)},WebAudio._shouldMuteOnHide=function(){return Utils.isMobileDevice()},WebAudio._fadeIn=function(duration){if(this._masterGainNode){const gain=this._masterGainNode.gain,currentTime=WebAudio._context.currentTime
gain.setValueAtTime(0,currentTime),gain.linearRampToValueAtTime(this._masterVolume,currentTime+duration)}},WebAudio._fadeOut=function(duration){if(this._masterGainNode){const gain=this._masterGainNode.gain,currentTime=WebAudio._context.currentTime
gain.setValueAtTime(this._masterVolume,currentTime),gain.linearRampToValueAtTime(0,currentTime+duration)}},WebAudio.prototype.clear=function(){this.stop(),this._buffer=null,this._sourceNode=null,this._gainNode=null,this._pannerNode=null,this._totalTime=0,this._sampleRate=0,this._loopStart=0,this._loopLength=0,this._startTime=0,this._volume=1,this._pitch=1,this._pan=0,this._endTimer=null,this._loadListeners=[],this._stopListeners=[],this._hasError=!1,this._autoPlay=!1},Object.defineProperty(WebAudio.prototype,"url",{get(){return this._url},configurable:!0}),Object.defineProperty(WebAudio.prototype,"volume",{get(){return this._volume},set(value){this._volume=value,this._gainNode&&this._gainNode.gain.setValueAtTime(this._volume,WebAudio._context.currentTime)},configurable:!0}),Object.defineProperty(WebAudio.prototype,"pitch",{get(){return this._pitch},set(value){this._pitch!==value&&(this._pitch=value,this.isPlaying()&&this.play(this._sourceNode.loop,0))},configurable:!0}),Object.defineProperty(WebAudio.prototype,"pan",{get(){return this._pan},set(value){this._pan=value,this._updatePanner()},configurable:!0}),WebAudio.prototype.isReady=function(){return!!this._buffer},WebAudio.prototype.isError=function(){return this._hasError},WebAudio.prototype.isPlaying=function(){return!!this._sourceNode},WebAudio.prototype.play=function(loop,offset){this.isReady()?(offset=offset||0,this._startPlaying(loop,offset)):WebAudio._context&&(this._autoPlay=!0,this.addLoadListener(function(){this._autoPlay&&this.play(loop,offset)}.bind(this)))},WebAudio.prototype.stop=function(){if(this._autoPlay=!1,this._removeEndTimer(),this._removeNodes(),this._stopListeners)for(;this._stopListeners.length>0;){const listner=void 0
this._stopListeners.shift()()}},WebAudio.prototype.fadeIn=function(duration){if(this.isReady()){if(this._gainNode){const gain=this._gainNode.gain,currentTime=WebAudio._context.currentTime
gain.setValueAtTime(0,currentTime),gain.linearRampToValueAtTime(this._volume,currentTime+duration)}}else this._autoPlay&&this.addLoadListener(function(){this.fadeIn(duration)}.bind(this))},WebAudio.prototype.fadeOut=function(duration){if(this._gainNode){const gain=this._gainNode.gain,currentTime=WebAudio._context.currentTime
gain.setValueAtTime(this._volume,currentTime),gain.linearRampToValueAtTime(0,currentTime+duration)}this._autoPlay=!1},WebAudio.prototype.seek=function(){if(WebAudio._context){let pos=(WebAudio._context.currentTime-this._startTime)*this._pitch
if(this._loopLength>0)for(;pos>=this._loopStart+this._loopLength;)pos-=this._loopLength
return pos}return 0},WebAudio.prototype.addLoadListener=function(listner){this._loadListeners.push(listner)},WebAudio.prototype.addStopListener=function(listner){this._stopListeners.push(listner)},WebAudio.prototype._load=function(url){if(WebAudio._context){const xhr=new XMLHttpRequest
Decrypter.hasEncryptedAudio&&(url=Decrypter.extToEncryptExt(url)),xhr.open("GET",url),xhr.responseType="arraybuffer",xhr.onload=function(){xhr.status<400&&this._onXhrLoad(xhr)}.bind(this),xhr.onerror=this._loader||function(){this._hasError=!0}.bind(this),xhr.send()}},WebAudio.prototype._onXhrLoad=function(xhr){let array=xhr.response
Decrypter.hasEncryptedAudio&&(array=Decrypter.decryptArrayBuffer(array)),this._readLoopComments(new Uint8Array(array)),WebAudio._context.decodeAudioData(array,function(buffer){this._buffer=buffer,this._totalTime=buffer.duration,this._loopLength>0&&this._sampleRate>0?(this._loopStart/=this._sampleRate,this._loopLength/=this._sampleRate):(this._loopStart=0,this._loopLength=this._totalTime),this._onLoad()}.bind(this))},WebAudio.prototype._startPlaying=function(loop,offset){if(this._loopLength>0)for(;offset>=this._loopStart+this._loopLength;)offset-=this._loopLength
this._removeEndTimer(),this._removeNodes(),this._createNodes(),this._connectNodes(),this._sourceNode.loop=loop,this._sourceNode.start(0,offset),this._startTime=WebAudio._context.currentTime-offset/this._pitch,this._createEndTimer()},WebAudio.prototype._createNodes=function(){const context=WebAudio._context
this._sourceNode=context.createBufferSource(),this._sourceNode.buffer=this._buffer,this._sourceNode.loopStart=this._loopStart,this._sourceNode.loopEnd=this._loopStart+this._loopLength,this._sourceNode.playbackRate.setValueAtTime(this._pitch,context.currentTime),this._gainNode=context.createGain(),this._gainNode.gain.setValueAtTime(this._volume,context.currentTime),this._pannerNode=context.createPanner(),this._pannerNode.panningModel="equalpower",this._updatePanner()},WebAudio.prototype._connectNodes=function(){this._sourceNode.connect(this._gainNode),this._gainNode.connect(this._pannerNode),this._pannerNode.connect(WebAudio._masterGainNode)},WebAudio.prototype._removeNodes=function(){this._sourceNode&&(this._sourceNode.stop(0),this._sourceNode=null,this._gainNode=null,this._pannerNode=null)},WebAudio.prototype._createEndTimer=function(){if(this._sourceNode&&!this._sourceNode.loop){const endTime=void 0,delay=this._startTime+this._totalTime/this._pitch-WebAudio._context.currentTime
this._endTimer=setTimeout(function(){this.stop()}.bind(this),1e3*delay)}},WebAudio.prototype._removeEndTimer=function(){this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null)},WebAudio.prototype._updatePanner=function(){if(this._pannerNode){const x=this._pan,z=1-Math.abs(x)
this._pannerNode.setPosition(x,0,z)}},WebAudio.prototype._onLoad=function(){for(;this._loadListeners.length>0;){const listner=void 0
this._loadListeners.shift()()}},WebAudio.prototype._readLoopComments=function(array){this._readOgg(array),this._readMp4(array)},WebAudio.prototype._readOgg=function(array){let index=0
for(;index<array.length&&"OggS"===this._readFourCharacters(array,index);){index+=26
let vorbisHeaderFound=!1
const numSegments=array[index++],segments=[]
for(let i=0;i<numSegments;i++)segments.push(array[index++])
for(let i=0;i<numSegments;i++){if("vorb"===this._readFourCharacters(array,index+1)){const headerType=array[index]
if(1===headerType)this._sampleRate=this._readLittleEndian(array,index+12)
else if(3===headerType){let size=0
for(;i<numSegments&&(size+=segments[i],!(segments[i]<255));i++);this._readMetaData(array,index,size)}vorbisHeaderFound=!0}index+=segments[i]}if(!vorbisHeaderFound)break}},WebAudio.prototype._readMp4=function(array){if("ftyp"===this._readFourCharacters(array,4)){let index=0
for(;index<array.length;){const size=this._readBigEndian(array,index),name=this._readFourCharacters(array,index+4)
if("moov"===name)index+=8
else if("mvhd"===name&&(this._sampleRate=this._readBigEndian(array,index+20)),"udta"!==name&&"meta"!==name||this._readMetaData(array,index,size),index+=size,size<=1)break}}},WebAudio.prototype._readMetaData=function(array,index,size){for(let i=index;i<index+size-10;i++)if("LOOP"===this._readFourCharacters(array,i)){let text=""
for(;array[i]>0;)text+=String.fromCharCode(array[i++])
if(text.match(/LOOPSTART=([0-9]+)/)&&(this._loopStart=parseInt(RegExp.$1)),text.match(/LOOPLENGTH=([0-9]+)/)&&(this._loopLength=parseInt(RegExp.$1)),"LOOPSTART"==text||"LOOPLENGTH"==text){let text2=""
for(i+=16;array[i]>0;)text2+=String.fromCharCode(array[i++])
"LOOPSTART"==text?this._loopStart=parseInt(text2):this._loopLength=parseInt(text2)}}},WebAudio.prototype._readLittleEndian=function(array,index){return 16777216*array[index+3]+65536*array[index+2]+256*array[index+1]+array[index+0]},WebAudio.prototype._readBigEndian=function(array,index){return 16777216*array[index+0]+65536*array[index+1]+256*array[index+2]+array[index+3]},WebAudio.prototype._readFourCharacters=function(array,index){let string=""
for(let i=0;i<4;i++)string+=String.fromCharCode(array[index+i])
return string},JsonEx.maxDepth=100,JsonEx._id=1,JsonEx._generateId=function(){return JsonEx._id++},JsonEx.stringify=function(object){const circular=[]
JsonEx._id=1
const json=JSON.stringify(this._encode(object,circular,0))
return this._cleanMetadata(object),this._restoreCircularReference(circular),json},JsonEx._restoreCircularReference=function(circulars){circulars.forEach((function(circular){const key=circular[0],value=circular[1],content=circular[2]
value[key]=content}))},JsonEx.parse=function(json){const circular=[],registry={},contents=this._decode(JSON.parse(json),circular,registry)
return this._cleanMetadata(contents),this._linkCircularReference(contents,circular,registry),contents},JsonEx._linkCircularReference=function(contents,circulars,registry){circulars.forEach((function(circular){const key=circular[0],value=circular[1],id=circular[2]
value[key]=registry[id]}))},JsonEx._cleanMetadata=function(object){object&&(delete object["@"],delete object["@c"],"object"==typeof object&&Object.keys(object).forEach((function(key){const value=object[key]
"object"==typeof value&&JsonEx._cleanMetadata(value)})))},JsonEx.makeDeepCopy=function(object){return this.parse(this.stringify(object))},JsonEx._encode=function(value,circular,depth){if(depth=depth||0,++depth>=this.maxDepth)throw new Error("Object too deep")
const type={}.toString.call(value)
if("[object Object]"===type||"[object Array]"===type){value["@c"]=JsonEx._generateId()
const constructorName=this._getConstructorName(value)
"Object"!==constructorName&&"Array"!==constructorName&&(value["@"]=constructorName)
for(let key in value)value.hasOwnProperty&&!value.hasOwnProperty(key)||key.match(/^@./)||(value[key]&&"object"==typeof value[key]?value[key]["@c"]?(circular.push([key,value,value[key]]),value[key]={"@r":value[key]["@c"]}):(value[key]=this._encode(value[key],circular,depth+1),value[key]instanceof Array&&(circular.push([key,value,value[key]]),value[key]={"@c":value[key]["@c"],"@a":value[key]})):value[key]=this._encode(value[key],circular,depth+1))}return depth--,value},JsonEx._decode=function(value,circular,registry){const type={}.toString.call(value)
if("[object Object]"===type||"[object Array]"===type){if(registry[value["@c"]]=value,null===value["@"])value=this._resetPrototype(value,null)
else if(value["@"]){const constructor=window[value["@"]]
constructor&&(value=this._resetPrototype(value,constructor.prototype))}for(let key in value)if(!value.hasOwnProperty||value.hasOwnProperty(key)){if(value[key]&&value[key]["@a"]){const body=value[key]["@a"]
body["@c"]=value[key]["@c"],value[key]=body}value[key]&&value[key]["@r"]&&circular.push([key,value,value[key]["@r"]]),value[key]=this._decode(value[key],circular,registry)}}return value},JsonEx._getConstructorName=function(value){if(!value.constructor)return null
let name=value.constructor.name
if(void 0===name){const func=void 0
name=/^\s*function\s*([A-Za-z0-9_$]*)/.exec(value.constructor)[1]}return name},JsonEx._resetPrototype=function(value,prototype){if(void 0!==Object.setPrototypeOf&&"object"==typeof prototype)Object.setPrototypeOf(value,prototype)
else if("__proto__"in value)value.__proto__=prototype
else{const newValue=Object.create(prototype)
for(let key in value)value.hasOwnProperty(key)&&(newValue[key]=value[key])
value=newValue}return value},Decrypter.hasEncryptedImages=!1,Decrypter.hasEncryptedAudio=!1,Decrypter._requestImgFile=[],Decrypter._headerlength=16,Decrypter._xhrOk=400,Decrypter._encryptionKey="",Decrypter._ignoreList=["img/system/Window.png"],Decrypter.SIGNATURE="5250474d56000000",Decrypter.VER="000301",Decrypter.REMAIN="0000000000",Decrypter.checkImgIgnore=function(url){for(let cnt=0;cnt<this._ignoreList.length;cnt++)if(url===this._ignoreList[cnt])return!0
return!1},Decrypter.decryptImg=function(url,bitmap){url=this.extToEncryptExt(url)
const requestFile=new XMLHttpRequest
requestFile.open("GET",url),requestFile.responseType="arraybuffer",requestFile.send(),requestFile.onload=function(){if(this.status<Decrypter._xhrOk){const arrayBuffer=Decrypter.decryptArrayBuffer(requestFile.response)
bitmap._image.src=Decrypter.createBlobUrl(arrayBuffer),bitmap._image.addEventListener("load",bitmap._loadListener=Bitmap.prototype._onLoad.bind(bitmap)),bitmap._image.addEventListener("error",bitmap._errorListener=bitmap._loader||Bitmap.prototype._onError.bind(bitmap))}},requestFile.onerror=function(){bitmap._loader?bitmap._loader():bitmap._onError()}},Decrypter.cutArrayHeader=function(arrayBuffer,length){return arrayBuffer.slice(length)},Decrypter.decryptArrayBuffer=function(arrayBuffer){if(!arrayBuffer)return null
const header=new Uint8Array(arrayBuffer,0,this._headerlength)
let i
const ref=this.SIGNATURE+this.VER+this.REMAIN,refBytes=new Uint8Array(16)
for(i=0;i<this._headerlength;i++)refBytes[i]=parseInt("0x"+ref.substr(2*i,2),16)
for(i=0;i<this._headerlength;i++)if(header[i]!==refBytes[i])throw new Error("Header is wrong")
arrayBuffer=this.cutArrayHeader(arrayBuffer,Decrypter._headerlength)
const view=new DataView(arrayBuffer)
if(this.readEncryptionkey(),arrayBuffer){const byteArray=new Uint8Array(arrayBuffer)
for(i=0;i<this._headerlength;i++)byteArray[i]=byteArray[i]^parseInt(Decrypter._encryptionKey[i],16),view.setUint8(i,byteArray[i])}return arrayBuffer},Decrypter.createBlobUrl=function(arrayBuffer){const blob=new Blob([arrayBuffer])
return window.URL.createObjectURL(blob)},Decrypter.extToEncryptExt=function(url){const ext=url.split(".").pop()
let encryptedExt=ext
return encryptedExt="ogg"===ext?".rpgmvo":"m4a"===ext?".rpgmvm":"png"===ext?".rpgmvp":ext,url.slice(0,url.lastIndexOf(ext)-1)+encryptedExt},Decrypter.readEncryptionkey=function(){this._encryptionKey=$dataSystem.encryptionKey.split(/(.{2})/).filter(Boolean)},ResourceHandler._reloaders=[],ResourceHandler._defaultRetryInterval=[500,1e3,3e3],ResourceHandler.createLoader=function(url,retryMethod,resignMethod,retryInterval){retryInterval=retryInterval||this._defaultRetryInterval
const reloaders=this._reloaders
let retryCount=0
return function(){retryCount<retryInterval.length?(setTimeout(retryMethod,retryInterval[retryCount]),retryCount++):(resignMethod&&resignMethod(),url&&(0===reloaders.length&&(Graphics.printLoadingError(url),SceneManager.stop()),reloaders.push((function(){retryCount=0,retryMethod()}))))}},ResourceHandler.exists=function(){return this._reloaders.length>0},ResourceHandler.retry=function(){this._reloaders.length>0&&(Graphics.eraseLoadingError(),SceneManager.resume(),this._reloaders.forEach((function(reloader){reloader()})),this._reloaders.length=0)}
