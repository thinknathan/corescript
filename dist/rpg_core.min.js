/*!
 * rpg_core.js - v1.6.1 (community-1.4)
 * (c) 2015 KADOKAWA CORPORATION./YOJI OJIMA
 * Contributions by the RPG Maker MV CoreScript team
 * https://github.com/thinknathan/corescript/blob/master/CONTRIBUTORS.md
 *
 * Licensed under the MIT License.
 * https://github.com/thinknathan/corescript/blob/master/LICENSE
 */
"use strict"
function ProgressWatcher(){throw new Error("This is a static class")}function JsExtensions(){throw new Error("This is not a class")}function Utils(){throw new Error("This is a static class")}function CacheEntry(t,e,i){this.cache=t,this.key=e,this.item=i,this.cached=!1,this.touchTicks=0,this.touchSeconds=0,this.ttlTicks=0,this.ttlSeconds=0,this.freedByTTL=!1}function CacheMap(t){this.manager=t,this._inner={},this._lastRemovedEntries={},this.updateTicks=0,this.lastCheckTTL=0,this.delayCheckTTL=100,this.updateSeconds=Date.now()}function ImageCache(){this.initialize.apply(this,arguments)}function RequestQueue(){this.initialize.apply(this,arguments)}function Point(){this.initialize.apply(this,arguments)}function Rectangle(){this.initialize.apply(this,arguments)}function Bitmap(){this.initialize.apply(this,arguments)}function BitmapPIXI(){this.initialize.apply(this,arguments)}function Graphics(){throw new Error("This is a static class")}function Input(){throw new Error("This is a static class")}function TouchInput(){throw new Error("This is a static class")}function Sprite(){this.initialize.apply(this,arguments)}function Tilemap(){this.initialize.apply(this,arguments)}function ShaderTilemap(){Tilemap.apply(this,arguments),this.roundPixels=!0}function TilingSprite(){this.initialize.apply(this,arguments)}function ScreenSprite(){this.initialize.apply(this,arguments)}function WindowSkinCache(){throw new Error("This is a static class")}function Window(){this.initialize.apply(this,arguments)}function WindowLayer(){this.initialize.apply(this,arguments)}function Weather(){this.initialize.apply(this,arguments)}function ToneFilter(){PIXI.filters.ColorMatrixFilter.call(this)}function ToneSprite(){this.initialize.apply(this,arguments)}function Stage(){this.initialize.apply(this,arguments)}function WebAudio(){this.initialize.apply(this,arguments)}function JsonEx(){throw new Error("This is a static class")}function Decrypter(){throw new Error("This is a static class")}function ResourceHandler(){throw new Error("This is a static class")}ProgressWatcher.initialize=function(){this.clearProgress(),ImageManager.setCreationHook(this._bitmapListener.bind(this)),AudioManager.setCreationHook(this._audioListener.bind(this))},ProgressWatcher._bitmapListener=function(t){this._countLoading++,t.addLoadListener(function(){this._countLoaded++,this._progressListener&&this._progressListener(this._countLoaded,this._countLoading)}.bind(this))},ProgressWatcher._audioListener=function(t){this._countLoading++,t.addLoadListener(function(){this._countLoaded++,this._progressListener&&this._progressListener(this._countLoaded,this._countLoading)}.bind(this))},ProgressWatcher.setProgressListener=function(t){this._progressListener=t},ProgressWatcher.clearProgress=function(){this._countLoading=0,this._countLoaded=0},ProgressWatcher.truncateProgress=function(){this._countLoaded&&(this._countLoading-=this._countLoaded,this._countLoaded=0)},Number.prototype.clamp=function(t,e){return Math.min(Math.max(this,t),e)},Number.prototype.mod=function(t){return(this%t+t)%t},String.prototype.format=function(){const t=arguments
return this.replace(/%([0-9]+)/g,(function(e,i){return t[Number(i)-1]}))},String.prototype.padZero=function(t){let e=this
for(;e.length<t;)e="0"+e
return e},Number.prototype.padZero=function(t){return String(this).padZero(t)},Object.defineProperties(Array.prototype,{equals:{enumerable:!1,value(t){if(!t||this.length!==t.length)return!1
for(let e=0;e<this.length;e++)if(this[e]instanceof Array&&t[e]instanceof Array){if(!this[e].equals(t[e]))return!1}else if(this[e]!==t[e])return!1
return!0}},clone:{enumerable:!1,value(){return this.slice(0)}},contains:{enumerable:!1,value(t){return this.indexOf(t)>=0}}}),String.prototype.contains=function(t){return this.indexOf(t)>=0},Math.randomInt=function(t){return Math.floor(t*Math.random())},Utils.RPGMAKER_NAME="MV",Utils.RPGMAKER_VERSION="1.6.1",Utils.RPGMAKER_ENGINE="community-1.4",Utils.isOptionValid=function(t){return!!location.search.slice(1).split("&").contains(t)||!!("undefined"!=typeof nw&&nw.App.argv.length>0&&nw.App.argv[0].split("&").contains(t))},Utils._nwjs=null,Utils.isNwjs=function(){if("boolean"==typeof Utils._nwjs)return Utils._nwjs
const t="function"==typeof require&&"object"==typeof process
return Utils._nwjs=t,t},Utils._highFps=!1,Utils.isHighFps=function(){return Utils._fpsChecked?Utils._highFps:Utils.getFps()>=66},Utils._fps=60,Utils._fpsIsBusyCounting=!1,Utils._fpsChecked=!1,
/**
 * Returns estimated monitor refresh rate.
 *
 * @static
 * @method getFps
 * @return {Number} Refresh rate
 * @credit Adapted from Adam Sassano on Stack Overflow
 * @license CC BY-SA 4.0
 */
Utils.getFps=function(){if(Utils._fpsChecked||Utils._fpsIsBusyCounting)return Utils._fps
{let t=0,e=0,i=0
const rafLoop=s=>{if(e<=180){let r
e++,i+=1e3/(s-t),t=s,requestAnimationFrame(rafLoop)}else Infinity!==Utils._fps&&(Utils._fps=i/e,Utils._fps>=66&&(Utils._highFps=!0)),Utils._fpsChecked=!0,Utils._fpsIsBusyCounting=!1}
return requestAnimationFrame((e=>{t=e,requestAnimationFrame(rafLoop)})),Utils._fpsIsBusyCounting=!0,Utils._fps}},Utils._mobileDevice=null,Utils.isMobileDevice=function(){if("boolean"==typeof Utils._mobileDevice)return Utils._mobileDevice
const t=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i,e=!!navigator.userAgent.match(t)
return Utils._mobileDevice=e,e},Utils._mobileSafari=null,Utils.isMobileSafari=function(){if("boolean"==typeof Utils._mobileSafari)return Utils._mobileSafari
const t=navigator.userAgent,e=!(!t.match(/iPhone|iPad|iPod/)||!t.match(/AppleWebKit/)||t.match("CriOS"))
return Utils._mobileSafari=e,e},Utils._androidChrome=null,Utils.isAndroidChrome=function(){if("boolean"==typeof Utils._androidChrome)return Utils._androidChrome
const t=navigator.userAgent,e=!(!t.match(/Android/)||!t.match(/Chrome/))
return Utils._androidChrome=e,e},Utils.canReadGameFiles=function(){const t=document.getElementsByTagName("script"),e=t[t.length-1],i=new XMLHttpRequest
try{return i.open("GET",e.src),i.overrideMimeType("text/javascript"),i.send(),!0}catch(t){return!1}},Utils.rgbToCssColor=function(t,e,i){return"rgb("+(t=Math.round(t))+","+(e=Math.round(e))+","+(i=Math.round(i))+")"},Utils._id=1,Utils.generateRuntimeId=function(){return Utils._id++},Utils._supportPassiveEvent=null,Utils.isSupportPassiveEvent=function(){if("boolean"==typeof Utils._supportPassiveEvent)return Utils._supportPassiveEvent
let t=!1
const e=Object.defineProperty({},"passive",{get(){t=!0}})
return window.addEventListener("test",null,e),Utils._supportPassiveEvent=t,t},CacheEntry.prototype.free=function(t){this.freedByTTL=t||!1,this.cached&&(this.cached=!1,delete this.cache._inner[this.key])},CacheEntry.prototype.allocate=function(){return this.cached||(this.cache._inner[this.key]=this,this.cached=!0),this.touch(),this},CacheEntry.prototype.setTimeToLive=function(t,e){return this.ttlTicks=t||0,this.ttlSeconds=e||0,this},CacheEntry.prototype.isStillAlive=function(){const t=this.cache
return(0==this.ttlTicks||this.touchTicks+this.ttlTicks<t.updateTicks)&&(0==this.ttlSeconds||this.touchSeconds+this.ttlSeconds<t.updateSeconds)},CacheEntry.prototype.touch=function(){const t=this.cache
this.cached?(this.touchTicks=t.updateTicks,this.touchSeconds=t.updateSeconds):this.freedByTTL&&(this.freedByTTL=!1,t._inner[this.key]||(t._inner[this.key]=this))},CacheMap.prototype.checkTTL=function(){const t=this._inner
let e=this._lastRemovedEntries
e||(e=[],this._lastRemovedEntries=e)
for(let i in t){const s=t[i]
s.isStillAlive()||e.push(s)}for(let t=0;t<e.length;t++)e[t].free(!0)
e.length=0},CacheMap.prototype.getItem=function(t){const e=this._inner[t]
return e?e.item:null},CacheMap.prototype.clear=function(){const t=Object.keys(this._inner)
for(let e=0;e<t.length;e++)this._inner[t[e]].free()},CacheMap.prototype.setItem=function(t,e){return new CacheEntry(this,t,e).allocate()},CacheMap.prototype.update=function(t,e){this.updateTicks+=t,this.updateSeconds+=e,this.updateSeconds>=this.delayCheckTTL+this.lastCheckTTL&&(this.lastCheckTTL=this.updateSeconds,this.checkTTL())},ImageCache.limit=1e7,ImageCache.prototype.initialize=function(){this._items={}},ImageCache.prototype.add=function(t,e){this._items[t]={bitmap:e,touch:Date.now(),key:t},this._truncateCache()},ImageCache.prototype.get=function(t){if(this._items[t]){const e=this._items[t]
return e.touch=Date.now(),e.bitmap}return null},ImageCache.prototype.reserve=function(t,e,i){this._items[t]||(this._items[t]={bitmap:e,touch:Date.now(),key:t}),this._items[t].reservationId=i},ImageCache.prototype.releaseReservation=function(t){const e=this._items
Object.keys(e).map((function(t){return e[t]})).forEach((function(e){e.reservationId===t&&delete e.reservationId}))},ImageCache.prototype._truncateCache=function(){const t=this._items
let e=ImageCache.limit
Object.keys(t).map((function(e){return t[e]})).sort((function(t,e){return e.touch-t.touch})).forEach(function(i){if(e>0||this._mustBeHeld(i)){const t=i.bitmap
e-=t.width*t.height}else delete t[i.key]}.bind(this))},ImageCache.prototype._mustBeHeld=function(t){return!(t.bitmap.isRequestOnly()||!t.reservationId&&t.bitmap.isReady())},ImageCache.prototype.isReady=function(){const t=this._items
return!Object.keys(t).some((function(e){return!t[e].bitmap.isRequestOnly()&&!t[e].bitmap.isReady()}))},ImageCache.prototype.getErrorBitmap=function(){const t=this._items
let e=null
return Object.keys(t).some((function(i){return!!t[i].bitmap.isError()&&(e=t[i].bitmap,!0)}))?e:null},RequestQueue.prototype.initialize=function(){this._queue=[]},RequestQueue.prototype.enqueue=function(t,e){this._queue.push({key:t,value:e})},RequestQueue.prototype.update=function(){if(0===this._queue.length)return
const t=this._queue[0]
t.value.isRequestReady()?(this._queue.shift(),0!==this._queue.length&&this._queue[0].value.startRequest()):t.value.startRequest()},RequestQueue.prototype.raisePriority=function(t){for(let e=0;e<this._queue.length;e++){const i=this._queue[e]
if(i.key===t){this._queue.splice(e,1),this._queue.unshift(i)
break}}},RequestQueue.prototype.clear=function(){this._queue.splice(0)},Point.prototype=Object.create(PIXI.Point.prototype),Point.prototype.constructor=Point,Point.prototype.initialize=function(t,e){PIXI.Point.call(this,t,e)},Rectangle.prototype=Object.create(PIXI.Rectangle.prototype),Rectangle.prototype.constructor=Rectangle,Rectangle.prototype.initialize=function(t,e,i,s){PIXI.Rectangle.call(this,t,e,i,s)},Rectangle.emptyRectangle=new Rectangle(0,0,0,0),Bitmap._reuseImages=[],Bitmap.prototype._createCanvas=function(t,e){if(this.__canvas=this.__canvas||document.createElement("canvas"),this.__context=this.__canvas.getContext("2d"),this.__canvas.width=Math.max(t||0,1),this.__canvas.height=Math.max(e||0,1),this._image){const t=Math.max(this._image.width||0,1),e=Math.max(this._image.height||0,1)
this.__canvas.width=t,this.__canvas.height=e,this._createBaseTexture(this._canvas),this.__context.drawImage(this._image,0,0)}this._setDirty()},Bitmap.prototype._createBaseTexture=function(t){this.__baseTexture=new PIXI.BaseTexture(t),this.__baseTexture.mipmap=!1,this.__baseTexture.width=t.width,this.__baseTexture.height=t.height,this._baseTexture.scaleMode=PIXI.SCALE_MODES.NEAREST},Bitmap.prototype._clearImgInstance=function(){this._image.src="",this._image.onload=null,this._image.onerror=null,this._errorListener=null,this._loadListener=null,Bitmap._reuseImages.push(this._image),this._image=null},Object.defineProperties(Bitmap.prototype,{_canvas:{get(){return this.__canvas||this._createCanvas(),this.__canvas}},_context:{get(){return this.__context||this._createCanvas(),this.__context}},_baseTexture:{get(){return this.__baseTexture||this._createBaseTexture(this._image||this.__canvas),this.__baseTexture}}}),Bitmap.prototype._renewCanvas=function(){const t=this._image
t&&this.__canvas&&(this.__canvas.width<t.width||this.__canvas.height<t.height)&&this._createCanvas()},Bitmap.prototype.initialize=function(t,e){this._defer||this._createCanvas(t,e),this._image=null,this._url="",this._paintOpacity=255,this._smooth=!1,this._loadListeners=[],this._loadingState="none",this._decodeAfterRequest=!1,this.cacheEntry=null,this.fontFace="GameFont",this.fontSize=28,this.fontItalic=!1,this.textColor="#ffffff",this.outlineColor="rgba(0, 0, 0, 0.5)",this.outlineWidth=4},Bitmap.load=function(t){const e=Object.create(Bitmap.prototype)
return e._defer=!0,e.initialize(),e._decodeAfterRequest=!0,e._requestImage(t),e},Bitmap.snap=function(t){const e=Graphics.width,i=Graphics.height,s=new Bitmap(e,i),r=s._context,n=PIXI.RenderTexture.create({width:e,height:i})
if(t){Graphics._renderer.render(t,{renderTexture:n}),t.worldTransform.identity()
let e=null
e=Graphics.isWebGL()?Graphics._renderer.plugins.extract.canvas(n):n.baseTexture._canvasRenderTarget.canvas,r.drawImage(e,0,0)}return n.destroy({destroyBase:!0}),s._setDirty(),s},Bitmap.prototype.isReady=function(){return"loaded"===this._loadingState||"none"===this._loadingState},Bitmap.prototype.isError=function(){return"error"===this._loadingState},Bitmap.prototype.touch=function(){this.cacheEntry&&this.cacheEntry.touch()},Object.defineProperty(Bitmap.prototype,"url",{get(){return this._url},configurable:!0}),Object.defineProperty(Bitmap.prototype,"baseTexture",{get(){return this._baseTexture},configurable:!0}),Object.defineProperty(Bitmap.prototype,"canvas",{get(){return this._canvas},configurable:!0}),Object.defineProperty(Bitmap.prototype,"context",{get(){return this._context},configurable:!0}),Object.defineProperty(Bitmap.prototype,"width",{get(){return this.isReady()?this._image?this._image.width:this._canvas.width:0},configurable:!0}),Object.defineProperty(Bitmap.prototype,"height",{get(){return this.isReady()?this._image?this._image.height:this._canvas.height:0},configurable:!0}),Object.defineProperty(Bitmap.prototype,"rect",{get(){return new Rectangle(0,0,this.width,this.height)},configurable:!0}),Object.defineProperty(Bitmap.prototype,"smooth",{get(){return this._smooth},set(t){!1!==this._smooth&&(this._smooth=!1)},configurable:!0}),Object.defineProperty(Bitmap.prototype,"paintOpacity",{get(){return this._paintOpacity},set(t){this._paintOpacity!==t&&(this._paintOpacity=t,this._context.globalAlpha=this._paintOpacity/255)},configurable:!0}),Bitmap.prototype.resize=function(t,e){t=Math.max(t||0,1),e=Math.max(e||0,1),this._canvas.width=t,this._canvas.height=e,this._baseTexture.width=t,this._baseTexture.height=e},Bitmap.prototype.blt=function(t,e,i,s,r,n,o,a,h){a=a||s,h=h||r,e=Math.floor(e),i=Math.floor(i),s=Math.floor(s),r=Math.floor(r),n=Math.floor(n),o=Math.floor(o),a=Math.floor(a),h=Math.floor(h),e>=0&&i>=0&&s>0&&r>0&&a>0&&h>0&&e+s<=t.width&&i+r<=t.height&&(this._context.globalCompositeOperation="source-over",this._context.drawImage(t._canvas,e,i,s,r,n,o,a,h),this._setDirty())},Bitmap.prototype.bltImage=function(t,e,i,s,r,n,o,a,h){a=a||s,h=h||r,e>=0&&i>=0&&s>0&&r>0&&a>0&&h>0&&e+s<=t.width&&i+r<=t.height&&(this._context.globalCompositeOperation="source-over",this._context.drawImage(t._image,e,i,s,r,n,o,a,h),this._setDirty())},Bitmap.prototype.getPixel=function(t,e){const i=this._context.getImageData(t,e,1,1).data
let s="#"
for(let t=0;t<3;t++)s+=i[t].toString(16).padZero(2)
return s},Bitmap.prototype.getAlphaPixel=function(t,e){const i=void 0
return this._context.getImageData(t,e,1,1).data[3]},Bitmap.prototype.clearRect=function(t,e,i,s){this._context.clearRect(t,e,i,s),this._setDirty()},Bitmap.prototype.clear=function(){this.clearRect(0,0,this.width,this.height)},Bitmap.prototype.fillRect=function(t,e,i,s,r){t=Math.floor(t),e=Math.floor(e),i=Math.floor(i),s=Math.floor(s)
const n=this._context
n.save(),n.fillStyle=r,n.fillRect(t,e,i,s),n.restore(),this._setDirty()},Bitmap.prototype.fillAll=function(t){this.fillRect(0,0,this.width,this.height,t)},Bitmap.prototype.gradientFillRect=function(t,e,i,s,r,n,o){const a=this._context
let h
h=o?a.createLinearGradient(t,e,t,e+s):a.createLinearGradient(t,e,t+i,e),h.addColorStop(0,r),h.addColorStop(1,n),a.save(),a.fillStyle=h,a.fillRect(t,e,i,s),a.restore(),this._setDirty()},Bitmap.prototype.drawCircle=function(t,e,i,s){t=Math.floor(t),e=Math.floor(e)
const r=this._context
r.save(),r.fillStyle=s,r.beginPath(),r.arc(t,e,i,0,2*Math.PI,!1),r.fill(),r.restore(),this._setDirty()},Bitmap.prototype.drawText=function(t,e,i,s,r,n){if(void 0!==t){e=Math.floor(e),i=Math.floor(i),s=Math.floor(s)||4294967295
let o=e
const a=i+(r=Math.floor(r))-Math.round((r-.7*this.fontSize)/2),h=this._context,p=h.globalAlpha
"center"===n&&(o+=s/2),"right"===n&&(o+=s),h.save(),h.font=this._makeFontNameText(),h.textAlign=n,h.textBaseline="alphabetic",h.globalAlpha=1,this._drawTextOutline(t,o,a,s),h.globalAlpha=p,this._drawTextBody(t,o,a,s),h.restore(),this._setDirty()}},Bitmap.prototype.drawSmallText=function(t,e,i,s,r,n){},Bitmap.prototype.measureTextWidth=function(t){const e=this._context
e.save(),e.font=this._makeFontNameText()
const i=e.measureText(t).width
return e.restore(),i},Bitmap.prototype.adjustTone=function(t,e,i){if((t||e||i)&&this.width>0&&this.height>0){const s=this._context,r=s.getImageData(0,0,this.width,this.height),n=r.data
for(let s=0;s<n.length;s+=4)n[s+0]+=t,n[s+1]+=e,n[s+2]+=i
s.putImageData(r,0,0),this._setDirty()}},Bitmap.prototype.rotateHue=function(t){if(t&&t&&this.width>0&&this.height>0){t=(t%360+360)%360
const e=this._context,i=e.getImageData(0,0,this.width,this.height),s=i.data
for(let e=0;e<s.length;e+=4){const i=rgbToHsl(s[e+0],s[e+1],s[e+2]),r=void 0,n=void 0,o=void 0,a=hslToRgb((i[0]+t)%360,i[1],i[2])
s[e+0]=a[0],s[e+1]=a[1],s[e+2]=a[2]}e.putImageData(i,0,0),this._setDirty()}function rgbToHsl(t,e,i){const s=Math.min(t,e,i),r=Math.max(t,e,i)
let n=0,o=0
const a=(s+r)/2,h=r-s
return h>0&&(n=t===r?((e-i)/h+6)%6*60:e===r?60*((i-t)/h+2):60*((t-e)/h+4),o=h/(255-Math.abs(2*a-255))),[n,o,a]}function hslToRgb(t,e,i){const s=(255-Math.abs(2*i-255))*e,r=void 0,n=i-s/2,o=s+n,a=s*(1-Math.abs(t/60%2-1))+n
return t<60?[o,a,n]:t<120?[a,o,n]:t<180?[n,o,a]:t<240?[n,a,o]:t<300?[a,n,o]:[o,n,a]}},Bitmap.prototype.blur=function(){for(let t=0;t<2;t++){const t=this.width,e=this.height,i=this._canvas,s=this._context,r=document.createElement("canvas"),n=r.getContext("2d")
r.width=t+2,r.height=e+2,n.drawImage(i,0,0,t,e,1,1,t,e),n.drawImage(i,0,0,t,1,1,0,t,1),n.drawImage(i,0,0,1,e,0,1,1,e),n.drawImage(i,0,e-1,t,1,1,e+1,t,1),n.drawImage(i,t-1,0,1,e,t+1,1,1,e),s.save(),s.fillStyle="black",s.fillRect(0,0,t,e),s.globalCompositeOperation="lighter",s.globalAlpha=1/9
for(let i=0;i<3;i++)for(let n=0;n<3;n++)s.drawImage(r,n,i,t,e,0,0,t,e)
s.restore()}this._setDirty()},Bitmap.prototype.addLoadListener=function(t){this.isReady()?t(this):this._loadListeners.push(t)},Bitmap.prototype._makeFontNameText=function(){return(this.fontItalic?"Italic ":"")+this.fontSize+"px "+this.fontFace},Bitmap.prototype._drawTextOutline=function(t,e,i,s){const r=this._context
r.strokeStyle=this.outlineColor,r.lineWidth=this.outlineWidth,r.lineJoin="round",r.strokeText(t,e,i,s)},Bitmap.prototype._drawTextBody=function(t,e,i,s){const r=this._context
r.fillStyle=this.textColor,r.fillText(t,e,i,s)},Bitmap.prototype._onLoad=function(){switch(this._image.removeEventListener("load",this._loadListener),this._image.removeEventListener("error",this._errorListener),this._renewCanvas(),this._loadingState){case"requesting":this._loadingState="requestCompleted",this._decodeAfterRequest?this.decode():(this._loadingState="purged",this._clearImgInstance())
break
case"decrypting":window.URL.revokeObjectURL(this._image.src),this._loadingState="decryptCompleted",this._decodeAfterRequest?this.decode():(this._loadingState="purged",this._clearImgInstance())}},Bitmap.prototype.decode=function(){switch(this._loadingState){case"requestCompleted":case"decryptCompleted":this._loadingState="loaded",this.__canvas||this._createBaseTexture(this._image),this._setDirty(),this._callLoadListeners()
break
case"requesting":case"decrypting":this._decodeAfterRequest=!0,this._loader||(this._loader=ResourceHandler.createLoader(this._url,this._requestImage.bind(this,this._url),this._onError.bind(this)),this._image.removeEventListener("error",this._errorListener),this._image.addEventListener("error",this._errorListener=this._loader))
break
case"pending":case"purged":case"error":this._decodeAfterRequest=!0,this._requestImage(this._url)}},Bitmap.prototype._callLoadListeners=function(){for(;this._loadListeners.length>0;){const t=void 0
this._loadListeners.shift()(this)}},Bitmap.prototype._onError=function(){this._image.removeEventListener("load",this._loadListener),this._image.removeEventListener("error",this._errorListener),this._loadingState="error"},Bitmap.prototype._setDirty=function(){this._dirty=!0},Bitmap.prototype.checkDirty=function(){if(this._dirty){this._baseTexture.update()
const t=this._baseTexture
setTimeout((function(){t.update()}),0),this._dirty=!1}},Bitmap.request=function(t){const e=Object.create(Bitmap.prototype)
return e._defer=!0,e.initialize(),e._url=t,e._loadingState="pending",e},Bitmap.prototype._requestImage=function(t){0!==Bitmap._reuseImages.length?this._image=Bitmap._reuseImages.pop():this._image=new Image,this._decodeAfterRequest&&!this._loader&&(this._loader=ResourceHandler.createLoader(t,this._requestImage.bind(this,t),this._onError.bind(this))),this._url=t,this._loadingState="requesting",!Decrypter.checkImgIgnore(t)&&Decrypter.hasEncryptedImages?(this._loadingState="decrypting",Decrypter.decryptImg(t,this)):(this._image.src=t,this._image.addEventListener("load",this._loadListener=Bitmap.prototype._onLoad.bind(this)),this._image.addEventListener("error",this._errorListener=this._loader||Bitmap.prototype._onError.bind(this)))},Bitmap.prototype.isRequestOnly=function(){return!(this._decodeAfterRequest||this.isReady())},Bitmap.prototype.isRequestReady=function(){return"pending"!==this._loadingState&&"requesting"!==this._loadingState&&"decrypting"!==this._loadingState},Bitmap.prototype.startRequest=function(){"pending"===this._loadingState&&(this._decodeAfterRequest=!1,this._requestImage(this._url))},BitmapPIXI.prototype=Object.create(PIXI.Container.prototype),BitmapPIXI.prototype.constructor=BitmapPIXI,BitmapPIXI.prototype.initialize=function(t,e){PIXI.Container.call(this),t=Math.max(t||0,1),e=Math.max(e||0,1),this._width=t,this._height=e,this._paintOpacity=255,this.textPadding=2,this.wordWrap=!1,this.wordWrapWidth=0,this.fontFace="GameFont",this.fontSize=28,this.fontItalic=!1,this.textColor="#ffffff",this.outlineColor="rgba(0, 0, 0, 0.5)",this.outlineWidth=4,this.textCache=[],this.on("removed",this.onRemoveAsAChild)},BitmapPIXI.prototype.onRemoveAsAChild=function(){this.textCache=[]
for(let t=this.children.length-1;t>=0;t--)this.children[t].destroy({children:!0,texture:!0}),this.removeChild(this.children[t])},Object.defineProperty(BitmapPIXI.prototype,"paintOpacity",{get(){return this._paintOpacity},set(t){this._paintOpacity!==t&&(this._paintOpacity=t)},configurable:!0}),Object.defineProperty(BitmapPIXI.prototype,"width",{get(){return this._width},set(t){this._width!==t&&(this._width=t)},configurable:!0}),Object.defineProperty(BitmapPIXI.prototype,"height",{get(){return this._height},set(t){this._height!==t&&(this._height=t)},configurable:!0}),BitmapPIXI.prototype.resize=function(t,e){t=Math.max(t||0,1),e=Math.max(e||0,1),this._width=t,this._height=e},BitmapPIXI.prototype.clear=function(){for(let t=this.children.length-1;t>=0;t--)this.children[t].isBitmapText?this.children[t].text="":(this.children[t].destroy({children:!0,texture:!0}),this.removeChild(this.children[t]))},BitmapPIXI.prototype.clearRect=function(t,e,i,s){const r=this,n=[]
this.children.forEach((function(r){r&&r.x>=t&&r.x<t+i&&r.y>=e&&r.y<e+s&&(r.isBitmapText?r.text="":n.push(r))})),n.forEach((function(t){t.destroy({children:!0,texture:!0}),r.removeChild(t)}))},BitmapPIXI.prototype.drawText=function(t,e,i,s,r,n){if(void 0===t)return
const o=this._paintOpacity/255
s=Math.floor(s)||4294967295,r=Math.floor(r),t=String(t),"center"===n?e+=s/2:"right"===n&&(e+=s),i=i+r-1.25*this.fontSize,e=Math.floor(e),i=Math.floor(i)
const a=void 0
this._updateExistingText(t,e,i,o)||this._drawNewText(t,e,i,o,s,r,n)},BitmapPIXI.prototype._updateExistingText=function(t,e,i,s){for(let r=0;r<this.textCache.length;r++){const n=this.textCache[r]
if(n.x===e&&n.y===i){const e=PIXI.utils.string2hex(this.textColor)
return n._tint!==e&&(n.tint=e),n.text!==t&&(n.text=t),n.alpha!==s&&(n.alpha=s),this.addChild(n),!0}}return!1},BitmapPIXI.prototype._drawNewText=function(t,e,i,s,r,n,o){const a={fontFamily:this.fontFace,fontSize:this.fontSize,fill:16777215,lineHeight:n,wordWrap:this.wordWrap,wordWrapWidth:this.wordWrapWidth,padding:this.textPadding,fontStyle:this.fontItalic?"italic":"normal",stroke:this.outlineColor,strokeThickness:this.outlineWidth}
PIXI.BitmapFont.available[a.fontFamily]||this._makeBitmapFont(a)
const h=new PIXI.BitmapText(t,{fontName:a.fontFamily,fontSize:a.fontSize})
!a.wordWrap&&h.width>r&&(h.scale.x=r/h.width),"center"===o?h.anchor.set(.5,0):"right"===o&&h.anchor.set(1,0),h&&(h.x=e,h.y=i,h.tint=PIXI.utils.string2hex(this.textColor),h.alpha=s,h.isBitmapText=!0,this.textCache.push(h),this.addChild(h))},BitmapPIXI.prototype._makeBitmapFont=function(t){const e={chars:[[" ","~"],"→","’"]}
PIXI.BitmapFont.from(t.fontFamily,t,e)},BitmapPIXI.prototype.measureTextWidth=function(t){t=String(t)
const e=new PIXI.TextStyle({fontFamily:this.fontFace,fontSize:this.fontSize,padding:this.textPadding}),i=void 0
return PIXI.TextMetrics.measureText(t,e).width},BitmapPIXI.prototype.create9Slice=function(t,e,i,s,r,n,o,a,h){return new PIXI.NineSlicePlane(new PIXI.Texture(t,new PIXI.Rectangle(e,i,s,r)),n,o,a,h)},BitmapPIXI.prototype.createTilingSprite=function(t,e,i,s,r,n,o){return new PIXI.TilingSprite(new PIXI.Texture(t,new PIXI.Rectangle(e,i,s,r)),n,o)},BitmapPIXI.prototype.createCroppedSprite=function(t,e,i,s,r){return new PIXI.Sprite(new PIXI.Texture(t,new PIXI.Rectangle(e,i,s,r)))},BitmapPIXI.prototype.blt=function(t,e,i,s,r,n,o,a,h){if(a=a||s,h=h||r,e=Math.floor(e),i=Math.floor(i),s=Math.floor(s),r=Math.floor(r),n=Math.floor(n),o=Math.floor(o),a=Math.floor(a),h=Math.floor(h),e>=0&&i>=0&&s>0&&r>0&&a>0&&h>0&&e+s<=t.width&&i+r<=t.height){const p=this.createCroppedSprite(t.baseTexture,e,i,s,r)
if(p)return p.x=n,p.y=o,p.width=a,p.height=h,p.alpha=this._paintOpacity/255,this.addChild(p),p}},BitmapPIXI.prototype.fillRect=function(t,e,i,s,r){t=Math.floor(t),e=Math.floor(e),i=Math.floor(i),s=Math.floor(s)
const n=new PIXI.Graphics
return r=PIXI.utils.string2hex(r),n.beginFill(r),n.drawRect(0,0,i,s),n.endFill(),n&&(n.x=t,n.y=e,n.alpha=this._paintOpacity/255,this.addChild(n)),n},BitmapPIXI.prototype.gradientFillRect=function(t,e,i,s,r,n,o){return this.fillRect(t,e,i,s,r)},BitmapPIXI.prototype.drawCircle=function(t,e,i,s){t=Math.floor(t),e=Math.floor(e)
const r=new PIXI.Graphics
return s=PIXI.utils.string2hex(s),r.beginFill(s),r.drawCircle(0,0,i),r.endFill(),r&&(r.x=t,r.y=e,r.alpha=this._paintOpacity/255,this.addChild(r)),r},Graphics._cssFontLoading=document.fonts&&document.fonts.ready&&document.fonts.ready.then,Graphics._fontLoaded=null,Graphics._videoVolume=1,Graphics.initialize=function(t,e,i){this._width=t||800,this._height=e||600,this._rendererType=i||"auto",this._boxWidth=this._width,this._boxHeight=this._height,this._scale=1,this._realScale=1,this._errorShowed=!1,this._errorPrinter=null,this._canvas=null,this._video=null,this._videoUnlocked=!1,this._videoLoading=!1,this._upperCanvas=null,this._fpsMeter=null,this._modeBox=null,this._skipCount=0,this._maxSkip=3,this._rendered=!1,this._loadingImage=null,this._loadingCount=0,this._fpsMeterToggled=!1,this._stretchEnabled=this._defaultStretchMode(),this._canUseDifferenceBlend=!1,this._canUseSaturationBlend=!1,this._hiddenCanvas=null,this._app=null,this._testCanvasBlendModes(),this._modifyExistingElements(),this._updateRealScale(),this._createAllElements(),this._disableTextSelection(),this._disableContextMenu(),this._setupEventHandlers(),this._setupCssFontLoading(),this._setupProgress()},Graphics._setupCssFontLoading=function(){Graphics._cssFontLoading&&document.fonts.ready.then((function(t){Graphics._fontLoaded=t})).catch((function(t){SceneManager.onError(t)}))},Graphics.canUseCssFontLoading=function(){return!!this._cssFontLoading},Object.defineProperty(Graphics,"app",{get(){return this._app},configurable:!0}),Object.defineProperty(Graphics,"_renderer",{get(){return this._app.renderer},configurable:!0}),Graphics.frameCount=0,Graphics.BLEND_NORMAL=0,Graphics.BLEND_ADD=1,Graphics.BLEND_MULTIPLY=2,Graphics.BLEND_SCREEN=3,Graphics.tickStart=function(){},Graphics.tickEnd=function(){},Graphics.render=function(t){t&&(this._app.stage=t)},Graphics.isWebGL=function(){return this._renderer&&this._renderer.type===PIXI.RENDERER_TYPE.WEBGL},Graphics._canWebGL=null,Graphics.hasWebGL=function(){if("boolean"==typeof Graphics._canWebGL)return Graphics._canWebGL
try{const t=document.createElement("canvas"),e=!(!t.getContext("webgl")&&!t.getContext("experimental-webgl"))
return Graphics._canWebGL=e,e}catch(t){return Graphics._canWebGL=!1,!1}},Graphics.canUseDifferenceBlend=function(){return this._canUseDifferenceBlend},Graphics.canUseSaturationBlend=function(){return this._canUseSaturationBlend},Graphics.setLoadingImage=function(t){this._loadingImage=new Image,this._loadingImage.src=t},Graphics.setProgressEnabled=function(t){this._progressEnabled=t},Graphics.startLoading=function(){this._loadingCount=0,ProgressWatcher.truncateProgress(),ProgressWatcher.setProgressListener(this._updateProgressCount.bind(this)),this._progressTimeout=setTimeout((function(){Graphics._showProgress()}),1500)},Graphics._setupProgress=function(){this._progressElement=document.createElement("div"),this._progressElement.id="loading-progress",this._progressElement.width=600,this._progressElement.height=300,this._progressElement.style.visibility="hidden",this._barElement=document.createElement("div"),this._barElement.id="loading-bar",this._barElement.style.width="100%",this._barElement.style.height="10%",this._barElement.style.background="linear-gradient(to top, gray, lightgray)",this._barElement.style.border="5px solid white",this._barElement.style.borderRadius="15px",this._barElement.style.marginTop="40%",this._filledBarElement=document.createElement("div"),this._filledBarElement.id="loading-filled-bar",this._filledBarElement.style.width="0%",this._filledBarElement.style.height="100%",this._filledBarElement.style.background="linear-gradient(to top, lime, honeydew)",this._filledBarElement.style.borderRadius="10px",this._progressElement.appendChild(this._barElement),this._barElement.appendChild(this._filledBarElement),this._updateProgress(),document.body.appendChild(this._progressElement)},Graphics._showProgress=function(){this._progressEnabled&&(this._progressElement.value=0,this._progressElement.style.visibility="visible",this._progressElement.style.zIndex=98)},Graphics._hideProgress=function(){this._progressElement&&(this._progressElement.style.visibility="hidden"),clearTimeout(this._progressTimeout)},Graphics._updateProgressCount=function(t,e){let i
i=0!==e?t/e*100:100,this._filledBarElement.style.width=i+"%"},Graphics._updateProgress=function(){this._centerElement(this._progressElement)},Graphics.updateLoading=function(){this._loadingCount++,this._paintUpperCanvas(),this._upperCanvas.style.opacity=1,this._updateProgress()},Graphics.endLoading=function(){this._clearUpperCanvas(),this._upperCanvas.style.opacity=0,this._hideProgress()},Graphics.printLoadingError=function(t){if(this._errorPrinter&&!this._errorShowed){this._updateErrorPrinter(),this._errorPrinter.innerHTML=this._makeErrorHtml("Loading Error","Failed to load: "+t),this._errorPrinter.style.userSelect="text",this._errorPrinter.style.webkitUserSelect="text",this._errorPrinter.style.msUserSelect="text",this._errorPrinter.style.mozUserSelect="text",this._errorPrinter.oncontextmenu=null
const e=document.createElement("button")
e.innerHTML="Retry",e.style.fontSize="24px",e.style.color="#ffffff",e.style.backgroundColor="#000000",e.addEventListener("touchstart",(function(t){t.stopPropagation()})),e.addEventListener("click",(function(t){ResourceHandler.retry()})),this._errorPrinter.appendChild(e),this._loadingCount=-Infinity}},Graphics.eraseLoadingError=function(){this._errorPrinter&&!this._errorShowed&&(this._errorPrinter.innerHTML="",this._errorPrinter.style.userSelect="none",this._errorPrinter.style.webkitUserSelect="none",this._errorPrinter.style.msUserSelect="none",this._errorPrinter.style.mozUserSelect="none",this._errorPrinter.oncontextmenu=function(){return!1},this._loadingCount=0)},Graphics.printError=function(t,e){this._errorShowed=!0,this._hideProgress(),this.hideFps(),this._errorPrinter&&(this._updateErrorPrinter(),this._errorPrinter.innerHTML=this._makeErrorHtml(t,e),this._errorPrinter.style.userSelect="text",this._errorPrinter.style.webkitUserSelect="text",this._errorPrinter.style.msUserSelect="text",this._errorPrinter.style.mozUserSelect="text",this._errorPrinter.oncontextmenu=null,this._errorMessage&&this._makeErrorMessage()),this._applyCanvasFilter(),this._clearUpperCanvas()},Graphics.printErrorDetail=function(t){if(this._errorPrinter&&this._showErrorDetail){const e=this._formatEventInfo(t),i=this._formatEventCommandInfo(t),s=i?e+", "+i:e,r=this._formatStackTrace(t)
this._makeErrorDetail(s,r)}},Graphics.setErrorMessage=function(t){this._errorMessage=t},Graphics.setShowErrorDetail=function(t){this._showErrorDetail=t},Graphics.showFps=function(){this._fpsMeter&&(this._fpsMeter.extensions.pixi||this._fpsMeter.enableExtension("pixi",[PIXI,this._app]),document.body.appendChild(this._fpsMeter.dom),this._fpsMeter.show(!0))},Graphics.hideFps=function(){this._fpsMeter&&(document.body.removeChild(this._fpsMeter.dom),this._fpsMeter.show(!1))},Graphics.loadFont=function(t,e){const i=document.createElement("style"),s=document.getElementsByTagName("head"),r='@font-face { font-family: "'+t+'"; src: url("'+e+'"); }'
i.type="text/css",s.item(0).appendChild(i),i.sheet.insertRule(r,0),this._createFontLoader(t)},Graphics.isFontLoaded=function(t){if(Graphics._cssFontLoading)return!!Graphics._fontLoaded&&Graphics._fontLoaded.check('10px "'+t+'"')
{this._hiddenCanvas||(this._hiddenCanvas=document.createElement("canvas"))
const e=this._hiddenCanvas.getContext("2d"),i="abcdefghijklmnopqrstuvwxyz"
let s,r
return e.font="40px "+t+", sans-serif",s=e.measureText(i).width,e.font="40px sans-serif",r=e.measureText(i).width,s!==r}},Graphics.playVideo=function(t){this._videoLoader=ResourceHandler.createLoader(null,this._playVideo.bind(this,t),this._onVideoError.bind(this)),this._playVideo(t)},Graphics._playVideo=function(t){this._video.src=t,this._video.onloadeddata=this._onVideoLoad.bind(this),this._video.onerror=this._videoLoader,this._video.onended=this._onVideoEnd.bind(this),this._video.load(),this._videoLoading=!0},Graphics.isVideoPlaying=function(){return this._videoLoading||this._isVideoVisible()},Graphics.canPlayVideoType=function(t){return this._video&&this._video.canPlayType(t)},Graphics.setVideoVolume=function(t){this._videoVolume=t,this._video&&(this._video.volume=this._videoVolume)},Graphics.pageToCanvasX=function(t){if(this._canvas){const e=this._canvas.offsetLeft
return Math.round((t-e)/this._realScale)}return 0},Graphics.pageToCanvasY=function(t){if(this._canvas){const e=this._canvas.offsetTop
return Math.round((t-e)/this._realScale)}return 0},Graphics.isInsideCanvas=function(t,e){return t>=0&&t<this._width&&e>=0&&e<this._height},Graphics.callGC=function(){Graphics.isWebGL()&&Graphics._renderer.textureGC.run()},Object.defineProperty(Graphics,"width",{get(){return this._width},set(t){this._width!==t&&(this._width=t,this._updateAllElements())},configurable:!0}),Object.defineProperty(Graphics,"height",{get(){return this._height},set(t){this._height!==t&&(this._height=t,this._updateAllElements())},configurable:!0}),Object.defineProperty(Graphics,"boxWidth",{get(){return this._boxWidth},set(t){this._boxWidth=t},configurable:!0}),Object.defineProperty(Graphics,"boxHeight",{get(){return this._boxHeight},set(t){this._boxHeight=t},configurable:!0}),Object.defineProperty(Graphics,"scale",{get(){return this._scale},set(t){this._scale!==t&&(this._scale=t,this._updateAllElements())},configurable:!0}),Graphics._createAllElements=function(){this._createErrorPrinter(),this._createCanvas(),this._createVideo(),this._createUpperCanvas(),this._createRenderer(),this._createPixiApp(),this._createFPSMeter(),this._createModeBox(),this._createGameFontLoader()},Graphics._updateAllElements=function(){this._updateRealScale(),this._updateErrorPrinter(),this._updateCanvas(),this._updateVideo(),this._updateUpperCanvas(),this._updateRenderer(),this._paintUpperCanvas(),this._updateProgress()},Graphics._updateRealScale=function(){if(this._stretchEnabled){let t=window.innerWidth/this._width,e=window.innerHeight/this._height
t>=1&&t-.01<=1&&(t=1),e>=1&&e-.01<=1&&(e=1),this._realScale=Math.min(t,e)}else this._realScale=this._scale},Graphics._makeErrorHtml=function(t,e){return'<font color="yellow"><b>'+t+'</b></font><br><font color="white">'+decodeURIComponent(e)+"</font><br>"},Graphics._defaultStretchMode=function(){return Utils.isNwjs()||Utils.isMobileDevice()},Graphics._testCanvasBlendModes=function(){let t,e,i,s
t=document.createElement("canvas"),t.width=1,t.height=1,e=t.getContext("2d"),e.globalCompositeOperation="source-over",e.fillStyle="white",e.fillRect(0,0,1,1),e.globalCompositeOperation="difference",e.fillStyle="white",e.fillRect(0,0,1,1),i=e.getImageData(0,0,1,1),e.globalCompositeOperation="source-over",e.fillStyle="black",e.fillRect(0,0,1,1),e.globalCompositeOperation="saturation",e.fillStyle="white",e.fillRect(0,0,1,1),s=e.getImageData(0,0,1,1),this._canUseDifferenceBlend=0===i.data[0],this._canUseSaturationBlend=0===s.data[0]},Graphics._modifyExistingElements=function(){const t=document.getElementsByTagName("*")
for(let e=0;e<t.length;e++)t[e].style.zIndex>0&&(t[e].style.zIndex=0)},Graphics._createErrorPrinter=function(){this._errorPrinter=document.createElement("p"),this._errorPrinter.id="ErrorPrinter",this._updateErrorPrinter(),document.body.appendChild(this._errorPrinter)},Graphics._updateErrorPrinter=function(){this._errorPrinter.width=.9*this._width,this._errorShowed&&this._showErrorDetail?this._errorPrinter.height=.9*this._height:this._errorShowed&&this._errorMessage?this._errorPrinter.height=100:this._errorPrinter.height=40,this._errorPrinter.style.textAlign="center",this._errorPrinter.style.textShadow="1px 1px 3px #000",this._errorPrinter.style.fontSize="20px",this._errorPrinter.style.zIndex=99,this._centerElement(this._errorPrinter)},Graphics._makeErrorMessage=function(){const t=document.createElement("div"),e=t.style
e.color="white",e.textAlign="left",e.fontSize="18px",t.innerHTML="<hr>"+this._errorMessage,this._errorPrinter.appendChild(t)},Graphics._makeErrorDetail=function(t,e){const i=document.createElement("div"),s=i.style
s.color="white",s.textAlign="left",s.fontSize="18px",i.innerHTML="<br><hr>"+t+"<br><br>"+e,this._errorPrinter.appendChild(i)},Graphics._formatEventInfo=function(t){switch(String(t.eventType)){case"map_event":return"MapID: %1, MapEventID: %2, page: %3, line: %4".format(t.mapId,t.mapEventId,t.page,t.line)
case"common_event":return"CommonEventID: %1, line: %2".format(t.commonEventId,t.line)
case"battle_event":return"TroopID: %1, page: %2, line: %3".format(t.troopId,t.page,t.line)
case"test_event":return"TestEvent, line: %1".format(t.line)
default:return"No information"}},Graphics._formatEventCommandInfo=function(t){switch(String(t.eventCommand)){case"plugin_command":return"◆Plugin Command: "+t.content
case"script":return"◆Script: "+t.content
case"control_variables":return"◆Control Variables: Script: "+t.content
case"conditional_branch_script":return"◆If: Script: "+t.content
case"set_route_script":return"◆Set Movement Route: ◇Script: "+t.content
case"auto_route_script":return"Autonomous Movement Custom Route: ◇Script: "+t.content
default:return""}},Graphics._formatStackTrace=function(t){return decodeURIComponent((t.stack||"").replace(/file:.*js\//g,"").replace(/http:.*js\//g,"").replace(/https:.*js\//g,"").replace(/chrome-extension:.*js\//g,"").replace(/\n/g,"<br>"))},Graphics._createCanvas=function(){this._canvas=document.createElement("canvas"),this._canvas.id="GameCanvas",this._updateCanvas(),document.body.appendChild(this._canvas)},Graphics._updateCanvas=function(){this._canvas.width=this._width,this._canvas.height=this._height,this._canvas.style.zIndex=1,this._centerElement(this._canvas)},Graphics._createVideo=function(){this._video=document.createElement("video"),this._video.id="GameVideo",this._video.style.opacity=0,this._video.setAttribute("playsinline",""),this._video.volume=this._videoVolume,this._updateVideo(),makeVideoPlayableInline(this._video),document.body.appendChild(this._video)},Graphics._updateVideo=function(){this._video.width=this._width,this._video.height=this._height,this._video.style.zIndex=2,this._centerElement(this._video)},Graphics._createUpperCanvas=function(){this._upperCanvas=document.createElement("canvas"),this._upperCanvas.id="UpperCanvas",this._updateUpperCanvas(),document.body.appendChild(this._upperCanvas)},Graphics._updateUpperCanvas=function(){this._upperCanvas.width=this._width,this._upperCanvas.height=this._height,this._upperCanvas.style.zIndex=3,this._centerElement(this._upperCanvas)},Graphics._clearUpperCanvas=function(){const t=void 0
this._upperCanvas.getContext("2d").clearRect(0,0,this._width,this._height)},Graphics._paintUpperCanvas=function(){if(this._clearUpperCanvas(),this._loadingImage&&this._loadingCount>=20){const t=this._upperCanvas.getContext("2d"),e=(this._width-this._loadingImage.width)/2,i=(this._height-this._loadingImage.height)/2,s=((this._loadingCount-20)/30).clamp(0,1)
t.save(),t.globalAlpha=s,t.drawImage(this._loadingImage,e,i),t.restore()}},Graphics._createRenderer=function(){},Graphics._updateRenderer=function(){this._app&&this._app.renderer.resize(this._width,this._height)},Graphics._createFPSMeter=function(){"function"==typeof GameStats&&(this._fpsMeter=new GameStats({autoPlace:!1}),this._fpsMeter.show(!1),this._fpsMeter.dom.style.zIndex=1)},Graphics._createModeBox=function(){const t=document.createElement("div")
t.id="modeTextBack",t.style.position="absolute",t.style.left="5px",t.style.top="5px",t.style.width="119px",t.style.height="58px",t.style.background="rgba(0,0,0,0.2)",t.style.zIndex=9,t.style.opacity=0
const e=document.createElement("div")
e.id="modeText",e.style.position="absolute",e.style.left="0px",e.style.top="41px",e.style.width="119px",e.style.fontSize="12px",e.style.fontFamily="monospace",e.style.color="white",e.style.textAlign="center",e.style.textShadow="1px 1px 0 rgba(0,0,0,0.5)",e.innerHTML=this.isWebGL()?"WebGL mode":"Canvas mode",document.body.appendChild(t),t.appendChild(e),this._modeBox=t},Graphics._createGameFontLoader=function(){this._createFontLoader("GameFont")},Graphics._createFontLoader=function(t){const e=document.createElement("div"),i=document.createTextNode(".")
e.style.fontFamily=t,e.style.fontSize="0px",e.style.color="transparent",e.style.position="absolute",e.style.margin="auto",e.style.top="0px",e.style.left="0px",e.style.width="1px",e.style.height="1px",e.appendChild(i),document.body.appendChild(e)},Graphics._centerElement=function(t){const e=t.width*this._realScale,i=t.height*this._realScale
t.style.position="absolute",t.style.margin="auto",t.style.top=0,t.style.left=0,t.style.right=0,t.style.bottom=0,t.style.width=e+"px",t.style.height=i+"px"},Graphics._disableTextSelection=function(){const t=document.body
t.style.userSelect="none",t.style.webkitUserSelect="none",t.style.msUserSelect="none",t.style.mozUserSelect="none"},Graphics._disableContextMenu=function(){const t=document.body.getElementsByTagName("*"),oncontextmenu=function(){return!1}
for(let e=0;e<t.length;e++)t[e].oncontextmenu=oncontextmenu},Graphics._applyCanvasFilter=function(){this._canvas&&(this._canvas.style.opacity=.5,this._canvas.style.filter="blur(8px)",this._canvas.style.webkitFilter="blur(8px)")},Graphics._onVideoLoad=function(){this._video.play(),this._updateVisibility(!0),this._videoLoading=!1},Graphics._onVideoError=function(){this._updateVisibility(!1),this._videoLoading=!1},Graphics._onVideoEnd=function(){this._updateVisibility(!1)},Graphics._updateVisibility=function(t){this._video.style.opacity=t?1:0,this._canvas.style.opacity=t?0:1},Graphics._isVideoVisible=function(){return this._video.style.opacity>0},Graphics._setupEventHandlers=function(){window.addEventListener("resize",this._onWindowResize.bind(this)),document.addEventListener("keydown",this._onKeyDown.bind(this)),document.addEventListener("keydown",this._onTouchEnd.bind(this)),document.addEventListener("mousedown",this._onTouchEnd.bind(this)),document.addEventListener("touchend",this._onTouchEnd.bind(this))},Graphics._onWindowResize=function(){this._updateAllElements()},Graphics._onKeyDown=function(t){if(!t.ctrlKey&&!t.altKey)switch(t.keyCode){case 113:t.preventDefault(),this._switchFPSMeter()
break
case 114:t.preventDefault(),this._switchStretchMode()
break
case 115:t.preventDefault(),this._switchFullScreen()}},Graphics._onTouchEnd=function(t){this._videoUnlocked||(this._video.play(),this._videoUnlocked=!0),this._isVideoVisible()&&this._video.paused&&this._video.play()},Graphics._switchFPSMeter=function(){this._fpsMeter&&this._fpsMeterToggled?(this.hideFps(),this._fpsMeterToggled=!1):this._fpsMeter&&!this._fpsMeterToggled&&(this.showFps(),this._fpsMeterToggled=!0)},Graphics._switchStretchMode=function(){this._stretchEnabled=!this._stretchEnabled,this._updateAllElements()},Graphics._switchFullScreen=function(){this._isFullScreen()?this._cancelFullScreen():this._requestFullScreen()},Graphics._isFullScreen=function(){return document.fullscreenElement||document.mozFullScreen||document.webkitFullscreenElement||document.msFullscreenElement},Graphics._requestFullScreen=function(){const t=document.body
t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullScreen?t.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT):t.msRequestFullscreen&&t.msRequestFullscreen()},Graphics._cancelFullScreen=function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()},Graphics._onTick=function(t){this._fpsMeter&&this._fpsMeter.shown&&this._fpsMeter.begin(),this._app.stage&&this._app.render(),this._fpsMeter&&this._fpsMeter.shown&&this._fpsMeter.end()},Graphics._createPixiApp=function(){const t={view:this._canvas,width:this._width,height:this._height,resolution:window.devicePixelRatio,powerPreference:"high-performance",autoStart:!0}
try{this._app=new PIXI.Application(t),this._app.ticker.remove(this._app.render,this._app),this._app.ticker.add(this._onTick,this)}catch(t){this._app=null}},Input.initialize=function(){this.clear(),this._wrapNwjsAlert(),this._setupEventHandlers()},Input.keyRepeatWait=24,Input.keyRepeatInterval=6,Input.keyMapper={9:"tab",13:"ok",16:"shift",17:"control",18:"control",27:"escape",32:"ok",33:"pageup",34:"pagedown",37:"left",38:"up",39:"right",40:"down",45:"escape",81:"pageup",87:"pagedown",88:"escape",90:"ok",96:"escape",98:"down",100:"left",102:"right",104:"up",120:"debug"},Input.gamepadMapper={0:"ok",1:"cancel",2:"shift",3:"menu",4:"pageup",5:"pagedown",12:"up",13:"down",14:"left",15:"right"},Input.clear=function(){this._currentState={},this._previousState={},this._gamepadStates=[],this._latestButton=null,this._pressedTime=0,this._dir4=0,this._dir8=0,this._preferredAxis="",this._date=0},Input.update=function(){this._pollGamepads(),this._currentState[this._latestButton]?this._pressedTime++:this._latestButton=null
for(let t in this._currentState)this._currentState[t]&&!this._previousState[t]&&(this._latestButton=t,this._pressedTime=0,this._date=Date.now()),this._previousState[t]=this._currentState[t]
this._updateDirection()},Input.isPressed=function(t){return!(!this._isEscapeCompatible(t)||!this.isPressed("escape"))||!!this._currentState[t]},Input.isTriggered=function(t){return!(!this._isEscapeCompatible(t)||!this.isTriggered("escape"))||this._latestButton===t&&0===this._pressedTime},Input.isRepeated=function(t){return!(!this._isEscapeCompatible(t)||!this.isRepeated("escape"))||this._latestButton===t&&(0===this._pressedTime||this._pressedTime>=this.keyRepeatWait&&this._pressedTime%this.keyRepeatInterval==0)},Input.isLongPressed=function(t){return!(!this._isEscapeCompatible(t)||!this.isLongPressed("escape"))||this._latestButton===t&&this._pressedTime>=this.keyRepeatWait},Object.defineProperty(Input,"dir4",{get(){return this._dir4},configurable:!0}),Object.defineProperty(Input,"dir8",{get(){return this._dir8},configurable:!0}),Object.defineProperty(Input,"date",{get(){return this._date},configurable:!0}),Input._wrapNwjsAlert=function(){if(Utils.isNwjs()){const t=window.alert
window.alert=function(){const e=require("nw.gui"),i=e.Window.get()
t.apply(this,arguments),i.focus(),Input.clear()}}},Input._setupEventHandlers=function(){document.addEventListener("keydown",this._onKeyDown.bind(this)),document.addEventListener("keyup",this._onKeyUp.bind(this)),window.addEventListener("blur",this._onLostFocus.bind(this))},Input._onKeyDown=function(t){this._shouldPreventDefault(t.keyCode)&&t.preventDefault(),144===t.keyCode&&this.clear()
const e=this.keyMapper[t.keyCode]
ResourceHandler.exists()&&"ok"===e?ResourceHandler.retry():e&&(this._currentState[e]=!0)},Input._shouldPreventDefault=function(t){switch(t){case 8:case 33:case 34:case 37:case 38:case 39:case 40:return!0}return!1},Input._onKeyUp=function(t){const e=this.keyMapper[t.keyCode]
e&&(this._currentState[e]=!1),0===t.keyCode&&this.clear()},Input._onLostFocus=function(){this.clear()},Input._pollGamepads=function(){if(navigator.getGamepads){const t=navigator.getGamepads()
if(t)for(let e=0;e<t.length;e++){const i=t[e]
i&&i.connected&&this._updateGamepadState(i)}}},Input._updateGamepadState=function(t){const e=this._gamepadStates[t.index]||[],i=[],s=t.buttons,r=t.axes,n=.5
i[12]=!1,i[13]=!1,i[14]=!1,i[15]=!1
for(let t=0;t<s.length;t++)i[t]=s[t].pressed
r[1]<-.5?i[12]=!0:r[1]>n&&(i[13]=!0),r[0]<-.5?i[14]=!0:r[0]>n&&(i[15]=!0)
for(let t=0;t<i.length;t++)if(i[t]!==e[t]){const e=this.gamepadMapper[t]
e&&(this._currentState[e]=i[t])}this._gamepadStates[t.index]=i},Input._updateDirection=function(){let t=this._signX(),e=this._signY()
this._dir8=this._makeNumpadDirection(t,e),0!==t&&0!==e?"x"===this._preferredAxis?e=0:t=0:0!==t?this._preferredAxis="y":0!==e&&(this._preferredAxis="x"),this._dir4=this._makeNumpadDirection(t,e)},Input._signX=function(){let t=0
return this.isPressed("left")&&t--,this.isPressed("right")&&t++,t},Input._signY=function(){let t=0
return this.isPressed("up")&&t--,this.isPressed("down")&&t++,t},Input._makeNumpadDirection=function(t,e){return 0!==t||0!==e?5-3*e+t:0},Input._isEscapeCompatible=function(t){return"cancel"===t||"menu"===t},TouchInput.initialize=function(){this.clear(),this._setupEventHandlers()},TouchInput.keyRepeatWait=24,TouchInput.keyRepeatInterval=6,TouchInput.clear=function(){this._mousePressed=!1,this._screenPressed=!1,this._pressedTime=0,this._events={},this._events.triggered=!1,this._events.cancelled=!1,this._events.moved=!1,this._events.released=!1,this._events.wheelX=0,this._events.wheelY=0,this._triggered=!1,this._cancelled=!1,this._moved=!1,this._released=!1,this._wheelX=0,this._wheelY=0,this._x=0,this._y=0,this._date=0},TouchInput.update=function(){this._triggered=this._events.triggered,this._cancelled=this._events.cancelled,this._moved=this._events.moved,this._released=this._events.released,this._wheelX=this._events.wheelX,this._wheelY=this._events.wheelY,this._events.triggered=!1,this._events.cancelled=!1,this._events.moved=!1,this._events.released=!1,this._events.wheelX=0,this._events.wheelY=0,this.isPressed()&&this._pressedTime++},TouchInput.isPressed=function(){return this._mousePressed||this._screenPressed},TouchInput.isTriggered=function(){return this._triggered},TouchInput.isRepeated=function(){return this.isPressed()&&(this._triggered||this._pressedTime>=this.keyRepeatWait&&this._pressedTime%this.keyRepeatInterval==0)},TouchInput.isLongPressed=function(){return this.isPressed()&&this._pressedTime>=this.keyRepeatWait},TouchInput.isCancelled=function(){return this._cancelled},TouchInput.isMoved=function(){return this._moved},TouchInput.isReleased=function(){return this._released},Object.defineProperty(TouchInput,"wheelX",{get(){return this._wheelX},configurable:!0}),Object.defineProperty(TouchInput,"wheelY",{get(){return this._wheelY},configurable:!0}),Object.defineProperty(TouchInput,"x",{get(){return this._x},configurable:!0}),Object.defineProperty(TouchInput,"y",{get(){return this._y},configurable:!0}),Object.defineProperty(TouchInput,"date",{get(){return this._date},configurable:!0}),TouchInput._setupEventHandlers=function(){const t=Utils.isSupportPassiveEvent()
document.addEventListener("mousedown",this._onMouseDown.bind(this)),document.addEventListener("mousemove",this._onMouseMove.bind(this)),document.addEventListener("mouseup",this._onMouseUp.bind(this)),document.addEventListener("wheel",this._onWheel.bind(this),!!t&&{passive:!1}),document.addEventListener("touchstart",this._onTouchStart.bind(this),!!t&&{passive:!1}),document.addEventListener("touchmove",this._onTouchMove.bind(this),!!t&&{passive:!1}),document.addEventListener("touchend",this._onTouchEnd.bind(this)),document.addEventListener("touchcancel",this._onTouchCancel.bind(this)),document.addEventListener("pointerdown",this._onPointerDown.bind(this)),window.addEventListener("blur",this._onLostFocus.bind(this))},TouchInput._onMouseDown=function(t){0===t.button?this._onLeftButtonDown(t):1===t.button?this._onMiddleButtonDown(t):2===t.button&&this._onRightButtonDown(t)},TouchInput._onLeftButtonDown=function(t){const e=Graphics.pageToCanvasX(t.pageX),i=Graphics.pageToCanvasY(t.pageY)
Graphics.isInsideCanvas(e,i)&&(this._mousePressed=!0,this._pressedTime=0,this._onTrigger(e,i))},TouchInput._onMiddleButtonDown=function(t){},TouchInput._onRightButtonDown=function(t){const e=Graphics.pageToCanvasX(t.pageX),i=Graphics.pageToCanvasY(t.pageY)
Graphics.isInsideCanvas(e,i)&&this._onCancel(e,i)},TouchInput._onMouseMove=function(t){if(this._mousePressed){const e=Graphics.pageToCanvasX(t.pageX),i=Graphics.pageToCanvasY(t.pageY)
this._onMove(e,i)}},TouchInput._onMouseUp=function(t){if(0===t.button){const e=Graphics.pageToCanvasX(t.pageX),i=Graphics.pageToCanvasY(t.pageY)
this._mousePressed=!1,this._onRelease(e,i)}},TouchInput._onWheel=function(t){this._events.wheelX+=t.deltaX,this._events.wheelY+=t.deltaY,t.preventDefault()},TouchInput._onTouchStart=function(t){for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e],s=Graphics.pageToCanvasX(i.pageX),r=Graphics.pageToCanvasY(i.pageY)
Graphics.isInsideCanvas(s,r)&&(this._screenPressed=!0,this._pressedTime=0,t.touches.length>=2?this._onCancel(s,r):this._onTrigger(s,r),t.preventDefault())}(window.cordova||window.navigator.standalone)&&t.preventDefault()},TouchInput._onTouchMove=function(t){for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e],s=Graphics.pageToCanvasX(i.pageX),r=Graphics.pageToCanvasY(i.pageY)
this._onMove(s,r)}},TouchInput._onTouchEnd=function(t){for(let e=0;e<t.changedTouches.length;e++){const i=t.changedTouches[e],s=Graphics.pageToCanvasX(i.pageX),r=Graphics.pageToCanvasY(i.pageY)
this._screenPressed=!1,this._onRelease(s,r)}},TouchInput._onTouchCancel=function(t){this._screenPressed=!1},TouchInput._onPointerDown=function(t){if("touch"===t.pointerType&&!t.isPrimary){const e=Graphics.pageToCanvasX(t.pageX),i=Graphics.pageToCanvasY(t.pageY)
Graphics.isInsideCanvas(e,i)&&(this._onCancel(e,i),t.preventDefault())}},TouchInput._onLostFocus=function(){this.clear()},TouchInput._onTrigger=function(t,e){this._events.triggered=!0,this._x=t,this._y=e,this._date=Date.now()},TouchInput._onCancel=function(t,e){this._events.cancelled=!0,this._x=t,this._y=e},TouchInput._onMove=function(t,e){this._events.moved=!0,this._x=t,this._y=e},TouchInput._onRelease=function(t,e){this._events.released=!0,this._x=t,this._y=e},Sprite.prototype=Object.create(PIXI.Sprite.prototype),Sprite.prototype.constructor=Sprite,Sprite.voidFilter=new PIXI.filters.AlphaFilter,Sprite.prototype.initialize=function(t){const e=new PIXI.Texture(new PIXI.BaseTexture)
PIXI.Sprite.call(this,e),this.filters=null,this._bitmap=null,this._frame=new Rectangle,this._realFrame=new Rectangle,this._blendColor=[0,0,0,0],this._colorTone=[0,0,0,0],this._canvas=null,this._context=null,this._tintTexture=null,this._colorMatrixFilter=null,this.spriteId=Sprite._counter++,this.opaque=!1,this.bitmap=t},Sprite._counter=0,Object.defineProperty(Sprite.prototype,"bitmap",{get(){return this._bitmap},set(t){this._bitmap!==t&&(this._bitmap=t,t?(this._refreshFrame=!0,t.addLoadListener(this._onBitmapLoad.bind(this))):(this._refreshFrame=!1,this.texture.frame=Rectangle.emptyRectangle))},configurable:!0}),Object.defineProperty(Sprite.prototype,"width",{get(){return this._frame.width},set(t){this._frame.width=t,this._refresh()},configurable:!0}),Object.defineProperty(Sprite.prototype,"height",{get(){return this._frame.height},set(t){this._frame.height=t,this._refresh()},configurable:!0}),Object.defineProperty(Sprite.prototype,"opacity",{get(){return 255*this.alpha},set(t){this.alpha=t.clamp(0,255)/255},configurable:!0}),Sprite.prototype.update=function(){this.children.forEach((function(t){t.update&&t.update()}))},Sprite.prototype.move=function(t,e){this.x=t,this.y=e},Sprite.prototype.setFrame=function(t,e,i,s){this._refreshFrame=!1
const r=this._frame
t===r.x&&e===r.y&&i===r.width&&s===r.height||(r.x=t,r.y=e,r.width=i,r.height=s,this._refresh())},Sprite.prototype.getBlendColor=function(){return this._blendColor.clone()},Sprite.prototype.setBlendColor=function(t){if(!(t instanceof Array))throw new Error("Argument must be an array")
this._blendColor.equals(t)||(this._blendColor=t.clone(),this._refresh())},Sprite.prototype.getColorTone=function(){return this._colorTone.clone()},Sprite.prototype.setColorTone=function(t){if(!(t instanceof Array))throw new Error("Argument must be an array")
this._colorTone.equals(t)||(this._colorTone=t.clone(),this._refresh())},Sprite.prototype._onBitmapLoad=function(t){t===this._bitmap&&this._refreshFrame&&this._bitmap&&(this._refreshFrame=!1,this._frame.width=this._bitmap.width,this._frame.height=this._bitmap.height),this._refresh()},Sprite.prototype._refresh=function(){const t=Math.floor(this._frame.x),e=Math.floor(this._frame.y),i=Math.floor(this._frame.width),s=Math.floor(this._frame.height),r=this._bitmap?this._bitmap.width:0,n=this._bitmap?this._bitmap.height:0,o=t.clamp(0,r),a=e.clamp(0,n),h=(i-o+t).clamp(0,r-o),p=(s-a+e).clamp(0,n-a)
this._realFrame.x=o,this._realFrame.y=a,this._realFrame.width=h,this._realFrame.height=p,this.pivot.x=t-o,this.pivot.y=e-a,h>0&&p>0?this._needsTint()?Graphics.isWebGL()?(this._createTinterWebGL(),this._executeTintWebGL()):(this._createTinter(h,p),this._executeTint(o,a,h,p),this._tintTexture.update(),this.texture.baseTexture=this._tintTexture,this.texture.frame=new Rectangle(0,0,h,p)):(this._bitmap&&(this.texture.baseTexture=this._bitmap.baseTexture),this.texture.frame=this._realFrame,this._clearTintWebGL()):this._bitmap?this.texture.frame=Rectangle.emptyRectangle:(this.texture.baseTexture.width=Math.max(this.texture.baseTexture.width,this._frame.x+this._frame.width),this.texture.baseTexture.height=Math.max(this.texture.baseTexture.height,this._frame.y+this._frame.height),this.texture.frame=this._frame),this.texture._updateID++},Sprite.prototype._isInBitmapRect=function(t,e,i,s){return this._bitmap&&t+i>0&&e+s>0&&t<this._bitmap.width&&e<this._bitmap.height},Sprite.prototype._needsTint=function(){const t=this._colorTone
return t[0]||t[1]||t[2]||t[3]||this._blendColor[3]>0},Sprite.prototype._createTinter=function(t,e){this._canvas||(this._canvas=document.createElement("canvas"),this._context=this._canvas.getContext("2d")),this._canvas.width=t,this._canvas.height=e,this._tintTexture||(this._tintTexture=new PIXI.BaseTexture(this._canvas)),this._tintTexture.width=t,this._tintTexture.height=e,this._tintTexture.scaleMode=this._bitmap.baseTexture.scaleMode},Sprite.prototype._executeTint=function(t,e,i,s){const r=this._context,n=this._colorTone,o=this._blendColor
if(r.globalCompositeOperation="copy",r.drawImage(this._bitmap.canvas,t,e,i,s,0,0,i,s),n[0]||n[1]||n[2]||n[3]){if(Graphics.canUseSaturationBlend()){const t=Math.max(0,n[3])
r.globalCompositeOperation="saturation",r.fillStyle="rgba(255,255,255,"+t/255+")",r.fillRect(0,0,i,s)}const t=Math.max(0,n[0]),e=Math.max(0,n[1]),o=Math.max(0,n[2])
if(r.globalCompositeOperation="lighter",r.fillStyle=Utils.rgbToCssColor(t,e,o),r.fillRect(0,0,i,s),Graphics.canUseDifferenceBlend()){r.globalCompositeOperation="difference",r.fillStyle="white",r.fillRect(0,0,i,s)
const t=Math.max(0,-n[0]),e=Math.max(0,-n[1]),o=Math.max(0,-n[2])
r.globalCompositeOperation="lighter",r.fillStyle=Utils.rgbToCssColor(t,e,o),r.fillRect(0,0,i,s),r.globalCompositeOperation="difference",r.fillStyle="white",r.fillRect(0,0,i,s)}}const a=Math.max(0,o[0]),h=Math.max(0,o[1]),p=Math.max(0,o[2]),l=Math.max(0,o[3])
r.globalCompositeOperation="source-atop",r.fillStyle=Utils.rgbToCssColor(a,h,p),r.globalAlpha=l/255,r.fillRect(0,0,i,s),r.globalCompositeOperation="destination-in",r.globalAlpha=1,r.drawImage(this._bitmap.canvas,t,e,i,s,0,0,i,s)},Sprite.prototype._createTinterWebGL=function(){this.filters||(this.filters=[]),this._colorMatrixFilter||(this._colorMatrixFilter=new PIXI.filters.ColorMatrixFilter,this.filters.push(this._colorMatrixFilter)),this._colorMatrixFilter.enabled=!0},Sprite.prototype._executeTintWebGL=function(){const t=this._blendColor,e=t[0]/255,i=t[1]/255,s=t[2]/255,r=t[3]/255
this._colorMatrixFilter.matrix=[e/64,0,0,0,e,0,i/64,0,0,i,0,0,s/64,0,s,0,0,0,1,0],this._colorMatrixFilter.alpha=r},Sprite.prototype._clearTintWebGL=function(){this._colorMatrixFilter&&(this._colorMatrixFilter.enabled=!1)},Sprite.prototype._renderCanvas_PIXI=PIXI.Sprite.prototype._renderCanvas,Sprite.prototype._render_PIXI=PIXI.Sprite.prototype._render,Sprite.prototype._renderCanvas=function(t){this.bitmap&&this.bitmap.touch(),this.bitmap&&!this.bitmap.isReady()||this.texture.frame.width>0&&this.texture.frame.height>0&&this._renderCanvas_PIXI(t)},Sprite.prototype._render=function(t){this.bitmap&&this.bitmap.touch(),this.bitmap&&!this.bitmap.isReady()||this.texture.frame.width>0&&this.texture.frame.height>0&&(this._bitmap&&this._bitmap.checkDirty(),this._render_PIXI(t))},Tilemap.prototype=Object.create(PIXI.Container.prototype),Tilemap.prototype.constructor=Tilemap,Tilemap.prototype.initialize=function(){PIXI.Container.call(this),this._margin=20,this._width=Graphics.width+2*this._margin,this._height=Graphics.height+2*this._margin,this._tileWidth=48,this._tileHeight=48,this._mapWidth=0,this._mapHeight=0,this._mapData=null,this._layerWidth=0,this._layerHeight=0,this._lastTiles=[],this.bitmaps=[],this.origin=new Point,this.flags=[],this.animationCount=0,this.horizontalWrap=!1,this.verticalWrap=!1,this._createLayers(),this.refresh()},Object.defineProperty(Tilemap.prototype,"width",{get(){return this._width},set(t){this._width!==t&&(this._width=t,this._createLayers())}}),Object.defineProperty(Tilemap.prototype,"height",{get(){return this._height},set(t){this._height!==t&&(this._height=t,this._createLayers())}}),Object.defineProperty(Tilemap.prototype,"tileWidth",{get(){return this._tileWidth},set(t){this._tileWidth!==t&&(this._tileWidth=t,this._createLayers())}}),Object.defineProperty(Tilemap.prototype,"tileHeight",{get(){return this._tileHeight},set(t){this._tileHeight!==t&&(this._tileHeight=t,this._createLayers())}}),Tilemap.prototype.setData=function(t,e,i){this._mapWidth=t,this._mapHeight=e,this._mapData=i},Tilemap.prototype.isReady=function(){for(let t=0;t<this.bitmaps.length;t++)if(this.bitmaps[t]&&!this.bitmaps[t].isReady())return!1
return!0},Tilemap.prototype.update=function(){this.animationCount++,this.animationFrame=Math.floor(this.animationCount/30),this.children.forEach((function(t){t.update&&t.update()}))
for(let t=0;t<this.bitmaps.length;t++)this.bitmaps[t]&&this.bitmaps[t].touch()},Tilemap.prototype.refresh=function(){this._lastTiles.length=0},Tilemap.prototype.refreshTileset=function(){},Tilemap.prototype.updateTransform=function(){const t=Math.floor(this.origin.x),e=Math.floor(this.origin.y),i=Math.floor((t-this._margin)/this._tileWidth),s=Math.floor((e-this._margin)/this._tileHeight)
this._updateLayerPositions(i,s),(this._needsRepaint||this._lastAnimationFrame!==this.animationFrame||this._lastStartX!==i||this._lastStartY!==s)&&(this._frameUpdated=this._lastAnimationFrame!==this.animationFrame,this._lastAnimationFrame=this.animationFrame,this._lastStartX=i,this._lastStartY=s,this._paintAllTiles(i,s),this._needsRepaint=!1),this._sortChildren(),PIXI.Container.prototype.updateTransform.call(this)},Tilemap.prototype._createLayers=function(){const t=this._width,e=this._height,i=this._margin,s=Math.ceil(t/this._tileWidth)+1,r=Math.ceil(e/this._tileHeight)+1,n=s*this._tileWidth,o=r*this._tileHeight
this._lowerBitmap=new Bitmap(n,o),this._upperBitmap=new Bitmap(n,o),this._layerWidth=n,this._layerHeight=o,this._lowerLayer=new Sprite,this._lowerLayer.move(-i,-i,t,e),this._lowerLayer.z=0,this._upperLayer=new Sprite,this._upperLayer.move(-i,-i,t,e),this._upperLayer.z=4
for(let t=0;t<4;t++)this._lowerLayer.addChild(new Sprite(this._lowerBitmap)),this._upperLayer.addChild(new Sprite(this._upperBitmap))
this.addChild(this._lowerLayer),this.addChild(this._upperLayer)},Tilemap.prototype._updateLayerPositions=function(t,e){const i=this._margin,s=Math.floor(this.origin.x),r=Math.floor(this.origin.y),n=(s-i).mod(this._layerWidth),o=(r-i).mod(this._layerHeight),a=this._layerWidth-n,h=this._layerHeight-o,p=this._width-a,l=this._height-h
for(let t=0;t<2;t++){let e
e=0===t?this._lowerLayer.children:this._upperLayer.children,e[0].move(0,0,a,h),e[0].setFrame(n,o,a,h),e[1].move(a,0,p,h),e[1].setFrame(0,o,p,h),e[2].move(0,h,a,l),e[2].setFrame(n,0,a,l),e[3].move(a,h,p,l),e[3].setFrame(0,0,p,l)}},Tilemap.prototype._paintAllTiles=function(t,e){const i=Math.ceil(this._width/this._tileWidth)+1,s=Math.ceil(this._height/this._tileHeight)+1
for(let r=0;r<s;r++)for(let s=0;s<i;s++)this._paintTiles(t,e,s,r)},Tilemap.prototype._paintTiles=function(t,e,i,s){const r=1e4,n=t+i,o=e+s,a=(n*this._tileWidth).mod(this._layerWidth),h=(o*this._tileHeight).mod(this._layerHeight),p=a/this._tileWidth,l=h/this._tileHeight,c=this._readMapData(n,o,0),d=this._readMapData(n,o,1),u=this._readMapData(n,o,2),_=this._readMapData(n,o,3),f=this._readMapData(n,o,4),m=this._readMapData(n,o-1,1),g=[],y=[]
this._isHigherTile(c)?y.push(c):g.push(c),this._isHigherTile(d)?y.push(d):g.push(d),g.push(-f),this._isTableTile(m)&&!this._isTableTile(d)&&(Tilemap.isShadowingTile(c)||g.push(r+m)),this._isOverpassPosition(n,o)?(y.push(u),y.push(_)):(this._isHigherTile(u)?y.push(u):g.push(u),this._isHigherTile(_)?y.push(_):g.push(_))
const w=this._readLastTiles(0,p,l)
if(!g.equals(w)||Tilemap.isTileA1(c)&&this._frameUpdated){this._lowerBitmap.clearRect(a,h,this._tileWidth,this._tileHeight)
for(let t=0;t<g.length;t++){const e=g[t]
e<0?this._drawShadow(this._lowerBitmap,f,a,h):e>=r?this._drawTableEdge(this._lowerBitmap,m,a,h):this._drawTile(this._lowerBitmap,e,a,h)}this._writeLastTiles(0,p,l,g)}const T=this._readLastTiles(1,p,l)
if(!y.equals(T)){this._upperBitmap.clearRect(a,h,this._tileWidth,this._tileHeight)
for(let t=0;t<y.length;t++)this._drawTile(this._upperBitmap,y[t],a,h)
this._writeLastTiles(1,p,l,y)}},Tilemap.prototype._readLastTiles=function(t,e,i){const s=this._lastTiles[t]
if(s){const t=s[i]
if(t){const i=t[e]
if(i)return i}}return[]},Tilemap.prototype._writeLastTiles=function(t,e,i,s){let r=this._lastTiles[t]
r||(r=this._lastTiles[t]=[])
let n=r[i]
n||(n=r[i]=[]),n[e]=s},Tilemap.prototype._drawTile=function(t,e,i,s){Tilemap.isVisibleTile(e)&&(Tilemap.isAutotile(e)?this._drawAutotile(t,e,i,s):this._drawNormalTile(t,e,i,s))},Tilemap.prototype._drawNormalTile=function(t,e,i,s){let r=0
r=Tilemap.isTileA5(e)?4:5+Math.floor(e/256)
const n=this._tileWidth,o=this._tileHeight,a=(Math.floor(e/128)%2*8+e%8)*n,h=Math.floor(e%256/8)%16*o,p=this.bitmaps[r]
p&&t.bltImage(p,a,h,n,o,i,s,n,o)},Tilemap.prototype._drawAutotile=function(t,e,i,s){let r=Tilemap.FLOOR_AUTOTILE_TABLE
const n=Tilemap.getAutotileKind(e),o=Tilemap.getAutotileShape(e),a=n%8,h=Math.floor(n/8)
let p=0,l=0,c=0,d=!1
if(Tilemap.isTileA1(e)){const t=[0,1,2,1][this.animationFrame%4]
c=0,0===n?(p=2*t,l=0):1===n?(p=2*t,l=3):2===n?(p=6,l=0):3===n?(p=6,l=3):(p=8*Math.floor(a/4),l=6*h+Math.floor(a/2)%2*3,n%2==0?p+=2*t:(p+=6,r=Tilemap.WATERFALL_AUTOTILE_TABLE,l+=this.animationFrame%3))}else Tilemap.isTileA2(e)?(c=1,p=2*a,l=3*(h-2),d=this._isTableTile(e)):Tilemap.isTileA3(e)?(c=2,p=2*a,l=2*(h-6),r=Tilemap.WALL_AUTOTILE_TABLE):Tilemap.isTileA4(e)&&(c=3,p=2*a,l=Math.floor(2.5*(h-10)+(h%2==1?.5:0)),h%2==1&&(r=Tilemap.WALL_AUTOTILE_TABLE))
const u=r[o],_=this.bitmaps[c]
if(u&&_){const e=this._tileWidth/2,r=this._tileHeight/2
for(let n=0;n<4;n++){const o=u[n][0],a=u[n][1],h=(2*p+o)*e,c=(2*l+a)*r,f=i+n%2*e
let m=s+Math.floor(n/2)*r
if(!d||1!==a&&5!==a)t.bltImage(_,h,c,e,r,f,m,e,r)
else{let i=o,s
1===a&&(i=[0,3,2,1][o])
const n=(2*p+i)*e,d=(2*l+3)*r
t.bltImage(_,n,d,e,r,f,m,e,r),m+=r/2,t.bltImage(_,h,c,e,r/2,f,m,e,r/2)}}}},Tilemap.prototype._drawTableEdge=function(t,e,i,s){if(Tilemap.isTileA2(e)){const r=Tilemap.FLOOR_AUTOTILE_TABLE,n=Tilemap.getAutotileKind(e),o=Tilemap.getAutotileShape(e),a=void 0,h=void 0,p=1,l=n%8*2,c=3*(Math.floor(n/8)-2),d=r[o]
if(d){const e=this.bitmaps[p],r=this._tileWidth/2,n=this._tileHeight/2
for(let o=0;o<2;o++){const a=void 0,h=void 0,p=(2*l+d[2+o][0])*r,u=(2*c+d[2+o][1])*n+n/2,_=i+o%2*r,f=s+Math.floor(o/2)*n
t.bltImage(e,p,u,r,n/2,_,f,r,n/2)}}}},Tilemap.prototype._drawShadow=function(t,e,i,s){if(15&e){const r=this._tileWidth/2,n=this._tileHeight/2,o="rgba(0,0,0,0.5)"
for(let a=0;a<4;a++)if(e&1<<a){const e=i+a%2*r,h=s+Math.floor(a/2)*n
t.fillRect(e,h,r,n,o)}}},Tilemap.prototype._readMapData=function(t,e,i){if(this._mapData){const s=this._mapWidth,r=this._mapHeight
return this.horizontalWrap&&(t=t.mod(s)),this.verticalWrap&&(e=e.mod(r)),t>=0&&t<s&&e>=0&&e<r&&this._mapData[(i*r+e)*s+t]||0}return 0},Tilemap.prototype._isHigherTile=function(t){return 16&this.flags[t]},Tilemap.prototype._isTableTile=function(t){return Tilemap.isTileA2(t)&&128&this.flags[t]},Tilemap.prototype._isOverpassPosition=function(t,e){return!1},Tilemap.prototype._sortChildren=function(){this.children.sort(this._compareChildOrder.bind(this))},Tilemap.prototype._compareChildOrder=function(t,e){return t.z===e.z?t.y===e.y?t.spriteId-e.spriteId:t.y-e.y:t.z-e.z},Tilemap.TILE_ID_B=0,Tilemap.TILE_ID_C=256,Tilemap.TILE_ID_D=512,Tilemap.TILE_ID_E=768,Tilemap.TILE_ID_A5=1536,Tilemap.TILE_ID_A1=2048,Tilemap.TILE_ID_A2=2816,Tilemap.TILE_ID_A3=4352,Tilemap.TILE_ID_A4=5888,Tilemap.TILE_ID_MAX=8192,Tilemap.isVisibleTile=function(t){return t>0&&t<this.TILE_ID_MAX},Tilemap.isAutotile=function(t){return t>=this.TILE_ID_A1},Tilemap.getAutotileKind=function(t){return Math.floor((t-this.TILE_ID_A1)/48)},Tilemap.getAutotileShape=function(t){return(t-this.TILE_ID_A1)%48},Tilemap.makeAutotileId=function(t,e){return this.TILE_ID_A1+48*t+e},Tilemap.isSameKindTile=function(t,e){return this.isAutotile(t)&&this.isAutotile(e)?this.getAutotileKind(t)===this.getAutotileKind(e):t===e},Tilemap.isTileA1=function(t){return t>=this.TILE_ID_A1&&t<this.TILE_ID_A2},Tilemap.isTileA2=function(t){return t>=this.TILE_ID_A2&&t<this.TILE_ID_A3},Tilemap.isTileA3=function(t){return t>=this.TILE_ID_A3&&t<this.TILE_ID_A4},Tilemap.isTileA4=function(t){return t>=this.TILE_ID_A4&&t<this.TILE_ID_MAX},Tilemap.isTileA5=function(t){return t>=this.TILE_ID_A5&&t<this.TILE_ID_A1},Tilemap.isWaterTile=function(t){return!(!this.isTileA1(t)||t>=this.TILE_ID_A1+96&&t<this.TILE_ID_A1+192)},Tilemap.isWaterfallTile=function(t){return t>=this.TILE_ID_A1+192&&t<this.TILE_ID_A2&&this.getAutotileKind(t)%2==1},Tilemap.isGroundTile=function(t){return this.isTileA1(t)||this.isTileA2(t)||this.isTileA5(t)},Tilemap.isShadowingTile=function(t){return this.isTileA3(t)||this.isTileA4(t)},Tilemap.isRoofTile=function(t){return this.isTileA3(t)&&this.getAutotileKind(t)%16<8},Tilemap.isWallTopTile=function(t){return this.isTileA4(t)&&this.getAutotileKind(t)%16<8},Tilemap.isWallSideTile=function(t){return(this.isTileA3(t)||this.isTileA4(t))&&this.getAutotileKind(t)%16>=8},Tilemap.isWallTile=function(t){return this.isWallTopTile(t)||this.isWallSideTile(t)},Tilemap.isFloorTypeAutotile=function(t){return this.isTileA1(t)&&!this.isWaterfallTile(t)||this.isTileA2(t)||this.isWallTopTile(t)},Tilemap.isWallTypeAutotile=function(t){return this.isRoofTile(t)||this.isWallSideTile(t)},Tilemap.isWaterfallTypeAutotile=function(t){return this.isWaterfallTile(t)},Tilemap.FLOOR_AUTOTILE_TABLE=[[[2,4],[1,4],[2,3],[1,3]],[[2,0],[1,4],[2,3],[1,3]],[[2,4],[3,0],[2,3],[1,3]],[[2,0],[3,0],[2,3],[1,3]],[[2,4],[1,4],[2,3],[3,1]],[[2,0],[1,4],[2,3],[3,1]],[[2,4],[3,0],[2,3],[3,1]],[[2,0],[3,0],[2,3],[3,1]],[[2,4],[1,4],[2,1],[1,3]],[[2,0],[1,4],[2,1],[1,3]],[[2,4],[3,0],[2,1],[1,3]],[[2,0],[3,0],[2,1],[1,3]],[[2,4],[1,4],[2,1],[3,1]],[[2,0],[1,4],[2,1],[3,1]],[[2,4],[3,0],[2,1],[3,1]],[[2,0],[3,0],[2,1],[3,1]],[[0,4],[1,4],[0,3],[1,3]],[[0,4],[3,0],[0,3],[1,3]],[[0,4],[1,4],[0,3],[3,1]],[[0,4],[3,0],[0,3],[3,1]],[[2,2],[1,2],[2,3],[1,3]],[[2,2],[1,2],[2,3],[3,1]],[[2,2],[1,2],[2,1],[1,3]],[[2,2],[1,2],[2,1],[3,1]],[[2,4],[3,4],[2,3],[3,3]],[[2,4],[3,4],[2,1],[3,3]],[[2,0],[3,4],[2,3],[3,3]],[[2,0],[3,4],[2,1],[3,3]],[[2,4],[1,4],[2,5],[1,5]],[[2,0],[1,4],[2,5],[1,5]],[[2,4],[3,0],[2,5],[1,5]],[[2,0],[3,0],[2,5],[1,5]],[[0,4],[3,4],[0,3],[3,3]],[[2,2],[1,2],[2,5],[1,5]],[[0,2],[1,2],[0,3],[1,3]],[[0,2],[1,2],[0,3],[3,1]],[[2,2],[3,2],[2,3],[3,3]],[[2,2],[3,2],[2,1],[3,3]],[[2,4],[3,4],[2,5],[3,5]],[[2,0],[3,4],[2,5],[3,5]],[[0,4],[1,4],[0,5],[1,5]],[[0,4],[3,0],[0,5],[1,5]],[[0,2],[3,2],[0,3],[3,3]],[[0,2],[1,2],[0,5],[1,5]],[[0,4],[3,4],[0,5],[3,5]],[[2,2],[3,2],[2,5],[3,5]],[[0,2],[3,2],[0,5],[3,5]],[[0,0],[1,0],[0,1],[1,1]]],Tilemap.WALL_AUTOTILE_TABLE=[[[2,2],[1,2],[2,1],[1,1]],[[0,2],[1,2],[0,1],[1,1]],[[2,0],[1,0],[2,1],[1,1]],[[0,0],[1,0],[0,1],[1,1]],[[2,2],[3,2],[2,1],[3,1]],[[0,2],[3,2],[0,1],[3,1]],[[2,0],[3,0],[2,1],[3,1]],[[0,0],[3,0],[0,1],[3,1]],[[2,2],[1,2],[2,3],[1,3]],[[0,2],[1,2],[0,3],[1,3]],[[2,0],[1,0],[2,3],[1,3]],[[0,0],[1,0],[0,3],[1,3]],[[2,2],[3,2],[2,3],[3,3]],[[0,2],[3,2],[0,3],[3,3]],[[2,0],[3,0],[2,3],[3,3]],[[0,0],[3,0],[0,3],[3,3]]],Tilemap.WATERFALL_AUTOTILE_TABLE=[[[2,0],[1,0],[2,1],[1,1]],[[0,0],[1,0],[0,1],[1,1]],[[2,0],[3,0],[2,1],[3,1]],[[0,0],[3,0],[0,1],[3,1]]],ShaderTilemap.prototype=Object.create(Tilemap.prototype),ShaderTilemap.prototype.constructor=ShaderTilemap,PIXI.tilemap.Constant.SCALE_MODE=PIXI.SCALE_MODES.NEAREST,PIXI.tilemap.Constant.DO_CLEAR=!0,PIXI.tilemap.Constant.boundCountPerBuffer=4,PIXI.tilemap.Constant.maxTextures=4,ShaderTilemap.prototype._hackRenderer=function(t){let e=this.animationFrame%4
return 3==e&&(e=1),t.plugins.tilemap.tileAnim[0]=e*this._tileWidth,t.plugins.tilemap.tileAnim[1]=this.animationFrame%3*this._tileHeight,t},ShaderTilemap.prototype.renderCanvas=function(t){this._hackRenderer(t),PIXI.Container.prototype.renderCanvas.call(this,t)},ShaderTilemap.prototype.render=function(t){this._hackRenderer(t),PIXI.Container.prototype.render.call(this,t)},ShaderTilemap.prototype.refresh=function(){this._lastBitmapLength!==this.bitmaps.length&&(this._lastBitmapLength=this.bitmaps.length,this.refreshTileset()),this._needsRepaint=!0},ShaderTilemap.prototype.refreshTileset=function(){const t=this.bitmaps.map((function(t){return t._baseTexture?new PIXI.Texture(t._baseTexture):t}))
this.lowerLayer.setBitmaps(t),this.upperLayer.setBitmaps(t)},ShaderTilemap.prototype.updateTransform=function(){const t=Math.floor(this.origin.x),e=Math.floor(this.origin.y),i=Math.floor((t-this._margin)/this._tileWidth),s=Math.floor((e-this._margin)/this._tileHeight)
this._updateLayerPositions(i,s),(this._needsRepaint||this._lastStartX!==i||this._lastStartY!==s)&&(this._lastStartX=i,this._lastStartY=s,this._paintAllTiles(i,s),this._needsRepaint=!1),this._sortChildren(),PIXI.Container.prototype.updateTransform.call(this)},ShaderTilemap.prototype._createLayers=function(){this._needsRepaint=!0,this.lowerZLayer||(this.addChild(this.lowerZLayer=new PIXI.tilemap.ZLayer(this,0)),this.addChild(this.upperZLayer=new PIXI.tilemap.ZLayer(this,4)),this.lowerZLayer.addChild(this.lowerLayer=new PIXI.tilemap.CompositeRectTileLayer(0,[])),this.lowerLayer.shadowColor=new Float32Array([0,0,0,.5]),this.upperZLayer.addChild(this.upperLayer=new PIXI.tilemap.CompositeRectTileLayer(4,[])))},ShaderTilemap.prototype._updateLayerPositions=function(t,e){const i=Math.floor(this.origin.x),s=Math.floor(this.origin.y)
this.lowerZLayer.position.x=t*this._tileWidth-i,this.lowerZLayer.position.y=e*this._tileHeight-s,this.upperZLayer.position.x=t*this._tileWidth-i,this.upperZLayer.position.y=e*this._tileHeight-s},ShaderTilemap.prototype._paintAllTiles=function(t,e){this.lowerZLayer.clear(),this.upperZLayer.clear()
const i=Math.ceil(this._width/this._tileWidth)+1,s=Math.ceil(this._height/this._tileHeight)+1
for(let r=0;r<s;r++)for(let s=0;s<i;s++)this._paintTiles(t,e,s,r)},ShaderTilemap.prototype._paintTiles=function(t,e,i,s){const r=t+i,n=e+s,o=i*this._tileWidth,a=s*this._tileHeight,h=this._readMapData(r,n,0),p=this._readMapData(r,n,1),l=this._readMapData(r,n,2),c=this._readMapData(r,n,3),d=this._readMapData(r,n,4),u=this._readMapData(r,n-1,1),_=this.lowerLayer.children[0],f=this.upperLayer.children[0]
this._isHigherTile(h)?this._drawTile(f,h,o,a):this._drawTile(_,h,o,a),this._isHigherTile(p)?this._drawTile(f,p,o,a):this._drawTile(_,p,o,a),this._drawShadow(_,d,o,a),this._isTableTile(u)&&!this._isTableTile(p)&&(Tilemap.isShadowingTile(h)||this._drawTableEdge(_,u,o,a)),this._isOverpassPosition(r,n)?(this._drawTile(f,l,o,a),this._drawTile(f,c,o,a)):(this._isHigherTile(l)?this._drawTile(f,l,o,a):this._drawTile(_,l,o,a),this._isHigherTile(c)?this._drawTile(f,c,o,a):this._drawTile(_,c,o,a))},ShaderTilemap.prototype._drawTile=function(t,e,i,s){Tilemap.isVisibleTile(e)&&(Tilemap.isAutotile(e)?this._drawAutotile(t,e,i,s):this._drawNormalTile(t,e,i,s))},ShaderTilemap.prototype._drawNormalTile=function(t,e,i,s){let r=0
r=Tilemap.isTileA5(e)?4:5+Math.floor(e/256)
const n=this._tileWidth,o=this._tileHeight,a=(Math.floor(e/128)%2*8+e%8)*n,h=Math.floor(e%256/8)%16*o
t.addRect(r,a,h,i,s,n,o)},ShaderTilemap.prototype._drawAutotile=function(t,e,i,s){let r=Tilemap.FLOOR_AUTOTILE_TABLE
const n=Tilemap.getAutotileKind(e),o=Tilemap.getAutotileShape(e),a=n%8,h=Math.floor(n/8)
let p=0,l=0,c=0,d=!1,u=0,_=0
Tilemap.isTileA1(e)?(c=0,0===n?(u=2,l=0):1===n?(u=2,l=3):2===n?(p=6,l=0):3===n?(p=6,l=3):(p=8*Math.floor(a/4),l=6*h+Math.floor(a/2)%2*3,n%2==0?u=2:(p+=6,r=Tilemap.WATERFALL_AUTOTILE_TABLE,_=1))):Tilemap.isTileA2(e)?(c=1,p=2*a,l=3*(h-2),d=this._isTableTile(e)):Tilemap.isTileA3(e)?(c=2,p=2*a,l=2*(h-6),r=Tilemap.WALL_AUTOTILE_TABLE):Tilemap.isTileA4(e)&&(c=3,p=2*a,l=Math.floor(2.5*(h-10)+(h%2==1?.5:0)),h%2==1&&(r=Tilemap.WALL_AUTOTILE_TABLE))
const f=r[o],m=this._tileWidth/2,g=this._tileHeight/2
for(let e=0;e<4;e++){const r=f[e][0],n=f[e][1],o=(2*p+r)*m,a=(2*l+n)*g,h=i+e%2*m,y=s+Math.floor(e/2)*g
if(!d||1!==n&&5!==n)t.addRect(c,o,a,h,y,m,g,u,_)
else{let e=r
const i=void 0
1===n&&(e=(4-r)%4)
const s=(2*p+e)*m,d=(2*l+3)*g
t.addRect(c,s,d,h,y,m,g,u,_),t.addRect(c,o,a,h,y+g/2,m,g/2,u,_)}}},ShaderTilemap.prototype._drawTableEdge=function(t,e,i,s){if(Tilemap.isTileA2(e)){const r=Tilemap.FLOOR_AUTOTILE_TABLE,n=Tilemap.getAutotileKind(e),o=Tilemap.getAutotileShape(e),a=void 0,h=void 0,p=1,l=n%8*2,c=3*(Math.floor(n/8)-2),d=r[o],u=this._tileWidth/2,_=this._tileHeight/2
for(let e=0;e<2;e++){const r=void 0,n=void 0,o=(2*l+d[2+e][0])*u,a=(2*c+d[2+e][1])*_+_/2,h=i+e%2*u,f=s+Math.floor(e/2)*_
t.addRect(p,o,a,h,f,u,_/2)}}},ShaderTilemap.prototype._drawShadow=function(t,e,i,s){if(15&e){const r=this._tileWidth/2,n=this._tileHeight/2
for(let o=0;o<4;o++)if(e&1<<o){const e=i+o%2*r,a=s+Math.floor(o/2)*n
t.addRect(-1,0,0,e,a,r,n)}}},TilingSprite.prototype=Object.create(PIXI.TilingSprite.prototype),TilingSprite.prototype.constructor=TilingSprite,TilingSprite.prototype.initialize=function(t){const e=new PIXI.Texture(new PIXI.BaseTexture)
PIXI.TilingSprite.call(this,e),this._bitmap=null,this._width=0,this._height=0,this._frame=new Rectangle,this.spriteId=Sprite._counter++,this.origin=new Point,this.bitmap=t},TilingSprite.prototype._renderCanvas_PIXI=PIXI.TilingSprite.prototype._renderCanvas,TilingSprite.prototype._render_PIXI=PIXI.TilingSprite.prototype._render,TilingSprite.prototype._renderCanvas=function(t){this._bitmap&&this._bitmap.touch(),this.texture.frame.width>0&&this.texture.frame.height>0&&this._renderCanvas_PIXI(t)},Object.defineProperty(TilingSprite.prototype,"bitmap",{get(){return this._bitmap},set(t){this._bitmap!==t&&(this._bitmap=t,this._bitmap?this._bitmap.addLoadListener(this._onBitmapLoad.bind(this)):this.texture.frame=Rectangle.emptyRectangle)},configurable:!0}),Object.defineProperty(TilingSprite.prototype,"opacity",{get(){return 255*this.alpha},set(t){this.alpha=t.clamp(0,255)/255},configurable:!0}),TilingSprite.prototype.update=function(){this.children.forEach((function(t){t.update&&t.update()}))},TilingSprite.prototype.move=function(t,e,i,s){this.x=t||0,this.y=e||0,this._width=i||0,this._height=s||0},TilingSprite.prototype.setFrame=function(t,e,i,s){this._frame.x=t,this._frame.y=e,this._frame.width=i,this._frame.height=s,this._refresh()},TilingSprite.prototype.updateTransform=function(){this.tilePosition.x=Math.round(-this.origin.x),this.tilePosition.y=Math.round(-this.origin.y),this.updateTransformTS()},TilingSprite.prototype.updateTransformTS=PIXI.TilingSprite.prototype.updateTransform,TilingSprite.prototype._onBitmapLoad=function(){this.texture.baseTexture=this._bitmap.baseTexture,this._refresh()},TilingSprite.prototype._refresh=function(){const t=this._frame.clone()
0===t.width&&0===t.height&&this._bitmap&&(t.width=this._bitmap.width,t.height=this._bitmap.height),this.texture.frame=t,this.texture._updateID++,this.tilingTexture=null},TilingSprite.prototype._render=function(t){this._bitmap&&(this._bitmap.touch(),this._bitmap.checkDirty()),this._render_PIXI(t)},ScreenSprite.prototype=Object.create(PIXI.Container.prototype),ScreenSprite.prototype.constructor=ScreenSprite,ScreenSprite.prototype.initialize=function(){PIXI.Container.call(this),this._graphics=new PIXI.Graphics,this.addChild(this._graphics),this.opacity=0,this._red=-1,this._green=-1,this._blue=-1,this._colorText="",this.setBlack()},Object.defineProperty(ScreenSprite.prototype,"opacity",{get(){return 255*this.alpha},set(t){this.alpha=t.clamp(0,255)/255},configurable:!0}),ScreenSprite.YEPWarned=!1,ScreenSprite.warnYep=function(){ScreenSprite.YEPWarned||(ScreenSprite.YEPWarned=!0)},Object.defineProperty(ScreenSprite.prototype,"anchor",{get(){return ScreenSprite.warnYep(),this.scale.x=1,this.scale.y=1,{x:0,y:0}},set(t){this.alpha=t.clamp(0,255)/255},configurable:!0}),Object.defineProperty(ScreenSprite.prototype,"blendMode",{get(){return this._graphics.blendMode},set(t){this._graphics.blendMode=t},configurable:!0}),ScreenSprite.prototype.setBlack=function(){this.setColor(0,0,0)},ScreenSprite.prototype.setWhite=function(){this.setColor(255,255,255)},ScreenSprite.prototype.setColor=function(t,e,i){if(this._red!==t||this._green!==e||this._blue!==i){t=Math.round(t||0).clamp(0,255),e=Math.round(e||0).clamp(0,255),i=Math.round(i||0).clamp(0,255),this._red=t,this._green=e,this._blue=i,this._colorText=Utils.rgbToCssColor(t,e,i)
const s=this._graphics
s.clear()
const r=t<<16|e<<8|i
s.beginFill(r,1),s.drawRect(5*-Graphics.width,5*-Graphics.height,10*Graphics.width,10*Graphics.height)}},WindowSkinCache._cache={},WindowSkinCache.setItem=function(t,e,i){WindowSkinCache._cache[t]||(WindowSkinCache._cache[t]={}),WindowSkinCache._cache[t][i]=e},WindowSkinCache.getItem=function(t,e){return!!WindowSkinCache._cache[t]&&!!WindowSkinCache._cache[t][e]&&WindowSkinCache._cache[t][e]},Window.prototype=Object.create(PIXI.Container.prototype),Window.prototype.constructor=Window,Window.prototype.initialize=function(){PIXI.Container.call(this),this._isWindow=!0,this._windowskin=null,this._width=0,this._height=0,this._cursorRect=new Rectangle,this._openness=255,this._animationCount=0,this._padding=18,this._margin=4,this._colorTone=[0,0,0],this._windowSpriteContainer=null,this._windowBackSprite=null,this._windowCursorSprite=null,this._windowFrameSprite=null,this._windowContentsSprite=null,this._windowArrowSprites=[],this._windowPauseSignSprite=null,this._createAllParts(),this.origin=new Point,this.active=!0,this.downArrowVisible=!1,this.upArrowVisible=!1,this.pause=!1},Object.defineProperty(Window.prototype,"windowskin",{get(){return this._windowskin},set(t){this._windowskin!==t&&(this._windowskin=t,this._windowskin.addLoadListener(this._onWindowskinLoad.bind(this)))},configurable:!0}),Object.defineProperty(Window.prototype,"contents",{get(){return this._windowContentsSprite.children[0]},set(t){const e=this._windowContentsSprite.children[0]
e&&this._windowContentsSprite.removeChild(e),this._windowContentsSprite.addChild(t)},configurable:!0}),Object.defineProperty(Window.prototype,"width",{get(){return this._width},set(t){this._width=t,this._refreshAllParts()},configurable:!0}),Object.defineProperty(Window.prototype,"height",{get(){return this._height},set(t){this._height=t,this._refreshAllParts()},configurable:!0}),Object.defineProperty(Window.prototype,"padding",{get(){return this._padding},set(t){this._padding=t,this._refreshAllParts()},configurable:!0}),Object.defineProperty(Window.prototype,"margin",{get(){return this._margin},set(t){this._margin=t,this._refreshAllParts()},configurable:!0}),Object.defineProperty(Window.prototype,"opacity",{get(){return 255*this._windowSpriteContainer.alpha},set(t){this._windowSpriteContainer.alpha=t.clamp(0,255)/255},configurable:!0}),Object.defineProperty(Window.prototype,"backOpacity",{get(){return 255*this._windowBackSprite.alpha},set(t){this._windowBackSprite.alpha=t.clamp(0,255)/255},configurable:!0}),Object.defineProperty(Window.prototype,"contentsOpacity",{get(){return 255*this._windowContentsSprite.alpha},set(t){this._windowContentsSprite.alpha=t.clamp(0,255)/255},configurable:!0}),Object.defineProperty(Window.prototype,"openness",{get(){return this._openness},set(t){this._openness!==t&&(this._openness=t.clamp(0,255),this._windowSpriteContainer.scale.y=this._openness/255,this._windowSpriteContainer.y=this.height/2*(1-this._openness/255))},configurable:!0}),Window.prototype.update=function(){this.active&&this._animationCount++,this.children.forEach((function(t){t.update&&t.update()}))},Window.prototype.move=function(t,e,i,s){this.x=Math.floor(t||0),this.y=Math.floor(e||0),this._width===i&&this._height===s||(this._width=Math.floor(i||0),this._height=Math.floor(s||0),this._refreshAllParts())},Window.prototype.isOpen=function(){return this._openness>=255},Window.prototype.isClosed=function(){return this._openness<=0},Window.prototype.setCursorRect=function(t,e,i,s){const r=Math.floor(t||0),n=Math.floor(e||0),o=Math.floor(i||0),a=Math.floor(s||0),h=this._cursorRect
h.x===r&&h.y===n&&h.width===o&&h.height===a||(this._cursorRect.x=r,this._cursorRect.y=n,this._cursorRect.width=o,this._cursorRect.height=a,this._refreshCursor())},Window.prototype.setTone=function(t,e,i){const s=this._colorTone;(t/=255)<0&&(t=0),(e/=255)<0&&(e=0),(i/=255)<0&&(i=0),t===s[0]&&e===s[1]&&i===s[2]||(this._colorTone=[t,e,i],this._refreshBack())},Window.prototype.addChildToBack=function(t){const e=this.children.indexOf(this._windowSpriteContainer)
return this.addChildAt(t,e+1)},Window.prototype.updateTransform=function(){this._updateCursor(),this._updateArrows(),this._updatePauseSign(),this._updateContents(),PIXI.Container.prototype.updateTransform.call(this)},Window.prototype._createAllParts=function(){this._windowSpriteContainer=new PIXI.Container,this._windowBackSprite=new BitmapPIXI,this._windowCursorSprite=new BitmapPIXI,this._windowFrameSprite=new PIXI.Container,this._windowContentsSprite=new Sprite,this._downArrowSprite=new Sprite,this._upArrowSprite=new Sprite,this._windowPauseSignSprite=new Sprite,this._windowBackSprite.alpha=192/255,this.addChild(this._windowSpriteContainer),this._windowSpriteContainer.addChild(this._windowBackSprite),this._windowSpriteContainer.addChild(this._windowFrameSprite),this.addChild(this._windowCursorSprite),this.addChild(this._windowContentsSprite),this.addChild(this._downArrowSprite),this.addChild(this._upArrowSprite),this.addChild(this._windowPauseSignSprite)},Window.prototype._onWindowskinLoad=function(){this._refreshAllParts()},Window.prototype._refreshAllParts=function(){this._refreshBack(),this._refreshFrame(),this._refreshCursor(),this._refreshContents(),this._refreshArrows(),this._refreshPauseSign()},Window.prototype._refreshBack=function(){const t=this._margin,e=this._width-2*t,i=this._height-2*t,s=PIXI.utils.rgb2hex(this._colorTone)
if(e>0&&i>0&&this._windowskin&&!this._windowBackSprite._setupComplete){const t=96
this._windowBackSprite.blt(this._windowskin,0,0,t,t,0,0,e,i),this._windowBackSprite.addChild(this._windowBackSprite.createTilingSprite(this._windowskin.baseTexture,0,t,t,t,e,i)),this._windowBackSprite._setupComplete=!0}this._windowBackSprite.width=e,this._windowBackSprite.height=i,this._windowBackSprite.x=t,this._windowBackSprite.y=t,this._windowBackSprite.children.forEach((function(t){t&&(t.width=e,t.height=i,t.tint=s)}))},Window.prototype._refreshFrame=function(){const t=this._width,e=this._height,i=24
if(t>0&&e>0&&this._windowskin&&!this._windowFrameSprite._setupComplete){let s
const r=WindowSkinCache.getItem(this._windowskin._url,"frame")
if(r)s=r
else{const r=new BitmapPIXI,n=this._windowskin,o=96,a=96
r.blt(n,o+i,0,o-48,i,i,0,t-48,i),r.blt(n,o+i,0+a-i,o-48,i,i,e-i,t-48,i),r.blt(n,o+0,24,i,o-48,0,i,i,e-48),r.blt(n,o+a-i,24,i,o-48,t-i,i,i,e-48),r.blt(n,o+0,0,i,i,0,0,i,i),r.blt(n,o+a-i,0,i,i,t-i,0,i,i),r.blt(n,o+0,0+a-i,i,i,0,e-i,i,i),r.blt(n,o+a-i,0+a-i,i,i,t-i,e-i,i,i),s=Graphics._renderer.generateTexture(r),r.destroy({children:!0,texture:!0}),WindowSkinCache.setItem(this._windowskin._url,s,"frame")}this._windowFramePlane=new PIXI.NineSlicePlane(s,12,12,12,12),this._windowFrameSprite.addChild(this._windowFramePlane),this._windowFrameSprite._setupComplete=!0}this._windowFrameSprite._setupComplete&&(this._windowFramePlane.width=t,this._windowFramePlane.height=e)},Window.prototype._refreshCursor=function(){const t=this._padding,e=this._cursorRect.x+t-this.origin.x,i=this._cursorRect.y+t-this.origin.y,s=this._cursorRect.width,r=this._cursorRect.height
if(s>0&&r>0&&this._windowskin&&!this._windowCursorSprite._setupComplete){const t=96,e=48
this._windowCursorPlane=this._windowCursorSprite.create9Slice(this._windowskin.baseTexture,t,t,e,e,12,12,12,12),this._windowCursorSprite.addChild(this._windowCursorPlane),this._windowCursorSprite._setupComplete=!0}this._windowCursorPlane&&(this._windowCursorPlane.x=e,this._windowCursorPlane.y=i,this._windowCursorPlane.width=s,this._windowCursorPlane.height=r)},Window.prototype._refreshContents=function(){this._windowContentsSprite.move(this.padding,this.padding),this._windowContentsSprite.children.length&&this._windowContentsSprite.children[0].clear()},Window.prototype._refreshArrows=function(){const t=this._width,e=this._height,i=24,s=12,r=120,n=24
this._downArrowSprite.bitmap=this._windowskin,this._downArrowSprite.anchor.x=.5,this._downArrowSprite.anchor.y=.5,this._downArrowSprite.setFrame(132,60,i,s),this._downArrowSprite.move(t/2,e-s),this._upArrowSprite.bitmap=this._windowskin,this._upArrowSprite.anchor.x=.5,this._upArrowSprite.anchor.y=.5,this._upArrowSprite.setFrame(132,n,i,s),this._upArrowSprite.move(t/2,s)},Window.prototype._refreshPauseSign=function(){const t=144,e=96,i=24
this._windowPauseSignSprite.bitmap=this._windowskin,this._windowPauseSignSprite.anchor.x=.5,this._windowPauseSignSprite.anchor.y=1,this._windowPauseSignSprite.move(this._width/2,this._height),this._windowPauseSignSprite.setFrame(t,e,i,i),this._windowPauseSignSprite.alpha=0},Window.prototype._updateCursor=function(){const t=this._animationCount%40
let e=this.contentsOpacity
this.active&&(e-=t<20?8*t:8*(40-t)),this._windowCursorSprite.alpha=e/255,this._windowCursorSprite.visible=this.isOpen()},Window.prototype._updateContents=function(){const t=this._width-2*this._padding,e=this._height-2*this._padding
t>0&&e>0?(this._windowContentsSprite.setFrame(this.origin.x,this.origin.y,t,e),this._windowContentsSprite.visible=this.isOpen()):this._windowContentsSprite.visible=!1},Window.prototype._updateArrows=function(){this._downArrowSprite.visible=this.isOpen()&&this.downArrowVisible,this._upArrowSprite.visible=this.isOpen()&&this.upArrowVisible},Window.prototype._updatePauseSign=function(){const t=this._windowPauseSignSprite,e=Math.floor(this._animationCount/16)%2,i=Math.floor(this._animationCount/16/2)%2,s=144,r=96,n=24
this.pause?t.alpha<1&&(t.alpha=Math.min(t.alpha+.1,1)):t.alpha=0,t.setFrame(s+e*n,r+i*n,n,n),t.visible=this.isOpen()},WindowLayer.prototype=Object.create(PIXI.Container.prototype),WindowLayer.prototype.constructor=WindowLayer,WindowLayer.prototype.initialize=function(){PIXI.Container.call(this),this._width=0,this._height=0,this.on("removed",this.onRemoveAsAChild)},WindowLayer.prototype.onRemoveAsAChild=function(){this.removeChildren()},WindowLayer.voidFilter=new PIXI.filters.AlphaFilter,Object.defineProperty(WindowLayer.prototype,"width",{get(){return this._width},set(t){this._width=t},configurable:!0}),Object.defineProperty(WindowLayer.prototype,"height",{get(){return this._height},set(t){this._height=t},configurable:!0}),WindowLayer.prototype.move=function(t,e,i,s){this.x=t,this.y=e,this.width=i,this.height=s},WindowLayer.prototype.update=function(){this.children.forEach((function(t){t.update&&t.update()}))},WindowLayer.prototype.render=PIXI.Container.prototype.render,WindowLayer.prototype.renderCanvas=PIXI.Container.prototype.renderCanvas,Weather.prototype=Object.create(PIXI.Container.prototype),Weather.prototype.constructor=Weather,Weather.prototype.initialize=function(){PIXI.Container.call(this),this._width=Graphics.width,this._height=Graphics.height,this._sprites=[],this._createBitmaps(),this._createDimmer(),this.type="none",this.power=0,this.origin=new Point},Weather.prototype.update=function(){this._updateDimmer(),this._updateAllSprites()},Weather.prototype._createBitmaps=function(){this._rainBitmap=new Bitmap(1,60),this._rainBitmap.fillAll("white"),this._stormBitmap=new Bitmap(2,100),this._stormBitmap.fillAll("white"),this._snowBitmap=new Bitmap(9,9),this._snowBitmap.drawCircle(4,4,4,"white")},Weather.prototype._createDimmer=function(){this._dimmerSprite=new ScreenSprite,this._dimmerSprite.setColor(80,80,80),this.addChild(this._dimmerSprite)},Weather.prototype._updateDimmer=function(){this._dimmerSprite.opacity=Math.floor(6*this.power)},Weather.prototype._updateAllSprites=function(){const t=Math.floor(10*this.power)
for(;this._sprites.length<t;)this._addSprite()
for(;this._sprites.length>t;)this._removeSprite()
this._sprites.forEach((function(t){this._updateSprite(t),t.x=t.ax-this.origin.x,t.y=t.ay-this.origin.y}),this)},Weather.prototype._addSprite=function(){const t=new Sprite(this.viewport)
t.opacity=0,this._sprites.push(t),this.addChild(t)},Weather.prototype._removeSprite=function(){this.removeChild(this._sprites.pop())},Weather.prototype._updateSprite=function(t){switch(this.type){case"rain":this._updateRainSprite(t)
break
case"storm":this._updateStormSprite(t)
break
case"snow":this._updateSnowSprite(t)}t.opacity<40&&this._rebornSprite(t)},Weather.prototype._updateRainSprite=function(t){t.bitmap=this._rainBitmap,t.rotation=Math.PI/16,t.ax-=6*Math.sin(t.rotation),t.ay+=6*Math.cos(t.rotation),t.opacity-=6},Weather.prototype._updateStormSprite=function(t){t.bitmap=this._stormBitmap,t.rotation=Math.PI/8,t.ax-=8*Math.sin(t.rotation),t.ay+=8*Math.cos(t.rotation),t.opacity-=8},Weather.prototype._updateSnowSprite=function(t){t.bitmap=this._snowBitmap,t.rotation=Math.PI/16,t.ax-=3*Math.sin(t.rotation),t.ay+=3*Math.cos(t.rotation),t.opacity-=3},Weather.prototype._rebornSprite=function(t){t.ax=Math.randomInt(Graphics.width+100)-100+this.origin.x,t.ay=Math.randomInt(Graphics.height+200)-200+this.origin.y,t.opacity=160+Math.randomInt(60)},ToneFilter.prototype=Object.create(PIXI.filters.ColorMatrixFilter.prototype),ToneFilter.prototype.constructor=ToneFilter,ToneFilter.prototype.adjustHue=function(t){this.hue(t,!0)},ToneFilter.prototype.adjustSaturation=function(t){t=(t||0).clamp(-255,255)/255,this.saturate(t,!0)},ToneFilter.prototype.adjustTone=function(t,e,i){if(t=(t||0).clamp(-255,255)/255,e=(e||0).clamp(-255,255)/255,i=(i||0).clamp(-255,255)/255,0!==t||0!==e||0!==i){const s=[1,0,0,t,0,0,1,0,e,0,0,0,1,i,0,0,0,0,1,0]
this._loadMatrix(s,!0)}},ToneSprite.prototype=Object.create(PIXI.Container.prototype),ToneSprite.prototype.constructor=ToneSprite,ToneSprite.prototype.initialize=function(){PIXI.Container.call(this),this.clear()},ToneSprite.prototype.clear=function(){this._red=0,this._green=0,this._blue=0,this._gray=0},ToneSprite.prototype.setTone=function(t,e,i,s){this._red=Math.round(t||0).clamp(-255,255),this._green=Math.round(e||0).clamp(-255,255),this._blue=Math.round(i||0).clamp(-255,255),this._gray=Math.round(s||0).clamp(0,255)},ToneSprite.prototype._renderCanvas=function(t){if(this.visible){const e=t.context,i=this.worldTransform,s=t.resolution,r=Graphics.width,n=Graphics.height
e.save(),e.setTransform(i.a,i.b,i.c,i.d,i.tx*s,i.ty*s),Graphics.canUseSaturationBlend()&&this._gray>0&&(e.globalCompositeOperation="saturation",e.globalAlpha=this._gray/255,e.fillStyle="#ffffff",e.fillRect(0,0,r,n)),e.globalAlpha=1
const o=Math.max(0,this._red),a=Math.max(0,this._green),h=Math.max(0,this._blue)
if((o||a||h)&&(e.globalCompositeOperation="lighter",e.fillStyle=Utils.rgbToCssColor(o,a,h),e.fillRect(0,0,r,n)),Graphics.canUseDifferenceBlend()){const t=Math.max(0,-this._red),i=Math.max(0,-this._green),s=Math.max(0,-this._blue);(t||i||s)&&(e.globalCompositeOperation="difference",e.fillStyle="#ffffff",e.fillRect(0,0,r,n),e.globalCompositeOperation="lighter",e.fillStyle=Utils.rgbToCssColor(t,i,s),e.fillRect(0,0,r,n),e.globalCompositeOperation="difference",e.fillStyle="#ffffff",e.fillRect(0,0,r,n))}e.restore()}},ToneSprite.prototype._render=function(t){},Stage.prototype=Object.create(PIXI.Container.prototype),Stage.prototype.constructor=Stage,Stage.prototype.initialize=function(){PIXI.Container.call(this),this.interactive=!1},WebAudio._standAlone=(function(t){return!t.ResourceHandler})(this),WebAudio.prototype.initialize=function(t){WebAudio._initialized||WebAudio.initialize(),this.clear(),WebAudio._standAlone||(this._loader=ResourceHandler.createLoader(t,this._load.bind(this,t),function(){this._hasError=!0}.bind(this))),this._load(t),this._url=t},WebAudio._masterVolume=1,WebAudio._context=null,WebAudio._masterGainNode=null,WebAudio._initialized=!1,WebAudio._unlocked=!1,WebAudio.initialize=function(t){return this._initialized||(t||(this._createContext(),this._detectCodecs(),this._createMasterGainNode(),this._setupEventHandlers()),this._initialized=!0),!!this._context},WebAudio.canPlayOgg=function(){return this._initialized||this.initialize(),!!this._canPlayOgg},WebAudio.canPlayM4a=function(){return this._initialized||this.initialize(),!!this._canPlayM4a},WebAudio.setMasterVolume=function(t){this._masterVolume=t,this._masterGainNode&&this._masterGainNode.gain.setValueAtTime(this._masterVolume,this._context.currentTime)},WebAudio._createContext=function(){try{"undefined"!=typeof AudioContext?this._context=new AudioContext:"undefined"!=typeof webkitAudioContext&&(this._context=new webkitAudioContext)}catch(t){this._context=null}},WebAudio._detectCodecs=function(){const t=document.createElement("audio")
t.canPlayType&&(this._canPlayOgg=t.canPlayType('audio/ogg; codecs="vorbis"'),this._canPlayM4a=t.canPlayType("audio/mp4"))},WebAudio._createMasterGainNode=function(){const t=WebAudio._context
t&&(this._masterGainNode=t.createGain(),this._masterGainNode.gain.setValueAtTime(this._masterVolume,t.currentTime),this._masterGainNode.connect(t.destination))},WebAudio._setupEventHandlers=function(){const resumeHandler=function(){const t=WebAudio._context
t&&"suspended"===t.state&&"function"==typeof t.resume?t.resume().then((function(){WebAudio._onTouchStart()})):WebAudio._onTouchStart()}
document.addEventListener("keydown",resumeHandler),document.addEventListener("mousedown",resumeHandler),document.addEventListener("touchend",resumeHandler),document.addEventListener("touchstart",this._onTouchStart.bind(this)),document.addEventListener("visibilitychange",this._onVisibilityChange.bind(this))},WebAudio._onTouchStart=function(){const t=WebAudio._context
if(t&&!this._unlocked){const e=void 0
t.createBufferSource().start(0),this._unlocked=!0}},WebAudio._onVisibilityChange=function(){"hidden"===document.visibilityState?this._onHide():this._onShow()},WebAudio._onHide=function(){this._shouldMuteOnHide()&&this._fadeOut(1)},WebAudio._onShow=function(){this._shouldMuteOnHide()&&this._fadeIn(1)},WebAudio._shouldMuteOnHide=function(){return Utils.isMobileDevice()},WebAudio._fadeIn=function(t){if(this._masterGainNode){const e=this._masterGainNode.gain,i=WebAudio._context.currentTime
e.setValueAtTime(0,i),e.linearRampToValueAtTime(this._masterVolume,i+t)}},WebAudio._fadeOut=function(t){if(this._masterGainNode){const e=this._masterGainNode.gain,i=WebAudio._context.currentTime
e.setValueAtTime(this._masterVolume,i),e.linearRampToValueAtTime(0,i+t)}},WebAudio.prototype.clear=function(){this.stop(),this._buffer=null,this._sourceNode=null,this._gainNode=null,this._pannerNode=null,this._totalTime=0,this._sampleRate=0,this._loopStart=0,this._loopLength=0,this._startTime=0,this._volume=1,this._pitch=1,this._pan=0,this._endTimer=null,this._loadListeners=[],this._stopListeners=[],this._hasError=!1,this._autoPlay=!1},Object.defineProperty(WebAudio.prototype,"url",{get(){return this._url},configurable:!0}),Object.defineProperty(WebAudio.prototype,"volume",{get(){return this._volume},set(t){this._volume=t,this._gainNode&&this._gainNode.gain.setValueAtTime(this._volume,WebAudio._context.currentTime)},configurable:!0}),Object.defineProperty(WebAudio.prototype,"pitch",{get(){return this._pitch},set(t){this._pitch!==t&&(this._pitch=t,this.isPlaying()&&this.play(this._sourceNode.loop,0))},configurable:!0}),Object.defineProperty(WebAudio.prototype,"pan",{get(){return this._pan},set(t){this._pan=t,this._updatePanner()},configurable:!0}),WebAudio.prototype.isReady=function(){return!!this._buffer},WebAudio.prototype.isError=function(){return this._hasError},WebAudio.prototype.isPlaying=function(){return!!this._sourceNode},WebAudio.prototype.play=function(t,e){this.isReady()?(e=e||0,this._startPlaying(t,e)):WebAudio._context&&(this._autoPlay=!0,this.addLoadListener(function(){this._autoPlay&&this.play(t,e)}.bind(this)))},WebAudio.prototype.stop=function(){if(this._autoPlay=!1,this._removeEndTimer(),this._removeNodes(),this._stopListeners)for(;this._stopListeners.length>0;){const t=void 0
this._stopListeners.shift()()}},WebAudio.prototype.fadeIn=function(t){if(this.isReady()){if(this._gainNode){const e=this._gainNode.gain,i=WebAudio._context.currentTime
e.setValueAtTime(0,i),e.linearRampToValueAtTime(this._volume,i+t)}}else this._autoPlay&&this.addLoadListener(function(){this.fadeIn(t)}.bind(this))},WebAudio.prototype.fadeOut=function(t){if(this._gainNode){const e=this._gainNode.gain,i=WebAudio._context.currentTime
e.setValueAtTime(this._volume,i),e.linearRampToValueAtTime(0,i+t)}this._autoPlay=!1},WebAudio.prototype.seek=function(){if(WebAudio._context){let t=(WebAudio._context.currentTime-this._startTime)*this._pitch
if(this._loopLength>0)for(;t>=this._loopStart+this._loopLength;)t-=this._loopLength
return t}return 0},WebAudio.prototype.addLoadListener=function(t){this._loadListeners.push(t)},WebAudio.prototype.addStopListener=function(t){this._stopListeners.push(t)},WebAudio.prototype._load=function(t){if(WebAudio._context){const e=new XMLHttpRequest
Decrypter.hasEncryptedAudio&&(t=Decrypter.extToEncryptExt(t)),e.open("GET",t),e.responseType="arraybuffer",e.onload=function(){e.status<400&&this._onXhrLoad(e)}.bind(this),e.onerror=this._loader||function(){this._hasError=!0}.bind(this),e.send()}},WebAudio.prototype._onXhrLoad=function(t){let e=t.response
Decrypter.hasEncryptedAudio&&(e=Decrypter.decryptArrayBuffer(e)),this._readLoopComments(new Uint8Array(e)),WebAudio._context.decodeAudioData(e,function(t){this._buffer=t,this._totalTime=t.duration,this._loopLength>0&&this._sampleRate>0?(this._loopStart/=this._sampleRate,this._loopLength/=this._sampleRate):(this._loopStart=0,this._loopLength=this._totalTime),this._onLoad()}.bind(this))},WebAudio.prototype._startPlaying=function(t,e){if(this._loopLength>0)for(;e>=this._loopStart+this._loopLength;)e-=this._loopLength
this._removeEndTimer(),this._removeNodes(),this._createNodes(),this._connectNodes(),this._sourceNode.loop=t,this._sourceNode.start(0,e),this._startTime=WebAudio._context.currentTime-e/this._pitch,this._createEndTimer()},WebAudio.prototype._createNodes=function(){const t=WebAudio._context
this._sourceNode=t.createBufferSource(),this._sourceNode.buffer=this._buffer,this._sourceNode.loopStart=this._loopStart,this._sourceNode.loopEnd=this._loopStart+this._loopLength,this._sourceNode.playbackRate.setValueAtTime(this._pitch,t.currentTime),this._gainNode=t.createGain(),this._gainNode.gain.setValueAtTime(this._volume,t.currentTime),this._pannerNode=t.createPanner(),this._pannerNode.panningModel="equalpower",this._updatePanner()},WebAudio.prototype._connectNodes=function(){this._sourceNode.connect(this._gainNode),this._gainNode.connect(this._pannerNode),this._pannerNode.connect(WebAudio._masterGainNode)},WebAudio.prototype._removeNodes=function(){this._sourceNode&&(this._sourceNode.stop(0),this._sourceNode=null,this._gainNode=null,this._pannerNode=null)},WebAudio.prototype._createEndTimer=function(){if(this._sourceNode&&!this._sourceNode.loop){const t=void 0,e=this._startTime+this._totalTime/this._pitch-WebAudio._context.currentTime
this._endTimer=setTimeout(function(){this.stop()}.bind(this),1e3*e)}},WebAudio.prototype._removeEndTimer=function(){this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null)},WebAudio.prototype._updatePanner=function(){if(this._pannerNode){const t=this._pan,e=1-Math.abs(t)
this._pannerNode.setPosition(t,0,e)}},WebAudio.prototype._onLoad=function(){for(;this._loadListeners.length>0;){const t=void 0
this._loadListeners.shift()()}},WebAudio.prototype._readLoopComments=function(t){this._readOgg(t),this._readMp4(t)},WebAudio.prototype._readOgg=function(t){let e=0
for(;e<t.length&&"OggS"===this._readFourCharacters(t,e);){e+=26
let i=!1
const s=t[e++],r=[]
for(let i=0;i<s;i++)r.push(t[e++])
for(let n=0;n<s;n++){if("vorb"===this._readFourCharacters(t,e+1)){const o=t[e]
if(1===o)this._sampleRate=this._readLittleEndian(t,e+12)
else if(3===o){let i=0
for(;n<s&&(i+=r[n],!(r[n]<255));n++);this._readMetaData(t,e,i)}i=!0}e+=r[n]}if(!i)break}},WebAudio.prototype._readMp4=function(t){if("ftyp"===this._readFourCharacters(t,4)){let e=0
for(;e<t.length;){const i=this._readBigEndian(t,e),s=this._readFourCharacters(t,e+4)
if("moov"===s)e+=8
else if("mvhd"===s&&(this._sampleRate=this._readBigEndian(t,e+20)),"udta"!==s&&"meta"!==s||this._readMetaData(t,e,i),e+=i,i<=1)break}}},WebAudio.prototype._readMetaData=function(t,e,i){for(let s=e;s<e+i-10;s++)if("LOOP"===this._readFourCharacters(t,s)){let e=""
for(;t[s]>0;)e+=String.fromCharCode(t[s++])
if(e.match(/LOOPSTART=([0-9]+)/)&&(this._loopStart=parseInt(RegExp.$1)),e.match(/LOOPLENGTH=([0-9]+)/)&&(this._loopLength=parseInt(RegExp.$1)),"LOOPSTART"==e||"LOOPLENGTH"==e){let i=""
for(s+=16;t[s]>0;)i+=String.fromCharCode(t[s++])
"LOOPSTART"==e?this._loopStart=parseInt(i):this._loopLength=parseInt(i)}}},WebAudio.prototype._readLittleEndian=function(t,e){return 16777216*t[e+3]+65536*t[e+2]+256*t[e+1]+t[e+0]},WebAudio.prototype._readBigEndian=function(t,e){return 16777216*t[e+0]+65536*t[e+1]+256*t[e+2]+t[e+3]},WebAudio.prototype._readFourCharacters=function(t,e){let i=""
for(let s=0;s<4;s++)i+=String.fromCharCode(t[e+s])
return i},JsonEx.maxDepth=100,JsonEx._id=1,JsonEx._generateId=function(){return JsonEx._id++},JsonEx.stringify=function(t){const e=[]
JsonEx._id=1
const i=JSON.stringify(this._encode(t,e,0))
return this._cleanMetadata(t),this._restoreCircularReference(e),i},JsonEx._restoreCircularReference=function(t){t.forEach((function(t){const e=t[0],i=t[1],s=t[2]
i[e]=s}))},JsonEx.parse=function(t){const e=[],i={},s=this._decode(JSON.parse(t),e,i)
return this._cleanMetadata(s),this._linkCircularReference(s,e,i),s},JsonEx._linkCircularReference=function(t,e,i){e.forEach((function(t){const e=t[0],s=t[1],r=t[2]
s[e]=i[r]}))},JsonEx._cleanMetadata=function(t){t&&(delete t["@"],delete t["@c"],"object"==typeof t&&Object.keys(t).forEach((function(e){const i=t[e]
"object"==typeof i&&JsonEx._cleanMetadata(i)})))},JsonEx.makeDeepCopy=function(t){return this.parse(this.stringify(t))},JsonEx._encode=function(t,e,i){if(i=i||0,++i>=this.maxDepth)throw new Error("Object too deep")
const s={}.toString.call(t)
if("[object Object]"===s||"[object Array]"===s){t["@c"]=JsonEx._generateId()
const s=this._getConstructorName(t)
"Object"!==s&&"Array"!==s&&(t["@"]=s)
for(let s in t)t.hasOwnProperty&&!t.hasOwnProperty(s)||s.match(/^@./)||(t[s]&&"object"==typeof t[s]?t[s]["@c"]?(e.push([s,t,t[s]]),t[s]={"@r":t[s]["@c"]}):(t[s]=this._encode(t[s],e,i+1),t[s]instanceof Array&&(e.push([s,t,t[s]]),t[s]={"@c":t[s]["@c"],"@a":t[s]})):t[s]=this._encode(t[s],e,i+1))}return i--,t},JsonEx._decode=function(t,e,i){const s={}.toString.call(t)
if("[object Object]"===s||"[object Array]"===s){if(i[t["@c"]]=t,null===t["@"])t=this._resetPrototype(t,null)
else if(t["@"]){const e=window[t["@"]]
e&&(t=this._resetPrototype(t,e.prototype))}for(let s in t)if(!t.hasOwnProperty||t.hasOwnProperty(s)){if(t[s]&&t[s]["@a"]){const e=t[s]["@a"]
e["@c"]=t[s]["@c"],t[s]=e}t[s]&&t[s]["@r"]&&e.push([s,t,t[s]["@r"]]),t[s]=this._decode(t[s],e,i)}}return t},JsonEx._getConstructorName=function(t){if(!t.constructor)return null
let e=t.constructor.name
if(void 0===e){const i=void 0
e=/^\s*function\s*([A-Za-z0-9_$]*)/.exec(t.constructor)[1]}return e},JsonEx._resetPrototype=function(t,e){if(void 0!==Object.setPrototypeOf&&"object"==typeof e)Object.setPrototypeOf(t,e)
else if("__proto__"in t)t.__proto__=e
else{const i=Object.create(e)
for(let e in t)t.hasOwnProperty(e)&&(i[e]=t[e])
t=i}return t},Decrypter.hasEncryptedImages=!1,Decrypter.hasEncryptedAudio=!1,Decrypter._requestImgFile=[],Decrypter._headerlength=16,Decrypter._xhrOk=400,Decrypter._encryptionKey="",Decrypter._ignoreList=["img/system/Window.png"],Decrypter.SIGNATURE="5250474d56000000",Decrypter.VER="000301",Decrypter.REMAIN="0000000000",Decrypter.checkImgIgnore=function(t){for(let e=0;e<this._ignoreList.length;e++)if(t===this._ignoreList[e])return!0
return!1},Decrypter.decryptImg=function(t,e){t=this.extToEncryptExt(t)
const i=new XMLHttpRequest
i.open("GET",t),i.responseType="arraybuffer",i.send(),i.onload=function(){if(this.status<Decrypter._xhrOk){const t=Decrypter.decryptArrayBuffer(i.response)
e._image.src=Decrypter.createBlobUrl(t),e._image.addEventListener("load",e._loadListener=Bitmap.prototype._onLoad.bind(e)),e._image.addEventListener("error",e._errorListener=e._loader||Bitmap.prototype._onError.bind(e))}},i.onerror=function(){e._loader?e._loader():e._onError()}},Decrypter.cutArrayHeader=function(t,e){return t.slice(e)},Decrypter.decryptArrayBuffer=function(t){if(!t)return null
const e=new Uint8Array(t,0,this._headerlength)
let i
const s=this.SIGNATURE+this.VER+this.REMAIN,r=new Uint8Array(16)
for(i=0;i<this._headerlength;i++)r[i]=parseInt("0x"+s.substr(2*i,2),16)
for(i=0;i<this._headerlength;i++)if(e[i]!==r[i])throw new Error("Header is wrong")
t=this.cutArrayHeader(t,Decrypter._headerlength)
const n=new DataView(t)
if(this.readEncryptionkey(),t){const e=new Uint8Array(t)
for(i=0;i<this._headerlength;i++)e[i]=e[i]^parseInt(Decrypter._encryptionKey[i],16),n.setUint8(i,e[i])}return t},Decrypter.createBlobUrl=function(t){const e=new Blob([t])
return window.URL.createObjectURL(e)},Decrypter.extToEncryptExt=function(t){const e=t.split(".").pop()
let i=e
return i="ogg"===e?".rpgmvo":"m4a"===e?".rpgmvm":"png"===e?".rpgmvp":e,t.slice(0,t.lastIndexOf(e)-1)+i},Decrypter.readEncryptionkey=function(){this._encryptionKey=$dataSystem.encryptionKey.split(/(.{2})/).filter(Boolean)},ResourceHandler._reloaders=[],ResourceHandler._defaultRetryInterval=[500,1e3,3e3],ResourceHandler.createLoader=function(t,e,i,s){s=s||this._defaultRetryInterval
const r=this._reloaders
let n=0
return function(){n<s.length?(setTimeout(e,s[n]),n++):(i&&i(),t&&(0===r.length&&(Graphics.printLoadingError(t),SceneManager.stop()),r.push((function(){n=0,e()}))))}},ResourceHandler.exists=function(){return this._reloaders.length>0},ResourceHandler.retry=function(){this._reloaders.length>0&&(Graphics.eraseLoadingError(),SceneManager.resume(),this._reloaders.forEach((function(t){t()})),this._reloaders.length=0)}
