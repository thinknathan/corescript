/*!!
 * game_storage_worker.js - corescript v1.6.1 (community-1.4)
 * (c) 2015 KADOKAWA CORPORATION./YOJI OJIMA
 * Contributions by the RPG Maker MV CoreScript team
 * https://github.com/thinknathan/corescript/blob/master/CONTRIBUTORS.md
 *
 * idb-keyval 6.2.0 | Copyright 2016, Jake Archibald
 * https://github.com/jakearchibald/idb-keyval/blob/main/LICENCE
 *
 * fflate@0.7.3 | https://github.com/101arrowz/fflate/blob/master/LICENSE
 *
 * Comlink | Copyright 2019 Google Inc.
 * https://github.com/GoogleChromeLabs/comlink/blob/main/LICENSE
 */
!(function(){"use strict";var e=Uint8Array,r=Uint16Array,t=Uint32Array,a=new e([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),n=new e([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),o=new e([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),s=function(e,a){for(var n=new r(31),o=0;o<31;++o)n[o]=a+=1<<e[o-1];var s=new t(n[30]);for(o=1;o<30;++o)for(var i=n[o];i<n[o+1];++i)s[i]=i-n[o]<<5|o;return[n,s]},i=s(a,2),c=i[0],u=i[1];c[28]=258,u[258]=28;for(var l=s(n,0),f=l[0],v=l[1],h=new r(32768),d=0;d<32768;++d){var g=(43690&d)>>>1|(21845&d)<<1;g=(61680&(g=(52428&g)>>>2|(13107&g)<<2))>>>4|(3855&g)<<4,h[d]=((65280&g)>>>8|(255&g)<<8)>>>1}var p=function(e,t,a){for(var n=e.length,o=0,s=new r(t);o<n;++o)e[o]&&++s[e[o]-1];var i,c=new r(t);for(o=0;o<t;++o)c[o]=c[o-1]+s[o-1]<<1;if(a){i=new r(1<<t);var u=15-t;for(o=0;o<n;++o)if(e[o])for(var l=o<<4|e[o],f=t-e[o],v=c[e[o]-1]++<<f,d=v|(1<<f)-1;v<=d;++v)i[h[v]>>>u]=l}else for(i=new r(n),o=0;o<n;++o)e[o]&&(i[o]=h[c[e[o]-1]++]>>>15-e[o]);return i},m=new e(288);for(d=0;d<144;++d)m[d]=8;for(d=144;d<256;++d)m[d]=9;for(d=256;d<280;++d)m[d]=7;for(d=280;d<288;++d)m[d]=8;var w=new e(32);for(d=0;d<32;++d)w[d]=5;var y=p(m,9,0),b=p(m,9,1),k=p(w,5,0),E=p(w,5,1),S=function(e){for(var r=e[0],t=1;t<e.length;++t)e[t]>r&&(r=e[t]);return r},C=function(e,r,t){var a=r/8|0;return(e[a]|e[a+1]<<8)>>(7&r)&t},M=function(e,r){var t=r/8|0;return(e[t]|e[t+1]<<8|e[t+2]<<16)>>(7&r)},T=function(e){return(e+7)/8|0},A=function(a,n,o){(null==n||n<0)&&(n=0),(null==o||o>a.length)&&(o=a.length);var s=new(2==a.BYTES_PER_ELEMENT?r:4==a.BYTES_PER_ELEMENT?t:e)(o-n);return s.set(a.subarray(n,o)),s},x=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],K=function(e,r,t){var a=new Error(r||x[e]);if(a.code=e,Error.captureStackTrace&&Error.captureStackTrace(a,K),!t)throw a;return a},L=function(e,r,t){t<<=7&r;var a=r/8|0;e[a]|=t,e[a+1]|=t>>>8},P=function(e,r,t){t<<=7&r;var a=r/8|0;e[a]|=t,e[a+1]|=t>>>8,e[a+2]|=t>>>16},R=function(t,a){for(var n=[],o=0;o<t.length;++o)t[o]&&n.push({s:o,f:t[o]});var s=n.length,i=n.slice();if(!s)return[z,0];if(1==s){var c=new e(n[0].s+1);return c[n[0].s]=1,[c,1]}n.sort((function(e,r){return e.f-r.f})),n.push({s:-1,f:25001});var u=n[0],l=n[1],f=0,v=1,h=2;for(n[0]={s:-1,f:u.f+l.f,l:u,r:l};v!=s-1;)u=n[n[f].f<n[h].f?f++:h++],l=n[f!=v&&n[f].f<n[h].f?f++:h++],n[v++]={s:-1,f:u.f+l.f,l:u,r:l};var d=i[0].s;for(o=1;o<s;++o)i[o].s>d&&(d=i[o].s);var g=new r(d+1),p=N(n[v-1],g,0);if(p>a){o=0;var m=0,w=p-a,y=1<<w;for(i.sort((function(e,r){return g[r.s]-g[e.s]||e.f-r.f}));o<s;++o){var b=i[o].s;if(!(g[b]>a))break;m+=y-(1<<p-g[b]),g[b]=a}for(m>>>=w;m>0;){var k=i[o].s;g[k]<a?m-=1<<a-g[k]++-1:++o}for(;o>=0&&m;--o){var E=i[o].s;g[E]==a&&(--g[E],++m)}p=a}return[new e(g),p]},N=function(e,r,t){return-1==e.s?Math.max(N(e.l,r,t+1),N(e.r,r,t+1)):r[e.s]=t},O=function(e){for(var t=e.length;t&&!e[--t];);for(var a=new r(++t),n=0,o=e[0],s=1,i=function(e){a[n++]=e},c=1;c<=t;++c)if(e[c]==o&&c!=t)++s;else{if(!o&&s>2){for(;s>138;s-=138)i(32754);s>2&&(i(s>10?s-11<<5|28690:s-3<<5|12305),s=0)}else if(s>3){for(i(o),--s;s>6;s-=6)i(8304);s>2&&(i(s-3<<5|8208),s=0)}for(;s--;)i(o);s=1,o=e[c]}return[a.subarray(0,n),t]},W=function(e,r){for(var t=0,a=0;a<r.length;++a)t+=e[a]*r[a];return t},j=function(e,r,t){var a=t.length,n=T(r+2);e[n]=255&a,e[n+1]=a>>>8,e[n+2]=255^e[n],e[n+3]=255^e[n+1];for(var o=0;o<a;++o)e[n+o+4]=t[o];return 8*(n+4+a)},G=function(e,t,s,i,c,u,l,f,v,h,d){L(t,d++,s),++c[256];for(var g=R(c,15),b=g[0],E=g[1],S=R(u,15),C=S[0],M=S[1],T=O(b),A=T[0],x=T[1],K=O(C),N=K[0],G=K[1],B=new r(19),z=0;z<A.length;++z)B[31&A[z]]++;for(z=0;z<N.length;++z)B[31&N[z]]++;for(var D=R(B,7),U=D[0],_=D[1],F=19;F>4&&!U[o[F-1]];--F);var H,Y,I,X,q=h+5<<3,J=W(c,m)+W(u,w)+l,Q=W(c,b)+W(u,C)+l+14+3*F+W(B,U)+(2*B[16]+3*B[17]+7*B[18]);if(q<=J&&q<=Q)return j(t,d,e.subarray(v,v+h));if(L(t,d,1+(Q<J)),d+=2,Q<J){H=p(b,E,0),Y=b,I=p(C,M,0),X=C;var V=p(U,_,0);for(L(t,d,x-257),L(t,d+5,G-1),L(t,d+10,F-4),d+=14,z=0;z<F;++z)L(t,d+3*z,U[o[z]]);d+=3*F;for(var Z=[A,N],$=0;$<2;++$){var ee=Z[$];for(z=0;z<ee.length;++z){var re=31&ee[z];L(t,d,V[re]),d+=U[re],re>15&&(L(t,d,ee[z]>>>5&127),d+=ee[z]>>>12)}}}else H=y,Y=m,I=k,X=w;for(z=0;z<f;++z)if(i[z]>255){re=i[z]>>>18&31,P(t,d,H[re+257]),d+=Y[re+257],re>7&&(L(t,d,i[z]>>>23&31),d+=a[re]);var te=31&i[z];P(t,d,I[te]),d+=X[te],te>3&&(P(t,d,i[z]>>>5&8191),d+=n[te])}else P(t,d,H[i[z]]),d+=Y[i[z]];return P(t,d,H[256]),d+Y[256]},B=new t([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),z=new e(0);var D="undefined"!=typeof TextEncoder&&new TextEncoder,U="undefined"!=typeof TextDecoder&&new TextDecoder;try{U.decode(z,{stream:!0})}catch(e){}function _(e){return new Promise(((r,t)=>{e.oncomplete=e.onsuccess=()=>r(e.result),e.onabort=e.onerror=()=>t(e.error)}))}let F;function H(){return F||(F=(function(e,r){const t=indexedDB.open("keyval-store");t.onupgradeneeded=()=>t.result.createObjectStore(r);const a=_(t);return(e,t)=>a.then((a=>t(a.transaction(r,e).objectStore(r))))})(0,"keyval")),F}function Y(e,r=H()){return r("readonly",(r=>_(r.get(e))))}function I(e,r,t=H()){return t("readwrite",(t=>(t.put(r,e),_(t.transaction))))}function X(e,r=H()){return r("readwrite",(r=>(r.delete(e),_(r.transaction))))}function q(e=H()){return e("readonly",(e=>{if(e.getAllKeys)return _(e.getAllKeys());const r=[];return(function(e,t){return e.openCursor().onsuccess=function(){var e;this.result&&(e=this.result,r.push(e.key),this.result.continue())},_(e.transaction)})(e).then((()=>r))}))}const J=Symbol("Comlink.proxy"),Q=Symbol("Comlink.endpoint"),V=Symbol("Comlink.releaseProxy"),Z=Symbol("Comlink.thrown"),$=e=>"object"==typeof e&&null!==e||"function"==typeof e,ee=new Map([["proxy",{canHandle:e=>$(e)&&e[J],serialize(e){const{port1:r,port2:t}=new MessageChannel;return re(e,r),[t,[t]]},deserialize:e=>(e.start(),ne(e,[],undefined))}],["throw",{canHandle:e=>$(e)&&Z in e,serialize({value:e}){let r;return r=e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[r,[]]},deserialize(e){if(e.isError)throw Object.assign(new Error(e.value.message),e.value);throw e.value}}]]);function re(e,r=self){r.addEventListener("message",(function t(a){if(!a||!a.data)return;const{id:n,type:o,path:s}=Object.assign({path:[]},a.data),i=(a.data.argumentList||[]).map(ue);let c;try{const r=s.slice(0,-1).reduce(((e,r)=>e[r]),e),t=s.reduce(((e,r)=>e[r]),e);switch(o){case"GET":c=t;break;case"SET":r[s.slice(-1)[0]]=ue(a.data.value),c=!0;break;case"APPLY":c=t.apply(r,i);break;case"CONSTRUCT":c=(function(e){return Object.assign(e,{[J]:!0})})(new t(...i));break;case"ENDPOINT":{const{port1:r,port2:t}=new MessageChannel;re(e,t),c=ie(r,[r])}break;case"RELEASE":c=void 0;break;default:return}}catch(e){c={value:e,[Z]:0}}Promise.resolve(c).catch((e=>({value:e,[Z]:0}))).then((e=>{const[a,s]=ce(e);r.postMessage(Object.assign(Object.assign({},a),{id:n}),s),"RELEASE"===o&&(r.removeEventListener("message",t),te(r))}))})),r.start&&r.start()}function te(e){(function(e){return"MessagePort"===e.constructor.name})(e)&&e.close()}function ae(e){if(e)throw new Error("Proxy has been released and is not useable")}function ne(e,r=[],t=function(){}){let a=!1;const n=new Proxy(t,{get(t,o){if(ae(a),o===V)return()=>le(e,{type:"RELEASE",path:r.map((e=>e.toString()))}).then((()=>{te(e),a=!0}));if("then"===o){if(0===r.length)return{then:()=>n};const t=le(e,{type:"GET",path:r.map((e=>e.toString()))}).then(ue);return t.then.bind(t)}return ne(e,[...r,o])},set(t,n,o){ae(a);const[s,i]=ce(o);return le(e,{type:"SET",path:[...r,n].map((e=>e.toString())),value:s},i).then(ue)},apply(t,n,o){ae(a);const s=r[r.length-1];if(s===Q)return le(e,{type:"ENDPOINT"}).then(ue);if("bind"===s)return ne(e,r.slice(0,-1));const[i,c]=oe(o);return le(e,{type:"APPLY",path:r.map((e=>e.toString())),argumentList:i},c).then(ue)},construct(t,n){ae(a);const[o,s]=oe(n);return le(e,{type:"CONSTRUCT",path:r.map((e=>e.toString())),argumentList:o},s).then(ue)}});return n}function oe(e){const r=e.map(ce);return[r.map((e=>e[0])),(t=r.map((e=>e[1])),Array.prototype.concat.apply([],t))];var t}const se=new WeakMap;function ie(e,r){return se.set(e,r),e}function ce(e){for(const[r,t]of ee)if(t.canHandle(e)){const[a,n]=t.serialize(e);return[{type:"HANDLER",name:r,value:a},n]}return[{type:"RAW",value:e},se.get(e)||[]]}function ue(e){switch(e.type){case"HANDLER":return ee.get(e.name).deserialize(e.value);case"RAW":return e.value}}function le(e,r,t){return new Promise((a=>{const n=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");e.addEventListener("message",(function r(t){t.data&&t.data.id&&t.data.id===n&&(e.removeEventListener("message",r),a(t.data))})),e.start&&e.start(),e.postMessage(Object.assign({id:n},r),t)}))}class fe{static successCallback(){return!0}static failureCallback(e){return console.error(e),!1}static compress(o){if(null===o)return null;try{const s=(function(r,t){var a;if(D)return D.encode(r);var n=r.length,o=new e(r.length+(r.length>>1)),s=0,i=function(e){o[s++]=e};for(a=0;a<n;++a){if(s+5>o.length){var c=new e(s+8+(n-a<<1));c.set(o),o=c}var u=r.charCodeAt(a);u<128?i(u):u<2048?(i(192|u>>6),i(128|63&u)):u>55295&&u<57344?(i(240|(u=65536+(1047552&u)|1023&r.charCodeAt(++a))>>18),i(128|u>>12&63),i(128|u>>6&63),i(128|63&u)):(i(224|u>>12),i(128|u>>6&63),i(128|63&u))}return A(o,0,s)})(o);return(function(o,s){return l=0,f=0,(function(o,s,i,c,l,f){var h=o.length,d=new e(c+h+5*(1+Math.ceil(h/7e3))+l),g=d.subarray(c,d.length-l),p=0;if(!s||h<8)for(var m=0;m<=h;m+=65535){var w=m+65535;w>=h&&(g[p>>3]=f),p=j(g,p+1,o.subarray(m,w))}else{for(var y=B[s-1],b=y>>>13,k=8191&y,E=(1<<i)-1,S=new r(32768),C=new r(E+1),M=Math.ceil(i/3),x=2*M,K=function(e){return(o[e]^o[e+1]<<M^o[e+2]<<x)&E},L=new t(25e3),P=new r(288),R=new r(32),N=0,O=0,W=(m=0,0),D=0,U=0;m<h;++m){var _=K(m),F=32767&m,H=C[_];if(S[F]=H,C[_]=F,D<=m){var Y=h-m;if((N>7e3||W>24576)&&Y>423){p=G(o,g,0,L,P,R,O,W,U,m-U,p),W=N=O=0,U=m;for(var I=0;I<286;++I)P[I]=0;for(I=0;I<30;++I)R[I]=0}var X=2,q=0,J=k,Q=F-H&32767;if(Y>2&&_==K(m-Q))for(var V=Math.min(b,Y)-1,Z=Math.min(32767,m),$=Math.min(258,Y);Q<=Z&&--J&&F!=H;){if(o[m+X]==o[m+X-Q]){for(var ee=0;ee<$&&o[m+ee]==o[m+ee-Q];++ee);if(ee>X){if(X=ee,q=Q,ee>V)break;var re=Math.min(Q,ee-2),te=0;for(I=0;I<re;++I){var ae=m-Q+I+32768&32767,ne=ae-S[ae]+32768&32767;ne>te&&(te=ne,H=ae)}}}Q+=(F=H)-(H=S[F])+32768&32767}if(q){L[W++]=268435456|u[X]<<18|v[q];var oe=31&u[X],se=31&v[q];O+=a[oe]+n[se],++P[257+oe],++R[se],D=m+X,++N}else L[W++]=o[m],++P[o[m]]}}p=G(o,g,f,L,P,R,O,W,U,m-U,p),!f&&7&p&&(p=j(g,p+1,z))}return A(d,0,c+T(p)+l)})(i=o,null==(c={level:1}||{}).level?6:c.level,null==c.mem?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(i.length)))):12+c.mem,l,f,!h);var i,c,l,f,h})(s)}catch(e){return console.error(e),null}}static decompress(r){if(null===r)return null;try{return(function(e,r){if(r){for(var t="",a=0;a<e.length;a+=16384)t+=String.fromCharCode.apply(null,e.subarray(a,a+16384));return t}if(U)return U.decode(e);var n=(function(e){for(var r="",t=0;;){var a=e[t++],n=(a>127)+(a>223)+(a>239);if(t+n>e.length)return[r,A(e,t-1)];n?3==n?(a=((15&a)<<18|(63&e[t++])<<12|(63&e[t++])<<6|63&e[t++])-65536,r+=String.fromCharCode(55296|a>>10,56320|1023&a)):r+=1&n?String.fromCharCode((31&a)<<6|63&e[t++]):String.fromCharCode((15&a)<<12|(63&e[t++])<<6|63&e[t++]):r+=String.fromCharCode(a)}})(e),o=n[0];return n[1].length&&K(8),o})((function(r,t){return(function(r,t,s){var i=r.length;if(!i||s&&s.f&&!s.l)return t||new e(0);var u=!t||s,l=!s||s.i;s||(s={}),t||(t=new e(3*i));var v=function(r){var a=t.length;if(r>a){var n=new e(Math.max(2*a,r));n.set(t),t=n}},h=s.f||0,d=s.p||0,g=s.b||0,m=s.l,w=s.d,y=s.m,k=s.n,x=8*i;do{if(!m){h=C(r,d,1);var L=C(r,d+1,3);if(d+=3,!L){var P=r[(_=T(d)+4)-4]|r[_-3]<<8,R=_+P;if(R>i){l&&K(0);break}u&&v(g+P),t.set(r.subarray(_,R),g),s.b=g+=P,s.p=d=8*R,s.f=h;continue}if(1==L)m=b,w=E,y=9,k=5;else if(2==L){var N=C(r,d,31)+257,O=C(r,d+10,15)+4,W=N+C(r,d+5,31)+1;d+=14;for(var j=new e(W),G=new e(19),B=0;B<O;++B)G[o[B]]=C(r,d+3*B,7);d+=3*O;var z=S(G),D=(1<<z)-1,U=p(G,z,1);for(B=0;B<W;){var _,F=U[C(r,d,D)];if(d+=15&F,(_=F>>>4)<16)j[B++]=_;else{var H=0,Y=0;for(16==_?(Y=3+C(r,d,3),d+=2,H=j[B-1]):17==_?(Y=3+C(r,d,7),d+=3):18==_&&(Y=11+C(r,d,127),d+=7);Y--;)j[B++]=H}}var I=j.subarray(0,N),X=j.subarray(N);y=S(I),k=S(X),m=p(I,y,1),w=p(X,k,1)}else K(1);if(d>x){l&&K(0);break}}u&&v(g+131072);for(var q=(1<<y)-1,J=(1<<k)-1,Q=d;;Q=d){var V=(H=m[M(r,d)&q])>>>4;if((d+=15&H)>x){l&&K(0);break}if(H||K(2),V<256)t[g++]=V;else{if(256==V){Q=d,m=null;break}var Z=V-254;if(V>264){var $=a[B=V-257];Z=C(r,d,(1<<$)-1)+c[B],d+=$}var ee=w[M(r,d)&J],re=ee>>>4;if(ee||K(3),d+=15&ee,X=f[re],re>3&&($=n[re],X+=M(r,d)&(1<<$)-1,d+=$),d>x){l&&K(0);break}u&&v(g+131072);for(var te=g+Z;g<te;g+=4)t[g]=t[g-X],t[g+1]=t[g+1-X],t[g+2]=t[g+2-X],t[g+3]=t[g+3-X];g=te}}s.l=m,s.p=Q,s.b=g,s.f=h,m&&(h=1,s.m=y,s.d=w,s.n=k)}while(!h);return g==t.length?t:A(t,0,g)})(r,t)})(r))}catch(e){return console.error(e),null}}static storageKey(e,r){return e<0?r+" Config":0===e?r+" Global":r+" File"+e}static async save(e,r,t){const a=this.storageKey(e,t),n=this.compress(r);return await I(a,n).then(this.successCallback).catch(this.failureCallback)}static async load(e,r){const t=this.storageKey(e,r),a=await Y(t).catch(this.failureCallback),n=this.decompress(a);if(n)return n;if(e>0){console.warn("[WebStorageManager.load] Loading failed. Restoring backup.");const t=await this.loadBackup(e,r);return await this.restoreBackup(e,r),t}return console.warn("[WebStorageManager.load] Loading failed. File broken or missing."),!1}static async deleteSave(e,r){const t=this.storageKey(e,r);return await X(t).then(this.successCallback).catch(this.failureCallback)}static async saveExists(e,r){const t=this.storageKey(e,r);return await q().then((function(e){return e.includes(t)}))}static async restoreBackup(e,r){const t=this.storageKey(e,r)+"bak",a=await this.loadBackup(e,r);return await this.save(e,a,r),await X(t).then(this.successCallback).catch(this.failureCallback)}static async backupSave(e,r){const t=this.storageKey(e,r),a=t+"bak",n=await Y(t).catch(this.failureCallback);return!!n&&await I(a,n).then(this.successCallback).catch(this.failureCallback)}static async loadBackup(e,r){const t=this.storageKey(e,r)+"bak",a=await Y(t);return this.decompress(a)}}re(class{static compress({data:e}){const r=fe.compress(e);return console.log("[GameStorageWorker.compress]",{data:e,compressed:r}),ie({result:r},[r.buffer])}static decompress({data:e}){const r=fe.decompress(e);return console.log("[GameStorageWorker.decompress]",{data:e,decompressed:r}),{result:r}}static async makeSave({id:e,data:r,webKey:t}){const a=await fe.save(e,r,t);return console.log("[GameStorageWorker.makeSave]",{id:e,data:r,webKey:t},a),{success:a}}static async loadSave({id:e,webKey:r}){const t=await fe.load(e,r);return console.log("[GameStorageWorker.loadSave]",{id:e,webKey:r},t),{result:t}}static async backupSave({id:e,webKey:r}){const t=await fe.backupSave(e,r);return console.log("[GameStorageWorker.backupSave]",{id:e,webKey:r},t),{success:t}}static async checkSaveExists({id:e,webKey:r}){const t=await fe.saveExists(e,r);return console.log("[GameStorageWorker.checkSaveExists]",{id:e,webKey:r},t),{result:t}}})})();
