/*!!
 * game_storage_worker.js - corescript v1.6.1 (community-1.4)
 * (c) 2015 KADOKAWA CORPORATION./YOJI OJIMA
 * Contributions by the RPG Maker MV CoreScript team
 * https://github.com/thinknathan/corescript/blob/master/CONTRIBUTORS.md
 *
 * idb-keyval 6.2.0 | Copyright 2016, Jake Archibald
 * https://github.com/jakearchibald/idb-keyval/blob/main/LICENCE
 *
 * fflate@0.7.4 | https://github.com/101arrowz/fflate/blob/master/LICENSE
 *
 * Comlink v4.3.1 | Copyright 2019 Google Inc.
 * https://github.com/GoogleChromeLabs/comlink/blob/main/LICENSE
 */
!(function(){"use strict";var e=Uint8Array,r=Uint16Array,t=Uint32Array,n=new e([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),a=new e([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),o=new e([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),s=function(e,n){for(var a=new r(31),o=0;o<31;++o)a[o]=n+=1<<e[o-1];var s=new t(a[30]);for(o=1;o<30;++o)for(var i=a[o];i<a[o+1];++i)s[i]=i-a[o]<<5|o;return[a,s]},i=s(n,2),c=i[0],u=i[1];c[28]=258,u[258]=28;for(var l=s(a,0),f=l[0],v=l[1],h=new r(32768),d=0;d<32768;++d){var g=(43690&d)>>>1|(21845&d)<<1;g=(61680&(g=(52428&g)>>>2|(13107&g)<<2))>>>4|(3855&g)<<4,h[d]=((65280&g)>>>8|(255&g)<<8)>>>1}var p=function(e,t,n){for(var a=e.length,o=0,s=new r(t);o<a;++o)e[o]&&++s[e[o]-1];var i,c=new r(t);for(o=0;o<t;++o)c[o]=c[o-1]+s[o-1]<<1;if(n){i=new r(1<<t);var u=15-t;for(o=0;o<a;++o)if(e[o])for(var l=o<<4|e[o],f=t-e[o],v=c[e[o]-1]++<<f,d=v|(1<<f)-1;v<=d;++v)i[h[v]>>>u]=l}else for(i=new r(a),o=0;o<a;++o)e[o]&&(i[o]=h[c[e[o]-1]++]>>>15-e[o]);return i},m=new e(288);for(d=0;d<144;++d)m[d]=8;for(d=144;d<256;++d)m[d]=9;for(d=256;d<280;++d)m[d]=7;for(d=280;d<288;++d)m[d]=8;var w=new e(32);for(d=0;d<32;++d)w[d]=5;var b=p(m,9,0),y=p(m,9,1),k=p(w,5,0),E=p(w,5,1),S=function(e){for(var r=e[0],t=1;t<e.length;++t)e[t]>r&&(r=e[t]);return r},C=function(e,r,t){var n=r/8|0;return(e[n]|e[n+1]<<8)>>(7&r)&t},M=function(e,r){var t=r/8|0;return(e[t]|e[t+1]<<8|e[t+2]<<16)>>(7&r)},T=function(e){return(e+7)/8|0},A=function(n,a,o){(null==a||a<0)&&(a=0),(null==o||o>n.length)&&(o=n.length);var s=new(2==n.BYTES_PER_ELEMENT?r:4==n.BYTES_PER_ELEMENT?t:e)(o-a);return s.set(n.subarray(a,o)),s},x=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],L=function(e,r,t){var n=new Error(r||x[e]);if(n.code=e,Error.captureStackTrace&&Error.captureStackTrace(n,L),!t)throw n;return n},P=function(e,r,t){t<<=7&r;var n=r/8|0;e[n]|=t,e[n+1]|=t>>>8},R=function(e,r,t){t<<=7&r;var n=r/8|0;e[n]|=t,e[n+1]|=t>>>8,e[n+2]|=t>>>16},N=function(t,n){for(var a=[],o=0;o<t.length;++o)t[o]&&a.push({s:o,f:t[o]});var s=a.length,i=a.slice();if(!s)return[z,0];if(1==s){var c=new e(a[0].s+1);return c[a[0].s]=1,[c,1]}a.sort((function(e,r){return e.f-r.f})),a.push({s:-1,f:25001});var u=a[0],l=a[1],f=0,v=1,h=2;for(a[0]={s:-1,f:u.f+l.f,l:u,r:l};v!=s-1;)u=a[a[f].f<a[h].f?f++:h++],l=a[f!=v&&a[f].f<a[h].f?f++:h++],a[v++]={s:-1,f:u.f+l.f,l:u,r:l};var d=i[0].s;for(o=1;o<s;++o)i[o].s>d&&(d=i[o].s);var g=new r(d+1),p=O(a[v-1],g,0);if(p>n){o=0;var m=0,w=p-n,b=1<<w;for(i.sort((function(e,r){return g[r.s]-g[e.s]||e.f-r.f}));o<s;++o){var y=i[o].s;if(!(g[y]>n))break;m+=b-(1<<p-g[y]),g[y]=n}for(m>>>=w;m>0;){var k=i[o].s;g[k]<n?m-=1<<n-g[k]++-1:++o}for(;o>=0&&m;--o){var E=i[o].s;g[E]==n&&(--g[E],++m)}p=n}return[new e(g),p]},O=function(e,r,t){return-1==e.s?Math.max(O(e.l,r,t+1),O(e.r,r,t+1)):r[e.s]=t},W=function(e){for(var t=e.length;t&&!e[--t];);for(var n=new r(++t),a=0,o=e[0],s=1,i=function(e){n[a++]=e},c=1;c<=t;++c)if(e[c]==o&&c!=t)++s;else{if(!o&&s>2){for(;s>138;s-=138)i(32754);s>2&&(i(s>10?s-11<<5|28690:s-3<<5|12305),s=0)}else if(s>3){for(i(o),--s;s>6;s-=6)i(8304);s>2&&(i(s-3<<5|8208),s=0)}for(;s--;)i(o);s=1,o=e[c]}return[n.subarray(0,a),t]},j=function(e,r){for(var t=0,n=0;n<r.length;++n)t+=e[n]*r[n];return t},K=function(e,r,t){var n=t.length,a=T(r+2);e[a]=255&n,e[a+1]=n>>>8,e[a+2]=255^e[a],e[a+3]=255^e[a+1];for(var o=0;o<n;++o)e[a+o+4]=t[o];return 8*(a+4+n)},G=function(e,t,s,i,c,u,l,f,v,h,d){P(t,d++,s),++c[256];for(var g=N(c,15),y=g[0],E=g[1],S=N(u,15),C=S[0],M=S[1],T=W(y),A=T[0],x=T[1],L=W(C),O=L[0],G=L[1],B=new r(19),z=0;z<A.length;++z)B[31&A[z]]++;for(z=0;z<O.length;++z)B[31&O[z]]++;for(var D=N(B,7),U=D[0],_=D[1],H=19;H>4&&!U[o[H-1]];--H);var F,Y,I,X,q=h+5<<3,J=j(c,m)+j(u,w)+l,Q=j(c,y)+j(u,C)+l+14+3*H+j(B,U)+(2*B[16]+3*B[17]+7*B[18]);if(q<=J&&q<=Q)return K(t,d,e.subarray(v,v+h));if(P(t,d,1+(Q<J)),d+=2,Q<J){F=p(y,E,0),Y=y,I=p(C,M,0),X=C;var V=p(U,_,0);for(P(t,d,x-257),P(t,d+5,G-1),P(t,d+10,H-4),d+=14,z=0;z<H;++z)P(t,d+3*z,U[o[z]]);d+=3*H;for(var Z=[A,O],$=0;$<2;++$){var ee=Z[$];for(z=0;z<ee.length;++z){var re=31&ee[z];P(t,d,V[re]),d+=U[re],re>15&&(P(t,d,ee[z]>>>5&127),d+=ee[z]>>>12)}}}else F=b,Y=m,I=k,X=w;for(z=0;z<f;++z)if(i[z]>255){re=i[z]>>>18&31,R(t,d,F[re+257]),d+=Y[re+257],re>7&&(P(t,d,i[z]>>>23&31),d+=n[re]);var te=31&i[z];R(t,d,I[te]),d+=X[te],te>3&&(R(t,d,i[z]>>>5&8191),d+=a[te])}else R(t,d,F[i[z]]),d+=Y[i[z]];return R(t,d,F[256]),d+Y[256]},B=new t([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),z=new e(0);var D="undefined"!=typeof TextEncoder&&new TextEncoder,U="undefined"!=typeof TextDecoder&&new TextDecoder;try{U.decode(z,{stream:!0})}catch(e){}function _(e){return new Promise(((r,t)=>{e.oncomplete=e.onsuccess=()=>r(e.result),e.onabort=e.onerror=()=>t(e.error)}))}let H;function F(){return H||(H=(function(e,r){const t=indexedDB.open("keyval-store");t.onupgradeneeded=()=>t.result.createObjectStore(r);const n=_(t);return(e,t)=>n.then((n=>t(n.transaction(r,e).objectStore(r))))})(0,"keyval")),H}function Y(e,r=F()){return r("readonly",(r=>_(r.get(e))))}function I(e,r,t=F()){return t("readwrite",(t=>(t.put(r,e),_(t.transaction))))}function X(e=F()){return e("readonly",(e=>{if(e.getAllKeys)return _(e.getAllKeys());const r=[];return(function(e,t){return e.openCursor().onsuccess=function(){var e;this.result&&(e=this.result,r.push(e.key),this.result.continue())},_(e.transaction)})(e).then((()=>r))}))}const q=Symbol("Comlink.proxy"),J=Symbol("Comlink.endpoint"),Q=Symbol("Comlink.releaseProxy"),V=Symbol("Comlink.thrown"),Z=e=>"object"==typeof e&&null!==e||"function"==typeof e,$=new Map([["proxy",{canHandle:e=>Z(e)&&e[q],serialize(e){const{port1:r,port2:t}=new MessageChannel;return ee(e,r),[t,[t]]},deserialize:e=>(e.start(),ne(e,[],undefined))}],["throw",{canHandle:e=>Z(e)&&V in e,serialize({value:e}){let r;return r=e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[r,[]]},deserialize(e){if(e.isError)throw Object.assign(new Error(e.value.message),e.value);throw e.value}}]]);function ee(e,r=self){r.addEventListener("message",(function t(n){if(!n||!n.data)return;const{id:a,type:o,path:s}=Object.assign({path:[]},n.data),i=(n.data.argumentList||[]).map(ce);let c;try{const r=s.slice(0,-1).reduce(((e,r)=>e[r]),e),t=s.reduce(((e,r)=>e[r]),e);switch(o){case"GET":c=t;break;case"SET":r[s.slice(-1)[0]]=ce(n.data.value),c=!0;break;case"APPLY":c=t.apply(r,i);break;case"CONSTRUCT":c=(function(e){return Object.assign(e,{[q]:!0})})(new t(...i));break;case"ENDPOINT":{const{port1:r,port2:t}=new MessageChannel;ee(e,t),c=se(r,[r])}break;case"RELEASE":c=void 0;break;default:return}}catch(e){c={value:e,[V]:0}}Promise.resolve(c).catch((e=>({value:e,[V]:0}))).then((e=>{const[n,s]=ie(e);r.postMessage(Object.assign(Object.assign({},n),{id:a}),s),"RELEASE"===o&&(r.removeEventListener("message",t),re(r))}))})),r.start&&r.start()}function re(e){(function(e){return"MessagePort"===e.constructor.name})(e)&&e.close()}function te(e){if(e)throw new Error("Proxy has been released and is not useable")}function ne(e,r=[],t=function(){}){let n=!1;const a=new Proxy(t,{get(t,o){if(te(n),o===Q)return()=>ue(e,{type:"RELEASE",path:r.map((e=>e.toString()))}).then((()=>{re(e),n=!0}));if("then"===o){if(0===r.length)return{then:()=>a};const t=ue(e,{type:"GET",path:r.map((e=>e.toString()))}).then(ce);return t.then.bind(t)}return ne(e,[...r,o])},set(t,a,o){te(n);const[s,i]=ie(o);return ue(e,{type:"SET",path:[...r,a].map((e=>e.toString())),value:s},i).then(ce)},apply(t,a,o){te(n);const s=r[r.length-1];if(s===J)return ue(e,{type:"ENDPOINT"}).then(ce);if("bind"===s)return ne(e,r.slice(0,-1));const[i,c]=ae(o);return ue(e,{type:"APPLY",path:r.map((e=>e.toString())),argumentList:i},c).then(ce)},construct(t,a){te(n);const[o,s]=ae(a);return ue(e,{type:"CONSTRUCT",path:r.map((e=>e.toString())),argumentList:o},s).then(ce)}});return a}function ae(e){const r=e.map(ie);return[r.map((e=>e[0])),(t=r.map((e=>e[1])),Array.prototype.concat.apply([],t))];var t}const oe=new WeakMap;function se(e,r){return oe.set(e,r),e}function ie(e){for(const[r,t]of $)if(t.canHandle(e)){const[n,a]=t.serialize(e);return[{type:"HANDLER",name:r,value:n},a]}return[{type:"RAW",value:e},oe.get(e)||[]]}function ce(e){switch(e.type){case"HANDLER":return $.get(e.name).deserialize(e.value);case"RAW":return e.value}}function ue(e,r,t){return new Promise((n=>{const a=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");e.addEventListener("message",(function r(t){t.data&&t.data.id&&t.data.id===a&&(e.removeEventListener("message",r),n(t.data))})),e.start&&e.start(),e.postMessage(Object.assign({id:a},r),t)}))}class le{static successCallback(){return!0}static failureCallback(e){return console.error(e),!1}static compress(o){if(null===o)return null;try{const s=(function(r,t){var n;if(D)return D.encode(r);var a=r.length,o=new e(r.length+(r.length>>1)),s=0,i=function(e){o[s++]=e};for(n=0;n<a;++n){if(s+5>o.length){var c=new e(s+8+(a-n<<1));c.set(o),o=c}var u=r.charCodeAt(n);u<128?i(u):u<2048?(i(192|u>>6),i(128|63&u)):u>55295&&u<57344?(i(240|(u=65536+(1047552&u)|1023&r.charCodeAt(++n))>>18),i(128|u>>12&63),i(128|u>>6&63),i(128|63&u)):(i(224|u>>12),i(128|u>>6&63),i(128|63&u))}return A(o,0,s)})(o);return(function(o,s){return l=0,f=0,(function(o,s,i,c,l,f){var h=o.length,d=new e(c+h+5*(1+Math.ceil(h/7e3))+l),g=d.subarray(c,d.length-l),p=0;if(!s||h<8)for(var m=0;m<=h;m+=65535){var w=m+65535;w>=h&&(g[p>>3]=f),p=K(g,p+1,o.subarray(m,w))}else{for(var b=B[s-1],y=b>>>13,k=8191&b,E=(1<<i)-1,S=new r(32768),C=new r(E+1),M=Math.ceil(i/3),x=2*M,L=function(e){return(o[e]^o[e+1]<<M^o[e+2]<<x)&E},P=new t(25e3),R=new r(288),N=new r(32),O=0,W=0,j=(m=0,0),D=0,U=0;m<h;++m){var _=L(m),H=32767&m,F=C[_];if(S[H]=F,C[_]=H,D<=m){var Y=h-m;if((O>7e3||j>24576)&&Y>423){p=G(o,g,0,P,R,N,W,j,U,m-U,p),j=O=W=0,U=m;for(var I=0;I<286;++I)R[I]=0;for(I=0;I<30;++I)N[I]=0}var X=2,q=0,J=k,Q=H-F&32767;if(Y>2&&_==L(m-Q))for(var V=Math.min(y,Y)-1,Z=Math.min(32767,m),$=Math.min(258,Y);Q<=Z&&--J&&H!=F;){if(o[m+X]==o[m+X-Q]){for(var ee=0;ee<$&&o[m+ee]==o[m+ee-Q];++ee);if(ee>X){if(X=ee,q=Q,ee>V)break;var re=Math.min(Q,ee-2),te=0;for(I=0;I<re;++I){var ne=m-Q+I+32768&32767,ae=ne-S[ne]+32768&32767;ae>te&&(te=ae,F=ne)}}}Q+=(H=F)-(F=S[H])+32768&32767}if(q){P[j++]=268435456|u[X]<<18|v[q];var oe=31&u[X],se=31&v[q];W+=n[oe]+a[se],++R[257+oe],++N[se],D=m+X,++O}else P[j++]=o[m],++R[o[m]]}}p=G(o,g,f,P,R,N,W,j,U,m-U,p),!f&&7&p&&(p=K(g,p+1,z))}return A(d,0,c+T(p)+l)})(i=o,null==(c={level:1}||{}).level?6:c.level,null==c.mem?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(i.length)))):12+c.mem,l,f,!h);var i,c,l,f,h})(s)}catch(e){return console.error(e),null}}static decompress(r){if(null===r)return null;try{return(function(e,r){if(r){for(var t="",n=0;n<e.length;n+=16384)t+=String.fromCharCode.apply(null,e.subarray(n,n+16384));return t}if(U)return U.decode(e);var a=(function(e){for(var r="",t=0;;){var n=e[t++],a=(n>127)+(n>223)+(n>239);if(t+a>e.length)return[r,A(e,t-1)];a?3==a?(n=((15&n)<<18|(63&e[t++])<<12|(63&e[t++])<<6|63&e[t++])-65536,r+=String.fromCharCode(55296|n>>10,56320|1023&n)):r+=1&a?String.fromCharCode((31&n)<<6|63&e[t++]):String.fromCharCode((15&n)<<12|(63&e[t++])<<6|63&e[t++]):r+=String.fromCharCode(n)}})(e),o=a[0];return a[1].length&&L(8),o})((function(r,t){return(function(r,t,s){var i=r.length;if(!i||s&&s.f&&!s.l)return t||new e(0);var u=!t||s,l=!s||s.i;s||(s={}),t||(t=new e(3*i));var v=function(r){var n=t.length;if(r>n){var a=new e(Math.max(2*n,r));a.set(t),t=a}},h=s.f||0,d=s.p||0,g=s.b||0,m=s.l,w=s.d,b=s.m,k=s.n,x=8*i;do{if(!m){h=C(r,d,1);var P=C(r,d+1,3);if(d+=3,!P){var R=r[(_=T(d)+4)-4]|r[_-3]<<8,N=_+R;if(N>i){l&&L(0);break}u&&v(g+R),t.set(r.subarray(_,N),g),s.b=g+=R,s.p=d=8*N,s.f=h;continue}if(1==P)m=y,w=E,b=9,k=5;else if(2==P){var O=C(r,d,31)+257,W=C(r,d+10,15)+4,j=O+C(r,d+5,31)+1;d+=14;for(var K=new e(j),G=new e(19),B=0;B<W;++B)G[o[B]]=C(r,d+3*B,7);d+=3*W;var z=S(G),D=(1<<z)-1,U=p(G,z,1);for(B=0;B<j;){var _,H=U[C(r,d,D)];if(d+=15&H,(_=H>>>4)<16)K[B++]=_;else{var F=0,Y=0;for(16==_?(Y=3+C(r,d,3),d+=2,F=K[B-1]):17==_?(Y=3+C(r,d,7),d+=3):18==_&&(Y=11+C(r,d,127),d+=7);Y--;)K[B++]=F}}var I=K.subarray(0,O),X=K.subarray(O);b=S(I),k=S(X),m=p(I,b,1),w=p(X,k,1)}else L(1);if(d>x){l&&L(0);break}}u&&v(g+131072);for(var q=(1<<b)-1,J=(1<<k)-1,Q=d;;Q=d){var V=(F=m[M(r,d)&q])>>>4;if((d+=15&F)>x){l&&L(0);break}if(F||L(2),V<256)t[g++]=V;else{if(256==V){Q=d,m=null;break}var Z=V-254;if(V>264){var $=n[B=V-257];Z=C(r,d,(1<<$)-1)+c[B],d+=$}var ee=w[M(r,d)&J],re=ee>>>4;if(ee||L(3),d+=15&ee,X=f[re],re>3&&($=a[re],X+=M(r,d)&(1<<$)-1,d+=$),d>x){l&&L(0);break}u&&v(g+131072);for(var te=g+Z;g<te;g+=4)t[g]=t[g-X],t[g+1]=t[g+1-X],t[g+2]=t[g+2-X],t[g+3]=t[g+3-X];g=te}}s.l=m,s.p=Q,s.b=g,s.f=h,m&&(h=1,s.m=b,s.d=w,s.n=k)}while(!h);return g==t.length?t:A(t,0,g)})(r,t)})(r))}catch(e){return console.error(e),null}}static async save(e,r){const t=this.compress(e);return await I(r,t).then(this.successCallback).catch(this.failureCallback)}static async load(e,r){const t=await Y(r).catch(this.failureCallback);if(t){const n=this.decompress(t);if(n)return n;if(e>0){console.warn("[WebStorageManager.load] Loading failed. Restoring backup.");const e=await this.loadBackup(r);return await this.restoreBackup(r),e}return console.warn("[WebStorageManager.load] Loading failed. File broken or missing."),!1}return!1}static async saveExists(e){return await X().then((function(r){return r.includes(e)}))}static async restoreBackup(e){const r=e+"bak",t=await this.loadBackup(e);return await this.save(t,e),await(function(e,r=F()){return r("readwrite",(r=>(r.delete(e),_(r.transaction))))})(r).then(this.successCallback).catch(this.failureCallback)}static async backupSave(e){const r=e+"bak",t=await Y(e).catch(this.failureCallback);return!!t&&await I(r,t).then(this.successCallback).catch(this.failureCallback)}static async loadBackup(e){const r=e+"bak",t=await Y(r);return this.decompress(t)}}ee(class{static compress({data:e}){const r=le.compress(e);return console.log("[GameStorageWorker.compress]",{data:e,compressed:r}),se({result:r},[r.buffer])}static decompress({data:e}){const r=le.decompress(e);return console.log("[GameStorageWorker.decompress]",{data:e,decompressed:r}),{result:r}}static async makeSave({data:e,webKey:r}){const t=await le.save(e,r);return console.log("[GameStorageWorker.makeSave]",{data:e,webKey:r},t),{success:t}}static async loadSave({id:e,webKey:r}){const t=await le.load(e,r);return console.log("[GameStorageWorker.loadSave]",{id:e,webKey:r},t),{result:t}}static async backupSave({webKey:e}){const r=await le.backupSave(e);return console.log("[GameStorageWorker.backupSave]",{webKey:e},r),{success:r}}static async checkSaveExists({webKey:e}){const r=await le.saveExists(e);return console.log("[GameStorageWorker.checkSaveExists]",{webKey:e},r),{result:r}}})})();
