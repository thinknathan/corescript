/*!!
 * game_storage_worker.js - corescript v1.6.1 (community-1.4)
 * (c) 2015 KADOKAWA CORPORATION./YOJI OJIMA
 * Contributions by the RPG Maker MV CoreScript team
 * https://github.com/thinknathan/corescript/blob/master/CONTRIBUTORS.md
 *
 * idb-keyval 6.2.0 | Copyright 2016, Jake Archibald
 * https://github.com/jakearchibald/idb-keyval/blob/main/LICENCE
 *
 * fflate@0.7.4 | https://github.com/101arrowz/fflate/blob/master/LICENSE
 *
 * Comlink v4.3.1 | Copyright 2019 Google Inc.
 * https://github.com/GoogleChromeLabs/comlink/blob/main/LICENSE
 */
!(function(){"use strict";var e=Uint8Array,r=Uint16Array,t=Uint32Array,n=new e([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),a=new e([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),o=new e([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),s=function(e,n){for(var a=new r(31),o=0;o<31;++o)a[o]=n+=1<<e[o-1];var s=new t(a[30]);for(o=1;o<30;++o)for(var i=a[o];i<a[o+1];++i)s[i]=i-a[o]<<5|o;return[a,s]},i=s(n,2),c=i[0],u=i[1];c[28]=258,u[258]=28;for(var l=s(a,0),f=l[0],v=l[1],h=new r(32768),d=0;d<32768;++d){var g=(43690&d)>>>1|(21845&d)<<1;g=(61680&(g=(52428&g)>>>2|(13107&g)<<2))>>>4|(3855&g)<<4,h[d]=((65280&g)>>>8|(255&g)<<8)>>>1}var p=function(e,t,n){for(var a=e.length,o=0,s=new r(t);o<a;++o)e[o]&&++s[e[o]-1];var i,c=new r(t);for(o=0;o<t;++o)c[o]=c[o-1]+s[o-1]<<1;if(n){i=new r(1<<t);var u=15-t;for(o=0;o<a;++o)if(e[o])for(var l=o<<4|e[o],f=t-e[o],v=c[e[o]-1]++<<f,d=v|(1<<f)-1;v<=d;++v)i[h[v]>>>u]=l}else for(i=new r(a),o=0;o<a;++o)e[o]&&(i[o]=h[c[e[o]-1]++]>>>15-e[o]);return i},m=new e(288);for(d=0;d<144;++d)m[d]=8;for(d=144;d<256;++d)m[d]=9;for(d=256;d<280;++d)m[d]=7;for(d=280;d<288;++d)m[d]=8;var w=new e(32);for(d=0;d<32;++d)w[d]=5;var b=p(m,9,0),y=p(m,9,1),k=p(w,5,0),E=p(w,5,1),S=function(e){for(var r=e[0],t=1;t<e.length;++t)e[t]>r&&(r=e[t]);return r},C=function(e,r,t){var n=r/8|0;return(e[n]|e[n+1]<<8)>>(7&r)&t},M=function(e,r){var t=r/8|0;return(e[t]|e[t+1]<<8|e[t+2]<<16)>>(7&r)},T=function(e){return(e+7)/8|0},x=function(n,a,o){(null==a||a<0)&&(a=0),(null==o||o>n.length)&&(o=n.length);var s=new(2==n.BYTES_PER_ELEMENT?r:4==n.BYTES_PER_ELEMENT?t:e)(o-a);return s.set(n.subarray(a,o)),s},A=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],L=function(e,r,t){var n=new Error(r||A[e]);if(n.code=e,Error.captureStackTrace&&Error.captureStackTrace(n,L),!t)throw n;return n},R=function(e,r,t){t<<=7&r;var n=r/8|0;e[n]|=t,e[n+1]|=t>>>8},P=function(e,r,t){t<<=7&r;var n=r/8|0;e[n]|=t,e[n+1]|=t>>>8,e[n+2]|=t>>>16},O=function(t,n){for(var a=[],o=0;o<t.length;++o)t[o]&&a.push({s:o,f:t[o]});var s=a.length,i=a.slice();if(!s)return[B,0];if(1==s){var c=new e(a[0].s+1);return c[a[0].s]=1,[c,1]}a.sort((function(e,r){return e.f-r.f})),a.push({s:-1,f:25001});var u=a[0],l=a[1],f=0,v=1,h=2;for(a[0]={s:-1,f:u.f+l.f,l:u,r:l};v!=s-1;)u=a[a[f].f<a[h].f?f++:h++],l=a[f!=v&&a[f].f<a[h].f?f++:h++],a[v++]={s:-1,f:u.f+l.f,l:u,r:l};var d=i[0].s;for(o=1;o<s;++o)i[o].s>d&&(d=i[o].s);var g=new r(d+1),p=j(a[v-1],g,0);if(p>n){o=0;var m=0,w=p-n,b=1<<w;for(i.sort((function(e,r){return g[r.s]-g[e.s]||e.f-r.f}));o<s;++o){var y=i[o].s;if(!(g[y]>n))break;m+=b-(1<<p-g[y]),g[y]=n}for(m>>>=w;m>0;){var k=i[o].s;g[k]<n?m-=1<<n-g[k]++-1:++o}for(;o>=0&&m;--o){var E=i[o].s;g[E]==n&&(--g[E],++m)}p=n}return[new e(g),p]},j=function(e,r,t){return-1==e.s?Math.max(j(e.l,r,t+1),j(e.r,r,t+1)):r[e.s]=t},N=function(e){for(var t=e.length;t&&!e[--t];);for(var n=new r(++t),a=0,o=e[0],s=1,i=function(e){n[a++]=e},c=1;c<=t;++c)if(e[c]==o&&c!=t)++s;else{if(!o&&s>2){for(;s>138;s-=138)i(32754);s>2&&(i(s>10?s-11<<5|28690:s-3<<5|12305),s=0)}else if(s>3){for(i(o),--s;s>6;s-=6)i(8304);s>2&&(i(s-3<<5|8208),s=0)}for(;s--;)i(o);s=1,o=e[c]}return[n.subarray(0,a),t]},W=function(e,r){for(var t=0,n=0;n<r.length;++n)t+=e[n]*r[n];return t},z=function(e,r,t){var n=t.length,a=T(r+2);e[a]=255&n,e[a+1]=n>>>8,e[a+2]=255^e[a],e[a+3]=255^e[a+1];for(var o=0;o<n;++o)e[a+o+4]=t[o];return 8*(a+4+n)},K=function(e,t,s,i,c,u,l,f,v,h,d){R(t,d++,s),++c[256];for(var g=O(c,15),y=g[0],E=g[1],S=O(u,15),C=S[0],M=S[1],T=N(y),x=T[0],A=T[1],L=N(C),j=L[0],K=L[1],G=new r(19),B=0;B<x.length;++B)G[31&x[B]]++;for(B=0;B<j.length;++B)G[31&j[B]]++;for(var D=O(G,7),U=D[0],F=D[1],_=19;_>4&&!U[o[_-1]];--_);var H,I,Y,X,$=h+5<<3,q=W(c,m)+W(u,w)+l,J=W(c,y)+W(u,C)+l+14+3*_+W(G,U)+(2*G[16]+3*G[17]+7*G[18]);if($<=q&&$<=J)return z(t,d,e.subarray(v,v+h));if(R(t,d,1+(J<q)),d+=2,J<q){H=p(y,E,0),I=y,Y=p(C,M,0),X=C;var Q=p(U,F,0);for(R(t,d,A-257),R(t,d+5,K-1),R(t,d+10,_-4),d+=14,B=0;B<_;++B)R(t,d+3*B,U[o[B]]);d+=3*_;for(var V=[x,j],Z=0;Z<2;++Z){var ee=V[Z];for(B=0;B<ee.length;++B){var re=31&ee[B];R(t,d,Q[re]),d+=U[re],re>15&&(R(t,d,ee[B]>>>5&127),d+=ee[B]>>>12)}}}else H=b,I=m,Y=k,X=w;for(B=0;B<f;++B)if(i[B]>255){re=i[B]>>>18&31,P(t,d,H[re+257]),d+=I[re+257],re>7&&(R(t,d,i[B]>>>23&31),d+=n[re]);var te=31&i[B];P(t,d,Y[te]),d+=X[te],te>3&&(P(t,d,i[B]>>>5&8191),d+=a[te])}else P(t,d,H[i[B]]),d+=I[i[B]];return P(t,d,H[256]),d+I[256]},G=new t([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),B=new e(0),D="undefined"!=typeof TextEncoder&&new TextEncoder,U="undefined"!=typeof TextDecoder&&new TextDecoder;try{U.decode(B,{stream:!0})}catch(e){}function F(e){return new Promise(((r,t)=>{e.oncomplete=e.onsuccess=()=>r(e.result),e.onabort=e.onerror=()=>t(e.error)}))}let _;function H(){return _||(_=(function(e,r){const t=indexedDB.open("keyval-store");t.onupgradeneeded=()=>t.result.createObjectStore(r);const n=F(t);return(e,t)=>n.then((n=>t(n.transaction(r,e).objectStore(r))))})(0,"keyval")),_}function I(e,r=H()){return r("readonly",(r=>F(r.get(e))))}function Y(e,r,t=H()){return t("readwrite",(t=>(t.put(r,e),F(t.transaction))))}function X(e=H()){return e("readonly",(e=>{if(e.getAllKeys)return F(e.getAllKeys());const r=[];return(function(e,t){return e.openCursor().onsuccess=function(){var e;this.result&&(e=this.result,r.push(e.key),this.result.continue())},F(e.transaction)})(e).then((()=>r))}))}const $=Symbol("Comlink.proxy"),q=Symbol("Comlink.endpoint"),J=Symbol("Comlink.releaseProxy"),Q=Symbol("Comlink.finalizer"),V=Symbol("Comlink.thrown"),Z=e=>"object"==typeof e&&null!==e||"function"==typeof e,ee=new Map([["proxy",{canHandle:e=>Z(e)&&e[$],serialize(e){const{port1:r,port2:t}=new MessageChannel;return re(e,r),[t,[t]]},deserialize:e=>(e.start(),ie(e,[],undefined))}],["throw",{canHandle:e=>Z(e)&&V in e,serialize({value:e}){let r;return r=e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[r,[]]},deserialize(e){if(e.isError)throw Object.assign(new Error(e.value.message),e.value);throw e.value}}]]);function re(e,r=globalThis,t=["*"]){r.addEventListener("message",(function n(a){if(!a||!a.data)return;if(!(function(e,r){for(const t of e){if(r===t||"*"===t)return!0;if(t instanceof RegExp&&t.test(r))return!0}return!1})(t,a.origin))return void console.warn(`Invalid origin '${a.origin}' for comlink proxy`);const{id:o,type:s,path:i}=Object.assign({path:[]},a.data),c=(a.data.argumentList||[]).map(ve);let u;try{const r=i.slice(0,-1).reduce(((e,r)=>e[r]),e),t=i.reduce(((e,r)=>e[r]),e);switch(s){case"GET":u=t;break;case"SET":r[i.slice(-1)[0]]=ve(a.data.value),u=!0;break;case"APPLY":u=t.apply(r,c);break;case"CONSTRUCT":u=(function(e){return Object.assign(e,{[$]:!0})})(new t(...c));break;case"ENDPOINT":{const{port1:r,port2:t}=new MessageChannel;re(e,t),u=le(r,[r])}break;case"RELEASE":u=void 0;break;default:return}}catch(e){u={value:e,[V]:0}}Promise.resolve(u).catch((e=>({value:e,[V]:0}))).then((t=>{const[a,i]=fe(t);r.postMessage(Object.assign(Object.assign({},a),{id:o}),i),"RELEASE"===s&&(r.removeEventListener("message",n),te(r),Q in e&&"function"==typeof e[Q]&&e[Q]())})).catch((e=>{const[t,n]=fe({value:new TypeError("Unserializable return value"),[V]:0});r.postMessage(Object.assign(Object.assign({},t),{id:o}),n)}))})),r.start&&r.start()}function te(e){(function(e){return"MessagePort"===e.constructor.name})(e)&&e.close()}function ne(e){if(e)throw new Error("Proxy has been released and is not useable")}function ae(e){return he(e,{type:"RELEASE"}).then((()=>{te(e)}))}const oe=new WeakMap,se="FinalizationRegistry"in globalThis&&new FinalizationRegistry((e=>{const r=(oe.get(e)||0)-1;oe.set(e,r),0===r&&ae(e)}));function ie(e,r=[],t=function(){}){let n=!1;const a=new Proxy(t,{get(t,o){if(ne(n),o===J)return()=>{!(function(e){se&&se.unregister(e)})(a),ae(e),n=!0};if("then"===o){if(0===r.length)return{then:()=>a};const t=he(e,{type:"GET",path:r.map((e=>e.toString()))}).then(ve);return t.then.bind(t)}return ie(e,[...r,o])},set(t,a,o){ne(n);const[s,i]=fe(o);return he(e,{type:"SET",path:[...r,a].map((e=>e.toString())),value:s},i).then(ve)},apply(t,a,o){ne(n);const s=r[r.length-1];if(s===q)return he(e,{type:"ENDPOINT"}).then(ve);if("bind"===s)return ie(e,r.slice(0,-1));const[i,c]=ce(o);return he(e,{type:"APPLY",path:r.map((e=>e.toString())),argumentList:i},c).then(ve)},construct(t,a){ne(n);const[o,s]=ce(a);return he(e,{type:"CONSTRUCT",path:r.map((e=>e.toString())),argumentList:o},s).then(ve)}});return(function(e,r){const t=(oe.get(r)||0)+1;oe.set(r,t),se&&se.register(e,r,e)})(a,e),a}function ce(e){const r=e.map(fe);return[r.map((e=>e[0])),(t=r.map((e=>e[1])),Array.prototype.concat.apply([],t))];var t}const ue=new WeakMap;function le(e,r){return ue.set(e,r),e}function fe(e){for(const[r,t]of ee)if(t.canHandle(e)){const[n,a]=t.serialize(e);return[{type:"HANDLER",name:r,value:n},a]}return[{type:"RAW",value:e},ue.get(e)||[]]}function ve(e){switch(e.type){case"HANDLER":return ee.get(e.name).deserialize(e.value);case"RAW":return e.value}}function he(e,r,t){return new Promise((n=>{const a=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");e.addEventListener("message",(function r(t){t.data&&t.data.id&&t.data.id===a&&(e.removeEventListener("message",r),n(t.data))})),e.start&&e.start(),e.postMessage(Object.assign({id:a},r),t)}))}class de{static successCallback(){return!0}static failureCallback(e){return console.error(e),!1}static compress(o){if(null===o)return null;try{const s=(function(r,t){var n;if(D)return D.encode(r);var a=r.length,o=new e(r.length+(r.length>>1)),s=0,i=function(e){o[s++]=e};for(n=0;n<a;++n){if(s+5>o.length){var c=new e(s+8+(a-n<<1));c.set(o),o=c}var u=r.charCodeAt(n);u<128?i(u):u<2048?(i(192|u>>6),i(128|63&u)):u>55295&&u<57344?(i(240|(u=65536+(1047552&u)|1023&r.charCodeAt(++n))>>18),i(128|u>>12&63),i(128|u>>6&63),i(128|63&u)):(i(224|u>>12),i(128|u>>6&63),i(128|63&u))}return x(o,0,s)})(o);return(function(o,s){return l=0,f=0,(function(o,s,i,c,l,f){var h=o.length,d=new e(c+h+5*(1+Math.ceil(h/7e3))+l),g=d.subarray(c,d.length-l),p=0;if(!s||h<8)for(var m=0;m<=h;m+=65535){var w=m+65535;w>=h&&(g[p>>3]=f),p=z(g,p+1,o.subarray(m,w))}else{for(var b=G[s-1],y=b>>>13,k=8191&b,E=(1<<i)-1,S=new r(32768),C=new r(E+1),M=Math.ceil(i/3),A=2*M,L=function(e){return(o[e]^o[e+1]<<M^o[e+2]<<A)&E},R=new t(25e3),P=new r(288),O=new r(32),j=0,N=0,W=(m=0,0),D=0,U=0;m<h;++m){var F=L(m),_=32767&m,H=C[F];if(S[_]=H,C[F]=_,D<=m){var I=h-m;if((j>7e3||W>24576)&&I>423){p=K(o,g,0,R,P,O,N,W,U,m-U,p),W=j=N=0,U=m;for(var Y=0;Y<286;++Y)P[Y]=0;for(Y=0;Y<30;++Y)O[Y]=0}var X=2,$=0,q=k,J=_-H&32767;if(I>2&&F==L(m-J))for(var Q=Math.min(y,I)-1,V=Math.min(32767,m),Z=Math.min(258,I);J<=V&&--q&&_!=H;){if(o[m+X]==o[m+X-J]){for(var ee=0;ee<Z&&o[m+ee]==o[m+ee-J];++ee);if(ee>X){if(X=ee,$=J,ee>Q)break;var re=Math.min(J,ee-2),te=0;for(Y=0;Y<re;++Y){var ne=m-J+Y+32768&32767,ae=ne-S[ne]+32768&32767;ae>te&&(te=ae,H=ne)}}}J+=(_=H)-(H=S[_])+32768&32767}if($){R[W++]=268435456|u[X]<<18|v[$];var oe=31&u[X],se=31&v[$];N+=n[oe]+a[se],++P[257+oe],++O[se],D=m+X,++j}else R[W++]=o[m],++P[o[m]]}}p=K(o,g,f,R,P,O,N,W,U,m-U,p),!f&&7&p&&(p=z(g,p+1,B))}return x(d,0,c+T(p)+l)})(i=o,null==(c={level:1}||{}).level?6:c.level,null==c.mem?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(i.length)))):12+c.mem,l,f,!h);var i,c,l,f,h})(s)}catch(e){return console.error(e),null}}static decompress(r){if(null===r)return null;try{const t=(function(r,t){return(function(r,t,s){var i=r.length;if(!i||s&&s.f&&!s.l)return t||new e(0);var u=!t||s,l=!s||s.i;s||(s={}),t||(t=new e(3*i));var v=function(r){var n=t.length;if(r>n){var a=new e(Math.max(2*n,r));a.set(t),t=a}},h=s.f||0,d=s.p||0,g=s.b||0,m=s.l,w=s.d,b=s.m,k=s.n,A=8*i;do{if(!m){h=C(r,d,1);var R=C(r,d+1,3);if(d+=3,!R){var P=r[(F=T(d)+4)-4]|r[F-3]<<8,O=F+P;if(O>i){l&&L(0);break}u&&v(g+P),t.set(r.subarray(F,O),g),s.b=g+=P,s.p=d=8*O,s.f=h;continue}if(1==R)m=y,w=E,b=9,k=5;else if(2==R){var j=C(r,d,31)+257,N=C(r,d+10,15)+4,W=j+C(r,d+5,31)+1;d+=14;for(var z=new e(W),K=new e(19),G=0;G<N;++G)K[o[G]]=C(r,d+3*G,7);d+=3*N;var B=S(K),D=(1<<B)-1,U=p(K,B,1);for(G=0;G<W;){var F,_=U[C(r,d,D)];if(d+=15&_,(F=_>>>4)<16)z[G++]=F;else{var H=0,I=0;for(16==F?(I=3+C(r,d,3),d+=2,H=z[G-1]):17==F?(I=3+C(r,d,7),d+=3):18==F&&(I=11+C(r,d,127),d+=7);I--;)z[G++]=H}}var Y=z.subarray(0,j),X=z.subarray(j);b=S(Y),k=S(X),m=p(Y,b,1),w=p(X,k,1)}else L(1);if(d>A){l&&L(0);break}}u&&v(g+131072);for(var $=(1<<b)-1,q=(1<<k)-1,J=d;;J=d){var Q=(H=m[M(r,d)&$])>>>4;if((d+=15&H)>A){l&&L(0);break}if(H||L(2),Q<256)t[g++]=Q;else{if(256==Q){J=d,m=null;break}var V=Q-254;if(Q>264){var Z=n[G=Q-257];V=C(r,d,(1<<Z)-1)+c[G],d+=Z}var ee=w[M(r,d)&q],re=ee>>>4;if(ee||L(3),d+=15&ee,X=f[re],re>3&&(Z=a[re],X+=M(r,d)&(1<<Z)-1,d+=Z),d>A){l&&L(0);break}u&&v(g+131072);for(var te=g+V;g<te;g+=4)t[g]=t[g-X],t[g+1]=t[g+1-X],t[g+2]=t[g+2-X],t[g+3]=t[g+3-X];g=te}}s.l=m,s.p=J,s.b=g,s.f=h,m&&(h=1,s.m=b,s.d=w,s.n=k)}while(!h);return g==t.length?t:x(t,0,g)})(r,void 0)})(r);return(function(e,r){if(U)return U.decode(e);var t=(function(e){for(var r="",t=0;;){var n=e[t++],a=(n>127)+(n>223)+(n>239);if(t+a>e.length)return[r,x(e,t-1)];a?3==a?(n=((15&n)<<18|(63&e[t++])<<12|(63&e[t++])<<6|63&e[t++])-65536,r+=String.fromCharCode(55296|n>>10,56320|1023&n)):r+=1&a?String.fromCharCode((31&n)<<6|63&e[t++]):String.fromCharCode((15&n)<<12|(63&e[t++])<<6|63&e[t++]):r+=String.fromCharCode(n)}})(e),n=t[0];return t[1].length&&L(8),n})(t)}catch(e){return console.error(e),null}}static async save(e,r){const t=this.compress(e);return await Y(r,t).then(this.successCallback).catch(this.failureCallback)}static async load(e,r){const t=await I(r).catch(this.failureCallback);if(t){const n=this.decompress(t);if(n)return n;if(e>0){console.warn("[WebStorageManager.load] Loading failed. Restoring backup.");const e=await this.loadBackup(r);return await this.restoreBackup(r),e}return console.warn("[WebStorageManager.load] Loading failed. File broken or missing."),!1}return!1}static async saveExists(e){return await X().then((function(r){return r.includes(e)}))}static async restoreBackup(e){const r=e+"bak",t=await this.loadBackup(e);return await this.save(t,e),await(function(e,r=H()){return r("readwrite",(r=>(r.delete(e),F(r.transaction))))})(r).then(this.successCallback).catch(this.failureCallback)}static async backupSave(e){const r=e+"bak",t=await I(e).catch(this.failureCallback);return!!t&&await Y(r,t).then(this.successCallback).catch(this.failureCallback)}static async loadBackup(e){const r=e+"bak",t=await I(r);return this.decompress(t)}}re(class{static compress({data:e}){const r=de.compress(e);return console.log("[GameStorageWorker.compress]",{data:e,compressed:r}),le({result:r},[r.buffer])}static decompress({data:e}){const r=de.decompress(e);return console.log("[GameStorageWorker.decompress]",{data:e,decompressed:r}),{result:r}}static async makeSave({data:e,webKey:r}){const t=await de.save(e,r);return console.log("[GameStorageWorker.makeSave]",{data:e,webKey:r},t),{success:t}}static async loadSave({id:e,webKey:r}){const t=await de.load(e,r);return console.log("[GameStorageWorker.loadSave]",{id:e,webKey:r},t),{result:t}}static async backupSave({webKey:e}){const r=await de.backupSave(e);return console.log("[GameStorageWorker.backupSave]",{webKey:e},r),{success:r}}static async checkSaveExists({webKey:e}){const r=await de.saveExists(e);return console.log("[GameStorageWorker.checkSaveExists]",{webKey:e},r),{result:r}}})})();
