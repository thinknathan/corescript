// @license https://github.com/thinknathan/corescript/blob/master/LICENSE
"use strict"
function Sprite_Base(){this.initialize.apply(this,arguments)}function Sprite_Button(){this.initialize.apply(this,arguments)}function Sprite_Character(){this.initialize.apply(this,arguments)}function Sprite_Battler(){this.initialize.apply(this,arguments)}function Sprite_Actor(){this.initialize.apply(this,arguments)}function Sprite_Enemy(){this.initialize.apply(this,arguments)}function Sprite_Animation(){this.initialize.apply(this,arguments)}function Sprite_Damage(){this.initialize.apply(this,arguments)}function Sprite_StateIcon(){this.initialize.apply(this,arguments)}function Sprite_StateOverlay(){this.initialize.apply(this,arguments)}function Sprite_Weapon(){this.initialize.apply(this,arguments)}function Sprite_Balloon(){this.initialize.apply(this,arguments)}function Sprite_Picture(){this.initialize.apply(this,arguments)}function Sprite_Timer(){this.initialize.apply(this,arguments)}function Sprite_Destination(){this.initialize.apply(this,arguments)}function Spriteset_Base(){this.initialize.apply(this,arguments)}function Spriteset_Map(){this.initialize.apply(this,arguments)}function Spriteset_Battle(){this.initialize.apply(this,arguments)}Sprite_Base.prototype=Object.create(Sprite.prototype),Sprite_Base.prototype.constructor=Sprite_Base,Sprite_Base.prototype.initialize=function(){Sprite.prototype.initialize.call(this),this._animationSprites=[],this._effectTarget=this,this._hiding=!1},Sprite_Base.prototype.update=function(){Sprite.prototype.update.call(this),this.updateVisibility(),this.updateAnimationSprites()},Sprite_Base.prototype.hide=function(){this._hiding=!0,this.updateVisibility()},Sprite_Base.prototype.show=function(){this._hiding=!1,this.updateVisibility()},Sprite_Base.prototype.updateVisibility=function(){this.visible=!this._hiding},Sprite_Base.prototype.updateAnimationSprites=function(){if(this._animationSprites.length>0){const sprites=this._animationSprites.clone()
this._animationSprites=[]
for(let i=0;i<sprites.length;i++){const sprite=sprites[i]
sprite.isPlaying()?this._animationSprites.push(sprite):sprite.remove()}}},Sprite_Base.prototype.startAnimation=function(animation,mirror,delay){const sprite=new Sprite_Animation
sprite.setup(this._effectTarget,animation,mirror,delay),this.parent.addChild(sprite),this._animationSprites.push(sprite)},Sprite_Base.prototype.isAnimationPlaying=function(){return this._animationSprites.length>0},Sprite_Button.prototype=Object.create(Sprite.prototype),Sprite_Button.prototype.constructor=Sprite_Button,Sprite_Button.prototype.initialize=function(){Sprite.prototype.initialize.call(this),this._touching=!1,this._coldFrame=null,this._hotFrame=null,this._clickHandler=null},Sprite_Button.prototype.update=function(){Sprite.prototype.update.call(this),this.updateFrame(),this.processTouch()},Sprite_Button.prototype.updateFrame=function(){let frame
frame=this._touching?this._hotFrame:this._coldFrame,frame&&this.setFrame(frame.x,frame.y,frame.width,frame.height)},Sprite_Button.prototype.setColdFrame=function(x,y,width,height){this._coldFrame=new Rectangle(x,y,width,height)},Sprite_Button.prototype.setHotFrame=function(x,y,width,height){this._hotFrame=new Rectangle(x,y,width,height)},Sprite_Button.prototype.setClickHandler=function(method){this._clickHandler=method},Sprite_Button.prototype.callClickHandler=function(){this._clickHandler&&this._clickHandler()},Sprite_Button.prototype.processTouch=function(){this.isActive()?(TouchInput.isTriggered()&&this.isButtonTouched()&&(this._touching=!0),this._touching&&(!TouchInput.isReleased()&&this.isButtonTouched()||(this._touching=!1,TouchInput.isReleased()&&this.callClickHandler()))):this._touching=!1},Sprite_Button.prototype.isActive=function(){let node=this
for(;node;){if(!node.visible)return!1
node=node.parent}return!0},Sprite_Button.prototype.isButtonTouched=function(){const x=this.canvasToLocalX(TouchInput.x),y=this.canvasToLocalY(TouchInput.y)
return x>=0&&y>=0&&x<this.width&&y<this.height},Sprite_Button.prototype.canvasToLocalX=function(x){let node=this
for(;node;)x-=node.x,node=node.parent
return x},Sprite_Button.prototype.canvasToLocalY=function(y){let node=this
for(;node;)y-=node.y,node=node.parent
return y},Sprite_Character.prototype=Object.create(Sprite_Base.prototype),Sprite_Character.prototype.constructor=Sprite_Character,Sprite_Character.prototype.initialize=function(character){Sprite_Base.prototype.initialize.call(this),this.initMembers(),this.setCharacter(character)},Sprite_Character.prototype.initMembers=function(){this.anchor.x=.5,this.anchor.y=1,this._character=null,this._balloonDuration=0,this._tilesetId=0,this._upperBody=null,this._lowerBody=null},Sprite_Character.prototype.setCharacter=function(character){this._character=character},Sprite_Character.prototype.update=function(){Sprite_Base.prototype.update.call(this),this.updateBitmap(),this.updateFrame(),this.updatePosition(),this.updateAnimation(),this.updateBalloon(),this.updateOther()},Sprite_Character.prototype.updateVisibility=function(){Sprite_Base.prototype.updateVisibility.call(this),this._character.isTransparent()&&(this.visible=!1)},Sprite_Character.prototype.isTile=function(){return this._character.tileId>0},Sprite_Character.prototype.tilesetBitmap=function(tileId){const tileset=$gameMap.tileset(),setNumber=5+Math.floor(tileId/256)
return ImageManager.loadTileset(tileset.tilesetNames[setNumber])},Sprite_Character.prototype.updateBitmap=function(){this.isImageChanged()&&(this._tilesetId=$gameMap.tilesetId(),this._tileId=this._character.tileId(),this._characterName=this._character.characterName(),this._characterIndex=this._character.characterIndex(),this._tileId>0?this.setTileBitmap():this.setCharacterBitmap())},Sprite_Character.prototype.isImageChanged=function(){return this._tilesetId!==$gameMap.tilesetId()||this._tileId!==this._character.tileId()||this._characterName!==this._character.characterName()||this._characterIndex!==this._character.characterIndex()},Sprite_Character.prototype.setTileBitmap=function(){this.bitmap=this.tilesetBitmap(this._tileId)},Sprite_Character.prototype.setCharacterBitmap=function(){this.bitmap=ImageManager.loadCharacter(this._characterName),this._isBigCharacter=ImageManager.isBigCharacter(this._characterName)},Sprite_Character.prototype.updateFrame=function(){this._tileId>0?this.updateTileFrame():this.updateCharacterFrame()},Sprite_Character.prototype.updateTileFrame=function(){const pw=this.patternWidth(),ph=this.patternHeight(),sx=(Math.floor(this._tileId/128)%2*8+this._tileId%8)*pw,sy=Math.floor(this._tileId%256/8)%16*ph
this.setFrame(sx,sy,pw,ph)},Sprite_Character.prototype.updateCharacterFrame=function(){const pw=this.patternWidth(),ph=this.patternHeight(),sx=(this.characterBlockX()+this.characterPatternX())*pw,sy=(this.characterBlockY()+this.characterPatternY())*ph
if(this.updateHalfBodySprites(),this._bushDepth>0){const d=this._bushDepth
this._upperBody.setFrame(sx,sy,pw,ph-d),this._lowerBody.setFrame(sx,sy+ph-d,pw,d),this.setFrame(sx,sy,0,ph)}else this.setFrame(sx,sy,pw,ph)},Sprite_Character.prototype.characterBlockX=function(){if(this._isBigCharacter)return 0
{const index=void 0
return this._character.characterIndex()%4*3}},Sprite_Character.prototype.characterBlockY=function(){if(this._isBigCharacter)return 0
{const index=this._character.characterIndex()
return 4*Math.floor(index/4)}},Sprite_Character.prototype.characterPatternX=function(){return this._character.pattern()},Sprite_Character.prototype.characterPatternY=function(){return(this._character.direction()-2)/2},Sprite_Character.prototype.patternWidth=function(){return this._tileId>0?$gameMap.tileWidth():this._isBigCharacter?this.bitmap.width/3:this.bitmap.width/12},Sprite_Character.prototype.patternHeight=function(){return this._tileId>0?$gameMap.tileHeight():this._isBigCharacter?this.bitmap.height/4:this.bitmap.height/8},Sprite_Character.prototype.updateHalfBodySprites=function(){this._bushDepth>0?(this.createHalfBodySprites(),this._upperBody.bitmap=this.bitmap,this._upperBody.visible=!0,this._upperBody.y=-this._bushDepth,this._lowerBody.bitmap=this.bitmap,this._lowerBody.visible=!0,this._upperBody.setBlendColor(this.getBlendColor()),this._lowerBody.setBlendColor(this.getBlendColor()),this._upperBody.setColorTone(this.getColorTone()),this._lowerBody.setColorTone(this.getColorTone())):this._upperBody&&(this._upperBody.visible=!1,this._lowerBody.visible=!1)},Sprite_Character.prototype.createHalfBodySprites=function(){this._upperBody||(this._upperBody=new Sprite,this._upperBody.anchor.x=.5,this._upperBody.anchor.y=1,this.addChild(this._upperBody)),this._lowerBody||(this._lowerBody=new Sprite,this._lowerBody.anchor.x=.5,this._lowerBody.anchor.y=1,this._lowerBody.opacity=128,this.addChild(this._lowerBody))},Sprite_Character.prototype.updatePosition=function(){this.x=this._character.screenX(),this.y=this._character.screenY(),this.z=this._character.screenZ()},Sprite_Character.prototype.updateAnimation=function(){this.setupAnimation(),this.isAnimationPlaying()||this._character.endAnimation(),this.isBalloonPlaying()||this._character.endBalloon()},Sprite_Character.prototype.updateOther=function(){this.opacity=this._character.opacity(),this.blendMode=this._character.blendMode(),this._bushDepth=this._character.bushDepth()},Sprite_Character.prototype.setupAnimation=function(){if(this._character.animationId()>0){const animation=$dataAnimations[this._character.animationId()]
this.startAnimation(animation,!1,0),this._character.startAnimation()}},Sprite_Character.prototype.setupBalloon=function(){this._character.balloonId()>0&&(this.startBalloon(),this._character.startBalloon())},Sprite_Character.prototype.startBalloon=function(){this._balloonSprite||(this._balloonSprite=new Sprite_Balloon),this._balloonSprite.setup(this._character.balloonId()),this.parent.addChild(this._balloonSprite)},Sprite_Character.prototype.updateBalloon=function(){this.setupBalloon(),this._balloonSprite&&(this._balloonSprite.x=this.x,this._balloonSprite.y=this.y-this.height,this._balloonSprite.isPlaying()||this.endBalloon())},Sprite_Character.prototype.endBalloon=function(){this._balloonSprite&&(this.parent.removeChild(this._balloonSprite),this._balloonSprite=null)},Sprite_Character.prototype.isBalloonPlaying=function(){return!!this._balloonSprite},Sprite_Battler.prototype=Object.create(Sprite_Base.prototype),Sprite_Battler.prototype.constructor=Sprite_Battler,Sprite_Battler.prototype.initialize=function(battler){Sprite_Base.prototype.initialize.call(this),this.initMembers(),this.setBattler(battler)},Sprite_Battler.prototype.initMembers=function(){this.anchor.x=.5,this.anchor.y=1,this._battler=null,this._damages=[],this._homeX=0,this._homeY=0,this._offsetX=0,this._offsetY=0,this._targetOffsetX=NaN,this._targetOffsetY=NaN,this._movementDuration=0,this._selectionEffectCount=0},Sprite_Battler.prototype.setBattler=function(battler){this._battler=battler},Sprite_Battler.prototype.setHome=function(x,y){this._homeX=x,this._homeY=y,this.updatePosition()},Sprite_Battler.prototype.update=function(){Sprite_Base.prototype.update.call(this),this._battler?(this.updateMain(),this.updateAnimation(),this.updateDamagePopup(),this.updateSelectionEffect()):this.bitmap=null},Sprite_Battler.prototype.updateVisibility=function(){Sprite_Base.prototype.updateVisibility.call(this),this._battler&&this._battler.isSpriteVisible()||(this.visible=!1)},Sprite_Battler.prototype.updateMain=function(){this._battler.isSpriteVisible()&&(this.updateBitmap(),this.updateFrame()),this.updateMove(),this.updatePosition()},Sprite_Battler.prototype.updateBitmap=function(){},Sprite_Battler.prototype.updateFrame=function(){},Sprite_Battler.prototype.updateMove=function(){if(this._movementDuration>0){const d=this._movementDuration
this._offsetX=(this._offsetX*(d-1)+this._targetOffsetX)/d,this._offsetY=(this._offsetY*(d-1)+this._targetOffsetY)/d,this._movementDuration--,0===this._movementDuration&&this.onMoveEnd()}},Sprite_Battler.prototype.updatePosition=function(){this.x=this._homeX+this._offsetX,this.y=this._homeY+this._offsetY},Sprite_Battler.prototype.updateAnimation=function(){this.setupAnimation()},Sprite_Battler.prototype.updateDamagePopup=function(){if(this.setupDamagePopup(),this._damages.length>0){for(let i=0;i<this._damages.length;i++)this._damages[i].update()
this._damages[0].isPlaying()||(this.parent.removeChild(this._damages[0]),this._damages.shift())}},Sprite_Battler.prototype.updateSelectionEffect=function(){const target=this._effectTarget
this._battler.isSelected()?(this._selectionEffectCount++,this._selectionEffectCount%30<15?target.setBlendColor([255,255,255,64]):target.setBlendColor([0,0,0,0])):this._selectionEffectCount>0&&(this._selectionEffectCount=0,target.setBlendColor([0,0,0,0]))},Sprite_Battler.prototype.setupAnimation=function(){for(;this._battler.isAnimationRequested();){const data=this._battler.shiftAnimation(),animation=$dataAnimations[data.animationId],mirror=data.mirror,delay=3===animation.position?0:data.delay
this.startAnimation(animation,mirror,delay)
for(let i=0;i<this._animationSprites.length;i++){const sprite=void 0
this._animationSprites[i].visible=this._battler.isSpriteVisible()}}},Sprite_Battler.prototype.setupDamagePopup=function(){if(this._battler.isDamagePopupRequested()){if(this._battler.isSpriteVisible()){const sprite=new Sprite_Damage
sprite.x=this.x+this.damageOffsetX(),sprite.y=this.y+this.damageOffsetY(),sprite.setup(this._battler),this._damages.push(sprite),this.parent.addChild(sprite)}this._battler.clearDamagePopup(),this._battler.clearResult()}},Sprite_Battler.prototype.damageOffsetX=function(){return 0},Sprite_Battler.prototype.damageOffsetY=function(){return 0},Sprite_Battler.prototype.startMove=function(x,y,duration){this._targetOffsetX===x&&this._targetOffsetY===y||(this._targetOffsetX=x,this._targetOffsetY=y,this._movementDuration=duration,0===duration&&(this._offsetX=x,this._offsetY=y))},Sprite_Battler.prototype.onMoveEnd=function(){},Sprite_Battler.prototype.isEffecting=function(){return!1},Sprite_Battler.prototype.isMoving=function(){return this._movementDuration>0},Sprite_Battler.prototype.inHomePosition=function(){return 0===this._offsetX&&0===this._offsetY},Sprite_Actor.prototype=Object.create(Sprite_Battler.prototype),Sprite_Actor.prototype.constructor=Sprite_Actor,Sprite_Actor.MOTIONS={walk:{index:0,loop:!0},wait:{index:1,loop:!0},chant:{index:2,loop:!0},guard:{index:3,loop:!0},damage:{index:4,loop:!1},evade:{index:5,loop:!1},thrust:{index:6,loop:!1},swing:{index:7,loop:!1},missile:{index:8,loop:!1},skill:{index:9,loop:!1},spell:{index:10,loop:!1},item:{index:11,loop:!1},escape:{index:12,loop:!0},victory:{index:13,loop:!0},dying:{index:14,loop:!0},abnormal:{index:15,loop:!0},sleep:{index:16,loop:!0},dead:{index:17,loop:!0}},Sprite_Actor.prototype.initialize=function(battler){Sprite_Battler.prototype.initialize.call(this,battler),this.moveToStartPosition()},Sprite_Actor.prototype.initMembers=function(){Sprite_Battler.prototype.initMembers.call(this),this._battlerName="",this._motion=null,this._motionCount=0,this._pattern=0,this.createShadowSprite(),this.createWeaponSprite(),this.createMainSprite(),this.createStateSprite()},Sprite_Actor.prototype.createMainSprite=function(){this._mainSprite=new Sprite_Base,this._mainSprite.anchor.x=.5,this._mainSprite.anchor.y=1,this.addChild(this._mainSprite),this._effectTarget=this._mainSprite},Sprite_Actor.prototype.createShadowSprite=function(){this._shadowSprite=new Sprite,this._shadowSprite.bitmap=ImageManager.loadSystem("Shadow2"),this._shadowSprite.anchor.x=.5,this._shadowSprite.anchor.y=.5,this._shadowSprite.y=-2,this.addChild(this._shadowSprite)},Sprite_Actor.prototype.createWeaponSprite=function(){this._weaponSprite=new Sprite_Weapon,this.addChild(this._weaponSprite)},Sprite_Actor.prototype.createStateSprite=function(){this._stateSprite=new Sprite_StateOverlay,this.addChild(this._stateSprite)},Sprite_Actor.prototype.setBattler=function(battler){Sprite_Battler.prototype.setBattler.call(this,battler)
const changed=void 0
battler!==this._actor&&(this._actor=battler,battler&&this.setActorHome(battler.index()),this.startEntryMotion(),this._stateSprite.setup(battler))},Sprite_Actor.prototype.moveToStartPosition=function(){this.startMove(300,0,0)},Sprite_Actor.prototype.setActorHome=function(index){this.setHome(600+32*index,280+48*index)},Sprite_Actor.prototype.update=function(){Sprite_Battler.prototype.update.call(this),this.updateShadow(),this._actor&&this.updateMotion()},Sprite_Actor.prototype.updateShadow=function(){this._shadowSprite.visible=!!this._actor},Sprite_Actor.prototype.updateMain=function(){Sprite_Battler.prototype.updateMain.call(this),this._actor.isSpriteVisible()&&!this.isMoving()&&this.updateTargetPosition()},Sprite_Actor.prototype.setupMotion=function(){this._actor.isMotionRequested()&&(this.startMotion(this._actor.motionType()),this._actor.clearMotion())},Sprite_Actor.prototype.setupWeaponAnimation=function(){this._actor.isWeaponAnimationRequested()&&(this._weaponSprite.setup(this._actor.weaponImageId()),this._actor.clearWeaponAnimation())},Sprite_Actor.prototype.startMotion=function(motionType){const newMotion=Sprite_Actor.MOTIONS[motionType]
this._motion!==newMotion&&(this._motion=newMotion,this._motionCount=0,this._pattern=0)},Sprite_Actor.prototype.updateTargetPosition=function(){this._actor.isInputting()||this._actor.isActing()?this.stepForward():this._actor.canMove()&&BattleManager.isEscaped()?this.retreat():this.inHomePosition()||this.stepBack()},Sprite_Actor.prototype.updateBitmap=function(){Sprite_Battler.prototype.updateBitmap.call(this)
const name=this._actor.battlerName()
this._battlerName!==name&&(this._battlerName=name,this._mainSprite.bitmap=ImageManager.loadSvActor(name))},Sprite_Actor.prototype.updateFrame=function(){Sprite_Battler.prototype.updateFrame.call(this)
const bitmap=this._mainSprite.bitmap
if(bitmap){const motionIndex=this._motion?this._motion.index:0,pattern=this._pattern<3?this._pattern:1,cw=bitmap.width/9,ch=bitmap.height/6,cx=3*Math.floor(motionIndex/6)+pattern,cy=motionIndex%6
this._mainSprite.setFrame(cx*cw,cy*ch,cw,ch)}},Sprite_Actor.prototype.updateMove=function(){const bitmap=this._mainSprite.bitmap
bitmap&&!bitmap.isReady()||Sprite_Battler.prototype.updateMove.call(this)},Sprite_Actor.prototype.updateMotion=function(){this.setupMotion(),this.setupWeaponAnimation(),this._actor.isMotionRefreshRequested()&&(this.refreshMotion(),this._actor.clearMotion()),this.updateMotionCount()},Sprite_Actor.prototype.updateMotionCount=function(){this._motion&&++this._motionCount>=this.motionSpeed()&&(this._motion.loop?this._pattern=(this._pattern+1)%4:this._pattern<2?this._pattern++:this.refreshMotion(),this._motionCount=0)},Sprite_Actor.prototype.motionSpeed=function(){return 12},Sprite_Actor.prototype.refreshMotion=function(){const actor=this._actor,motionGuard=Sprite_Actor.MOTIONS.guard
if(actor){if(this._motion===motionGuard&&!BattleManager.isInputting())return
const stateMotion=actor.stateMotionIndex()
actor.isInputting()||actor.isActing()?this.startMotion("walk"):3===stateMotion?this.startMotion("dead"):2===stateMotion?this.startMotion("sleep"):actor.isChanting()?this.startMotion("chant"):actor.isGuard()||actor.isGuardWaiting()?this.startMotion("guard"):1===stateMotion?this.startMotion("abnormal"):actor.isDying()?this.startMotion("dying"):actor.isUndecided()?this.startMotion("walk"):this.startMotion("wait")}},Sprite_Actor.prototype.startEntryMotion=function(){this._actor&&this._actor.canMove()?(this.startMotion("walk"),this.startMove(0,0,30)):this.isMoving()||(this.refreshMotion(),this.startMove(0,0,0))},Sprite_Actor.prototype.stepForward=function(){this.startMove(-48,0,12)},Sprite_Actor.prototype.stepBack=function(){this.startMove(0,0,12)},Sprite_Actor.prototype.retreat=function(){this.startMove(300,0,30)},Sprite_Actor.prototype.onMoveEnd=function(){Sprite_Battler.prototype.onMoveEnd.call(this),BattleManager.isBattleEnd()||this.refreshMotion()},Sprite_Actor.prototype.damageOffsetX=function(){return-32},Sprite_Actor.prototype.damageOffsetY=function(){return 0},Sprite_Enemy.prototype=Object.create(Sprite_Battler.prototype),Sprite_Enemy.prototype.constructor=Sprite_Enemy,Sprite_Enemy.prototype.initialize=function(battler){Sprite_Battler.prototype.initialize.call(this,battler)},Sprite_Enemy.prototype.initMembers=function(){Sprite_Battler.prototype.initMembers.call(this),this._enemy=null,this._appeared=!1,this._battlerName="",this._battlerHue=0,this._effectType=null,this._effectDuration=0,this._shake=0,this.createStateIconSprite()},Sprite_Enemy.prototype.createStateIconSprite=function(){this._stateIconSprite=new Sprite_StateIcon,this.addChild(this._stateIconSprite)},Sprite_Enemy.prototype.setBattler=function(battler){Sprite_Battler.prototype.setBattler.call(this,battler),this._enemy=battler,this.setHome(battler.screenX(),battler.screenY()),this._stateIconSprite.setup(battler)},Sprite_Enemy.prototype.update=function(){Sprite_Battler.prototype.update.call(this),this._enemy&&(this.updateEffect(),this.updateStateSprite())},Sprite_Enemy.prototype.updateBitmap=function(){Sprite_Battler.prototype.updateBitmap.call(this)
const name=this._enemy.battlerName(),hue=this._enemy.battlerHue()
this._battlerName===name&&this._battlerHue===hue||(this._battlerName=name,this._battlerHue=hue,this.loadBitmap(name,hue),this.initVisibility())},Sprite_Enemy.prototype.loadBitmap=function(name,hue){$gameSystem.isSideView()?this.bitmap=ImageManager.loadSvEnemy(name,hue):this.bitmap=ImageManager.loadEnemy(name,hue)},Sprite_Enemy.prototype.updateFrame=function(){Sprite_Battler.prototype.updateFrame.call(this)
let frameHeight=this.bitmap.height
"bossCollapse"===this._effectType&&(frameHeight=this._effectDuration),this.setFrame(0,0,this.bitmap.width,frameHeight)},Sprite_Enemy.prototype.updatePosition=function(){Sprite_Battler.prototype.updatePosition.call(this),this.x+=this._shake},Sprite_Enemy.prototype.updateStateSprite=function(){this._stateIconSprite.y=-Math.round(.9*(this.bitmap.height+40)),this._stateIconSprite.y<20-this.y&&(this._stateIconSprite.y=20-this.y)},Sprite_Enemy.prototype.initVisibility=function(){this._appeared=this._enemy.isAlive(),this._appeared||(this.opacity=0)},Sprite_Enemy.prototype.setupEffect=function(){this._appeared&&this._enemy.isEffectRequested()&&(this.startEffect(this._enemy.effectType()),this._enemy.clearEffect()),!this._appeared&&this._enemy.isAlive()?this.startEffect("appear"):this._appeared&&this._enemy.isHidden()&&this.startEffect("disappear")},Sprite_Enemy.prototype.startEffect=function(effectType){switch(this._effectType=effectType,this._effectType){case"appear":this.startAppear()
break
case"disappear":this.startDisappear()
break
case"whiten":this.startWhiten()
break
case"blink":this.startBlink()
break
case"collapse":this.startCollapse()
break
case"bossCollapse":this.startBossCollapse()
break
case"instantCollapse":this.startInstantCollapse()}this.revertToNormal()},Sprite_Enemy.prototype.startAppear=function(){this._effectDuration=16,this._appeared=!0},Sprite_Enemy.prototype.startDisappear=function(){this._effectDuration=32,this._appeared=!1},Sprite_Enemy.prototype.startWhiten=function(){this._effectDuration=16},Sprite_Enemy.prototype.startBlink=function(){this._effectDuration=20},Sprite_Enemy.prototype.startCollapse=function(){this._effectDuration=32,this._appeared=!1},Sprite_Enemy.prototype.startBossCollapse=function(){this._effectDuration=this.bitmap.height,this._appeared=!1},Sprite_Enemy.prototype.startInstantCollapse=function(){this._effectDuration=16,this._appeared=!1},Sprite_Enemy.prototype.updateEffect=function(){if(this.setupEffect(),this._effectDuration>0){switch(this._effectDuration--,this._effectType){case"whiten":this.updateWhiten()
break
case"blink":this.updateBlink()
break
case"appear":this.updateAppear()
break
case"disappear":this.updateDisappear()
break
case"collapse":this.updateCollapse()
break
case"bossCollapse":this.updateBossCollapse()
break
case"instantCollapse":this.updateInstantCollapse()}0===this._effectDuration&&(this._effectType=null)}},Sprite_Enemy.prototype.isEffecting=function(){return null!==this._effectType},Sprite_Enemy.prototype.revertToNormal=function(){this._shake=0,this.blendMode=0,this.opacity=255,this.setBlendColor([0,0,0,0])},Sprite_Enemy.prototype.updateWhiten=function(){const alpha=128-10*(16-this._effectDuration)
this.setBlendColor([255,255,255,alpha])},Sprite_Enemy.prototype.updateBlink=function(){this.opacity=this._effectDuration%10<5?255:0},Sprite_Enemy.prototype.updateAppear=function(){this.opacity=16*(16-this._effectDuration)},Sprite_Enemy.prototype.updateDisappear=function(){this.opacity=256-10*(32-this._effectDuration)},Sprite_Enemy.prototype.updateCollapse=function(){this.blendMode=Graphics.BLEND_ADD,this.setBlendColor([255,128,128,128]),this.opacity*=this._effectDuration/(this._effectDuration+1)},Sprite_Enemy.prototype.updateBossCollapse=function(){this._shake=this._effectDuration%2*4-2,this.blendMode=Graphics.BLEND_ADD,this.opacity*=this._effectDuration/(this._effectDuration+1),this.setBlendColor([255,255,255,255-this.opacity]),this._effectDuration%20==19&&SoundManager.playBossCollapse2()},Sprite_Enemy.prototype.updateInstantCollapse=function(){this.opacity=0},Sprite_Enemy.prototype.damageOffsetX=function(){return 0},Sprite_Enemy.prototype.damageOffsetY=function(){return-8},Sprite_Animation.prototype=Object.create(Sprite.prototype),Sprite_Animation.prototype.constructor=Sprite_Animation,Sprite_Animation._checker1={},Sprite_Animation._checker2={},Sprite_Animation.prototype.initialize=function(){Sprite.prototype.initialize.call(this),this._reduceArtifacts=!0,this.initMembers()},Sprite_Animation.prototype.initMembers=function(){this._target=null,this._animation=null,this._mirror=!1,this._delay=0,this._rate=4,this._duration=0,this._flashColor=[0,0,0,0],this._flashDuration=0,this._screenFlashDuration=0,this._hidingDuration=0,this._bitmap1=null,this._bitmap2=null,this._cellSprites=[],this._screenFlashSprite=null,this._duplicated=!1,this.z=8},Sprite_Animation.prototype.setup=function(target,animation,mirror,delay){this._target=target,this._animation=animation,this._mirror=mirror,this._delay=delay,this._animation&&(this.remove(),this.setupRate(),this.setupDuration(),this.loadBitmaps(),this.createSprites())},Sprite_Animation.prototype.remove=function(){this.parent&&this.parent.removeChild(this)&&(this._target.setBlendColor([0,0,0,0]),this._target.show())},Sprite_Animation.prototype.setupRate=function(){this._rate=4},Sprite_Animation.prototype.setupDuration=function(){this._duration=this._animation.frames.length*this._rate+1},Sprite_Animation.prototype.update=function(){Sprite.prototype.update.call(this),this.updateMain(),this.updateFlash(),this.updateScreenFlash(),this.updateHiding(),Sprite_Animation._checker1={},Sprite_Animation._checker2={}},Sprite_Animation.prototype.updateFlash=function(){if(this._flashDuration>0){const d=this._flashDuration--
this._flashColor[3]*=(d-1)/d,this._target.setBlendColor(this._flashColor)}},Sprite_Animation.prototype.updateScreenFlash=function(){if(this._screenFlashDuration>0){const d=this._screenFlashDuration--
this._screenFlashSprite&&(this._screenFlashSprite.x=-this.absoluteX(),this._screenFlashSprite.y=-this.absoluteY(),this._screenFlashSprite.opacity*=(d-1)/d,this._screenFlashSprite.visible=this._screenFlashDuration>0)}},Sprite_Animation.prototype.absoluteX=function(){let x=0,object=this
for(;object;)x+=object.x,object=object.parent
return x},Sprite_Animation.prototype.absoluteY=function(){let y=0,object=this
for(;object;)y+=object.y,object=object.parent
return y},Sprite_Animation.prototype.updateHiding=function(){this._hidingDuration>0&&(this._hidingDuration--,0===this._hidingDuration&&this._target.show())},Sprite_Animation.prototype.isPlaying=function(){return this._duration>0},Sprite_Animation.prototype.loadBitmaps=function(){const name1=this._animation.animation1Name,name2=this._animation.animation2Name,hue1=this._animation.animation1Hue,hue2=this._animation.animation2Hue
this._bitmap1=ImageManager.loadAnimation(name1,hue1),this._bitmap2=ImageManager.loadAnimation(name2,hue2)},Sprite_Animation.prototype.isReady=function(){return this._bitmap1&&this._bitmap1.isReady()&&this._bitmap2&&this._bitmap2.isReady()},Sprite_Animation.prototype.createSprites=function(){Sprite_Animation._checker2[this._animation]||(this.createCellSprites(),3===this._animation.position&&(Sprite_Animation._checker2[this._animation]=!0),this.createScreenFlashSprite()),Sprite_Animation._checker1[this._animation]?this._duplicated=!0:(this._duplicated=!1,3===this._animation.position&&(Sprite_Animation._checker1[this._animation]=!0))},Sprite_Animation.prototype.createCellSprites=function(){this._cellSprites=[]
for(let i=0;i<16;i++){const sprite=new Sprite
sprite.anchor.x=.5,sprite.anchor.y=.5,this._cellSprites.push(sprite),this.addChild(sprite)}},Sprite_Animation.prototype.createScreenFlashSprite=function(){this._screenFlashSprite=new ScreenSprite,this.addChild(this._screenFlashSprite)},Sprite_Animation.prototype.updateMain=function(){this.isPlaying()&&this.isReady()&&(this._delay>0?this._delay--:(this._duration--,this.updatePosition(),this._duration%this._rate==0&&this.updateFrame()))},Sprite_Animation.prototype.updatePosition=function(){if(3===this._animation.position)this.x=this.parent.width/2,this.y=this.parent.height/2
else{const parent=this._target.parent,grandparent=parent?parent.parent:null
this.x=this._target.x,this.y=this._target.y,this.parent===grandparent&&(this.x+=parent.x,this.y+=parent.y),0===this._animation.position?this.y-=this._target.height:1===this._animation.position&&(this.y-=this._target.height/2)}},Sprite_Animation.prototype.updateFrame=function(){if(this._duration>0){const frameIndex=this.currentFrameIndex()
this.updateAllCellSprites(this._animation.frames[frameIndex]),this._animation.timings.forEach((function(timing){timing.frame===frameIndex&&this.processTimingData(timing)}),this)}},Sprite_Animation.prototype.currentFrameIndex=function(){return this._animation.frames.length-Math.floor((this._duration+this._rate-1)/this._rate)},Sprite_Animation.prototype.updateAllCellSprites=function(frame){for(let i=0;i<this._cellSprites.length;i++){const sprite=this._cellSprites[i]
i<frame.length?this.updateCellSprite(sprite,frame[i]):sprite.visible=!1}},Sprite_Animation.prototype.updateCellSprite=function(sprite,cell){const pattern=cell[0]
if(pattern>=0){const sx=pattern%5*192,sy=192*Math.floor(pattern%100/5),mirror=this._mirror
sprite.bitmap=pattern<100?this._bitmap1:this._bitmap2,sprite.setFrame(sx,sy,192,192),sprite.x=cell[1],sprite.y=cell[2],sprite.rotation=cell[4]*Math.PI/180,sprite.scale.x=cell[3]/100,cell[5]&&(sprite.scale.x*=-1),mirror&&(sprite.x*=-1,sprite.rotation*=-1,sprite.scale.x*=-1),sprite.scale.y=cell[3]/100,sprite.opacity=cell[6],sprite.blendMode=cell[7],sprite.visible=!0}else sprite.visible=!1},Sprite_Animation.prototype.processTimingData=function(timing){const duration=timing.flashDuration*this._rate
switch(timing.flashScope){case 1:this.startFlash(timing.flashColor,duration)
break
case 2:this.startScreenFlash(timing.flashColor,duration)
break
case 3:this.startHiding(duration)}!this._duplicated&&timing.se&&AudioManager.playSe(timing.se)},Sprite_Animation.prototype.startFlash=function(color,duration){this._flashColor=color.clone(),this._flashDuration=duration},Sprite_Animation.prototype.startScreenFlash=function(color,duration){this._screenFlashDuration=duration,this._screenFlashSprite&&(this._screenFlashSprite.setColor(color[0],color[1],color[2]),this._screenFlashSprite.opacity=color[3])},Sprite_Animation.prototype.startHiding=function(duration){this._hidingDuration=duration,this._target.hide()},Sprite_Damage.prototype=Object.create(Sprite.prototype),Sprite_Damage.prototype.constructor=Sprite_Damage,Sprite_Damage.prototype.initialize=function(){Sprite.prototype.initialize.call(this),this._duration=90,this._flashColor=[0,0,0,0],this._flashDuration=0,this._damageBitmap=ImageManager.loadSystem("Damage")},Sprite_Damage.prototype.setup=function(target){const result=target.result()
result.missed||result.evaded?this.createMiss():result.hpAffected?this.createDigits(0,result.hpDamage):target.isAlive()&&0!==result.mpDamage&&this.createDigits(2,result.mpDamage),result.critical&&this.setupCriticalEffect()},Sprite_Damage.prototype.setupCriticalEffect=function(){this._flashColor=[255,0,0,160],this._flashDuration=60},Sprite_Damage.prototype.digitWidth=function(){return this._damageBitmap?this._damageBitmap.width/10:0},Sprite_Damage.prototype.digitHeight=function(){return this._damageBitmap?this._damageBitmap.height/5:0},Sprite_Damage.prototype.createMiss=function(){const w=this.digitWidth(),h=this.digitHeight(),sprite=this.createChildSprite()
sprite.setFrame(0,4*h,4*w,h),sprite.dy=0},Sprite_Damage.prototype.createDigits=function(baseRow,value){const string=Math.abs(value).toString(),row=baseRow+(value<0?1:0),w=this.digitWidth(),h=this.digitHeight()
for(let i=0;i<string.length;i++){const sprite=this.createChildSprite(),n=Number(string[i])
sprite.setFrame(n*w,row*h,w,h),sprite.x=(i-(string.length-1)/2)*w,sprite.dy=-i}},Sprite_Damage.prototype.createChildSprite=function(){const sprite=new Sprite
return sprite.bitmap=this._damageBitmap,sprite.anchor.x=.5,sprite.anchor.y=1,sprite.y=-40,sprite.ry=sprite.y,this.addChild(sprite),sprite},Sprite_Damage.prototype.update=function(){if(Sprite.prototype.update.call(this),this._duration>0){this._duration--
for(let i=0;i<this.children.length;i++)this.updateChild(this.children[i])}this.updateFlash(),this.updateOpacity()},Sprite_Damage.prototype.updateChild=function(sprite){sprite.dy+=.5,sprite.ry+=sprite.dy,sprite.ry>=0&&(sprite.ry=0,sprite.dy*=-.6),sprite.y=Math.round(sprite.ry),sprite.setBlendColor(this._flashColor)},Sprite_Damage.prototype.updateFlash=function(){if(this._flashDuration>0){const d=this._flashDuration--
this._flashColor[3]*=(d-1)/d}},Sprite_Damage.prototype.updateOpacity=function(){this._duration<10&&(this.opacity=255*this._duration/10)},Sprite_Damage.prototype.isPlaying=function(){return this._duration>0},Sprite_StateIcon.prototype=Object.create(Sprite.prototype),Sprite_StateIcon.prototype.constructor=Sprite_StateIcon,Sprite_StateIcon.prototype.initialize=function(){Sprite.prototype.initialize.call(this),this.initMembers(),this.loadBitmap()},Sprite_StateIcon._iconWidth=32,Sprite_StateIcon._iconHeight=32,Sprite_StateIcon.prototype.initMembers=function(){this._battler=null,this._iconIndex=0,this._animationCount=0,this._animationIndex=0,this.anchor.x=.5,this.anchor.y=.5},Sprite_StateIcon.prototype.loadBitmap=function(){this.bitmap=ImageManager.loadSystem("IconSet"),this.setFrame(0,0,0,0)},Sprite_StateIcon.prototype.setup=function(battler){this._battler=battler},Sprite_StateIcon.prototype.update=function(){Sprite.prototype.update.call(this),this._animationCount++,this._animationCount>=this.animationWait()&&(this.updateIcon(),this.updateFrame(),this._animationCount=0)},Sprite_StateIcon.prototype.animationWait=function(){return 40},Sprite_StateIcon.prototype.updateIcon=function(){let icons=[]
this._battler&&this._battler.isAlive()&&(icons=this._battler.allIcons()),icons.length>0?(this._animationIndex++,this._animationIndex>=icons.length&&(this._animationIndex=0),this._iconIndex=icons[this._animationIndex]):(this._animationIndex=0,this._iconIndex=0)},Sprite_StateIcon.prototype.updateFrame=function(){const pw=Sprite_StateIcon._iconWidth,ph=Sprite_StateIcon._iconHeight,sx=this._iconIndex%16*pw,sy=Math.floor(this._iconIndex/16)*ph
this.setFrame(sx,sy,pw,ph)},Sprite_StateOverlay.prototype=Object.create(Sprite_Base.prototype),Sprite_StateOverlay.prototype.constructor=Sprite_StateOverlay,Sprite_StateOverlay.prototype.initialize=function(){Sprite_Base.prototype.initialize.call(this),this.initMembers(),this.loadBitmap()},Sprite_StateOverlay.prototype.initMembers=function(){this._battler=null,this._overlayIndex=0,this._animationCount=0,this._pattern=0,this.anchor.x=.5,this.anchor.y=1},Sprite_StateOverlay.prototype.loadBitmap=function(){this.bitmap=ImageManager.loadSystem("States"),this.setFrame(0,0,0,0)},Sprite_StateOverlay.prototype.setup=function(battler){this._battler=battler},Sprite_StateOverlay.prototype.update=function(){Sprite_Base.prototype.update.call(this),this._animationCount++,this._animationCount>=this.animationWait()&&(this.updatePattern(),this.updateFrame(),this._animationCount=0)},Sprite_StateOverlay.prototype.animationWait=function(){return 8},Sprite_StateOverlay.prototype.updatePattern=function(){this._pattern++,this._pattern%=8,this._battler&&(this._overlayIndex=this._battler.stateOverlayIndex())},Sprite_StateOverlay.prototype.updateFrame=function(){if(this._overlayIndex>0){const w=96,h=96,sx=this._pattern*w,sy=(this._overlayIndex-1)*h
this.setFrame(sx,sy,w,h)}else this.setFrame(0,0,0,0)},Sprite_Weapon.prototype=Object.create(Sprite_Base.prototype),Sprite_Weapon.prototype.constructor=Sprite_Weapon,Sprite_Weapon.prototype.initialize=function(){Sprite_Base.prototype.initialize.call(this),this.initMembers()},Sprite_Weapon.prototype.initMembers=function(){this._weaponImageId=0,this._animationCount=0,this._pattern=0,this.anchor.x=.5,this.anchor.y=1,this.x=-16},Sprite_Weapon.prototype.setup=function(weaponImageId){this._weaponImageId=weaponImageId,this._animationCount=0,this._pattern=0,this.loadBitmap(),this.updateFrame()},Sprite_Weapon.prototype.update=function(){Sprite_Base.prototype.update.call(this),this._animationCount++,this._animationCount>=this.animationWait()&&(this.updatePattern(),this.updateFrame(),this._animationCount=0)},Sprite_Weapon.prototype.animationWait=function(){return 12},Sprite_Weapon.prototype.updatePattern=function(){this._pattern++,this._pattern>=3&&(this._weaponImageId=0)},Sprite_Weapon.prototype.loadBitmap=function(){const pageId=Math.floor((this._weaponImageId-1)/12)+1
this.bitmap=pageId>=1?ImageManager.loadSystem("Weapons"+pageId):ImageManager.loadSystem("")},Sprite_Weapon.prototype.updateFrame=function(){if(this._weaponImageId>0){const index=(this._weaponImageId-1)%12,w=96,h=64,sx=(3*Math.floor(index/6)+this._pattern)*w,sy=Math.floor(index%6)*h
this.setFrame(sx,sy,w,h)}else this.setFrame(0,0,0,0)},Sprite_Weapon.prototype.isPlaying=function(){return this._weaponImageId>0},Sprite_Balloon.prototype=Object.create(Sprite_Base.prototype),Sprite_Balloon.prototype.constructor=Sprite_Balloon,Sprite_Balloon.prototype.initialize=function(){Sprite_Base.prototype.initialize.call(this),this.initMembers(),this.loadBitmap()},Sprite_Balloon.prototype.initMembers=function(){this._balloonId=0,this._duration=0,this.anchor.x=.5,this.anchor.y=1,this.z=7},Sprite_Balloon.prototype.loadBitmap=function(){this.bitmap=ImageManager.loadSystem("Balloon"),this.setFrame(0,0,0,0)},Sprite_Balloon.prototype.setup=function(balloonId){this._balloonId=balloonId,this._duration=8*this.speed()+this.waitTime()},Sprite_Balloon.prototype.update=function(){Sprite_Base.prototype.update.call(this),this._duration>0&&(this._duration--,this._duration>0&&this.updateFrame())},Sprite_Balloon.prototype.updateFrame=function(){const w=48,h=48,sx=this.frameIndex()*w,sy=(this._balloonId-1)*h
this.setFrame(sx,sy,w,h)},Sprite_Balloon.prototype.speed=function(){return 8},Sprite_Balloon.prototype.waitTime=function(){return 12},Sprite_Balloon.prototype.frameIndex=function(){const index=(this._duration-this.waitTime())/this.speed()
return 7-Math.max(Math.floor(index),0)},Sprite_Balloon.prototype.isPlaying=function(){return this._duration>0},Sprite_Picture.prototype=Object.create(Sprite.prototype),Sprite_Picture.prototype.constructor=Sprite_Picture,Sprite_Picture.prototype.initialize=function(pictureId){Sprite.prototype.initialize.call(this),this._pictureId=pictureId,this._pictureName="",this.update()},Sprite_Picture.prototype.picture=function(){return $gameScreen.picture(this._pictureId)},Sprite_Picture.prototype.update=function(){Sprite.prototype.update.call(this),this.updateBitmap(),this.visible&&(this.updateOrigin(),this.updatePosition(),this.updateScale(),this.updateTone(),this.updateOther())},Sprite_Picture.prototype.updateBitmap=function(){const picture=this.picture()
if(picture){const pictureName=picture.name()
this._pictureName!==pictureName&&(this._pictureName=pictureName,this.loadBitmap()),this.visible=!0}else this._pictureName="",this.bitmap=null,this.visible=!1},Sprite_Picture.prototype.updateOrigin=function(){const picture=void 0
0===this.picture().origin()?(this.anchor.x=0,this.anchor.y=0):(this.anchor.x=.5,this.anchor.y=.5)},Sprite_Picture.prototype.updatePosition=function(){const picture=this.picture()
this.x=Math.floor(picture.x()),this.y=Math.floor(picture.y())},Sprite_Picture.prototype.updateScale=function(){const picture=this.picture()
this.scale.x=picture.scaleX()/100,this.scale.y=picture.scaleY()/100},Sprite_Picture.prototype.updateTone=function(){const picture=this.picture()
picture.tone()?this.setColorTone(picture.tone()):this.setColorTone([0,0,0,0])},Sprite_Picture.prototype.updateOther=function(){const picture=this.picture()
this.opacity=picture.opacity(),this.blendMode=picture.blendMode(),this.rotation=picture.angle()*Math.PI/180},Sprite_Picture.prototype.loadBitmap=function(){this.bitmap=ImageManager.loadPicture(this._pictureName)},Sprite_Timer.prototype=Object.create(Sprite.prototype),Sprite_Timer.prototype.constructor=Sprite_Timer,Sprite_Timer.prototype.initialize=function(){Sprite.prototype.initialize.call(this),this._seconds=0,this.createBitmap(),this.update()},Sprite_Timer.prototype.createBitmap=function(){this.bitmap=new Bitmap(96,48),this.bitmap.fontSize=32},Sprite_Timer.prototype.update=function(){Sprite.prototype.update.call(this),this.updateBitmap(),this.updatePosition(),this.updateVisibility()},Sprite_Timer.prototype.updateBitmap=function(){this._seconds!==$gameTimer.seconds()&&(this._seconds=$gameTimer.seconds(),this.redraw())},Sprite_Timer.prototype.redraw=function(){const text=this.timerText(),width=this.bitmap.width,height=this.bitmap.height
this.bitmap.clear(),this.bitmap.drawText(text,0,0,width,height,"center")},Sprite_Timer.prototype.timerText=function(){const min=Math.floor(this._seconds/60)%60,sec=this._seconds%60
return min.padZero(2)+":"+sec.padZero(2)},Sprite_Timer.prototype.updatePosition=function(){this.x=Graphics.width-this.bitmap.width,this.y=0},Sprite_Timer.prototype.updateVisibility=function(){this.visible=$gameTimer.isWorking()},Sprite_Destination.prototype=Object.create(Sprite.prototype),Sprite_Destination.prototype.constructor=Sprite_Destination,Sprite_Destination.prototype.initialize=function(){Sprite.prototype.initialize.call(this),this.createBitmap(),this._frameCount=0},Sprite_Destination.prototype.update=function(){Sprite.prototype.update.call(this),$gameTemp.isDestinationValid()?(this.updatePosition(),this.updateAnimation(),this.visible=!0):(this._frameCount=0,this.visible=!1)},Sprite_Destination.prototype.createBitmap=function(){const tileWidth=$gameMap.tileWidth(),tileHeight=$gameMap.tileHeight()
this.bitmap=new Bitmap(tileWidth,tileHeight),this.bitmap.fillAll("white"),this.anchor.x=.5,this.anchor.y=.5,this.blendMode=Graphics.BLEND_ADD},Sprite_Destination.prototype.updatePosition=function(){const tileWidth=$gameMap.tileWidth(),tileHeight=$gameMap.tileHeight(),x=$gameTemp.destinationX(),y=$gameTemp.destinationY()
this.x=($gameMap.adjustX(x)+.5)*tileWidth,this.y=($gameMap.adjustY(y)+.5)*tileHeight},Sprite_Destination.prototype.updateAnimation=function(){this._frameCount++,this._frameCount%=20,this.opacity=6*(20-this._frameCount),this.scale.x=1+this._frameCount/20,this.scale.y=this.scale.x},Spriteset_Base.prototype=Object.create(Sprite.prototype),Spriteset_Base.prototype.constructor=Spriteset_Base,Spriteset_Base.prototype.initialize=function(){Sprite.prototype.initialize.call(this),this.setFrame(0,0,Graphics.width,Graphics.height),this._tone=[0,0,0,0],this.opaque=!0,this.createLowerLayer(),this.createToneChanger(),this.createUpperLayer(),this.update()},Spriteset_Base.prototype.createLowerLayer=function(){this.createBaseSprite()},Spriteset_Base.prototype.createUpperLayer=function(){this.createPictures(),this.createTimer(),this.createScreenSprites()},Spriteset_Base.prototype.update=function(){Sprite.prototype.update.call(this),this.updateScreenSprites(),this.updateToneChanger(),this.updatePosition()},Spriteset_Base.prototype.createBaseSprite=function(){this._baseSprite=new Sprite,this._baseSprite.setFrame(0,0,this.width,this.height),this._blackScreen=new ScreenSprite,this._blackScreen.opacity=255,this.addChild(this._baseSprite),this._baseSprite.addChild(this._blackScreen)},Spriteset_Base.prototype.createToneChanger=function(){Graphics.isWebGL()?this.createWebGLToneChanger():this.createCanvasToneChanger()},Spriteset_Base.prototype.createWebGLToneChanger=function(){const margin=48,width=Graphics.width+96,height=Graphics.height+96
this._toneFilter=new ToneFilter,this._toneFilter.enabled=!1,this._baseSprite.filters=[this._toneFilter],this._baseSprite.filterArea=new Rectangle(-48,-48,width,height)},Spriteset_Base.prototype.createCanvasToneChanger=function(){this._toneSprite=new ToneSprite,this.addChild(this._toneSprite)},Spriteset_Base.prototype.createPictures=function(){const width=Graphics.boxWidth,height=Graphics.boxHeight,x=(Graphics.width-width)/2,y=(Graphics.height-height)/2
this._pictureContainer=new Sprite,this._pictureContainer.setFrame(x,y,width,height)
for(let i=1;i<=$gameScreen.maxPictures();i++)this._pictureContainer.addChild(new Sprite_Picture(i))
this.addChild(this._pictureContainer)},Spriteset_Base.prototype.createTimer=function(){this._timerSprite=new Sprite_Timer,this.addChild(this._timerSprite)},Spriteset_Base.prototype.createScreenSprites=function(){this._flashSprite=new ScreenSprite,this._fadeSprite=new ScreenSprite,this.addChild(this._flashSprite),this.addChild(this._fadeSprite)},Spriteset_Base.prototype.updateScreenSprites=function(){const color=$gameScreen.flashColor()
this._flashSprite.setColor(color[0],color[1],color[2]),this._flashSprite.opacity=color[3],this._fadeSprite.opacity=255-$gameScreen.brightness()},Spriteset_Base.prototype.updateToneChanger=function(){const tone=$gameScreen.tone()
this._tone.equals(tone)||(this._tone=tone.clone(),Graphics.isWebGL()?this.updateWebGLToneChanger():this.updateCanvasToneChanger())},Spriteset_Base.prototype.updateWebGLToneChanger=function(){const tone=this._tone
this._toneFilter.reset(),tone[0]||tone[1]||tone[2]||tone[3]?(this._toneFilter.enabled=!0,this._toneFilter.adjustTone(tone[0],tone[1],tone[2]),this._toneFilter.adjustSaturation(-tone[3])):this._toneFilter.enabled=!1},Spriteset_Base.prototype.updateCanvasToneChanger=function(){const tone=this._tone
this._toneSprite.setTone(tone[0],tone[1],tone[2],tone[3])},Spriteset_Base.prototype.updatePosition=function(){const screen=$gameScreen,scale=screen.zoomScale()
this.scale.x=scale,this.scale.y=scale,this.x=Math.round(-screen.zoomX()*(scale-1)),this.y=Math.round(-screen.zoomY()*(scale-1)),this.x+=Math.round(screen.shake())},Spriteset_Map.prototype=Object.create(Spriteset_Base.prototype),Spriteset_Map.prototype.constructor=Spriteset_Map,Spriteset_Map.prototype.initialize=function(){Spriteset_Base.prototype.initialize.call(this)},Spriteset_Map.prototype.createLowerLayer=function(){Spriteset_Base.prototype.createLowerLayer.call(this),this.createParallax(),this.createTilemap(),this.createCharacters(),this.createShadow(),this.createDestination(),this.createWeather()},Spriteset_Map.prototype.update=function(){Spriteset_Base.prototype.update.call(this),this.updateTileset(),this.updateParallax(),this.updateTilemap(),this.updateShadow(),this.updateWeather()},Spriteset_Map.prototype.hideCharacters=function(){for(let i=0;i<this._characterSprites.length;i++){const sprite=this._characterSprites[i]
sprite.isTile()||sprite.hide()}},Spriteset_Map.prototype.createParallax=function(){this._parallax=new TilingSprite,this._parallax.move(0,0,Graphics.width,Graphics.height),this._baseSprite.addChild(this._parallax)},Spriteset_Map.prototype.createTilemap=function(){Graphics.isWebGL()?this._tilemap=new ShaderTilemap:this._tilemap=new Tilemap,this._tilemap.tileWidth=$gameMap.tileWidth(),this._tilemap.tileHeight=$gameMap.tileHeight(),this._tilemap.setData($gameMap.width(),$gameMap.height(),$gameMap.data()),this._tilemap.horizontalWrap=$gameMap.isLoopHorizontal(),this._tilemap.verticalWrap=$gameMap.isLoopVertical(),this.loadTileset(),this._baseSprite.addChild(this._tilemap)},Spriteset_Map.prototype.loadTileset=function(){if(this._tileset=$gameMap.tileset(),this._tileset){const tilesetNames=this._tileset.tilesetNames
for(let i=0;i<tilesetNames.length;i++)this._tilemap.bitmaps[i]=ImageManager.loadTileset(tilesetNames[i])
const newTilesetFlags=$gameMap.tilesetFlags()
this._tilemap.refreshTileset(),this._tilemap.flags.equals(newTilesetFlags)||this._tilemap.refresh(),this._tilemap.flags=newTilesetFlags}},Spriteset_Map.prototype.createCharacters=function(){this._characterSprites=[],$gameMap.events().forEach((function(event){this._characterSprites.push(new Sprite_Character(event))}),this),$gameMap.vehicles().forEach((function(vehicle){this._characterSprites.push(new Sprite_Character(vehicle))}),this),$gamePlayer.followers().reverseEach((function(follower){this._characterSprites.push(new Sprite_Character(follower))}),this),this._characterSprites.push(new Sprite_Character($gamePlayer))
for(let i=0;i<this._characterSprites.length;i++)this._tilemap.addChild(this._characterSprites[i])},Spriteset_Map.prototype.createShadow=function(){this._shadowSprite=new Sprite,this._shadowSprite.bitmap=ImageManager.loadSystem("Shadow1"),this._shadowSprite.anchor.x=.5,this._shadowSprite.anchor.y=1,this._shadowSprite.z=6,this._tilemap.addChild(this._shadowSprite)},Spriteset_Map.prototype.createDestination=function(){this._destinationSprite=new Sprite_Destination,this._destinationSprite.z=9,this._tilemap.addChild(this._destinationSprite)},Spriteset_Map.prototype.createWeather=function(){this._weather=new Weather,this.addChild(this._weather)},Spriteset_Map.prototype.updateTileset=function(){this._tileset!==$gameMap.tileset()&&this.loadTileset()},Spriteset_Map.prototype._canvasReAddParallax=function(){const index=this._baseSprite.children.indexOf(this._parallax)
this._baseSprite.removeChild(this._parallax),this._parallax=new TilingSprite,this._parallax.move(0,0,Graphics.width,Graphics.height),this._parallax.bitmap=ImageManager.loadParallax(this._parallaxName),this._baseSprite.addChildAt(this._parallax,index)},Spriteset_Map.prototype.updateParallax=function(){this._parallaxName!==$gameMap.parallaxName()&&(this._parallaxName=$gameMap.parallaxName(),this._parallax.bitmap&&1!=Graphics.isWebGL()?this._canvasReAddParallax():this._parallax.bitmap=ImageManager.loadParallax(this._parallaxName)),this._parallax.bitmap&&(this._parallax.origin.x=$gameMap.parallaxOx(),this._parallax.origin.y=$gameMap.parallaxOy())},Spriteset_Map.prototype.updateTilemap=function(){this._tilemap.origin.x=$gameMap.displayX()*$gameMap.tileWidth(),this._tilemap.origin.y=$gameMap.displayY()*$gameMap.tileHeight(),this._tilemap.bitmaps&&!this.isTilesetReady&&this._tilemap.bitmaps.every((bitmap=>bitmap.isRequestReady()))&&(this._tilemap.refresh(),this._tilemap.refreshTileset(),this.isTilesetReady=!0)},Spriteset_Map.prototype.updateShadow=function(){const airship=$gameMap.airship()
this._shadowSprite.x=airship.shadowX(),this._shadowSprite.y=airship.shadowY(),this._shadowSprite.opacity=airship.shadowOpacity()},Spriteset_Map.prototype.updateWeather=function(){this._weather.type=$gameScreen.weatherType(),this._weather.power=$gameScreen.weatherPower(),this._weather.origin.x=$gameMap.displayX()*$gameMap.tileWidth(),this._weather.origin.y=$gameMap.displayY()*$gameMap.tileHeight()},Spriteset_Battle.prototype=Object.create(Spriteset_Base.prototype),Spriteset_Battle.prototype.constructor=Spriteset_Battle,Spriteset_Battle.prototype.initialize=function(){Spriteset_Base.prototype.initialize.call(this),this._battlebackLocated=!1},Spriteset_Battle.prototype.createLowerLayer=function(){Spriteset_Base.prototype.createLowerLayer.call(this),this.createBackground(),this.createBattleField(),this.createBattleback(),this.createEnemies(),this.createActors()},Spriteset_Battle.prototype.createBackground=function(){this._backgroundSprite=new Sprite,this._backgroundSprite.bitmap=SceneManager.backgroundBitmap(),this._baseSprite.addChild(this._backgroundSprite)},Spriteset_Battle.prototype.update=function(){Spriteset_Base.prototype.update.call(this),this.updateActors(),this.updateBattleback()},Spriteset_Battle.prototype.createBattleField=function(){const width=Graphics.boxWidth,height=Graphics.boxHeight,x=(Graphics.width-width)/2,y=(Graphics.height-height)/2
this._battleField=new Sprite,this._battleField.setFrame(x,y,width,height),this._battleField.x=x,this._battleField.y=y,this._baseSprite.addChild(this._battleField)},Spriteset_Battle.prototype.createBattleback=function(){const margin=32,x=-this._battleField.x-32,y=-this._battleField.y-32,width=Graphics.width+64,height=Graphics.height+64
this._back1Sprite=new TilingSprite,this._back2Sprite=new TilingSprite,this._back1Sprite.bitmap=this.battleback1Bitmap(),this._back2Sprite.bitmap=this.battleback2Bitmap(),this._back1Sprite.move(x,y,width,height),this._back2Sprite.move(x,y,width,height),this._battleField.addChild(this._back1Sprite),this._battleField.addChild(this._back2Sprite)},Spriteset_Battle.prototype.updateBattleback=function(){this._battlebackLocated||(this.locateBattleback(),this._battlebackLocated=!0)},Spriteset_Battle.prototype.locateBattleback=function(){const width=this._battleField.width,height=this._battleField.height,sprite1=this._back1Sprite,sprite2=this._back2Sprite
sprite1.origin.x=sprite1.x+(sprite1.bitmap.width-width)/2,sprite2.origin.x=sprite1.y+(sprite2.bitmap.width-width)/2,$gameSystem.isSideView()&&(sprite1.origin.y=sprite1.x+sprite1.bitmap.height-height,sprite2.origin.y=sprite1.y+sprite2.bitmap.height-height)},Spriteset_Battle.prototype.battleback1Bitmap=function(){return ImageManager.loadBattleback1(this.battleback1Name())},Spriteset_Battle.prototype.battleback2Bitmap=function(){return ImageManager.loadBattleback2(this.battleback2Name())},Spriteset_Battle.prototype.battleback1Name=function(){return BattleManager.isBattleTest()?$dataSystem.battleback1Name:$gameMap.battleback1Name()?$gameMap.battleback1Name():$gameMap.isOverworld()?this.overworldBattleback1Name():""},Spriteset_Battle.prototype.battleback2Name=function(){return BattleManager.isBattleTest()?$dataSystem.battleback2Name:$gameMap.battleback2Name()?$gameMap.battleback2Name():$gameMap.isOverworld()?this.overworldBattleback2Name():""},Spriteset_Battle.prototype.overworldBattleback1Name=function(){return""===$gameMap.battleback1Name()?"":$gamePlayer.isInVehicle()?this.shipBattleback1Name():this.normalBattleback1Name()},Spriteset_Battle.prototype.overworldBattleback2Name=function(){return""===$gameMap.battleback2Name()?"":$gamePlayer.isInVehicle()?this.shipBattleback2Name():this.normalBattleback2Name()},Spriteset_Battle.prototype.normalBattleback1Name=function(){return this.terrainBattleback1Name(this.autotileType(1))||this.terrainBattleback1Name(this.autotileType(0))||this.defaultBattleback1Name()},Spriteset_Battle.prototype.normalBattleback2Name=function(){return this.terrainBattleback2Name(this.autotileType(1))||this.terrainBattleback2Name(this.autotileType(0))||this.defaultBattleback2Name()},Spriteset_Battle.prototype.terrainBattleback1Name=function(type){switch(type){case 24:case 25:return"Wasteland"
case 26:case 27:return"DirtField"
case 32:case 33:return"Desert"
case 34:return"Lava1"
case 35:return"Lava2"
case 40:case 41:return"Snowfield"
case 42:return"Clouds"
case 4:case 5:return"PoisonSwamp"
default:return null}},Spriteset_Battle.prototype.terrainBattleback2Name=function(type){switch(type){case 20:case 21:return"Forest"
case 22:case 30:case 38:return"Cliff"
case 24:case 25:case 26:case 27:return"Wasteland"
case 32:case 33:return"Desert"
case 34:case 35:return"Lava"
case 40:case 41:return"Snowfield"
case 42:return"Clouds"
case 4:case 5:return"PoisonSwamp"}},Spriteset_Battle.prototype.defaultBattleback1Name=function(){return"Grassland"},Spriteset_Battle.prototype.defaultBattleback2Name=function(){return"Grassland"},Spriteset_Battle.prototype.shipBattleback1Name=function(){return"Ship"},Spriteset_Battle.prototype.shipBattleback2Name=function(){return"Ship"},Spriteset_Battle.prototype.autotileType=function(z){return $gameMap.autotileType($gamePlayer.x,$gamePlayer.y,z)},Spriteset_Battle.prototype.createEnemies=function(){const enemies=$gameTroop.members(),sprites=[]
for(let i=0;i<enemies.length;i++)sprites[i]=new Sprite_Enemy(enemies[i])
sprites.sort(this.compareEnemySprite.bind(this))
for(let j=0;j<sprites.length;j++)this._battleField.addChild(sprites[j])
this._enemySprites=sprites},Spriteset_Battle.prototype.compareEnemySprite=function(a,b){return a.y!==b.y?a.y-b.y:b.spriteId-a.spriteId},Spriteset_Battle.prototype.createActors=function(){this._actorSprites=[]
for(let i=0;i<$gameParty.maxBattleMembers();i++)this._actorSprites[i]=new Sprite_Actor,this._battleField.addChild(this._actorSprites[i])},Spriteset_Battle.prototype.updateActors=function(){const members=$gameParty.battleMembers()
for(let i=0;i<this._actorSprites.length;i++)this._actorSprites[i].setBattler(members[i])},Spriteset_Battle.prototype.battlerSprites=function(){return this._enemySprites.concat(this._actorSprites)},Spriteset_Battle.prototype.isAnimationPlaying=function(){return this.battlerSprites().some((function(sprite){return sprite.isAnimationPlaying()}))},Spriteset_Battle.prototype.isEffecting=function(){return this.battlerSprites().some((function(sprite){return sprite.isEffecting()}))},Spriteset_Battle.prototype.isAnyoneMoving=function(){return this.battlerSprites().some((function(sprite){return sprite.isMoving()}))},Spriteset_Battle.prototype.isBusy=function(){return this.isAnimationPlaying()||this.isAnyoneMoving()}
