/*!
 * rpg_managers.js - v1.6.1 (community-1.4)
 * (c) 2015 KADOKAWA CORPORATION./YOJI OJIMA
 * Contributions by the RPG Maker MV CoreScript team
 * https://github.com/thinknathan/corescript/blob/master/CONTRIBUTORS.md
 *
 * Licensed under the MIT License.
 * https://github.com/thinknathan/corescript/blob/master/LICENSE
 */
"use strict"
function DataManager(){throw new Error("This is a static class")}var $dataActors=null,$dataClasses=null,$dataSkills=null,$dataItems=null,$dataWeapons=null,$dataArmors=null,$dataEnemies=null,$dataTroops=null,$dataStates=null,$dataAnimations=null,$dataTilesets=null,$dataCommonEvents=null,$dataSystem=null,$dataMapInfos=null,$dataMap=null,$gameTemp=null,$gameSystem=null,$gameScreen=null,$gameTimer=null,$gameMessage=null,$gameSwitches=null,$gameVariables=null,$gameSelfSwitches=null,$gameActors=null,$gameParty=null,$gameTroop=null,$gameMap=null,$gamePlayer=null,$testEvent=null
function ConfigManager(){throw new Error("This is a static class")}function StorageManager(){throw new Error("This is a static class")}function ImageManager(){throw new Error("This is a static class")}function AudioManager(){throw new Error("This is a static class")}function SoundManager(){throw new Error("This is a static class")}function TextManager(){throw new Error("This is a static class")}function SceneManager(){throw new Error("This is a static class")}function BattleManager(){throw new Error("This is a static class")}function PluginManager(){throw new Error("This is a static class")}DataManager._globalId="RPGMV",DataManager._lastAccessedId=1,DataManager._errorUrl=null,DataManager._autoSaveFileId=0,DataManager._databaseFiles=[{name:"$dataActors",src:"Actors.json"},{name:"$dataClasses",src:"Classes.json"},{name:"$dataSkills",src:"Skills.json"},{name:"$dataItems",src:"Items.json"},{name:"$dataWeapons",src:"Weapons.json"},{name:"$dataArmors",src:"Armors.json"},{name:"$dataEnemies",src:"Enemies.json"},{name:"$dataTroops",src:"Troops.json"},{name:"$dataStates",src:"States.json"},{name:"$dataAnimations",src:"Animations.json"},{name:"$dataTilesets",src:"Tilesets.json"},{name:"$dataCommonEvents",src:"CommonEvents.json"},{name:"$dataSystem",src:"System.json"},{name:"$dataMapInfos",src:"MapInfos.json"}],DataManager.loadDatabase=function(){const e=void 0,t=this.isBattleTest()||this.isEventTest()?"Test_":""
for(let e=0;e<this._databaseFiles.length;e++){const a=this._databaseFiles[e].name,n=this._databaseFiles[e].src
this.loadDataFile(a,t+n)}this.isEventTest()&&this.loadDataFile("$testEvent",t+"Event.json")},DataManager.loadDataFile=function(e,t){const a=new XMLHttpRequest,n="data/"+t
a.open("GET",n),a.overrideMimeType("application/json"),a.onload=function(){a.status<400&&(window[e]=JSON.parse(a.responseText),DataManager.onLoad(window[e]))},a.onerror=this._mapLoader||function(){DataManager._errorUrl=DataManager._errorUrl||n},window[e]=null,a.send()},DataManager.isDatabaseLoaded=function(){this.checkError()
for(let e=0;e<this._databaseFiles.length;e++)if(!window[this._databaseFiles[e].name])return!1
return!0},DataManager.loadMapData=function(e){if(e>0){const t="Map%1.json".format(e.padZero(3))
this._mapLoader=ResourceHandler.createLoader("data/"+t,this.loadDataFile.bind(this,"$dataMap",t)),this.loadDataFile("$dataMap",t)}else this.makeEmptyMap()},DataManager.makeEmptyMap=function(){($dataMap={}).data=[],$dataMap.events=[],$dataMap.width=100,$dataMap.height=100,$dataMap.scrollType=3},DataManager.isMapLoaded=function(){return this.checkError(),!!$dataMap},DataManager.onLoad=function(e){let t
if(e===$dataMap?(this.extractMetadata(e),t=e.events):t=e,Array.isArray(t))for(let e=0;e<t.length;e++){const a=t[e]
a&&void 0!==a.note&&this.extractMetadata(a)}e===$dataSystem&&(Decrypter.hasEncryptedImages=!!e.hasEncryptedImages,Decrypter.hasEncryptedAudio=!!e.hasEncryptedAudio,Scene_Boot.loadSystemImages())},DataManager.extractMetadata=function(e){const t=/<([^<>:]+)(:?)([^>]*)>/g
for(e.meta={};;){const a=t.exec(e.note)
if(!a)break
":"===a[2]?e.meta[a[1]]=a[3]:e.meta[a[1]]=!0}},DataManager.checkError=function(){if(DataManager._errorUrl)throw new Error("Failed to load: "+DataManager._errorUrl)},DataManager.isBattleTest=function(){return Utils.isOptionValid("btest")},DataManager.isEventTest=function(){return Utils.isOptionValid("etest")},DataManager.isSkill=function(e){return e&&$dataSkills.contains(e)},DataManager.isItem=function(e){return e&&$dataItems.contains(e)},DataManager.isWeapon=function(e){return e&&$dataWeapons.contains(e)},DataManager.isArmor=function(e){return e&&$dataArmors.contains(e)},DataManager.createGameObjects=function(){$gameTemp=new Game_Temp,$gameSystem=new Game_System,$gameScreen=new Game_Screen,$gameTimer=new Game_Timer,$gameMessage=new Game_Message,$gameSwitches=new Game_Switches,$gameVariables=new Game_Variables,$gameSelfSwitches=new Game_SelfSwitches,$gameActors=new Game_Actors,$gameParty=new Game_Party,$gameTroop=new Game_Troop,$gameMap=new Game_Map,$gamePlayer=new Game_Player},DataManager.setupNewGame=function(){this.createGameObjects(),this.selectSavefileForNewGame(),$gameParty.setupStartingMembers(),$gamePlayer.reserveTransfer($dataSystem.startMapId,$dataSystem.startX,$dataSystem.startY),Graphics.frameCount=0,SceneManager.resetFrameCount()},DataManager.setupBattleTest=function(){this.createGameObjects(),$gameParty.setupBattleTest(),BattleManager.setup($dataSystem.testTroopId,!0,!1),BattleManager.setBattleTest(!0),BattleManager.playBattleBgm()},DataManager.setupEventTest=function(){this.createGameObjects(),this.selectSavefileForNewGame(),$gameParty.setupStartingMembers(),$gamePlayer.reserveTransfer(-1,8,6),$gamePlayer.setTransparent(!1)},DataManager.loadGlobalInfo=function(){if(this._globalInfo)return this._globalInfo
let e
try{e=StorageManager.load(0)}catch(e){return[]}if(e){this._globalInfo=JSON.parse(e)
for(let e=1;e<=this.maxSavefiles();e++)StorageManager.exists(e)||delete this._globalInfo[e]
return this._globalInfo}return this._globalInfo=[],this._globalInfo},DataManager.saveGlobalInfo=function(e){this._globalInfo=null,StorageManager.save(0,JSON.stringify(e))},DataManager.isThisGameFile=function(e){const t=this.loadGlobalInfo()
if(t&&t[e]){if(StorageManager.isLocalMode())return!0
{const a=t[e]
return a.globalId===this._globalId&&a.title===$dataSystem.gameTitle}}return!1},DataManager.isAnySavefileExists=function(){const e=this.loadGlobalInfo()
if(e)for(let t=1;t<e.length;t++)if(this.isThisGameFile(t))return!0
return!1},DataManager.latestSavefileId=function(){const e=this.loadGlobalInfo()
let t=1,a=0
if(e)for(let n=1;n<e.length;n++)this.isThisGameFile(n)&&e[n].timestamp>a&&(a=e[n].timestamp,t=n)
return t},DataManager.loadAllSavefileImages=function(){const e=this.loadGlobalInfo()
if(e)for(let t=1;t<e.length;t++)if(this.isThisGameFile(t)){const a=e[t]
this.loadSavefileImages(a)}},DataManager.loadSavefileImages=function(e){if(e.characters)for(let t=0;t<e.characters.length;t++)ImageManager.reserveCharacter(e.characters[t][0])
if(e.faces)for(let t=0;t<e.faces.length;t++)ImageManager.reserveFace(e.faces[t][0])},DataManager.maxSavefiles=function(){return 20},DataManager.saveGame=function(e){try{return StorageManager.backup(e),this.saveGameWithoutRescue(e)}catch(t){try{StorageManager.remove(e),StorageManager.restoreBackup(e)}catch(e){}return!1}},DataManager.loadGame=function(e){try{return this.loadGameWithoutRescue(e)}catch(e){return!1}},DataManager.loadSavefileInfo=function(e){const t=this.loadGlobalInfo()
return t&&t[e]?t[e]:null},DataManager.lastAccessedSavefileId=function(){return this._lastAccessedId},DataManager.saveGameWithoutRescue=function(e){const t=JsonEx.stringify(this.makeSaveContents())
t.length,StorageManager.save(e,t),this._lastAccessedId=e
const a=this.loadGlobalInfo()||[]
return a[e]=this.makeSavefileInfo(),this.saveGlobalInfo(a),!0},DataManager.loadGameWithoutRescue=function(e){if(this.isThisGameFile(e)){const t=StorageManager.load(e)
return this.createGameObjects(),this.extractSaveContents(JsonEx.parse(t)),this._lastAccessedId=e,!0}return!1},DataManager.selectSavefileForNewGame=function(){const e=this.loadGlobalInfo()
if(this._lastAccessedId=1,e){const t=Math.max(0,e.length-1)
if(t<this.maxSavefiles())this._lastAccessedId=t+1
else{let t=Number.MAX_VALUE
for(let a=1;a<e.length;a++){if(!e[a]){this._lastAccessedId=a
break}e[a].timestamp<t&&(t=e[a].timestamp,this._lastAccessedId=a)}}}},DataManager.makeSavefileInfo=function(){const e={}
return e.globalId=this._globalId,e.title=$dataSystem.gameTitle,e.characters=$gameParty.charactersForSavefile(),e.faces=$gameParty.facesForSavefile(),e.playtime=$gameSystem.playtimeText(),e.timestamp=Date.now(),e},DataManager.makeSaveContents=function(){const e={}
return e.system=$gameSystem,e.screen=$gameScreen,e.timer=$gameTimer,e.switches=$gameSwitches,e.variables=$gameVariables,e.selfSwitches=$gameSelfSwitches,e.actors=$gameActors,e.party=$gameParty,e.map=$gameMap,e.player=$gamePlayer,e},DataManager.extractSaveContents=function(e){$gameSystem=e.system,$gameScreen=e.screen,$gameTimer=e.timer,$gameSwitches=e.switches,$gameVariables=e.variables,$gameSelfSwitches=e.selfSwitches,$gameActors=e.actors,$gameParty=e.party,$gameMap=e.map,$gamePlayer=e.player},DataManager.setAutoSaveFileId=function(e){this._autoSaveFileId=e},DataManager.isAutoSaveFileId=function(e){return 0!==this._autoSaveFileId&&this._autoSaveFileId===e},DataManager.autoSaveGame=function(){0!==this._autoSaveFileId&&!this.isEventTest()&&$gameSystem.isSaveEnabled()&&($gameSystem.onBeforeSave(),this.saveGame(this._autoSaveFileId)&&StorageManager.cleanBackup(this._autoSaveFileId))},ConfigManager.alwaysDash=!1,ConfigManager.commandRemember=!1,Object.defineProperty(ConfigManager,"bgmVolume",{get:()=>AudioManager._bgmVolume,set(e){AudioManager.bgmVolume=e},configurable:!0}),Object.defineProperty(ConfigManager,"bgsVolume",{get:()=>AudioManager.bgsVolume,set(e){AudioManager.bgsVolume=e},configurable:!0}),Object.defineProperty(ConfigManager,"meVolume",{get:()=>AudioManager.meVolume,set(e){AudioManager.meVolume=e},configurable:!0}),Object.defineProperty(ConfigManager,"seVolume",{get:()=>AudioManager.seVolume,set(e){AudioManager.seVolume=e},configurable:!0}),ConfigManager.load=function(){let e,t={}
try{e=StorageManager.load(-1)}catch(e){}e&&(t=JSON.parse(e)),this.applyData(t)},ConfigManager.save=function(){StorageManager.save(-1,JSON.stringify(this.makeData()))},ConfigManager.makeData=function(){const e={}
return e.alwaysDash=this.alwaysDash,e.commandRemember=this.commandRemember,e.bgmVolume=this.bgmVolume,e.bgsVolume=this.bgsVolume,e.meVolume=this.meVolume,e.seVolume=this.seVolume,e},ConfigManager.applyData=function(e){this.alwaysDash=this.readFlag(e,"alwaysDash"),this.commandRemember=this.readFlag(e,"commandRemember"),this.bgmVolume=this.readVolume(e,"bgmVolume"),this.bgsVolume=this.readVolume(e,"bgsVolume"),this.meVolume=this.readVolume(e,"meVolume"),this.seVolume=this.readVolume(e,"seVolume")},ConfigManager.readFlag=function(e,t){return!!e[t]},ConfigManager.readVolume=function(e,t){const a=e[t]
return void 0!==a?Number(a).clamp(0,100):100},StorageManager.save=function(e,t){this.isLocalMode()?this.saveToLocalFile(e,t):this.saveToWebStorage(e,t)},StorageManager.load=function(e){return this.isLocalMode()?this.loadFromLocalFile(e):this.loadFromWebStorage(e)},StorageManager.exists=function(e){return this.isLocalMode()?this.localFileExists(e):this.webStorageExists(e)},StorageManager.remove=function(e){this.isLocalMode()?this.removeLocalFile(e):this.removeWebStorage(e)},StorageManager.backup=function(e){if(this.exists(e))if(this.isLocalMode()){const t=this.loadFromLocalFile(e),a=LZString.compressToBase64(t),n=require("fs"),r=this.localFileDirectoryPath(),s=this.localFilePath(e)+".bak"
n.existsSync(r)||n.mkdirSync(r),n.writeFileSync(s,a)}else{const t=this.loadFromWebStorage(e),a=LZString.compressToBase64(t),n=this.webStorageKey(e)+"bak"
localStorage.setItem(n,a)}},StorageManager.backupExists=function(e){return this.isLocalMode()?this.localFileBackupExists(e):this.webStorageBackupExists(e)},StorageManager.cleanBackup=function(e){if(this.backupExists(e))if(this.isLocalMode()){const t=require("fs"),a=this.localFilePath(e)
t.unlinkSync(a+".bak")}else{const t=this.webStorageKey(e)
localStorage.removeItem(t+"bak")}},StorageManager.restoreBackup=function(e){if(this.backupExists(e))if(this.isLocalMode()){const t=this.loadFromLocalBackupFile(e),a=LZString.compressToBase64(t),n=require("fs"),r=this.localFileDirectoryPath(),s=this.localFilePath(e)
n.existsSync(r)||n.mkdirSync(r),n.writeFileSync(s,a),n.unlinkSync(s+".bak")}else{const t=this.loadFromWebStorageBackup(e),a=LZString.compressToBase64(t),n=this.webStorageKey(e)
localStorage.setItem(n,a),localStorage.removeItem(n+"bak")}},StorageManager.isLocalMode=function(){return Utils.isNwjs()},StorageManager.saveToLocalFile=function(e,t){const a=LZString.compressToBase64(t),n=require("fs"),r=this.localFileDirectoryPath(),s=this.localFilePath(e)
n.existsSync(r)||n.mkdirSync(r),n.writeFileSync(s,a)},StorageManager.loadFromLocalFile=function(e){let t=null
const a=require("fs"),n=this.localFilePath(e)
return a.existsSync(n)&&(t=a.readFileSync(n,{encoding:"utf8"})),LZString.decompressFromBase64(t)},StorageManager.loadFromLocalBackupFile=function(e){let t=null
const a=require("fs"),n=this.localFilePath(e)+".bak"
return a.existsSync(n)&&(t=a.readFileSync(n,{encoding:"utf8"})),LZString.decompressFromBase64(t)},StorageManager.localFileBackupExists=function(e){const t=void 0
return require("fs").existsSync(this.localFilePath(e)+".bak")},StorageManager.localFileExists=function(e){const t=void 0
return require("fs").existsSync(this.localFilePath(e))},StorageManager.removeLocalFile=function(e){const t=require("fs"),a=this.localFilePath(e)
t.existsSync(a)&&t.unlinkSync(a)},StorageManager.saveToWebStorage=function(e,t){const a=this.webStorageKey(e),n=LZString.compressToBase64(t)
localStorage.setItem(a,n)},StorageManager.loadFromWebStorage=function(e){const t=this.webStorageKey(e),a=localStorage.getItem(t)
return LZString.decompressFromBase64(a)},StorageManager.loadFromWebStorageBackup=function(e){const t=this.webStorageKey(e)+"bak",a=localStorage.getItem(t)
return LZString.decompressFromBase64(a)},StorageManager.webStorageBackupExists=function(e){const t=this.webStorageKey(e)+"bak"
return!!localStorage.getItem(t)},StorageManager.webStorageExists=function(e){const t=this.webStorageKey(e)
return!!localStorage.getItem(t)},StorageManager.removeWebStorage=function(e){const t=this.webStorageKey(e)
localStorage.removeItem(t)},StorageManager.localFileDirectoryPath=function(){const e=require("path"),t=e.dirname(process.mainModule.filename)
return this.canMakeWwwSaveDirectory()?e.join(t,"save/"):e.join(e.dirname(t),"save/")},StorageManager.localFilePath=function(e){let t=""
return t=e<0?"config.rpgsave":0===e?"global.rpgsave":"file%1.rpgsave".format(e),this.localFileDirectoryPath()+t},StorageManager.webStorageKey=function(e){return e<0?"RPG Config":0===e?"RPG Global":"RPG File%1".format(e)},StorageManager.canMakeWwwSaveDirectory=function(){if(void 0===this._canMakeWwwSaveDirectory){const e=require("fs"),t=require("path"),a=t.dirname(process.mainModule.filename),n=t.join(a,"testDirectory/")
try{e.mkdirSync(n),e.rmdirSync(n),this._canMakeWwwSaveDirectory=!0}catch(e){this._canMakeWwwSaveDirectory=!1}}return this._canMakeWwwSaveDirectory},ImageManager.cache=new CacheMap(ImageManager),ImageManager._imageCache=new ImageCache,ImageManager._requestQueue=new RequestQueue,ImageManager._systemReservationId=Utils.generateRuntimeId(),ImageManager._generateCacheKey=function(e,t){return e+":"+t},ImageManager.loadAnimation=function(e,t){return this.loadBitmap("img/animations/",e,t,!0)},ImageManager.loadBattleback1=function(e,t){return this.loadBitmap("img/battlebacks1/",e,t,!0)},ImageManager.loadBattleback2=function(e,t){return this.loadBitmap("img/battlebacks2/",e,t,!0)},ImageManager.loadEnemy=function(e,t){return this.loadBitmap("img/enemies/",e,t,!0)},ImageManager.loadCharacter=function(e,t){return this.loadBitmap("img/characters/",e,t,!1)},ImageManager.loadFace=function(e,t){return this.loadBitmap("img/faces/",e,t,!0)},ImageManager.loadParallax=function(e,t){return this.loadBitmap("img/parallaxes/",e,t,!0)},ImageManager.loadPicture=function(e,t){return this.loadBitmap("img/pictures/",e,t,!0)},ImageManager.loadSvActor=function(e,t){return this.loadBitmap("img/sv_actors/",e,t,!1)},ImageManager.loadSvEnemy=function(e,t){return this.loadBitmap("img/sv_enemies/",e,t,!0)},ImageManager.loadSystem=function(e,t){return this.loadBitmap("img/system/",e,t,!1)},ImageManager.loadTileset=function(e,t){return this.loadBitmap("img/tilesets/",e,t,!1)},ImageManager.loadTitle1=function(e,t){return this.loadBitmap("img/titles1/",e,t,!0)},ImageManager.loadTitle2=function(e,t){return this.loadBitmap("img/titles2/",e,t,!0)},ImageManager.loadBitmap=function(e,t,a,n){if(t){const n=e+encodeURIComponent(t)+".png",r=this.loadNormalBitmap(n,a||0)
return r.smooth=!1,r}return this.loadEmptyBitmap()},ImageManager.loadEmptyBitmap=function(){let e=this._imageCache.get("empty")
return e||(e=new Bitmap,this._imageCache.add("empty",e),this._imageCache.reserve("empty",e,this._systemReservationId)),e},ImageManager.loadNormalBitmap=function(e,t){const a=this._generateCacheKey(e,t)
let n=this._imageCache.get(a)
return n?n.isReady()||n.decode():(n=Bitmap.load(e),this._callCreationHook(n),n.addLoadListener((function(){n.rotateHue(t)})),this._imageCache.add(a,n)),n},ImageManager.clear=function(){this._imageCache=new ImageCache},ImageManager.isReady=function(){return this._imageCache.isReady()},ImageManager.isObjectCharacter=function(e){const t=e.match(/^[\!\$]+/)
return t&&t[0].contains("!")},ImageManager.isBigCharacter=function(e){const t=e.match(/^[\!\$]+/)
return t&&t[0].contains("$")},ImageManager.isZeroParallax=function(e){return"!"===e.charAt(0)},ImageManager.reserveAnimation=function(e,t,a){return this.reserveBitmap("img/animations/",e,t,!0,a)},ImageManager.reserveBattleback1=function(e,t,a){return this.reserveBitmap("img/battlebacks1/",e,t,!0,a)},ImageManager.reserveBattleback2=function(e,t,a){return this.reserveBitmap("img/battlebacks2/",e,t,!0,a)},ImageManager.reserveEnemy=function(e,t,a){return this.reserveBitmap("img/enemies/",e,t,!0,a)},ImageManager.reserveCharacter=function(e,t,a){return this.reserveBitmap("img/characters/",e,t,!1,a)},ImageManager.reserveFace=function(e,t,a){return this.reserveBitmap("img/faces/",e,t,!0,a)},ImageManager.reserveParallax=function(e,t,a){return this.reserveBitmap("img/parallaxes/",e,t,!0,a)},ImageManager.reservePicture=function(e,t,a){return this.reserveBitmap("img/pictures/",e,t,!0,a)},ImageManager.reserveSvActor=function(e,t,a){return this.reserveBitmap("img/sv_actors/",e,t,!1,a)},ImageManager.reserveSvEnemy=function(e,t,a){return this.reserveBitmap("img/sv_enemies/",e,t,!0,a)},ImageManager.reserveSystem=function(e,t,a){return this.reserveBitmap("img/system/",e,t,!1,a||this._systemReservationId)},ImageManager.reserveTileset=function(e,t,a){return this.reserveBitmap("img/tilesets/",e,t,!1,a)},ImageManager.reserveTitle1=function(e,t,a){return this.reserveBitmap("img/titles1/",e,t,!0,a)},ImageManager.reserveTitle2=function(e,t,a){return this.reserveBitmap("img/titles2/",e,t,!0,a)},ImageManager.reserveBitmap=function(e,t,a,n,r){if(t){const n=e+encodeURIComponent(t)+".png",s=this.reserveNormalBitmap(n,a||0,r||this._defaultReservationId)
return s.smooth=!1,s}return this.loadEmptyBitmap()},ImageManager.reserveNormalBitmap=function(e,t,a){const n=this.loadNormalBitmap(e,t)
return this._imageCache.reserve(this._generateCacheKey(e,t),n,a),n},ImageManager.releaseReservation=function(e){this._imageCache.releaseReservation(e)},ImageManager.setDefaultReservationId=function(e){this._defaultReservationId=e},ImageManager.requestAnimation=function(e,t){return this.requestBitmap("img/animations/",e,t,!0)},ImageManager.requestBattleback1=function(e,t){return this.requestBitmap("img/battlebacks1/",e,t,!0)},ImageManager.requestBattleback2=function(e,t){return this.requestBitmap("img/battlebacks2/",e,t,!0)},ImageManager.requestEnemy=function(e,t){return this.requestBitmap("img/enemies/",e,t,!0)},ImageManager.requestCharacter=function(e,t){return this.requestBitmap("img/characters/",e,t,!1)},ImageManager.requestFace=function(e,t){return this.requestBitmap("img/faces/",e,t,!0)},ImageManager.requestParallax=function(e,t){return this.requestBitmap("img/parallaxes/",e,t,!0)},ImageManager.requestPicture=function(e,t){return this.requestBitmap("img/pictures/",e,t,!0)},ImageManager.requestSvActor=function(e,t){return this.requestBitmap("img/sv_actors/",e,t,!1)},ImageManager.requestSvEnemy=function(e,t){return this.requestBitmap("img/sv_enemies/",e,t,!0)},ImageManager.requestSystem=function(e,t){return this.requestBitmap("img/system/",e,t,!1)},ImageManager.requestTileset=function(e,t){return this.requestBitmap("img/tilesets/",e,t,!1)},ImageManager.requestTitle1=function(e,t){return this.requestBitmap("img/titles1/",e,t,!0)},ImageManager.requestTitle2=function(e,t){return this.requestBitmap("img/titles2/",e,t,!0)},ImageManager.requestBitmap=function(e,t,a,n){if(t){const n=e+encodeURIComponent(t)+".png",r=this.requestNormalBitmap(n,a||0)
return r.smooth=!1,r}return this.loadEmptyBitmap()},ImageManager.requestNormalBitmap=function(e,t){const a=this._generateCacheKey(e,t)
let n=this._imageCache.get(a)
return n?this._requestQueue.raisePriority(a):(n=Bitmap.request(e),this._callCreationHook(n),n.addLoadListener((function(){n.rotateHue(t)})),this._imageCache.add(a,n),this._requestQueue.enqueue(a,n)),n},ImageManager.update=function(){this._requestQueue.update()},ImageManager.clearRequest=function(){this._requestQueue.clear()},ImageManager.setCreationHook=function(e){this._creationHook=e},ImageManager._callCreationHook=function(e){this._creationHook&&this._creationHook(e)},AudioManager._masterVolume=1,AudioManager._bgmVolume=100,AudioManager._bgsVolume=100,AudioManager._meVolume=100,AudioManager._seVolume=100,AudioManager._currentBgm=null,AudioManager._currentBgs=null,AudioManager._bgmBuffer=null,AudioManager._bgsBuffer=null,AudioManager._meBuffer=null,AudioManager._seBuffers=[],AudioManager._staticBuffers=[],AudioManager._replayFadeTime=.5,AudioManager._path="audio/",AudioManager._blobUrl=null,Object.defineProperty(AudioManager,"masterVolume",{get(){return this._masterVolume},set(e){this._masterVolume=e,WebAudio.setMasterVolume(this._masterVolume),Graphics.setVideoVolume(this._masterVolume)},configurable:!0}),Object.defineProperty(AudioManager,"bgmVolume",{get(){return this._bgmVolume},set(e){this._bgmVolume=e,this.updateBgmParameters(this._currentBgm)},configurable:!0}),Object.defineProperty(AudioManager,"bgsVolume",{get(){return this._bgsVolume},set(e){this._bgsVolume=e,this.updateBgsParameters(this._currentBgs)},configurable:!0}),Object.defineProperty(AudioManager,"meVolume",{get(){return this._meVolume},set(e){this._meVolume=e,this.updateMeParameters(this._currentMe)},configurable:!0}),Object.defineProperty(AudioManager,"seVolume",{get(){return this._seVolume},set(e){this._seVolume=e},configurable:!0}),AudioManager.playBgm=function(e,t){this.isCurrentBgm(e)?this.updateBgmParameters(e):(this.stopBgm(),e.name&&(this._bgmBuffer=this.createBuffer("bgm",e.name),this.updateBgmParameters(e),this._meBuffer||this._bgmBuffer.play(!0,t||0))),this.updateCurrentBgm(e,t)},AudioManager.playEncryptedBgm=function(e,t){const a=this.audioFileExt()
let n=this._path+"bgm/"+encodeURIComponent(e.name)+a
n=Decrypter.extToEncryptExt(n)},AudioManager.createDecryptBuffer=function(e,t,a){this._blobUrl=e,this._bgmBuffer=this.createBuffer("bgm",t.name),this.updateBgmParameters(t),this._meBuffer||this._bgmBuffer.play(!0,a||0),this.updateCurrentBgm(t,a)},AudioManager.replayBgm=function(e){this.isCurrentBgm(e)?this.updateBgmParameters(e):(this.playBgm(e,e.pos),this._bgmBuffer&&this._bgmBuffer.fadeIn(this._replayFadeTime))},AudioManager.isCurrentBgm=function(e){return this._currentBgm&&this._bgmBuffer&&this._currentBgm.name===e.name},AudioManager.updateBgmParameters=function(e){this.updateBufferParameters(this._bgmBuffer,this._bgmVolume,e)},AudioManager.updateCurrentBgm=function(e,t){this._currentBgm={name:e.name,volume:e.volume,pitch:e.pitch,pan:e.pan,pos:t}},AudioManager.stopBgm=function(){this._bgmBuffer&&(this._bgmBuffer.stop(),this._bgmBuffer=null,this._currentBgm=null)},AudioManager.fadeOutBgm=function(e){this._bgmBuffer&&this._currentBgm&&(this._bgmBuffer.fadeOut(e),this._currentBgm=null)},AudioManager.fadeInBgm=function(e){this._bgmBuffer&&this._currentBgm&&this._bgmBuffer.fadeIn(e)},AudioManager.playBgs=function(e,t){this.isCurrentBgs(e)?this.updateBgsParameters(e):(this.stopBgs(),e.name&&(this._bgsBuffer=this.createBuffer("bgs",e.name),this.updateBgsParameters(e),this._bgsBuffer.play(!0,t||0))),this.updateCurrentBgs(e,t)},AudioManager.replayBgs=function(e){this.isCurrentBgs(e)?this.updateBgsParameters(e):(this.playBgs(e,e.pos),this._bgsBuffer&&this._bgsBuffer.fadeIn(this._replayFadeTime))},AudioManager.isCurrentBgs=function(e){return this._currentBgs&&this._bgsBuffer&&this._currentBgs.name===e.name},AudioManager.updateBgsParameters=function(e){this.updateBufferParameters(this._bgsBuffer,this._bgsVolume,e)},AudioManager.updateCurrentBgs=function(e,t){this._currentBgs={name:e.name,volume:e.volume,pitch:e.pitch,pan:e.pan,pos:t}},AudioManager.stopBgs=function(){this._bgsBuffer&&(this._bgsBuffer.stop(),this._bgsBuffer=null,this._currentBgs=null)},AudioManager.fadeOutBgs=function(e){this._bgsBuffer&&this._currentBgs&&(this._bgsBuffer.fadeOut(e),this._currentBgs=null)},AudioManager.fadeInBgs=function(e){this._bgsBuffer&&this._currentBgs&&this._bgsBuffer.fadeIn(e)},AudioManager.playMe=function(e){this.stopMe(),e.name&&(this._bgmBuffer&&this._currentBgm&&(this._currentBgm.pos=this._bgmBuffer.seek(),this._bgmBuffer.stop()),this._meBuffer=this.createBuffer("me",e.name),this.updateMeParameters(e),this._meBuffer.play(!1),this._meBuffer.addStopListener(this.stopMe.bind(this)))},AudioManager.updateMeParameters=function(e){this.updateBufferParameters(this._meBuffer,this._meVolume,e)},AudioManager.fadeOutMe=function(e){this._meBuffer&&this._meBuffer.fadeOut(e)},AudioManager.stopMe=function(){this._meBuffer&&(this._meBuffer.stop(),this._meBuffer=null,this._bgmBuffer&&this._currentBgm&&!this._bgmBuffer.isPlaying()&&(this._bgmBuffer.play(!0,this._currentBgm.pos),this._bgmBuffer.fadeIn(this._replayFadeTime)))},AudioManager.playSe=function(e){if(e.name){this._seBuffers=this._seBuffers.filter((function(e){return e.isPlaying()}))
const t=this.createBuffer("se",e.name)
this.updateSeParameters(t,e),t.play(!1),this._seBuffers.push(t)}},AudioManager.updateSeParameters=function(e,t){this.updateBufferParameters(e,this._seVolume,t)},AudioManager.stopSe=function(){this._seBuffers.forEach((function(e){e.stop()})),this._seBuffers=[]},AudioManager.playStaticSe=function(e){if(e.name){this.loadStaticSe(e)
for(let t=0;t<this._staticBuffers.length;t++){const a=this._staticBuffers[t]
if(a._reservedSeName===e.name){a.stop(),this.updateSeParameters(a,e),a.play(!1)
break}}}},AudioManager.loadStaticSe=function(e){if(e.name&&!this.isStaticSe(e)){const t=this.createBuffer("se",e.name)
t._reservedSeName=e.name,this._staticBuffers.push(t)}},AudioManager.isStaticSe=function(e){for(let t=0;t<this._staticBuffers.length;t++){const a=void 0
if(this._staticBuffers[t]._reservedSeName===e.name)return!0}return!1},AudioManager.stopAll=function(){this.stopMe(),this.stopBgm(),this.stopBgs(),this.stopSe()},AudioManager.saveBgm=function(){if(this._currentBgm){const e=this._currentBgm
return{name:e.name,volume:e.volume,pitch:e.pitch,pan:e.pan,pos:this._bgmBuffer?this._bgmBuffer.seek():0}}return this.makeEmptyAudioObject()},AudioManager.saveBgs=function(){if(this._currentBgs){const e=this._currentBgs
return{name:e.name,volume:e.volume,pitch:e.pitch,pan:e.pan,pos:this._bgsBuffer?this._bgsBuffer.seek():0}}return this.makeEmptyAudioObject()},AudioManager.makeEmptyAudioObject=function(){return{name:"",volume:0,pitch:0}},AudioManager.createBuffer=function(e,t){const a=this.audioFileExt(),n=this._path+e+"/"+encodeURIComponent(t)+a,r=new WebAudio(n)
return this._callCreationHook(r),r},AudioManager.updateBufferParameters=function(e,t,a){e&&a&&(e.volume=t*(a.volume||0)/1e4,e.pitch=(a.pitch||0)/100,e.pan=(a.pan||0)/100)},AudioManager.audioFileExt=function(){return WebAudio.canPlayOgg()&&!Utils.isMobileDevice()?".ogg":".m4a"},AudioManager.shouldUseHtml5Audio=function(){return!1},AudioManager.checkErrors=function(){this.checkWebAudioError(this._bgmBuffer),this.checkWebAudioError(this._bgsBuffer),this.checkWebAudioError(this._meBuffer),this._seBuffers.forEach(function(e){this.checkWebAudioError(e)}.bind(this)),this._staticBuffers.forEach(function(e){this.checkWebAudioError(e)}.bind(this))},AudioManager.checkWebAudioError=function(e){if(e&&e.isError())throw new Error("Failed to load: "+e.url)},AudioManager.setCreationHook=function(e){this._creationHook=e},AudioManager._callCreationHook=function(e){this._creationHook&&this._creationHook(e)},SoundManager.preloadImportantSounds=function(){this.loadSystemSound(0),this.loadSystemSound(1),this.loadSystemSound(2),this.loadSystemSound(3)},SoundManager.loadSystemSound=function(e){$dataSystem&&AudioManager.loadStaticSe($dataSystem.sounds[e])},SoundManager.playSystemSound=function(e){$dataSystem&&AudioManager.playStaticSe($dataSystem.sounds[e])},SoundManager.playCursor=function(){this.playSystemSound(0)},SoundManager.playOk=function(){this.playSystemSound(1)},SoundManager.playCancel=function(){this.playSystemSound(2)},SoundManager.playBuzzer=function(){this.playSystemSound(3)},SoundManager.playEquip=function(){this.playSystemSound(4)},SoundManager.playSave=function(){this.playSystemSound(5)},SoundManager.playLoad=function(){this.playSystemSound(6)},SoundManager.playBattleStart=function(){this.playSystemSound(7)},SoundManager.playEscape=function(){this.playSystemSound(8)},SoundManager.playEnemyAttack=function(){this.playSystemSound(9)},SoundManager.playEnemyDamage=function(){this.playSystemSound(10)},SoundManager.playEnemyCollapse=function(){this.playSystemSound(11)},SoundManager.playBossCollapse1=function(){this.playSystemSound(12)},SoundManager.playBossCollapse2=function(){this.playSystemSound(13)},SoundManager.playActorDamage=function(){this.playSystemSound(14)},SoundManager.playActorCollapse=function(){this.playSystemSound(15)},SoundManager.playRecovery=function(){this.playSystemSound(16)},SoundManager.playMiss=function(){this.playSystemSound(17)},SoundManager.playEvasion=function(){this.playSystemSound(18)},SoundManager.playMagicEvasion=function(){this.playSystemSound(19)},SoundManager.playReflection=function(){this.playSystemSound(20)},SoundManager.playShop=function(){this.playSystemSound(21)},SoundManager.playUseItem=function(){this.playSystemSound(22)},SoundManager.playUseSkill=function(){this.playSystemSound(23)},TextManager.basic=function(e){return $dataSystem.terms.basic[e]||""},TextManager.param=function(e){return $dataSystem.terms.params[e]||""},TextManager.command=function(e){return $dataSystem.terms.commands[e]||""},TextManager.message=function(e){return $dataSystem.terms.messages[e]||""},TextManager.getter=function(e,t){return{get(){return this[e](t)},configurable:!0}},Object.defineProperty(TextManager,"currencyUnit",{get:()=>$dataSystem.currencyUnit,configurable:!0}),Object.defineProperties(TextManager,{level:TextManager.getter("basic",0),levelA:TextManager.getter("basic",1),hp:TextManager.getter("basic",2),hpA:TextManager.getter("basic",3),mp:TextManager.getter("basic",4),mpA:TextManager.getter("basic",5),tp:TextManager.getter("basic",6),tpA:TextManager.getter("basic",7),exp:TextManager.getter("basic",8),expA:TextManager.getter("basic",9),fight:TextManager.getter("command",0),escape:TextManager.getter("command",1),attack:TextManager.getter("command",2),guard:TextManager.getter("command",3),item:TextManager.getter("command",4),skill:TextManager.getter("command",5),equip:TextManager.getter("command",6),status:TextManager.getter("command",7),formation:TextManager.getter("command",8),save:TextManager.getter("command",9),gameEnd:TextManager.getter("command",10),options:TextManager.getter("command",11),weapon:TextManager.getter("command",12),armor:TextManager.getter("command",13),keyItem:TextManager.getter("command",14),equip2:TextManager.getter("command",15),optimize:TextManager.getter("command",16),clear:TextManager.getter("command",17),newGame:TextManager.getter("command",18),continue_:TextManager.getter("command",19),toTitle:TextManager.getter("command",21),cancel:TextManager.getter("command",22),buy:TextManager.getter("command",24),sell:TextManager.getter("command",25),alwaysDash:TextManager.getter("message","alwaysDash"),commandRemember:TextManager.getter("message","commandRemember"),bgmVolume:TextManager.getter("message","bgmVolume"),bgsVolume:TextManager.getter("message","bgsVolume"),meVolume:TextManager.getter("message","meVolume"),seVolume:TextManager.getter("message","seVolume"),possession:TextManager.getter("message","possession"),expTotal:TextManager.getter("message","expTotal"),expNext:TextManager.getter("message","expNext"),saveMessage:TextManager.getter("message","saveMessage"),loadMessage:TextManager.getter("message","loadMessage"),file:TextManager.getter("message","file"),partyName:TextManager.getter("message","partyName"),emerge:TextManager.getter("message","emerge"),preemptive:TextManager.getter("message","preemptive"),surprise:TextManager.getter("message","surprise"),escapeStart:TextManager.getter("message","escapeStart"),escapeFailure:TextManager.getter("message","escapeFailure"),victory:TextManager.getter("message","victory"),defeat:TextManager.getter("message","defeat"),obtainExp:TextManager.getter("message","obtainExp"),obtainGold:TextManager.getter("message","obtainGold"),obtainItem:TextManager.getter("message","obtainItem"),levelUp:TextManager.getter("message","levelUp"),obtainSkill:TextManager.getter("message","obtainSkill"),useItem:TextManager.getter("message","useItem"),criticalToEnemy:TextManager.getter("message","criticalToEnemy"),criticalToActor:TextManager.getter("message","criticalToActor"),actorDamage:TextManager.getter("message","actorDamage"),actorRecovery:TextManager.getter("message","actorRecovery"),actorGain:TextManager.getter("message","actorGain"),actorLoss:TextManager.getter("message","actorLoss"),actorDrain:TextManager.getter("message","actorDrain"),actorNoDamage:TextManager.getter("message","actorNoDamage"),actorNoHit:TextManager.getter("message","actorNoHit"),enemyDamage:TextManager.getter("message","enemyDamage"),enemyRecovery:TextManager.getter("message","enemyRecovery"),enemyGain:TextManager.getter("message","enemyGain"),enemyLoss:TextManager.getter("message","enemyLoss"),enemyDrain:TextManager.getter("message","enemyDrain"),enemyNoDamage:TextManager.getter("message","enemyNoDamage"),enemyNoHit:TextManager.getter("message","enemyNoHit"),evasion:TextManager.getter("message","evasion"),magicEvasion:TextManager.getter("message","magicEvasion"),magicReflection:TextManager.getter("message","magicReflection"),counterAttack:TextManager.getter("message","counterAttack"),substitute:TextManager.getter("message","substitute"),buffAdd:TextManager.getter("message","buffAdd"),debuffAdd:TextManager.getter("message","debuffAdd"),buffRemove:TextManager.getter("message","buffRemove"),actionFailure:TextManager.getter("message","actionFailure")}),SceneManager._getTimeInMsWithoutMobileSafari=function(){return performance.now()},SceneManager._scene=null,SceneManager._nextScene=null,SceneManager._stack=[],SceneManager._stopped=!1,SceneManager._sceneStarted=!1,SceneManager._exiting=!1,SceneManager._previousClass=null,SceneManager._backgroundBitmap=null,SceneManager._screenWidth=816,SceneManager._screenHeight=624,SceneManager._boxWidth=816,SceneManager._boxHeight=624,SceneManager._deltaTime=1/60,Utils.isMobileSafari()||(SceneManager._currentTime=SceneManager._getTimeInMsWithoutMobileSafari()),SceneManager._accumulator=0,SceneManager._frameCount=0,SceneManager.run=function(e){try{this.initialize(),this.goto(e),this.requestUpdate()}catch(e){this.catchException(e)}},SceneManager.initialize=function(){this.initProgressWatcher(),this.initGraphics(),this.checkFileAccess(),this.initAudio(),this.initInput(),this.initNwjs(),this.checkPluginErrors(),this.setupErrorHandlers()},SceneManager.initProgressWatcher=function(){ProgressWatcher.initialize()},SceneManager.initGraphics=function(){const e=this.preferableRendererType()
Graphics.initialize(this._screenWidth,this._screenHeight,e),Graphics.boxWidth=this._boxWidth,Graphics.boxHeight=this._boxHeight,Graphics.setLoadingImage("img/system/Loading.png"),Utils.isOptionValid("showfps")&&Graphics.showFps(),"webgl"===e&&this.checkWebGL()},SceneManager.preferableRendererType=function(){return Utils.isOptionValid("canvas")?"canvas":Utils.isOptionValid("webgl")?"webgl":"auto"},SceneManager.shouldUseCanvasRenderer=function(){return Utils.isMobileDevice()},SceneManager.checkWebGL=function(){if(!Graphics.hasWebGL())throw new Error("Your browser does not support WebGL.")},SceneManager.checkFileAccess=function(){if(!Utils.canReadGameFiles())throw new Error("Your browser does not allow to read local files.")},SceneManager.initAudio=function(){const e=Utils.isOptionValid("noaudio")
if(!WebAudio.initialize(e)&&!e)throw new Error("Your browser does not support Web Audio API.")},SceneManager.initInput=function(){Input.initialize(),TouchInput.initialize()},SceneManager.initNwjs=function(){if(Utils.isNwjs()){const e=require("nw.gui"),t=e.Window.get()
if("darwin"===process.platform&&!t.menu){const a=new e.Menu({type:"menubar"}),n={hideEdit:!0,hideWindow:!0}
a.createMacBuiltin("Game",n),t.menu=a}}},SceneManager.checkPluginErrors=function(){PluginManager.checkErrors()},SceneManager.setupErrorHandlers=function(){window.addEventListener("error",this.onError.bind(this)),document.addEventListener("keydown",this.onKeyDown.bind(this))},SceneManager.frameCount=function(){return this._frameCount},SceneManager.setFrameCount=function(e){this._frameCount=e},SceneManager.resetFrameCount=function(){this._frameCount=0},SceneManager.requestUpdate=function(){this._stopped||requestAnimationFrame(this.update.bind(this))},SceneManager.update=function(){try{this.tickStart(),Utils.isMobileSafari()&&this.updateInputData(),this.updateManagers(),this.updateMain(),this.tickEnd()}catch(e){this.catchException(e)}},SceneManager.terminate=function(){window.close()},SceneManager.onError=function(e){if(e.filename||e.lineno)try{this.stop(),Graphics.printError("Error",e.message),AudioManager.stopAll()}catch(e){}},SceneManager.onKeyDown=function(e){if(!e.ctrlKey&&!e.altKey)switch(e.keyCode){case 116:Utils.isNwjs()&&location.reload()
break
case 119:Utils.isNwjs()&&Utils.isOptionValid("test")&&require("nw.gui").Window.get().showDevTools()}},SceneManager.catchException=function(e){e instanceof Error?(Graphics.printError(e.name,e.message),Graphics.printErrorDetail(e)):Graphics.printError("UnknownError",e),AudioManager.stopAll(),this.stop()},SceneManager.tickStart=function(){Graphics.tickStart()},SceneManager.tickEnd=function(){Graphics.tickEnd()},SceneManager.updateInputData=function(){Input.update(),TouchInput.update()},SceneManager.updateMain=function(){if(Utils.isHighFps()){if(Utils.isMobileSafari())this.changeScene(),this.updateScene()
else{const e=this._getTimeInMsWithoutMobileSafari()
void 0===this._currentTime&&(this._currentTime=e)
let t=(e-this._currentTime)/1e3
for(t>.25&&(t=.25),this._currentTime=e,this._accumulator+=t;this._accumulator>=this._deltaTime;)this.updateInputData(),this.changeScene(),this.updateScene(),this._accumulator-=this._deltaTime}this.renderScene(),this.requestUpdate()}else this.updateInputData(),this.changeScene(),this.updateScene(),this.renderScene(),this.requestUpdate()},SceneManager.updateManagers=function(){ImageManager.update()},SceneManager.changeScene=function(){this.isSceneChanging()&&!this.isCurrentSceneBusy()&&(this._scene&&(this._scene.terminate(),this._scene.detachReservation(),this._previousClass=this._scene.constructor),this._scene=this._nextScene,this._scene&&(this._scene.attachReservation(),this._scene.create(),this._nextScene=null,this._sceneStarted=!1,this.onSceneCreate()),this._exiting&&this.terminate())},SceneManager.updateScene=function(){this._scene&&(!this._sceneStarted&&this._scene.isReady()&&(this._scene.start(),this._sceneStarted=!0,this.onSceneStart()),this.isCurrentSceneStarted()&&(this.updateFrameCount(),this._scene.update()))},SceneManager.renderScene=function(){this.isCurrentSceneStarted()?Graphics.render(this._scene):this._scene&&this.onSceneLoading()},SceneManager.updateFrameCount=function(){this._frameCount++},SceneManager.onSceneCreate=function(){Graphics.startLoading()},SceneManager.onSceneStart=function(){Graphics.callGC(),Graphics.endLoading()},SceneManager.onSceneLoading=function(){Graphics.updateLoading()},SceneManager.isSceneChanging=function(){return this._exiting||!!this._nextScene},SceneManager.isCurrentSceneBusy=function(){return this._scene&&this._scene.isBusy()},SceneManager.isCurrentSceneStarted=function(){return this._scene&&this._sceneStarted},SceneManager.isNextScene=function(e){return this._nextScene&&this._nextScene.constructor===e},SceneManager.isPreviousScene=function(e){return this._previousClass===e},SceneManager.goto=function(e){e&&(this._nextScene=new e),this._scene&&this._scene.stop()},SceneManager.push=function(e){this._stack.push(this._scene.constructor),this.goto(e)},SceneManager.pop=function(){this._stack.length>0?this.goto(this._stack.pop()):this.exit()},SceneManager.exit=function(){this.goto(null),this._exiting=!0},SceneManager.clearStack=function(){this._stack=[]},SceneManager.stop=function(){this._stopped=!0},SceneManager.prepareNextScene=function(){this._nextScene.prepare.apply(this._nextScene,arguments)},SceneManager.snap=function(){return Bitmap.snap(this._scene)},SceneManager.snapForBackground=function(){this._backgroundBitmap=this.snap(),this._backgroundBitmap.blur()},SceneManager.backgroundBitmap=function(){return this._backgroundBitmap},SceneManager.resume=function(){this._stopped=!1,this.requestUpdate(),Utils.isMobileSafari()||(this._currentTime=this._getTimeInMsWithoutMobileSafari(),this._accumulator=0)},BattleManager.setup=function(e,t,a){this.initMembers(),this._canEscape=t,this._canLose=a,$gameTroop.setup(e),$gameScreen.onBattleStart(),this.makeEscapeRatio()},BattleManager.initMembers=function(){this._phase="init",this._canEscape=!1,this._canLose=!1,this._battleTest=!1,this._eventCallback=null,this._preemptive=!1,this._surprise=!1,this._actorIndex=-1,this._actionForcedBattler=null,this._mapBgm=null,this._mapBgs=null,this._actionBattlers=[],this._subject=null,this._action=null,this._targets=[],this._logWindow=null,this._statusWindow=null,this._spriteset=null,this._escapeRatio=0,this._escaped=!1,this._rewards={},this._turnForced=!1},BattleManager.isBattleTest=function(){return this._battleTest},BattleManager.setBattleTest=function(e){this._battleTest=e},BattleManager.setEventCallback=function(e){this._eventCallback=e},BattleManager.setLogWindow=function(e){this._logWindow=e},BattleManager.setStatusWindow=function(e){this._statusWindow=e},BattleManager.setSpriteset=function(e){this._spriteset=e},BattleManager.onEncounter=function(){this._preemptive=Math.random()<this.ratePreemptive(),this._surprise=Math.random()<this.rateSurprise()&&!this._preemptive},BattleManager.ratePreemptive=function(){return $gameParty.ratePreemptive($gameTroop.agility())},BattleManager.rateSurprise=function(){return $gameParty.rateSurprise($gameTroop.agility())},BattleManager.saveBgmAndBgs=function(){this._mapBgm=AudioManager.saveBgm(),this._mapBgs=AudioManager.saveBgs()},BattleManager.playBattleBgm=function(){AudioManager.playBgm($gameSystem.battleBgm()),AudioManager.stopBgs()},BattleManager.playVictoryMe=function(){AudioManager.playMe($gameSystem.victoryMe())},BattleManager.playDefeatMe=function(){AudioManager.playMe($gameSystem.defeatMe())},BattleManager.replayBgmAndBgs=function(){this._mapBgm?AudioManager.replayBgm(this._mapBgm):AudioManager.stopBgm(),this._mapBgs&&AudioManager.replayBgs(this._mapBgs)},BattleManager.makeEscapeRatio=function(){this._escapeRatio=.5*$gameParty.agility()/$gameTroop.agility()},BattleManager.update=function(){if(!this.isBusy()&&!this.updateEvent())switch(this._phase){case"start":this.startInput()
break
case"turn":this.updateTurn()
break
case"action":this.updateAction()
break
case"turnEnd":this.updateTurnEnd()
break
case"battleEnd":this.updateBattleEnd()}},BattleManager.updateEvent=function(){switch(this._phase){case"start":case"turn":case"turnEnd":return this.isActionForced()?(this.processForcedAction(),!0):this.updateEventMain()}return this.checkAbort()},BattleManager.updateEventMain=function(){return $gameTroop.updateInterpreter(),$gameParty.requestMotionRefresh(),!!($gameTroop.isEventRunning()||this.checkBattleEnd()||($gameTroop.setupBattleEvent(),$gameTroop.isEventRunning()||SceneManager.isSceneChanging()))},BattleManager.isBusy=function(){return $gameMessage.isBusy()||this._spriteset.isBusy()||this._logWindow.isBusy()},BattleManager.isInputting=function(){return"input"===this._phase},BattleManager.isInTurn=function(){return"turn"===this._phase},BattleManager.isTurnEnd=function(){return"turnEnd"===this._phase},BattleManager.isAborting=function(){return"aborting"===this._phase},BattleManager.isBattleEnd=function(){return"battleEnd"===this._phase},BattleManager.canEscape=function(){return this._canEscape},BattleManager.canLose=function(){return this._canLose},BattleManager.isEscaped=function(){return this._escaped},BattleManager.actor=function(){return this._actorIndex>=0?$gameParty.members()[this._actorIndex]:null},BattleManager.clearActor=function(){this.changeActor(-1,"")},BattleManager.changeActor=function(e,t){const a=this.actor()
this._actorIndex=e
const n=this.actor()
a&&a.setActionState(t),n&&n.setActionState("inputting")},BattleManager.startBattle=function(){this._phase="start",$gameSystem.onBattleStart(),$gameParty.onBattleStart(),$gameTroop.onBattleStart(),this.displayStartMessages()},BattleManager.displayStartMessages=function(){$gameTroop.enemyNames().forEach((function(e){$gameMessage.add(TextManager.emerge.format(e))})),this._preemptive?$gameMessage.add(TextManager.preemptive.format($gameParty.name())):this._surprise&&$gameMessage.add(TextManager.surprise.format($gameParty.name()))},BattleManager.startInput=function(){this._phase="input",$gameParty.makeActions(),$gameTroop.makeActions(),this.clearActor(),!this._surprise&&$gameParty.canInput()||this.startTurn()},BattleManager.inputtingAction=function(){const e=this.actor()
return e?e.inputtingAction():null},BattleManager.selectNextCommand=function(){do{const e=this.actor()
if((!e||!e.selectNextCommand())&&(this.changeActor(this._actorIndex+1,"waiting"),this._actorIndex>=$gameParty.size())){this.startTurn()
break}}while(!this.actor().canInput())},BattleManager.selectPreviousCommand=function(){do{const e=this.actor()
if((!e||!e.selectPreviousCommand())&&(this.changeActor(this._actorIndex-1,"undecided"),this._actorIndex<0))return}while(!this.actor().canInput())},BattleManager.refreshStatus=function(){this._statusWindow.refresh()},BattleManager.startTurn=function(){this._phase="turn",this.clearActor(),$gameTroop.increaseTurn(),this.makeActionOrders(),$gameParty.requestMotionRefresh(),this._logWindow.startTurn()},BattleManager.updateTurn=function(){$gameParty.requestMotionRefresh(),this._subject||(this._subject=this.getNextSubject()),this._subject?this.processTurn():this.endTurn()},BattleManager.processTurn=function(){const e=this._subject,t=e.currentAction()
t?(t.prepare(),t.isValid()&&this.startAction(),e.removeCurrentAction()):(e.onAllActionsEnd(),this.refreshStatus(),this._logWindow.displayAutoAffectedStatus(e),this._logWindow.displayCurrentState(e),this._logWindow.displayRegeneration(e),this._subject=this.getNextSubject())},BattleManager.endTurn=function(){this._phase="turnEnd",this._preemptive=!1,this._surprise=!1,this.allBattleMembers().forEach((function(e){e.onTurnEnd(),this.refreshStatus(),this._logWindow.displayAutoAffectedStatus(e),this._logWindow.displayRegeneration(e)}),this),this.isForcedTurn()&&(this._turnForced=!1)},BattleManager.isForcedTurn=function(){return this._turnForced},BattleManager.updateTurnEnd=function(){this.startInput()},BattleManager.getNextSubject=function(){for(;;){const e=this._actionBattlers.shift()
if(!e)return null
if(e.isBattleMember()&&e.isAlive())return e}},BattleManager.allBattleMembers=function(){return $gameParty.members().concat($gameTroop.members())},BattleManager.makeActionOrders=function(){let e=[]
this._surprise||(e=e.concat($gameParty.members())),this._preemptive||(e=e.concat($gameTroop.members())),e.forEach((function(e){e.makeSpeed()})),e.sort((function(e,t){return t.speed()-e.speed()})),this._actionBattlers=e},BattleManager.startAction=function(){const e=this._subject,t=e.currentAction(),a=t.makeTargets()
this._phase="action",this._action=t,this._targets=a,e.useItem(t.item()),this._action.applyGlobal(),this.refreshStatus(),this._logWindow.startAction(e,t,a)},BattleManager.updateAction=function(){const e=this._targets.shift()
e?this.invokeAction(this._subject,e):this.endAction()},BattleManager.endAction=function(){this._logWindow.endAction(this._subject),this._phase="turn"},BattleManager.invokeAction=function(e,t){this._logWindow.push("pushBaseLine"),Math.random()<this._action.itemCnt(t)?this.invokeCounterAttack(e,t):Math.random()<this._action.itemMrf(t)?this.invokeMagicReflection(e,t):this.invokeNormalAction(e,t),e.setLastTarget(t),this._logWindow.push("popBaseLine"),this.refreshStatus()},BattleManager.invokeNormalAction=function(e,t){const a=this.applySubstitute(t)
this._action.apply(a),this._logWindow.displayActionResults(e,a)},BattleManager.invokeCounterAttack=function(e,t){const a=new Game_Action(t)
a.setAttack(),a.apply(e),this._logWindow.displayCounter(t),this._logWindow.displayActionResults(t,e)},BattleManager.invokeMagicReflection=function(e,t){this._action._reflectionTarget=t,this._logWindow.displayReflection(t),this._action.apply(e),this._logWindow.displayActionResults(t,e)},BattleManager.applySubstitute=function(e){if(this.checkSubstitute(e)){const t=e.friendsUnit().substituteBattler()
if(t&&e!==t)return this._logWindow.displaySubstitute(t,e),t}return e},BattleManager.checkSubstitute=function(e){return e.isDying()&&!this._action.isCertainHit()},BattleManager.isActionForced=function(){return!!this._actionForcedBattler},BattleManager.forceAction=function(e){this._actionForcedBattler=e
const t=this._actionBattlers.indexOf(e)
t>=0&&this._actionBattlers.splice(t,1)},BattleManager.processForcedAction=function(){this._actionForcedBattler&&(this._turnForced=!0,this._subject=this._actionForcedBattler,this._actionForcedBattler=null,this.startAction(),this._subject.removeCurrentAction())},BattleManager.abort=function(){this._phase="aborting"},BattleManager.checkBattleEnd=function(){if(this._phase){if(this.checkAbort())return!0
if($gameParty.isAllDead())return this.processDefeat(),!0
if($gameTroop.isAllDead())return this.processVictory(),!0}return!1},BattleManager.checkAbort=function(){return($gameParty.isEmpty()||this.isAborting())&&(SoundManager.playEscape(),this._escaped=!0,this.processAbort()),!1},BattleManager.processVictory=function(){$gameParty.removeBattleStates(),$gameParty.performVictory(),this.playVictoryMe(),this.replayBgmAndBgs(),this.makeRewards(),this.displayVictoryMessage(),this.displayRewards(),this.gainRewards(),this.endBattle(0)},BattleManager.processEscape=function(){$gameParty.performEscape(),SoundManager.playEscape()
const e=this.processEscapeFormula()
return e?(this.displayEscapeSuccessMessage(),this._escaped=!0,this.processAbort()):(this.displayEscapeFailureMessage(),this._escapeRatio+=.1,$gameParty.clearActions(),this.startTurn()),e},BattleManager.processEscapeFormula=function(){return!!this._preemptive||Math.random()<this._escapeRatio},BattleManager.processAbort=function(){$gameParty.removeBattleStates(),this.replayBgmAndBgs(),this.endBattle(1)},BattleManager.processDefeat=function(){this.displayDefeatMessage(),this.playDefeatMe(),this._canLose?this.replayBgmAndBgs():AudioManager.stopBgm(),this.endBattle(2)},BattleManager.endBattle=function(e){this._phase="battleEnd",this._eventCallback&&this._eventCallback(e),0===e?$gameSystem.onBattleWin():this._escaped&&$gameSystem.onBattleEscape()},BattleManager.updateBattleEnd=function(){this.isBattleTest()?(AudioManager.stopBgm(),SceneManager.exit()):!this._escaped&&$gameParty.isAllDead()?this._canLose?($gameParty.reviveBattleMembers(),SceneManager.pop()):SceneManager.goto(Scene_Gameover):SceneManager.pop(),this._phase=null},BattleManager.makeRewards=function(){this._rewards={},this._rewards.gold=$gameTroop.goldTotal(),this._rewards.exp=$gameTroop.expTotal(),this._rewards.items=$gameTroop.makeDropItems()},BattleManager.displayVictoryMessage=function(){$gameMessage.add(TextManager.victory.format($gameParty.name()))},BattleManager.displayDefeatMessage=function(){$gameMessage.add(TextManager.defeat.format($gameParty.name()))},BattleManager.displayEscapeSuccessMessage=function(){$gameMessage.add(TextManager.escapeStart.format($gameParty.name()))},BattleManager.displayEscapeFailureMessage=function(){$gameMessage.add(TextManager.escapeStart.format($gameParty.name())),$gameMessage.add("\\."+TextManager.escapeFailure)},BattleManager.displayRewards=function(){this.displayExp(),this.displayGold(),this.displayDropItems()},BattleManager.displayExp=function(){const e=this._rewards.exp
if(e>0){const t=TextManager.obtainExp.format(e,TextManager.exp)
$gameMessage.add("\\."+t)}},BattleManager.displayGold=function(){const e=this._rewards.gold
e>0&&$gameMessage.add("\\."+TextManager.obtainGold.format(e))},BattleManager.displayDropItems=function(){const e=this._rewards.items
e.length>0&&($gameMessage.newPage(),e.forEach((function(e){$gameMessage.add(TextManager.obtainItem.format(e.name))})))},BattleManager.gainRewards=function(){this.gainExp(),this.gainGold(),this.gainDropItems()},BattleManager.gainExp=function(){const e=this._rewards.exp
$gameParty.allMembers().forEach((function(t){t.gainExp(e)}))},BattleManager.gainGold=function(){$gameParty.gainGold(this._rewards.gold)},BattleManager.gainDropItems=function(){const e=void 0
this._rewards.items.forEach((function(e){$gameParty.gainItem(e,1)}))},PluginManager._path="js/plugins/",PluginManager._scripts=[],PluginManager._errorUrls=[],PluginManager._parameters={},PluginManager.setup=function(e){e.forEach((function(e){e.status&&!this._scripts.contains(e.name)&&(this.setParameters(e.name,e.parameters),this.loadScript(e.name+".js"),this._scripts.push(e.name))}),this)},PluginManager.checkErrors=function(){const e=this._errorUrls.shift()
if(e)throw new Error("Failed to load: "+e)},PluginManager.parameters=function(e){return this._parameters[e.toLowerCase()]||{}},PluginManager.setParameters=function(e,t){this._parameters[e.toLowerCase()]=t},PluginManager.loadScript=function(e){const t=this._path+e,a=document.createElement("script")
a.type="text/javascript",a.src=t,a.async=!1,a.onerror=this.onError.bind(this),a._url=t,document.body.appendChild(a)},PluginManager.onError=function(e){this._errorUrls.push(e.target._url)}
